#!/usr/bin/env python3
"""
Simple browser automation command for AI agents.
Usage: browser login <url> <username> <password> [--extract <query>]
       browser scrape <url> [--selector <css>]
       browser screenshot <url> [--output <path>]
"""

import sys
import json
from pathlib import Path

# Add workers to path
sys.path.insert(0, str(Path(__file__).parent / 'workers'))


def main():
    if len(sys.argv) < 2:
        print("Usage:")
        print("  browser login <url> <username> <password>")
        print("  browser scrape <url>")
        print("  browser screenshot <url>")
        sys.exit(1)

    command = sys.argv[1]

    try:
        from browser_agent import BrowserAgent

        agent = BrowserAgent(headless=False)

        if not agent.start():
            print("ERROR: Could not start browser")
            sys.exit(1)

        if command == "login":
            if len(sys.argv) < 5:
                print("Usage: browser login <url> <username> <password>")
                sys.exit(1)

            url = sys.argv[2]
            username = sys.argv[3]
            password = sys.argv[4]

            print(f"Logging into {url}...")
            agent.navigate(url)

            success = agent.login(url, username, password)

            if success:
                print("‚úÖ Login successful")

                # Extract page content
                page_text = agent.get_page_text()

                # Find prices
                import re
                prices = re.findall(r'\$[\d,]+\.?\d*', page_text)

                # Find monthly info
                monthly = []
                for line in page_text.split('\n'):
                    if 'month' in line.lower() or 'monthly' in line.lower():
                        monthly.append(line.strip())

                print("\nüí∞ Prices found:", prices)
                print("\nüìÖ Monthly information:")
                for item in monthly[:10]:
                    print(f"  - {item}")

                # Save screenshot
                agent.screenshot('/tmp/browser_result.png')
                print("\nüì∏ Screenshot: /tmp/browser_result.png")

                # Save full results
                result = {
                    'success': True,
                    'url': agent.page.url,
                    'prices': prices,
                    'monthly_info': monthly[:10],
                    'page_excerpt': page_text[:1000]
                }

                with open('/tmp/browser_result.json', 'w') as f:
                    json.dump(result, f, indent=2)

                print("üìÑ Full results: /tmp/browser_result.json")

            else:
                print("‚ùå Login failed")
                sys.exit(1)

        elif command == "scrape":
            if len(sys.argv) < 3:
                print("Usage: browser scrape <url>")
                sys.exit(1)

            url = sys.argv[2]
            agent.navigate(url)

            page_text = agent.get_page_text()
            print(page_text)

            agent.screenshot('/tmp/browser_scrape.png')

        elif command == "screenshot":
            if len(sys.argv) < 3:
                print("Usage: browser screenshot <url>")
                sys.exit(1)

            url = sys.argv[2]
            output = sys.argv[4] if len(sys.argv) > 4 else '/tmp/screenshot.png'

            agent.navigate(url)
            agent.screenshot(output)
            print(f"Screenshot saved: {output}")

        else:
            print(f"Unknown command: {command}")
            sys.exit(1)

        # Keep browser open for inspection
        input("\nPress Enter to close browser...")
        agent.stop()

    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
