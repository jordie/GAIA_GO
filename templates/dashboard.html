<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Prevent theme flash by setting theme immediately -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            // Use saved theme, or system preference, defaulting to dark
            if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- CSRF Protection Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Architect Dashboard - Project Management</title>
    <!-- Google Fonts for Terminal Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Socket.IO Client for Real-time Updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- XSS Prevention Utilities - MUST be loaded before other scripts -->
    <script src="{{ url_for('static', filename='js/sanitize.js') }}"></script>
    <!-- CSRF Protection - MUST be loaded before API calls -->
    <script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
    <!-- Correlation ID Tracking for Request Tracing -->
    <script src="{{ url_for('static', filename='js/correlation.js') }}"></script>
    <!-- Keyboard Shortcuts Module -->
    <script src="{{ url_for('static', filename='js/keyboardShortcuts.js') }}"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --border: #30363d;
            --error: #f85149;
            --warning: #d29922;
            --success: #3fb950;
            --purple: #a371f7;
            --pink: #db61a2;

            /* Terminal Font Configuration */
            --terminal-font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            --terminal-font-size: 13px;
            --terminal-line-height: 1.5;
            --terminal-letter-spacing: 0;
        }

        /* Light mode theme */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --bg-hover: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
            --accent: #0969da;
            --accent-hover: #0550ae;
            --border: #d0d7de;
            --error: #cf222e;
            --warning: #9a6700;
            --success: #1a7f37;
            --purple: #8250df;
            --pink: #bf3989;
        }

        /* Smooth theme transition */
        html.theme-transition,
        html.theme-transition *,
        html.theme-transition *::before,
        html.theme-transition *::after {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.2s ease !important;
            transition-delay: 0s !important;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            bottom: 50px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            transform: scale(1.1);
        }

        body.focus-mode .theme-toggle {
            display: none;
        }

        /* Skip to content link - visible on focus for accessibility */
        .skip-to-content:focus {
            left: 0 !important;
            outline: 2px solid var(--accent);
        }

        /* Focus visible styles for keyboard navigation */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Improved clickable areas for accessibility */
        .nav-btn, .nav-dropdown-btn, .filter-chip, .sort-chip, .queue-filter {
            min-height: 36px;
            min-width: 36px;
        }

        .btn {
            min-height: 36px;
            padding: 8px 16px;
        }

        .project-item, .session-item, .queue-card {
            min-height: 44px;
        }

        /* Visual hierarchy improvements */
        .panel-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* Section dividers for visual grouping */
        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 16px 0;
        }



        /* Notification Container */
        .notification-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .notification {
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .notification.success {
            background: rgba(63, 185, 80, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .notification.error {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .notification.info {
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .notification.warning {
            background: rgba(210, 153, 34, 0.15);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ===================== */
        /* Collaboration Indicators */
        /* ===================== */

        /* Collaboration container on panel headers */
        .collaboration-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
            min-height: 40px;
        }

        .collaboration-bar.hidden {
            display: none;
        }

        /* Avatar stack for viewers/editors */
        .avatar-stack {
            display: flex;
            align-items: center;
        }

        .avatar-stack .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            border: 2px solid var(--bg-tertiary);
            margin-left: -8px;
            position: relative;
            transition: transform 0.2s, z-index 0.2s;
        }

        .avatar-stack .avatar:first-child {
            margin-left: 0;
        }

        .avatar-stack .avatar:hover {
            transform: scale(1.15);
            z-index: 10;
        }

        .avatar-stack .avatar-more {
            background: var(--bg-hover);
            color: var(--text-secondary);
            font-size: 10px;
        }

        /* Presence indicator dot */
        .avatar .presence-dot {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-tertiary);
        }

        .presence-dot.online {
            background: var(--success);
        }

        .presence-dot.typing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .presence-dot.idle {
            background: var(--text-secondary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Typing indicator animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 3px;
        }

        .typing-indicator .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-indicator .dot:nth-child(1) { animation-delay: 0s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* Viewer count badge */
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(88, 166, 255, 0.15);
            border-radius: 12px;
            font-size: 11px;
            color: var(--accent);
        }

        .viewer-count .icon {
            font-size: 12px;
        }

        /* Field-level typing indicator */
        .field-typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(210, 153, 34, 0.1);
            border-radius: 4px;
            font-size: 11px;
            color: var(--warning);
            margin-top: 4px;
        }

        .field-typing-indicator .mini-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #fff;
        }

        /* Collaboration tooltip */
        .collab-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
        }

        .collab-tooltip .user-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .collab-tooltip .user-action {
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Entity collaboration badge (for list items) */
        .entity-collab-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .entity-collab-badge.has-activity {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
        }

        .entity-collab-badge .mini-avatars {
            display: flex;
        }

        .entity-collab-badge .mini-avatar {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: -4px;
            border: 1px solid var(--bg-tertiary);
            font-size: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
        }

        .entity-collab-badge .mini-avatar:first-child {
            margin-left: 0;
        }

        /* Edit conflict warning */
        .edit-conflict-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .edit-conflict-warning .icon {
            font-size: 16px;
        }

        /* Loading Spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 17, 23, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 8px;
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            top: 50%;
            left: 50%;
            margin-top: -7px;
            margin-left: -7px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Panel Transition */
        .panel {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-row {
            height: 40px;
            margin-bottom: 8px;
        }

        .skeleton-card {
            height: 100px;
            margin-bottom: 12px;
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-section {
            border-bottom: 1px solid var(--border);
        }

        .shortcuts-section:last-child {
            border-bottom: none;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            font-size: 13px;
        }

        .shortcut-row:hover {
            background: var(--bg-hover);
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .shortcut-keys kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 11px;
            font-family: inherit;
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Form Validation Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--error);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }

        .form-input.error {
            border-color: var(--error);
        }

        .form-input.error:focus {
            box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.15);
        }

        .form-error {
            display: none;
            margin-top: 6px;
            font-size: 12px;
            color: var(--error);
        }

        .form-group.has-error .form-error {
            display: block;
        }

        .form-hint {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Attachment upload area */
        .attachment-upload-area {
            padding: 12px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
        }
        .attachment-upload-area:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-top: 8px;
        }
        .attachment-item .filename {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .attachment-item .file-size {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Focus Visible for Accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:focus-visible,
        .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Skip Link for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: black;
            padding: 8px 16px;
            z-index: 10000;
            transition: top 0.2s ease;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Onboarding Tour */
        .tour-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .tour-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .tour-spotlight {
            position: fixed;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            z-index: 9999;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .tour-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            max-width: 360px;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: tourSlideIn 0.3s ease;
        }

        @keyframes tourSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tour-tooltip-arrow {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            transform: rotate(45deg);
        }

        .tour-tooltip-arrow.top { top: -7px; border-right: none; border-bottom: none; }
        .tour-tooltip-arrow.bottom { bottom: -7px; border-left: none; border-top: none; }
        .tour-tooltip-arrow.left { left: -7px; border-right: none; border-top: none; }
        .tour-tooltip-arrow.right { right: -7px; border-left: none; border-bottom: none; }

        .tour-step-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }

        .tour-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: background 0.2s ease;
        }

        .tour-step-dot.active {
            background: var(--accent);
        }

        .tour-step-dot.completed {
            background: var(--success);
        }

        .tour-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .tour-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .tour-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .tour-skip {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            padding: 8px;
        }

        .tour-skip:hover {
            color: var(--text-primary);
        }

        .tour-nav {
            display: flex;
            gap: 8px;
        }

        .tour-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tour-btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .tour-btn-secondary:hover {
            background: var(--bg-hover);
        }

        .tour-btn-primary {
            background: var(--accent);
            border: 1px solid var(--accent);
            color: black;
        }

        .tour-btn-primary:hover {
            opacity: 0.9;
        }

        .tour-welcome {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 450px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
        }

        .tour-welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .tour-welcome h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .tour-welcome p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* Enhanced Loading Animations */

        /* Loading dots animation */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDots {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Progress bar */
        .loading-progress {
            position: fixed;
            top: 57px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--bg-tertiary);
            z-index: 1001;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--purple));
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-progress.indeterminate .loading-progress-bar {
            width: 30%;
            animation: indeterminateProgress 1.5s infinite ease-in-out;
        }

        @keyframes indeterminateProgress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        /* Staggered list animation */
        .stagger-in > * {
            opacity: 0;
            transform: translateY(10px);
            animation: staggerFadeIn 0.3s ease forwards;
        }

        .stagger-in > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger-in > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-in > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger-in > *:nth-child(4) { animation-delay: 0.2s; }
        .stagger-in > *:nth-child(5) { animation-delay: 0.25s; }
        .stagger-in > *:nth-child(6) { animation-delay: 0.3s; }
        .stagger-in > *:nth-child(7) { animation-delay: 0.35s; }
        .stagger-in > *:nth-child(8) { animation-delay: 0.4s; }

        @keyframes staggerFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Content reveal animation */
        .content-reveal {
            animation: contentReveal 0.4s ease;
        }

        @keyframes contentReveal {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scale in animation for cards */
        .scale-in {
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Slide in from right (for panels) */
        .slide-in-right {
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Loading state for cards */
        .card.loading-state {
            position: relative;
            overflow: hidden;
        }

        .card.loading-state::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            animation: cardShimmer 1.5s infinite;
        }

        @keyframes cardShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Refresh spin animation */
        .refresh-spinning {
            animation: spin 1s linear infinite;
        }

        /* Bounce animation for new items */
        .bounce-in {
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Saving indicator */
        .saving-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saving-indicator.success {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        /* Success/Error Flash */
        @keyframes successFlash {
            0%, 100% { background: var(--bg-tertiary); }
            50% { background: rgba(63, 185, 80, 0.2); }
        }

        @keyframes errorFlash {
            0%, 100% { background: var(--bg-tertiary); }
            50% { background: rgba(248, 81, 73, 0.2); }
        }

        .flash-success {
            animation: successFlash 0.5s ease;
        }

        .flash-error {
            animation: errorFlash 0.5s ease;
        }

        /* Focus Ring for Accessibility */
        button:focus-visible, input:focus-visible, select:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Hover Transitions */
        .btn, button {
            transition: all 0.15s ease;
        }

        .btn:active:not(:disabled), button:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--error); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.pending { background: var(--text-secondary); }

        .status-dot.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Clickable Stats */
        .clickable-stat {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .clickable-stat:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .clickable-stat:active {
            transform: translateY(0);
        }

        .clickable-stat:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Environment Health Summary */
        .env-health-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: var(--bg-primary);
        }

        .env-health-item:hover {
            background: var(--bg-tertiary);
        }

        .env-health-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .env-health-status {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .env-health-status.healthy {
            background: rgba(63, 185, 80, 0.2);
            color: var(--success);
        }

        .env-health-status.unhealthy {
            background: rgba(248, 81, 73, 0.2);
            color: var(--error);
        }

        .env-health-status.unknown {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-secondary);
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(90deg, rgba(248, 81, 73, 0.15), rgba(210, 153, 34, 0.15));
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-banner-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--warning);
        }

        .alert-banner-icon {
            font-size: 16px;
        }

        .alert-banner-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-banner .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
        }

        .alert-banner .btn-sm:hover {
            background: var(--bg-hover);
        }

        .btn-close-banner {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
        }

        .btn-close-banner:hover {
            color: var(--text-primary);
        }

        /* Auto-refresh Toggle */
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .auto-refresh-toggle input {
            display: none;
        }

        .toggle-slider {
            width: 32px;
            height: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 9px;
            position: relative;
            transition: all 0.2s ease;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: all 0.2s ease;
        }

        .auto-refresh-toggle input:checked + .toggle-slider {
            background: var(--accent);
            border-color: var(--accent);
        }

        .auto-refresh-toggle input:checked + .toggle-slider::after {
            transform: translateX(14px);
            background: white;
        }

        /* Collapsible Sidebar Section */
        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 4px 0;
            user-select: none;
        }

        .sidebar-section-header:hover {
            opacity: 0.8;
        }

        .sidebar-section-toggle {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .sidebar-section.collapsed .sidebar-section-toggle {
            transform: rotate(-90deg);
        }

        .sidebar-section.collapsed .sidebar-section-content {
            display: none;
        }

        /* Quick Actions Dropdown */
        .quick-actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .quick-actions-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
        }

        .quick-actions-dropdown:hover .quick-actions-menu,
        .quick-actions-menu:hover {
            display: block;
        }

        .quick-actions-menu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .quick-actions-menu button:hover {
            background: var(--bg-hover);
        }

        /* Enhanced Environment Cards */
        .env-card-enhanced {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .env-card-enhanced:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .env-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .env-card-header .env-name {
            font-weight: 600;
            font-size: 14px;
        }

        .env-card-info {
            font-size: 12px;
        }

        .env-card-info .env-host {
            color: var(--text-secondary);
            font-family: monospace;
            font-size: 11px;
        }

        .env-card-info .env-status-text {
            margin-top: 4px;
            font-weight: 500;
        }

        .env-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }

        .env-card-actions .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }

        .env-card-actions .btn-sm:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        /* Syntax Highlighting for Terminal */
        .terminal-json-key {
            color: #79c0ff;
        }

        .terminal-json-string {
            color: #a5d6ff;
        }

        .terminal-json-number {
            color: #ffa657;
        }

        .terminal-json-boolean {
            color: #ff7b72;
        }

        .terminal-success {
            color: var(--success);
        }

        .terminal-error {
            color: var(--error);
        }

        .terminal-warning {
            color: var(--warning);
        }

        .terminal-prompt {
            color: var(--purple);
        }

        /* ANSI Color Support for Terminal Output */
        .ansi-bold { font-weight: bold; }
        .ansi-dim { opacity: 0.7; }
        .ansi-italic { font-style: italic; }
        .ansi-underline { text-decoration: underline; }
        .ansi-blink { animation: blink 1s step-end infinite; }
        .ansi-reverse { filter: invert(1); }
        .ansi-hidden { visibility: hidden; }
        .ansi-strikethrough { text-decoration: line-through; }

        /* ANSI Foreground Colors */
        .ansi-fg-black { color: #586e75; }
        .ansi-fg-red { color: #dc322f; }
        .ansi-fg-green { color: #859900; }
        .ansi-fg-yellow { color: #b58900; }
        .ansi-fg-blue { color: #268bd2; }
        .ansi-fg-magenta { color: #d33682; }
        .ansi-fg-cyan { color: #2aa198; }
        .ansi-fg-white { color: #eee8d5; }
        .ansi-fg-default { color: #c9d1d9; }

        /* ANSI Bright Foreground Colors */
        .ansi-fg-bright-black { color: #657b83; }
        .ansi-fg-bright-red { color: #ff6b6b; }
        .ansi-fg-bright-green { color: #7ed321; }
        .ansi-fg-bright-yellow { color: #f5a623; }
        .ansi-fg-bright-blue { color: #58a6ff; }
        .ansi-fg-bright-magenta { color: #bd93f9; }
        .ansi-fg-bright-cyan { color: #56d4dd; }
        .ansi-fg-bright-white { color: #ffffff; }

        /* ANSI Background Colors */
        .ansi-bg-black { background-color: #073642; }
        .ansi-bg-red { background-color: #dc322f; }
        .ansi-bg-green { background-color: #859900; }
        .ansi-bg-yellow { background-color: #b58900; }
        .ansi-bg-blue { background-color: #268bd2; }
        .ansi-bg-magenta { background-color: #d33682; }
        .ansi-bg-cyan { background-color: #2aa198; }
        .ansi-bg-white { background-color: #eee8d5; color: #073642; }
        .ansi-bg-default { background-color: transparent; }

        /* ANSI Bright Background Colors */
        .ansi-bg-bright-black { background-color: #657b83; }
        .ansi-bg-bright-red { background-color: #ff6b6b; }
        .ansi-bg-bright-green { background-color: #7ed321; }
        .ansi-bg-bright-yellow { background-color: #f5a623; }
        .ansi-bg-bright-blue { background-color: #58a6ff; }
        .ansi-bg-bright-magenta { background-color: #bd93f9; }
        .ansi-bg-bright-cyan { background-color: #56d4dd; }
        .ansi-bg-bright-white { background-color: #ffffff; color: #073642; }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Enhanced Terminal Styling */
        .terminal-container {
            font-family: var(--terminal-font-family);
            font-size: var(--terminal-font-size);
            line-height: var(--terminal-line-height);
            letter-spacing: var(--terminal-letter-spacing);

            /* Disable ligatures for terminal accuracy */
            font-feature-settings: 'liga' 0, 'calt' 0;
            font-variant-numeric: tabular-nums slashed-zero;

            /* Improved font rendering */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeSpeed;

            /* Character grid alignment */
            tab-size: 4;
            white-space: pre;
            word-break: normal;
            overflow-wrap: normal;
        }

        /* Responsive terminal font sizes */
        @media (max-width: 768px) {
            .terminal-container {
                font-size: 11px;
                line-height: 1.4;
            }
        }

        @media (min-width: 1600px) {
            .terminal-container {
                font-size: 14px;
            }
        }

        /* Terminal Scrollbar Styling */
        .terminal-output::-webkit-scrollbar {
            width: 10px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: #161b22;
            border-radius: 5px;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 5px;
            border: 2px solid #161b22;
        }

        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Firefox Scrollbar */
        .terminal-output {
            scrollbar-width: thin;
            scrollbar-color: #30363d #161b22;
        }

        /* Terminal output responsive sizing */
        #tmuxOutput {
            min-height: 200px;
        }

        @media (max-width: 768px) {
            #tmuxOutput {
                padding: 12px;
            }
        }

        /* Terminal Line Numbers (optional) */
        .terminal-line {
            display: block;
            padding: 1px 0;
            min-height: 1.5em;
        }

        .terminal-line:hover {
            background: rgba(88, 166, 255, 0.05);
        }

        /* Scroll position indicator */
        .scroll-indicator {
            position: absolute;
            right: 16px;
            bottom: 80px;
            background: rgba(88, 166, 255, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .scroll-indicator.visible {
            opacity: 1;
        }

        /* Jump to bottom button */
        .scroll-to-bottom {
            position: absolute;
            right: 16px;
            bottom: 80px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.15s, background 0.15s;
            z-index: 10;
        }

        .scroll-to-bottom:hover {
            transform: scale(1.1);
            background: #79c0ff;
        }

        .scroll-to-bottom.visible {
            display: flex;
        }

        /* Snippet Dropdown */
        .snippet-item {
            display: block;
            width: 100%;
            padding: 8px 10px;
            background: transparent;
            border: none;
            color: #c9d1d9;
            text-align: left;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .snippet-item:hover {
            background: #30363d;
        }

        .snippet-item:active {
            background: #484f58;
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: #161b22;
            color: #c9d1d9;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            margin-bottom: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .header-nav {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
        }

        .nav-btn {
            padding: 10px 16px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-btn:hover,
        .nav-btn:active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        /* Dropdown Navigation */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-btn {
            padding: 10px 16px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            min-height: 40px;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-dropdown-btn:hover,
        .nav-dropdown-btn:active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-dropdown-btn.has-active {
            color: var(--accent);
        }

        .nav-dropdown-btn::after {
            content: '';
            font-size: 10px;
            opacity: 0.6;
            transition: transform 0.2s;
        }

        .nav-dropdown.open .nav-dropdown-btn::after {
            transform: rotate(180deg);
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-width: 180px;
            padding: 4px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            margin-top: 4px;
            /* Prevent dropdown from falling off screen */
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Auto-adjust dropdown position on small screens */
        @media (max-width: 1199px) {
            .nav-dropdown:last-child .nav-dropdown-menu,
            .nav-dropdown:nth-last-child(2) .nav-dropdown-menu {
                left: auto;
                right: 0;
            }
        }

        .nav-dropdown:hover .nav-dropdown-menu,
        .nav-dropdown.open .nav-dropdown-menu {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-dropdown.closing .nav-dropdown-menu {
            display: none !important;
        }

        .nav-dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 14px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: all 0.15s;
            min-height: 40px;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-dropdown-item:hover,
        .nav-dropdown-item:active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-dropdown-item.active {
            background: var(--bg-tertiary);
            color: var(--accent);
            font-weight: 500;
        }

        .nav-dropdown-section {
            padding: 8px 14px 6px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .nav-dropdown-section:first-child {
            margin-top: 0;
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        /* Global Search */
        .global-search {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 12px;
            margin-left: 16px;
            min-width: 180px;
            transition: all 0.2s;
        }

        .global-search:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.1);
        }

        .global-search-icon {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .global-search input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 13px;
            width: 180px;
            outline: none;
        }

        .global-search input::placeholder {
            color: var(--text-secondary);
        }

        .search-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover,
        .search-result-item.selected {
            background: var(--bg-tertiary);
        }

        .search-result-item.selected {
            border-left: 2px solid var(--accent);
            padding-left: 10px;
        }

        .search-result-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }

        .search-result-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .search-result-name {
            flex: 1;
            font-size: 13px;
        }

        .kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            font-family: monospace;
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-left: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Saved Views Dropdown */
        .views-dropdown {
            position: relative;
        }

        .views-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .views-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .views-btn::after {
            content: '';
            font-size: 10px;
            opacity: 0.6;
        }

        .views-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-width: 220px;
            padding: 8px;
            z-index: 1001;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            margin-top: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .views-dropdown.open .views-dropdown-menu {
            display: block;
        }

        .views-section-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px 4px;
        }

        .views-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .views-item:hover {
            background: var(--bg-tertiary);
        }

        .views-item-name {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .views-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .views-item:hover .views-item-actions {
            opacity: 1;
        }

        .views-item-btn {
            padding: 4px 6px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .views-item-btn:hover {
            background: var(--bg-primary);
        }

        .views-item-btn.delete:hover {
            color: var(--danger);
        }

        .views-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        .views-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .views-action-btn:hover {
            background: var(--bg-tertiary);
        }

        .views-action-btn.primary {
            background: var(--accent);
            color: white;
        }

        .views-action-btn.primary:hover {
            background: var(--accent-hover);
        }

        .views-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Save View Modal */
        .save-view-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .save-view-modal.open {
            display: flex;
        }

        .save-view-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
        }

        .save-view-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .save-view-field {
            margin-bottom: 16px;
        }

        .save-view-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .save-view-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .save-view-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .save-view-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .save-view-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .save-view-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-view-btn.cancel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .save-view-btn.cancel:hover {
            background: var(--bg-primary);
        }

        .save-view-btn.save {
            background: var(--accent);
            border: 1px solid var(--accent);
            color: white;
        }

        .save-view-btn.save:hover {
            background: var(--accent-hover);
        }

        .views-item.active {
            background: var(--accent-bg);
        }

        .views-item.active .views-item-name {
            color: var(--accent);
            font-weight: 500;
        }

        /* WebSocket Connection Status Indicator */
        .socket-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-tertiary);
            cursor: default;
        }

        .socket-status .socket-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            transition: background 0.3s;
        }

        .socket-status.online .socket-dot {
            background: var(--success);
            animation: socket-pulse 2s infinite;
        }

        .socket-status.offline .socket-dot {
            background: var(--text-secondary);
        }

        .socket-status .socket-label {
            color: var(--text-secondary);
        }

        .socket-status.online .socket-label {
            color: var(--success);
        }

        @keyframes socket-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(63, 185, 80, 0); }
        }

        /* Online Users Indicator */
        .online-users-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .online-users-indicator:hover {
            background: var(--bg-hover);
        }

        .online-users-indicator .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: socket-pulse 2s infinite;
        }

        /* Online Users Panel */
        .online-users-panel {
            position: absolute;
            top: 55px;
            right: 180px;
            width: 280px;
            max-height: 400px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .online-users-panel.active {
            display: block;
            animation: slideIn 0.2s ease;
        }

        .online-users-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .online-users-panel-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .online-users-panel-body {
            max-height: 320px;
            overflow-y: auto;
            padding: 8px;
        }

        .online-user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .online-user-item:hover {
            background: var(--bg-tertiary);
        }

        .online-user-item .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            position: relative;
        }

        .online-user-item .user-avatar .presence-dot {
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border: 2px solid var(--bg-secondary);
        }

        .online-user-item .user-info {
            flex: 1;
        }

        .online-user-item .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .online-user-item .user-activity {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .online-user-item.is-you .user-name::after {
            content: ' (you)';
            color: var(--text-secondary);
            font-weight: 400;
        }

        .online-users-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .focus-toggle {
            position: relative;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .focus-toggle:hover {
            background: var(--purple);
        }

        .focus-toggle.active {
            background: var(--purple);
        }

        .focus-icon {
            font-size: 18px;
        }

        /* Focus Mode Styles */
        body.focus-mode .sidebar {
            display: none !important;
        }

        body.focus-mode .header-nav {
            display: none !important;
        }

        body.focus-mode .main-container {
            height: calc(100vh - 57px);
        }

        body.focus-mode .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        body.focus-mode .panel-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        body.focus-mode .notification-container {
            right: 50%;
            transform: translateX(50%);
        }

        body.focus-mode .mobile-sidebar-toggle {
            display: none !important;
        }

        /* Focus mode indicator */
        .focus-mode-indicator {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--purple);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(163, 113, 247, 0.3);
            animation: slideUp 0.3s ease;
        }

        body.focus-mode .focus-mode-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .focus-mode-indicator button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }

        .focus-mode-indicator button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Global Status Bar */
        .global-status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--text-secondary);
            z-index: 900;
        }

        .status-bar-left,
        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-bar-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-bar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-bar-dot.warning {
            background: var(--warning);
        }

        .status-bar-dot.error {
            background: var(--error);
        }

        .status-bar-dot.pulse {
            animation: pulse 2s infinite;
        }

        .status-bar-divider {
            width: 1px;
            height: 14px;
            background: var(--border);
        }

        .status-bar-link {
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
        }

        .status-bar-link:hover {
            color: var(--accent);
        }

        /* Adjust content area for status bar */
        .main-container {
            height: calc(100vh - 57px - 28px);
        }

        body.focus-mode .global-status-bar {
            display: none;
        }

        body.focus-mode .main-container {
            height: calc(100vh - 57px);
        }

        /* Gamification Badges */
        .badges-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        .badge-icon {
            font-size: 14px;
        }

        .badge.earned {
            background: linear-gradient(135deg, rgba(163, 113, 247, 0.2), rgba(219, 97, 162, 0.2));
            border-color: var(--purple);
            color: var(--purple);
        }

        .badge.gold {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 180, 0, 0.2));
            border-color: #ffd700;
            color: #ffd700;
        }

        .badge.silver {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(160, 160, 160, 0.2));
            border-color: #c0c0c0;
            color: #c0c0c0;
        }

        .badge.bronze {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(180, 100, 30, 0.2));
            border-color: #cd7f32;
            color: #cd7f32;
        }

        /* XP Progress Bar */
        .xp-progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 8px;
        }

        .xp-level {
            font-size: 18px;
            font-weight: 700;
            color: var(--purple);
            min-width: 40px;
        }

        .xp-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple), var(--pink));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 80px;
            text-align: right;
        }

        /* Streak Counter */
        .streak-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(255, 136, 0, 0.15), rgba(255, 68, 0, 0.15));
            border: 1px solid #ff8800;
            border-radius: 16px;
            color: #ff8800;
            font-weight: 600;
            font-size: 13px;
        }

        .streak-fire {
            font-size: 16px;
            animation: flicker 1s infinite alternate;
        }

        @keyframes flicker {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--purple);
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 32px rgba(163, 113, 247, 0.3);
            z-index: 2000;
            opacity: 0;
            animation: achievementPop 0.5s ease forwards;
        }

        @keyframes achievementPop {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.8); }
            50% { transform: translateX(-50%) translateY(0) scale(1.05); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .achievement-icon {
            font-size: 40px;
        }

        .achievement-content h4 {
            color: var(--purple);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .achievement-content p {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .global-status-bar {
                display: none;
            }
        }

        .notification-bell {
            position: relative;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .notification-bell:hover {
            background: var(--bg-tertiary);
        }

        .bell-icon {
            font-size: 20px;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--error);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .notification-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .notification-panel.active {
            display: flex;
        }

        .notification-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .notification-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .notification-panel-body {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-tertiary);
        }

        .notification-item.unread {
            background: rgba(88, 166, 255, 0.05);
        }

        .notification-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .notification-icon.error { color: var(--error); }
        .notification-icon.success { color: var(--success); }
        .notification-icon.warning { color: var(--warning); }
        .notification-icon.info { color: var(--primary); }

        .notification-content-wrap {
            flex: 1;
            min-width: 0;
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-primary);
            word-wrap: break-word;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .notification-panel-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .notification-panel-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .logout-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
        }

        .logout-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .header-action-btn {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 999px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            text-decoration: none;
            transition: all 0.2s;
        }

        .header-action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-tertiary);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 57px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            transition: width 0.2s ease;
            position: relative;
            /* Visible scrollbar for better UX */
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .sidebar.collapsed {
            width: 56px;
        }

        .sidebar.collapsed .sidebar-section-content,
        .sidebar.collapsed .sidebar-title span:not(.sidebar-section-toggle),
        .sidebar.collapsed .project-list,
        .sidebar.collapsed .stats-grid,
        .sidebar.collapsed .activity-feed,
        .sidebar.collapsed .btn {
            display: none;
        }

        .sidebar.collapsed .sidebar-section {
            padding: 12px 8px;
        }

        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
        }

        .sidebar.collapsed .sidebar-section-toggle {
            display: none;
        }

        .sidebar-collapse-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            z-index: 10;
        }

        .sidebar-collapse-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar.collapsed .sidebar-collapse-btn {
            right: 12px;
        }

        .sidebar-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        /* Sidebar Prioritization - Quick Access */
        .sidebar-quick-access {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05) 0%, transparent 100%);
        }

        .quick-access-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pinned-panels {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .pinned-panel-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .pinned-panel-chip:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .pinned-panel-chip .chip-icon {
            font-size: 11px;
        }

        .pinned-panel-chip .chip-badge {
            background: var(--error);
            color: white;
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: 600;
        }

        .pinned-panel-chip .chip-badge.warning {
            background: var(--warning);
        }

        .pinned-panel-chip .unpin-btn {
            opacity: 0;
            margin-left: 2px;
            font-size: 10px;
            color: var(--text-secondary);
            transition: opacity 0.15s ease;
        }

        .pinned-panel-chip:hover .unpin-btn {
            opacity: 1;
        }

        .add-pin-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .add-pin-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Sidebar Section Dragging */
        .sidebar-section.dragging {
            opacity: 0.5;
        }

        .sidebar-section.drag-over {
            border-top: 2px solid var(--accent);
        }

        .sidebar-section-header .drag-handle {
            opacity: 0;
            cursor: grab;
            color: var(--text-secondary);
            margin-right: 4px;
            transition: opacity 0.15s ease;
        }

        .sidebar-section-header:hover .drag-handle {
            opacity: 0.5;
        }

        .sidebar-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 12px;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .sidebar-section-header {
            padding: 8px 4px;
            margin: -8px -4px 8px;
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .sidebar-section-header:hover {
            background: var(--bg-tertiary);
        }

        .sidebar-section-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: var(--bg-tertiary);
            font-size: 10px;
        }

        .sidebar-section.collapsed .sidebar-section-header {
            margin-bottom: 0;
        }

        .project-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .project-item {
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .project-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .project-item.active {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .project-badge {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--bg-primary);
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Content Area - Ensure content starts at TOP, not centered */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            /* Use block layout - simpler and content naturally starts at top */
            display: block;
        }

        .panel {
            display: none !important;
        }

        .panel.active {
            display: block !important;
            /* Ensure panel content starts at top - block layout naturally flows from top */
            margin-top: 0;
            width: 100%;
        }

        /* Panels that need flex display when active - must use !important to override inline styles */
        #panel-queue.active {
            display: flex !important;
            gap: 0;
            padding: 0;
            align-items: flex-start;
            justify-content: flex-start;
        }

        #panel-tmux.active {
            display: flex !important;
            flex-direction: column;
            height: calc(100vh - 57px);
            overflow: hidden;
            padding: 0;
            align-items: stretch;
            justify-content: flex-start;
        }

        /* Fix for all panels - content should always start at TOP */
        .panel > *:first-child {
            margin-top: 0;
        }

        /* Ensure System menu panels (docs, workers, nodes, tasks, accounts, services) start at top */
        #panel-docs.active,
        #panel-workers.active,
        #panel-services.active,
        #panel-nodes.active,
        #panel-tasks.active,
        #panel-accounts.active,
        #panel-testing.active,
        #panel-deployments.active {
            display: block !important;
            position: relative;
            top: 0;
            margin-top: 0;
            padding-top: 0;
        }

        /* Override any flex centering on content area for these panels */
        .content:has(.panel.active) {
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }

        /* Prevent browser auto-scroll on hash navigation */
        html {
            scroll-behavior: auto !important;
        }

        /* Ensure content area doesn't have scroll-related issues */
        .content {
            scroll-behavior: auto !important;
            overflow-anchor: none;
        }

        /* Force all panels to start at absolute top of content area */
        .panel.active {
            position: relative !important;
            top: 0 !important;
            margin-top: 0 !important;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 24px;
            font-weight: 600;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        /* Enhanced Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::before,
        [data-tooltip]::after {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        [data-tooltip]::before {
            content: attr(data-tooltip);
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            padding: 8px 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 6px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-tooltip]::after {
            content: '';
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }

        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        [data-tooltip]:hover::before {
            transform: translateX(-50%) translateY(0);
        }

        /* Tooltip positions */
        [data-tooltip-pos="bottom"]::before {
            bottom: auto;
            top: calc(100% + 8px);
            transform: translateX(-50%) translateY(-4px);
        }

        [data-tooltip-pos="bottom"]::after {
            bottom: auto;
            top: calc(100% + 2px);
            border-top-color: transparent;
            border-bottom-color: var(--border);
        }

        [data-tooltip-pos="bottom"]:hover::before {
            transform: translateX(-50%) translateY(0);
        }

        [data-tooltip-pos="left"]::before {
            bottom: auto;
            top: 50%;
            left: auto;
            right: calc(100% + 8px);
            transform: translateY(-50%) translateX(4px);
        }

        [data-tooltip-pos="left"]::after {
            bottom: auto;
            top: 50%;
            left: auto;
            right: calc(100% + 2px);
            transform: translateY(-50%);
            border-top-color: transparent;
            border-left-color: var(--border);
        }

        [data-tooltip-pos="left"]:hover::before {
            transform: translateY(-50%) translateX(0);
        }

        [data-tooltip-pos="right"]::before {
            bottom: auto;
            top: 50%;
            left: calc(100% + 8px);
            transform: translateY(-50%) translateX(-4px);
        }

        [data-tooltip-pos="right"]::after {
            bottom: auto;
            top: 50%;
            left: calc(100% + 2px);
            transform: translateY(-50%);
            border-top-color: transparent;
            border-right-color: var(--border);
        }

        [data-tooltip-pos="right"]:hover::before {
            transform: translateY(-50%) translateX(0);
        }

        /* Keyboard shortcut in tooltip */
        .tooltip-kbd {
            display: inline-block;
            padding: 2px 6px;
            margin-left: 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
            font-family: monospace;
            color: var(--text-secondary);
        }

        /* Cards Grid - align items to top */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
            align-items: start;
            align-content: start;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .card-body {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-draft { background: var(--bg-tertiary); color: var(--text-secondary); }
        .badge-open { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
        .badge-in_progress, .badge-in-progress { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .badge-review { background: rgba(163, 113, 247, 0.15); color: var(--purple); }
        .badge-completed, .badge-resolved { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .badge-critical { background: rgba(248, 81, 73, 0.15); color: var(--error); }
        .badge-high { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .badge-medium { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
        .badge-low { background: var(--bg-tertiary); color: var(--text-secondary); }
        .badge-online { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .badge-offline { background: rgba(248, 81, 73, 0.15); color: var(--error); }

        /* Project status badges */
        .badge-active { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .badge-planning { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
        .badge-on_hold { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .badge-archived { background: var(--bg-tertiary); color: var(--text-secondary); }

        /* Tables */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-tertiary);
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            font-size: 13px;
        }

        .pagination-info {
            color: var(--text-secondary);
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-controls button {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-controls select {
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-input {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* tmux Panel */
        .tmux-output {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .tmux-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .tmux-input input {
            flex: 1;
        }

        /* Nodes Panel */
        .node-card {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .node-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .node-status-indicator.online { background: var(--success); }
        .node-status-indicator.offline { background: var(--error); }

        .node-metrics {
            display: flex;
            gap: 24px;
            margin-top: 12px;
        }

        .node-metric {
            text-align: center;
        }

        .node-metric-value {
            font-size: 18px;
            font-weight: 600;
        }

        .node-metric-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        /* Node Health Charts */
        .node-health-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }

        .node-health-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s;
        }

        .node-health-fill.low { background: var(--success); }
        .node-health-fill.medium { background: var(--warning); }
        .node-health-fill.high { background: var(--error); }

        .node-metric-with-bar {
            flex: 1;
            min-width: 80px;
        }

        .node-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        /* Auto-refresh indicator */
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .auto-refresh-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .refresh-countdown {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .refresh-countdown.active {
            color: var(--success);
        }

        .node-last-updated {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 8px;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
            align-items: center;
        }

        .activity-item[onclick]:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .activity-item .activity-arrow {
            margin-left: auto;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .activity-item:hover .activity-arrow {
            opacity: 1;
            color: var(--primary) !important;
        }

        /* Documentation Panel Styles */
        .docs-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .docs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .docs-meta {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .docs-version {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .docs-updated {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .docs-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .docs-content h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 32px 0 16px 0;
            color: var(--text-primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        .docs-content h1:first-child {
            margin-top: 0;
        }

        .docs-content h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 28px 0 12px 0;
            color: var(--text-primary);
        }

        .docs-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 24px 0 10px 0;
            color: var(--text-primary);
        }

        .docs-content p {
            margin: 12px 0;
            color: var(--text-secondary);
        }

        .docs-content ul, .docs-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .docs-content li {
            margin: 6px 0;
            color: var(--text-secondary);
        }

        .docs-content code {
            background: var(--bg-tertiary);
            color: var(--cyan);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 13px;
        }

        .docs-content pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .docs-content pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        .docs-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .docs-content th, .docs-content td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border);
        }

        .docs-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .docs-content td {
            color: var(--text-secondary);
        }

        /* Docs panel specific styling */
        #panel-docs {
            width: 100%;
            padding: 24px;
        }

        #panel-docs.active {
            display: block !important;
        }

        .docs-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }

        .docs-section.feature {
            border-left-color: var(--green);
        }

        .docs-section.api {
            border-left-color: var(--cyan);
        }

        .docs-section.config {
            border-left-color: var(--yellow);
        }

        .docs-toc {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }

        .docs-toc h4 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .docs-toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .docs-toc li {
            margin: 6px 0;
        }

        .docs-toc a {
            color: var(--primary);
            text-decoration: none;
            font-size: 14px;
        }

        .docs-toc a:hover {
            text-decoration: underline;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-action {
            font-size: 14px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .header-nav {
                overflow-x: auto;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Review Queue Styles */
        .queue-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .queue-filter {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .queue-filter:hover {
            background: var(--bg-hover);
        }

        .queue-filter.active {
            background: var(--cyan);
            color: black;
            border-color: var(--cyan);
            font-weight: 600;
        }

        .queue-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .queue-item:hover {
            border-color: var(--cyan);
            background: var(--bg-hover);
        }

        .queue-item-priority {
            width: 4px;
            height: 48px;
            border-radius: 2px;
        }

        .queue-item-priority.critical { background: var(--red); }
        .queue-item-priority.high { background: var(--orange); }
        .queue-item-priority.normal { background: var(--blue); }
        .queue-item-priority.low { background: var(--text-secondary); }

        .queue-item-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .queue-item-content {
            flex: 1;
            min-width: 0;
        }

        .queue-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .queue-item-meta {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            gap: 16px;
        }

        .queue-item-actions {
            display: flex;
            gap: 8px;
        }

        /* Queue Priority Badges */
        .queue-priority-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .queue-priority-badge.priority-critical {
            background: rgba(248, 81, 73, 0.2);
            color: var(--red);
        }
        .queue-priority-badge.priority-high {
            background: rgba(255, 166, 87, 0.2);
            color: var(--orange);
        }
        .queue-priority-badge.priority-normal {
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent);
        }
        .queue-priority-badge.priority-low {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-secondary);
        }

        /* Queue Batch Bar */
        .queue-batch-bar {
            animation: slideDown 0.2s ease;
        }

        /* Queue Item Checkbox */
        .queue-item:hover .queue-item-checkbox {
            opacity: 1;
        }
        .queue-item-checkbox {
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .queue-item-checkbox:checked {
            opacity: 1;
        }

        /* Selected Queue Item */
        .queue-item.selected {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent);
        }

        /* App Card Styles */
        .app-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .app-card:hover {
            border-color: var(--cyan);
        }

        .app-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .app-card-name {
            font-size: 18px;
            font-weight: 600;
        }

        .app-card-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .app-card-status.running {
            background: rgba(0, 255, 136, 0.15);
            color: var(--green);
        }

        .app-card-status.idle {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .app-card-goal {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .app-card-phase {
            display: inline-block;
            padding: 4px 8px;
            background: var(--bg);
            border-radius: 4px;
            font-size: 12px;
            color: var(--cyan);
            margin-bottom: 12px;
        }

        .app-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        /* Mobile responsive for queue */
        @media (max-width: 768px) {
            .queue-summary {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .queue-item {
                flex-wrap: wrap;
            }

            .queue-item-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 8px;
            }
        }

        /* iOS/Mobile Base Fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: contain;
        }

        button, input, select, textarea {
            -webkit-appearance: none;
            appearance: none;
            border-radius: 6px;
        }

        /* Mobile Bottom Navigation Bar */
        .mobile-nav {
            display: none;
        }

        /* Mobile Sidebar Overlay Toggle */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            top: calc(12px + env(safe-area-inset-top, 0px));
            left: 16px;
            z-index: 1001;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .mobile-sidebar-toggle:hover {
            background: var(--bg-tertiary);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* ============================================
           RESPONSIVE BREAKPOINTS
           ============================================ */

        /* Large Desktop (1400px+): Default styles apply */

        /* Small Desktop (1200px - 1399px) */
        @media (max-width: 1399px) {
            .sidebar {
                width: 260px;
            }

            .content {
                padding: 20px;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }

            .stats-grid {
                gap: 6px;
            }

            .stat-value {
                font-size: 22px;
            }
        }

        /* Tablet Landscape (992px - 1199px) */
        @media (max-width: 1199px) {
            .sidebar {
                width: 240px;
            }

            .sidebar-section {
                padding: 10px 14px;
            }

            .content {
                padding: 16px;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 16px;
            }

            .panel-header {
                flex-wrap: wrap;
                gap: 12px;
            }

            .panel-actions {
                width: 100%;
                justify-content: flex-start;
            }

            /* Responsive navigation for tablets */
            .header-nav {
                gap: 2px;
            }

            .header-nav .nav-btn,
            .nav-dropdown-btn {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 38px;
            }

            .global-search {
                margin-left: 8px;
                min-width: 150px;
            }

            .global-search input {
                font-size: 13px;
            }

            /* Make dropdowns easier to tap */
            .nav-dropdown-item {
                padding: 14px 16px;
                font-size: 14px;
                min-height: 44px;
            }

            .queue-summary {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .stats-grid[style*="repeat(5"] {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .stats-grid[style*="repeat(4"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* Tablet Portrait (768px - 991px) */
        @media (max-width: 991px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 1000;
                transform: translateX(-100%);
                -webkit-transform: translateX(-100%);
                transition: transform 0.3s ease;
                -webkit-transition: -webkit-transform 0.3s ease;
                background: var(--bg-secondary);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                -webkit-transform: translateX(0);
            }

            .mobile-sidebar-toggle {
                display: flex;
            }

            .main-container {
                height: calc(100vh - 57px);
            }

            .content {
                margin-left: 0;
                width: 100%;
            }

            .header-left {
                padding-left: 56px;
            }

            .header-nav {
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .header-nav::-webkit-scrollbar {
                display: none;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            }

            .queue-summary {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .panel-title {
                font-size: 22px;
            }

            .modal {
                max-width: 90vw;
                max-height: 90vh;
            }

            /* Two-column layouts become single on tablet */
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* ============================================
           MOBILE LAYOUT - Complete Redesign
           ============================================ */
        @media (max-width: 768px) {
            /* Hide desktop elements - use mobile bottom nav instead */
            .header { display: none !important; }
            .header-nav { display: none !important; }
            .nav-dropdown { display: none !important; }

            /* Hide hamburger on phones - we use bottom nav */
            .mobile-sidebar-toggle { display: none !important; }
            .sidebar-overlay { display: none !important; }

            /* Sidebar is accessible via More menu on phones */
            .sidebar {
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 60px; /* Above mobile nav */
                width: 100%;
                z-index: 1500;
                transform: translateY(100%);
                -webkit-transform: translateY(100%);
                transition: transform 0.3s ease;
                -webkit-transition: -webkit-transform 0.3s ease;
                background: var(--bg-secondary);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sidebar.mobile-open {
                display: flex;
                transform: translateY(0);
                -webkit-transform: translateY(0);
            }

            /* Show mobile nav */
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                padding: 8px 0;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
                z-index: 1000;
                justify-content: space-around;
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 8px 16px;
                color: var(--text-secondary);
                text-decoration: none;
                font-size: 10px;
                min-width: 64px;
                border: none;
                background: none;
                cursor: pointer;
            }

            .mobile-nav-item.active {
                color: var(--cyan);
            }

            .mobile-nav-item .nav-icon {
                font-size: 24px;
                margin-bottom: 4px;
            }

            /* Mobile More Menu */
            .mobile-more-menu {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 2000;
            }

            .mobile-more-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
            }

            .mobile-more-content {
                position: absolute;
                bottom: 70px;
                left: 16px;
                right: 16px;
                background: var(--bg-secondary);
                border-radius: 16px;
                padding: 16px;
                max-height: 60vh;
                overflow-y: auto;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            }

            .mobile-more-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border);
                font-weight: 600;
                font-size: 16px;
            }

            .mobile-more-header button {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                cursor: pointer;
                padding: 4px 8px;
            }

            .mobile-more-section {
                font-size: 11px;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin: 16px 0 8px 0;
            }

            .mobile-more-section:first-of-type {
                margin-top: 0;
            }

            .mobile-more-item {
                display: flex;
                align-items: center;
                gap: 12px;
                width: 100%;
                padding: 12px;
                background: var(--bg-tertiary);
                border: none;
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 14px;
                cursor: pointer;
                margin-bottom: 8px;
                text-align: left;
            }

            .mobile-more-item:hover,
            .mobile-more-item:active {
                background: var(--bg-hover);
            }

            /* Mobile Header */
            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                padding: 12px 16px;
                padding-top: calc(12px + env(safe-area-inset-top, 0px));
                z-index: 1000;
                align-items: center;
                justify-content: space-between;
            }

            .mobile-header .logo {
                font-size: 20px;
                font-weight: 700;
                color: var(--cyan);
            }

            .mobile-header-actions {
                display: flex;
                gap: 12px;
            }

            .mobile-header-btn {
                background: none;
                border: none;
                color: var(--text);
                font-size: 20px;
                padding: 8px;
                cursor: pointer;
            }

            /* Content area */
            .content {
                margin-top: calc(56px + env(safe-area-inset-top, 0px));
                margin-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
                padding: 16px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Block layout - content naturally starts at top */
                display: block;
            }

            .panel {
                padding: 0;
            }

            .panel-header {
                margin-bottom: 16px;
            }

            .panel-title {
                font-size: 24px;
                font-weight: 700;
            }

            .panel-actions {
                margin-top: 12px;
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            /* Queue Summary - 2x2 Grid */
            .queue-summary {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }

            .queue-card {
                background: var(--bg-card) !important;
                border-radius: 12px !important;
                padding: 16px !important;
                text-align: center;
            }

            .queue-card > div:first-child {
                font-size: 32px !important;
                font-weight: 700 !important;
            }

            .queue-card > div:last-child {
                font-size: 12px !important;
                margin-top: 4px;
            }

            /* Queue Filters - Horizontal Scroll */
            .queue-filters {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                padding: 12px 0;
                margin: 0 -16px;
                padding-left: 16px;
                padding-right: 16px;
                scrollbar-width: none;
            }

            .queue-filters::-webkit-scrollbar { display: none; }

            .queue-filter {
                flex-shrink: 0;
                padding: 12px 20px;
                border-radius: 20px;
                font-size: 14px;
                min-height: 44px;
                white-space: nowrap;
            }

            /* Queue Items - Full Width Cards */
            .queue-items {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .queue-item {
                background: var(--bg-card);
                border-radius: 12px;
                padding: 16px;
                display: block;
            }

            .queue-item-priority {
                display: none;
            }

            .queue-item-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
            }

            .queue-item-icon {
                font-size: 28px;
            }

            .queue-item-title {
                font-size: 16px;
                font-weight: 600;
                flex: 1;
            }

            .queue-item-meta {
                display: flex;
                gap: 8px;
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 12px;
            }

            .queue-item-actions {
                display: flex;
                gap: 8px;
            }

            .queue-item-actions .btn {
                flex: 1;
                min-height: 48px;
                font-size: 15px;
            }

            /* Apps Grid - Single Column */
            .apps-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            }

            .app-card {
                background: var(--bg-card);
                border-radius: 16px;
                padding: 20px;
            }

            .app-card-header {
                margin-bottom: 12px;
            }

            .app-card-name {
                font-size: 18px;
            }

            .app-card-status {
                padding: 6px 12px;
                font-size: 13px;
            }

            .app-card-goal {
                font-size: 15px;
                line-height: 1.4;
            }

            .app-card-phase {
                font-size: 13px;
                padding: 6px 12px;
            }

            .app-card-actions {
                display: flex;
                gap: 12px;
                margin-top: 16px;
            }

            .app-card-actions .btn {
                flex: 1;
                min-height: 48px;
                font-size: 15px;
            }

            /* Buttons */
            .btn {
                min-height: 48px;
                padding: 14px 20px;
                font-size: 15px;
                border-radius: 10px;
            }

            .btn-sm {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Forms */
            input, textarea, select {
                min-height: 48px;
                font-size: 16px !important;
                padding: 14px;
                border-radius: 10px;
            }

            /* Modals - Full Screen on Mobile */
            .modal-overlay {
                padding: 0 !important;
            }

            .modal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                max-height: 100% !important;
                border-radius: 0 !important;
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                padding: 16px;
                padding-top: calc(16px + env(safe-area-inset-top, 0px));
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
            }

            .modal-body {
                flex: 1;
                overflow-y: auto;
                padding: 16px !important;
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)) !important;
            }

            .modal-close {
                font-size: 28px;
                padding: 8px;
            }

            /* Empty state */
            .empty-state {
                padding: 40px 20px !important;
            }

            .empty-state > div:first-child {
                font-size: 40px !important;
            }

            /* Hide non-essential desktop elements */
            .header-right { display: none; }
            .global-search { display: none; }

            /* =====================
               TMUX PANEL - Mobile
               ===================== */
            #panel-tmux {
                height: auto !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            #panel-tmux .sessions-container {
                flex-direction: column !important;
            }

            #panel-tmux .sessions-sidebar {
                width: 100% !important;
                min-width: 100% !important;
                border-right: none !important;
                border-bottom: 1px solid var(--border);
                max-height: none !important;
            }

            #panel-tmux .terminal-area {
                display: none !important;
            }

            #panel-tmux #tmuxSessionsList {
                padding: 12px !important;
            }

            /* Mobile session cards */
            .session-item {
                background: var(--bg-card) !important;
                border-radius: 12px !important;
                padding: 16px !important;
                margin-bottom: 12px !important;
            }

            .session-item-name {
                font-size: 16px !important;
            }

            .session-item-meta {
                font-size: 13px !important;
            }

            /* Session detail modal for mobile */
            .session-detail-mobile {
                padding: 16px;
            }

            .session-output-mobile {
                background: #0d1117;
                border-radius: 8px;
                padding: 12px;
                font-family: monospace;
                font-size: 12px;
                line-height: 1.4;
                overflow-x: auto;
                white-space: pre-wrap;
                word-break: break-all;
                max-height: 300px;
                overflow-y: auto;
            }

            .session-actions-mobile {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 16px;
            }

            .session-actions-mobile .btn {
                width: 100%;
            }

            /* Command input for mobile */
            .mobile-command-input {
                display: flex;
                gap: 8px;
                margin-top: 16px;
            }

            .mobile-command-input input {
                flex: 1;
            }

            /* Fullscreen tmux modal - Mobile optimizations */
            #modal-tmuxFullscreen {
                padding-top: env(safe-area-inset-top, 0px) !important;
            }

            #modal-tmuxFullscreen > div {
                padding-bottom: env(safe-area-inset-bottom, 0px) !important;
            }

            #fullscreenTmuxOutput {
                font-size: 12px !important;
                padding: 12px !important;
            }

            #modal-tmuxFullscreen .special-key {
                padding: 14px 10px !important;
                font-size: 12px !important;
                min-width: 44px !important;
            }

            #modal-tmuxFullscreen .quick-cmd {
                padding: 10px 12px !important;
                font-size: 12px !important;
            }

            #fullscreenTmuxInput {
                font-size: 16px !important;
                padding: 14px !important;
            }
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .queue-card:hover, .app-card:hover, .queue-item:hover {
                transform: none;
            }

            .btn:active, .queue-card:active, .app-card:active, .queue-filter:active, .mobile-nav-item:active {
                opacity: 0.7;
            }

            .btn, .nav-btn, .queue-card, .app-card, .queue-filter, .mobile-nav-item {
                -webkit-user-select: none;
                user-select: none;
            }
        }
    </style>

    <!-- xterm.js for embedded terminal -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>

    <style>
        /* xterm.js container styling */
        #xtermContainer {
            width: 100%;
            height: 100%;
            background: #0d1117;
        }

        #xtermContainer .xterm {
            padding: 8px;
        }

        #xtermContainer .xterm-viewport {
            background: #0d1117 !important;
        }

        /* Toggle between xterm and legacy view */
        .terminal-view-toggle {
            display: flex;
            gap: 4px;
            background: #21262d;
            border-radius: 6px;
            padding: 2px;
        }

        .terminal-view-toggle button {
            padding: 4px 10px;
            border: none;
            background: transparent;
            color: #8b949e;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .terminal-view-toggle button.active {
            background: #30363d;
            color: #c9d1d9;
        }

        .terminal-view-toggle button:hover:not(.active) {
            color: #c9d1d9;
        }
    </style>
    <!-- Inline Editing Styles -->
    <link rel="stylesheet" href="/static/css/inlineEdit.css">
    <!-- Chart.js for health monitoring graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body data-username="{{ session.get('username', 'User') }}">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-to-content" style="position: absolute; left: -9999px; top: 0; z-index: 9999; padding: 8px 16px; background: var(--accent); color: white; text-decoration: none; border-radius: 0 0 4px 0;">Skip to main content</a>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container" role="alert" aria-live="polite"></div>

    <!-- Loading Progress Bar -->
    <div class="loading-progress" id="loadingProgress" style="display: none;">
        <div class="loading-progress-bar" id="loadingProgressBar"></div>
    </div>

    <!-- Tablet Sidebar Toggle (768px-991px) -->
    <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()" aria-label="Toggle sidebar"></button>
    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Mobile Header (hidden on desktop) -->
    <div class="mobile-header" style="display: none;">
        <div class="logo">Architect <span style="font-size: 0.7em; opacity: 0.8;">(v2.43)</span></div>
        <div class="mobile-header-actions">
            <button class="mobile-header-btn" onclick="refreshQueue()" aria-label="Refresh queue"></button>
        </div>
    </div>

    <!-- Mobile Bottom Navigation (hidden on desktop) -->
    <nav class="mobile-nav" style="display: none;" role="navigation" aria-label="Mobile navigation">
        <button class="mobile-nav-item active" onclick="mobileNavigate('queue', this)">
            <span class="nav-icon"></span>
            <span>Queue</span>
        </button>
        <button class="mobile-nav-item" onclick="mobileNavigate('overview', this)">
            <span class="nav-icon"></span>
            <span>Dashboard</span>
        </button>
        <button class="mobile-nav-item" onclick="mobileNavigate('projects', this)">
            <span class="nav-icon"></span>
            <span>Projects</span>
        </button>
        <button class="mobile-nav-item" onclick="mobileNavigate('tmux', this)">
            <span class="nav-icon"></span>
            <span>Sessions</span>
        </button>
        <button class="mobile-nav-item" onclick="mobileNavigate('bugs', this)">
            <span class="nav-icon"></span>
            <span>Issues</span>
        </button>
        <button class="mobile-nav-item" onclick="showMobileMoreMenu()">
            <span class="nav-icon"></span>
            <span>More</span>
        </button>
    </nav>

    <!-- Mobile More Menu -->
    <div class="mobile-more-menu" id="mobileMoreMenu" style="display: none;">
        <div class="mobile-more-overlay" onclick="hideMobileMoreMenu()"></div>
        <div class="mobile-more-content">
            <div class="mobile-more-header">
                <span>More Options</span>
                <button onclick="hideMobileMoreMenu()">&times;</button>
            </div>
            <div class="mobile-more-section">DevOps</div>
            <button class="mobile-more-item" onclick="mobileNavigate('testing'); hideMobileMoreMenu()">
                <span></span> Testing
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('deployments'); hideMobileMoreMenu()">
                <span></span> Deployments
            </button>
            <div class="mobile-more-section">Infrastructure</div>
            <button class="mobile-more-item" onclick="mobileNavigate('services'); hideMobileMoreMenu()">
                <span></span> Services
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('regions'); hideMobileMoreMenu()">
                <span></span> Regions
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('nodes'); hideMobileMoreMenu()">
                <span></span> Nodes
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('tasks'); hideMobileMoreMenu()">
                <span></span> Tasks
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('workers'); hideMobileMoreMenu()">
                <span></span> Workers
            </button>
            <div class="mobile-more-section">System</div>
            <button class="mobile-more-item" onclick="mobileNavigate('accounts'); hideMobileMoreMenu()">
                <span></span> Settings
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('docs'); hideMobileMoreMenu()">
                <span></span> Documentation
            </button>
            <button class="mobile-more-item" onclick="mobileNavigate('sop'); hideMobileMoreMenu()">
                <span></span> SOP Editor
            </button>
            <button class="mobile-more-item" onclick="openDashboardPrintView(); hideMobileMoreMenu()">
                <span>P</span> Print / Export
            </button>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <div class="logo">Architect <span style="font-size: 0.7em; opacity: 0.8;">(v2.43)</span></div>
            <nav class="header-nav" role="navigation" aria-label="Main navigation">
                <!-- 1. Queue - Primary -->
                <a href="#queue" class="nav-btn active" data-panel="queue" style="background: var(--cyan); color: black; font-weight: 600; text-decoration: none;">Queue</a>

                <!-- 2. Dashboard -->
                <a href="#overview" class="nav-btn" data-panel="overview" style="text-decoration: none;">Dashboard</a>

                <!-- 2.5. AI Assistant -->
                <a href="#ai-assistant" class="nav-btn" data-panel="ai-assistant" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none;"> AI Assistant</a>

                <!-- 3. Projects Dropdown -->
                <div class="nav-dropdown" id="nav-projects">
                    <button class="nav-dropdown-btn" aria-haspopup="true" aria-expanded="false">Projects</button>
                    <div class="nav-dropdown-menu">
                        <a href="#projects" class="nav-dropdown-item" data-panel="projects" style="text-decoration: none;">All Projects</a>
                        <a href="#apps" class="nav-dropdown-item" data-panel="apps" style="text-decoration: none;">Apps</a>
                    </div>
                </div>

                <!-- 4. Issues Dropdown -->
                <div class="nav-dropdown" id="nav-issues">
                    <button class="nav-dropdown-btn" aria-haspopup="true" aria-expanded="false">Issues</button>
                    <div class="nav-dropdown-menu">
                        <a href="#features" class="nav-dropdown-item" data-panel="features" style="text-decoration: none;">Features</a>
                        <a href="#bugs" class="nav-dropdown-item" data-panel="bugs" style="text-decoration: none;">Bugs</a>
                        <a href="#errors" class="nav-dropdown-item" data-panel="errors" style="text-decoration: none;">Errors</a>
                    </div>
                </div>

                <!-- 5. Sessions - Prominent for terminal focus -->
                <a href="#tmux" class="nav-btn sessions-prominent" data-panel="tmux" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, #1a2233 100%); border: 1px solid var(--accent); color: var(--accent); text-decoration: none;"> Sessions</a>

                <!-- 6. System Dropdown - DevOps, Infra, Settings -->
                <div class="nav-dropdown" id="nav-system">
                    <button class="nav-dropdown-btn" aria-haspopup="true" aria-expanded="false">System</button>
                    <div class="nav-dropdown-menu" style="min-width: 160px;">
                        <div class="nav-dropdown-section">DevOps</div>
                        <a href="#testing" class="nav-dropdown-item" data-panel="testing" style="text-decoration: none;">Testing</a>
                        <a href="#deployments" class="nav-dropdown-item" data-panel="deployments" style="text-decoration: none;">Deployments</a>
                        <div class="nav-dropdown-divider"></div>
                        <div class="nav-dropdown-section">Infrastructure</div>
                        <a href="#system-overview" class="nav-dropdown-item" data-panel="system-overview" style="text-decoration: none;"> System Overview</a>
                        <a href="#services" class="nav-dropdown-item" data-panel="services" style="text-decoration: none;"> Services</a>
                        <a href="#regions" class="nav-dropdown-item" data-panel="regions" style="text-decoration: none;"> Regions</a>
                        <a href="#nodes" class="nav-dropdown-item" data-panel="nodes" style="text-decoration: none;">Nodes</a>
                        <a href="#tasks" class="nav-dropdown-item" data-panel="tasks" style="text-decoration: none;">Tasks</a>
                        <a href="#workers" class="nav-dropdown-item" data-panel="workers" style="text-decoration: none;">Workers</a>
                        <div class="nav-dropdown-divider"></div>
                        <div class="nav-dropdown-section">Security</div>
                        <a href="#vault" class="nav-dropdown-item" data-panel="vault" style="text-decoration: none;"> Vault</a>
                        <div class="nav-dropdown-divider"></div>
                        <div class="nav-dropdown-section">Monitoring</div>
                        <a href="#tokens" class="nav-dropdown-item" data-panel="tokens" style="text-decoration: none;"> Token Tracking</a>
                        <div class="nav-dropdown-divider"></div>
                        <a href="#accounts" class="nav-dropdown-item" data-panel="accounts" style="text-decoration: none;">Settings</a>
                        <a href="#docs" class="nav-dropdown-item" data-panel="docs" style="text-decoration: none;">Documentation</a>
                        <a href="#sop" class="nav-dropdown-item" data-panel="sop" style="text-decoration: none;"> SOP Editor</a>
                    </div>
                </div>
            </nav>

            <!-- Global Search -->
            <div class="global-search" style="position: relative;">
                <span class="global-search-icon"></span>
                <input type="text" id="globalSearch" placeholder="Search..." onkeyup="handleGlobalSearch(event)">
                <span class="kbd">K</span>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        <div class="header-right">
            <!-- Saved Views Dropdown -->
            <div class="views-dropdown" id="viewsDropdown">
                <button class="views-btn" onclick="toggleViewsDropdown(event)">
                    <span>Views</span>
                </button>
                <div class="views-dropdown-menu" id="viewsDropdownMenu">
                    <div class="views-section-label">Saved Views</div>
                    <div id="savedViewsList">
                        <div class="views-empty">No saved views</div>
                    </div>
                    <div class="views-divider"></div>
                    <button class="views-action-btn primary" onclick="openSaveViewModal()">
                        <span>+</span> Save Current View
                    </button>
                </div>
            </div>

            <div id="socketStatus" class="socket-status offline" title="WebSocket: Connecting...">
                <span class="socket-dot"></span>
                <span class="socket-label">Live</span>
            </div>
            <div id="onlineUsersIndicator" class="online-users-indicator" onclick="toggleOnlineUsersPanel()" data-tooltip="Online Users" data-tooltip-pos="bottom">
                <span class="online-dot"></span>
                <span id="onlineUsersCount">1</span>
            </div>
            <button class="focus-toggle" id="focusToggle" onclick="toggleFocusMode()" data-tooltip="Focus Mode (Ctrl+Shift+F)" data-tooltip-pos="bottom">
                <span class="focus-icon"></span>
            </button>
            <button class="notification-bell" id="notificationBell" onclick="toggleNotificationPanel()" data-tooltip="Notifications" data-tooltip-pos="bottom" aria-label="Notifications" aria-haspopup="true">
                <span class="bell-icon"></span>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <a href="/dashboard/print" class="header-action-btn" data-tooltip="Print / Export" data-tooltip-pos="bottom" target="_blank" rel="noopener">Print</a>
            <span class="user-menu" data-tooltip="Logged in as {{ session.username }}" data-tooltip-pos="bottom">{{ session.username }}</span>
            <a href="/logout" class="logout-btn" data-tooltip="Sign out" data-tooltip-pos="bottom">Logout</a>
        </div>
    </header>

    <!-- Focus Mode Indicator -->
    <div class="focus-mode-indicator" id="focusModeIndicator">
        <span> Focus Mode</span>
        <button onclick="toggleFocusMode()">Exit</button>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-panel-header">
            <h3>Notifications</h3>
            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="clearNotifications()">Clear All</button>
        </div>
        <div class="notification-panel-body" id="notificationPanelBody">
            <div class="notification-panel-empty">No notifications</div>
        </div>
    </div>

    <!-- Online Users Panel -->
    <div class="online-users-panel" id="onlineUsersPanel">
        <div class="online-users-panel-header">
            <h3>Online Users</h3>
            <span id="onlineUsersTotalCount" style="font-size: 11px; color: var(--text-secondary);">0 online</span>
        </div>
        <div class="online-users-panel-body" id="onlineUsersPanelBody">
            <div class="online-users-empty">Loading...</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="modal-confirm">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmTitle">Confirm</h2>
                <button class="modal-close" onclick="hideModal('confirm'); confirmReject();" aria-label="Close dialog">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="margin: 0; font-size: 15px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('confirm'); confirmReject();">Cancel</button>
                <button class="btn btn-primary" id="confirmButton" onclick="hideModal('confirm'); confirmResolve();">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help Modal -->
    <div class="modal-overlay" id="modal-keyboardShortcuts">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title"> Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="hideModal('keyboardShortcuts')" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                <div style="border-right: 1px solid var(--border);">
                    <div class="shortcuts-section">
                        <h4 style="margin: 16px 16px 8px; color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600;">Quick Navigation (Number Keys)</h4>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>1</kbd></span><span>Queue (Autopilot)</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>2</kbd></span><span>Overview Dashboard</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>3</kbd></span><span>Projects</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>4</kbd></span><span>Features</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>5</kbd></span><span>Bugs</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>6</kbd></span><span>Errors</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>7</kbd></span><span>Sessions (tmux)</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>8</kbd></span><span>Nodes</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>9</kbd></span><span>Workers</span></div>
                    </div>
                    <div class="shortcuts-section">
                        <h4 style="margin: 16px 16px 8px; color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600;">"Go To" Sequences (G + Key)</h4>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>Q</kbd></span><span>Queue</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>O</kbd>/<kbd>D</kbd></span><span>Overview / Dashboard</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>P</kbd></span><span>Projects</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>F</kbd></span><span>Features</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>B</kbd></span><span>Bugs</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>E</kbd></span><span>Errors</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>S</kbd>/<kbd>T</kbd></span><span>Sessions / Tmux</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>N</kbd></span><span>Nodes</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>W</kbd></span><span>Workers</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>K</kbd></span><span>Tasks (Kanban)</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>V</kbd></span><span>Vault (Secrets)</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>C</kbd></span><span>Focus / Concentrate</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>G</kbd> <kbd>R</kbd></span><span>SOP / Rules</span></div>
                    </div>
                </div>
                <div>
                    <div class="shortcuts-section">
                        <h4 style="margin: 16px 16px 8px; color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600;">List Navigation (Vim-style)</h4>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>J</kbd> / <kbd></kbd></span><span>Move down in list</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>K</kbd> / <kbd></kbd></span><span>Move up in list</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>Enter</kbd> / <kbd>O</kbd></span><span>Open selected item</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>E</kbd></span><span>Edit selected item</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>X</kbd> / <kbd>Del</kbd></span><span>Delete selected item</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>Home</kbd></span><span>Go to first item</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>End</kbd> / <kbd>Shift</kbd>+<kbd>G</kbd></span><span>Go to last item</span></div>
                    </div>
                    <div class="shortcuts-section">
                        <h4 style="margin: 16px 16px 8px; color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600;">Actions</h4>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>N</kbd></span><span>New item (context-aware)</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>R</kbd></span><span>Refresh current panel</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>/</kbd></span><span>Focus search/filter</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>Esc</kbd></span><span>Close modal / Clear selection</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd></kbd>/<kbd>Ctrl</kbd>+<kbd>K</kbd></span><span>Global search</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd></kbd>/<kbd>Ctrl</kbd>+<kbd>S</kbd></span><span>Save current form</span></div>
                    </div>
                    <div class="shortcuts-section">
                        <h4 style="margin: 16px 16px 8px; color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600;">View & Interface</h4>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd></kbd>/<kbd>Ctrl</kbd>+<kbd></kbd>+<kbd>F</kbd></span><span>Toggle Focus Mode</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd></kbd>/<kbd>Ctrl</kbd>+<kbd></kbd>+<kbd>L</kbd></span><span>Toggle Dark/Light Theme</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>[</kbd> / <kbd>]</kbd></span><span>Toggle sidebar</span></div>
                        <div class="shortcut-row"><span class="shortcut-keys"><kbd>?</kbd></span><span>Show this help</span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; border-top: 1px solid var(--border); padding: 12px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Press <kbd style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid var(--border);">?</kbd> anytime to show this help</span>
            </div>
        </div>
    </div>

    <!-- Onboarding Tour Container -->
    <div class="tour-overlay" id="tourOverlay"></div>
    <div id="tourSpotlight" class="tour-spotlight" style="display: none;"></div>
    <div id="tourTooltip" class="tour-tooltip" style="display: none;"></div>

    <div class="main-container">
        <aside class="sidebar" id="mainSidebar">
            <button class="sidebar-collapse-btn" onclick="toggleSidebar()" data-tooltip="Collapse sidebar" data-tooltip-pos="right" aria-label="Toggle sidebar">
                <span id="sidebarCollapseIcon"></span>
            </button>

            <!-- Quick Access Section - Pinned Panels -->
            <div class="sidebar-quick-access" id="sidebarQuickAccess">
                <div class="quick-access-title">
                    <span></span> Quick Access
                </div>
                <div class="pinned-panels" id="pinnedPanels">
                    <!-- Pinned panels will be rendered here -->
                </div>
            </div>

            <!-- Projects Section -->
            <div class="sidebar-section" id="sidebarProjects">
                <div class="sidebar-section-header sidebar-title" onclick="toggleSidebarSection('sidebarProjects')">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px;"></span> Projects
                    </span>
                    <span class="sidebar-section-toggle"></span>
                </div>
                <div class="sidebar-section-content">
                    <div class="project-list" id="projectList">
                        <button class="project-item active" data-project="all">
                            <span>All Projects</span>
                        </button>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 12px" onclick="showModal('newProject')">+ New Project</button>
                </div>
            </div>

            <!-- Quick Stats Section -->
            <div class="sidebar-section" id="sidebarStats" style="background: var(--bg-tertiary); margin: 8px; border-radius: 8px; border: none;">
                <div class="sidebar-section-header sidebar-title" onclick="toggleSidebarSection('sidebarStats')">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px;"></span> Quick Stats
                    </span>
                    <span class="sidebar-section-toggle"></span>
                </div>
                <div class="sidebar-section-content">
                    <div class="stats-grid" id="quickStats" style="gap: 8px;">
                        <div class="stat-item clickable-stat" onclick="navigateToPanel('features')" title="Click to view features" role="button" tabindex="0">
                            <div class="stat-value" id="statFeatures">0</div>
                            <div class="stat-label">Features</div>
                        </div>
                        <div class="stat-item clickable-stat" onclick="navigateToPanel('bugs')" title="Click to view bugs" role="button" tabindex="0">
                            <div class="stat-value" id="statBugs">0</div>
                            <div class="stat-label">Bugs</div>
                        </div>
                        <div class="stat-item clickable-stat" onclick="navigateToPanel('errors')" title="Click to view errors" role="button" tabindex="0">
                            <div class="stat-value" id="statErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                        <div class="stat-item clickable-stat" onclick="navigateToPanel('nodes')" title="Click to view nodes" role="button" tabindex="0">
                            <div class="stat-value" id="statNodes">0</div>
                            <div class="stat-label">Nodes</div>
                        </div>
                    </div>
                    <!-- Gamification Section -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Progress</span>
                            <div class="streak-counter" data-tooltip="Daily activity streak" data-tooltip-pos="left">
                                <span class="streak-fire"></span>
                                <span id="streakCount">0</span>
                            </div>
                        </div>
                        <div class="xp-progress-container">
                            <span class="xp-level" id="userLevel">Lv.1</span>
                            <div class="xp-bar">
                                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                            </div>
                            <span class="xp-text" id="xpText">0 / 50 XP</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="sidebar-section" id="sidebarActivity" style="flex: 1; overflow-y: auto;">
                <div class="sidebar-section-header sidebar-title" onclick="toggleSidebarSection('sidebarActivity')">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px;"></span> Recent Activity
                    </span>
                    <span class="sidebar-section-toggle"></span>
                </div>
                <div class="sidebar-section-content">
                    <div class="activity-feed" id="activityFeed" data-limit="5"></div>
                </div>
            </div>
        </aside>

        <main class="content" id="main-content" role="main" tabindex="-1">
            <!-- Review Queue Panel - Primary Home with Sessions Sidebar -->
            <div class="panel active" id="panel-queue">
                <!-- Main Queue Area -->
                <div class="queue-main-area" style="flex: 1; padding: 24px; overflow-y: auto;">
                    <div class="panel-header" style="padding: 0; margin-bottom: 24px;">
                        <h1 class="panel-title">Autopilot Control Tower</h1>
                        <div class="panel-actions" style="display: flex; align-items: center; gap: 12px;">
                            <button class="btn btn-secondary" id="toggleQueueSessions" onclick="toggleQueueSessionsPane()" title="Toggle Sessions Panel" style="padding: 6px 12px;">
                                 Sessions
                            </button>
                            <button class="btn btn-secondary" onclick="syncFromAssigner()" title="Sync tasks from Session Assigner" style="padding: 6px 12px;">
                                 Sync Assigner
                            </button>
                            <label class="auto-refresh-toggle" title="Auto-refresh every 5s">
                                <input type="checkbox" id="queueAutoRefresh" onchange="toggleQueueAutoRefresh(this.checked)">
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 8px; font-size: 12px;">Auto</span>
                            </label>
                            <span id="queueLastRefresh" style="font-size: 12px; color: var(--text-secondary);">Updated just now</span>
                            <button class="btn btn-secondary" onclick="refreshQueue()">Refresh</button>
                        </div>
                    </div>

                <!-- Activity Status Bar -->
                <div id="activityStatusBar" class="activity-status-bar" style="background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="activityPulse" class="activity-pulse" style="width: 12px; height: 12px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite;"></span>
                            <span style="font-weight: 600; font-size: 14px;">System Activity</span>
                        </div>
                        <div id="activeThreadCount" style="font-size: 13px; color: var(--text-secondary);">
                            <span id="activeSessionCount" style="color: var(--accent); font-weight: 600;">0</span> active sessions
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div id="activitySessions" style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;"></div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 20px; font-size: 12px; color: var(--text-secondary);">
                        <span> <span id="statWorking">0</span> working</span>
                        <span> <span id="statWaiting">0</span> waiting</span>
                        <span> <span id="statCompleted">0</span> completed today</span>
                        <span> <span id="statErrors">0</span> errors</span>
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.5; transform: scale(1.1); }
                    }
                    .session-chip {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 4px 10px;
                        background: var(--bg-tertiary);
                        border-radius: 12px;
                        font-size: 12px;
                        border: 1px solid var(--border);
                    }
                    .session-chip.working {
                        background: rgba(88, 166, 255, 0.15);
                        border-color: var(--accent);
                    }
                    .session-chip.waiting {
                        background: rgba(255, 193, 7, 0.15);
                        border-color: var(--yellow);
                    }
                    .session-chip .status-dot {
                        width: 6px;
                        height: 6px;
                        border-radius: 50%;
                    }
                    .session-chip.working .status-dot {
                        background: var(--accent);
                        animation: pulse 1.5s infinite;
                    }
                    .session-chip.waiting .status-dot {
                        background: var(--yellow);
                    }
                </style>

                <!-- Live Task Monitor -->
                <div id="liveTaskMonitor" class="live-task-monitor" style="background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 16px;"></span>
                            <span style="font-weight: 600; font-size: 14px;">Live Task Monitor</span>
                            <span id="liveMonitorStatus" class="status-dot" style="width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite;"></span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="liveMonitorLastUpdate" style="font-size: 11px; color: var(--text-secondary);">Updating...</span>
                            <label class="auto-refresh-toggle" title="Auto-refresh every 10s">
                                <input type="checkbox" id="liveMonitorAutoRefresh" checked onchange="toggleLiveMonitorAutoRefresh(this.checked)">
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 8px; font-size: 12px;">Auto</span>
                            </label>
                            <button class="btn btn-sm btn-secondary" onclick="refreshLiveTaskMonitor()" style="font-size: 11px; padding: 4px 8px;">Refresh</button>
                        </div>
                    </div>
                    <div id="liveTaskGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <!-- Task cards will be rendered here -->
                        <div style="text-align: center; color: var(--text-secondary); font-size: 12px; grid-column: span 2;">Loading tasks...</div>
                    </div>
                </div>

                <style>
                    .task-monitor-card {
                        background: var(--bg-tertiary);
                        border-radius: 8px;
                        padding: 14px;
                        border: 1px solid var(--border);
                        transition: all 0.3s ease;
                    }
                    .task-monitor-card:hover {
                        border-color: var(--accent);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(88, 166, 255, 0.1);
                    }
                    .task-monitor-card.working {
                        border-left: 3px solid var(--green);
                        background: rgba(76, 175, 80, 0.05);
                    }
                    .task-monitor-card.idle {
                        border-left: 3px solid var(--accent);
                        background: rgba(88, 166, 255, 0.05);
                    }
                    .task-monitor-card.error {
                        border-left: 3px solid var(--red);
                        background: rgba(244, 67, 54, 0.05);
                    }
                    .task-monitor-card.completed {
                        border-left: 3px solid var(--text-secondary);
                        background: rgba(128, 128, 128, 0.05);
                        opacity: 0.7;
                    }
                    .task-progress-bar {
                        width: 100%;
                        height: 6px;
                        background: var(--bg);
                        border-radius: 3px;
                        overflow: hidden;
                        margin: 8px 0;
                    }
                    .task-progress-fill {
                        height: 100%;
                        background: linear-gradient(90deg, var(--accent) 0%, var(--cyan) 100%);
                        transition: width 0.5s ease;
                        border-radius: 3px;
                    }
                    .task-progress-fill.completed {
                        background: var(--green);
                    }
                    .task-progress-fill.error {
                        background: var(--red);
                    }
                </style>

                <!-- Environment Checkout Status -->
                <div id="envCheckoutBar" class="env-checkout-bar" style="background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;"></span>
                            <span style="font-weight: 600; font-size: 14px;">Environment Checkout</span>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="refreshEnvCheckout()" style="font-size: 11px; padding: 4px 8px;">Refresh</button>
                    </div>
                    <div id="envCheckoutGrid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                        <!-- Environment cards will be rendered here -->
                        <div style="text-align: center; color: var(--text-secondary); font-size: 12px; grid-column: span 5;">Loading...</div>
                    </div>
                    <style>
                        .env-card {
                            background: var(--bg-tertiary);
                            border-radius: 8px;
                            padding: 12px;
                            border: 1px solid var(--border);
                            font-size: 11px;
                        }
                        .env-card.busy {
                            border-color: var(--accent);
                            background: rgba(88, 166, 255, 0.1);
                        }
                        .env-card.idle {
                            border-color: var(--green);
                            background: rgba(46, 160, 67, 0.1);
                        }
                        .env-card.conflict {
                            border-color: var(--red);
                            background: rgba(248, 81, 73, 0.15);
                            animation: conflict-pulse 1s infinite;
                        }
                        @keyframes conflict-pulse {
                            0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
                            50% { box-shadow: 0 0 0 4px rgba(248, 81, 73, 0); }
                        }
                        .env-card .env-name {
                            font-weight: 600;
                            font-size: 13px;
                            margin-bottom: 4px;
                        }
                        .env-card .env-branch {
                            color: var(--purple);
                            font-size: 10px;
                            margin-bottom: 6px;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                        .env-card .env-session {
                            color: var(--accent);
                            font-weight: 500;
                        }
                        .env-card .env-task {
                            color: var(--text-secondary);
                            font-size: 10px;
                            margin-top: 4px;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                    </style>
                </div>

                <!-- Orchestrator Task Progress from Google Sheets -->
                <div id="orchestratorProgress" class="orchestrator-progress" style="background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;"></span>
                            <span style="font-weight: 600; font-size: 14px;">Orchestrator Tasks (Google Sheets)</span>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="refreshOrchestratorTasks()" style="font-size: 11px; padding: 4px 8px;">Refresh</button>
                    </div>
                    <!-- Progress Bar -->
                    <div id="orchestratorProgressBar" style="background: var(--bg-tertiary); border-radius: 4px; height: 24px; overflow: hidden; margin-bottom: 12px; display: flex;">
                        <div id="orchestratorCompletedBar" style="background: var(--green); height: 100%; transition: width 0.3s;" title="Completed"></div>
                        <div id="orchestratorImplementingBar" style="background: var(--accent); height: 100%; transition: width 0.3s;" title="Implementing"></div>
                        <div id="orchestratorPendingBar" style="background: var(--yellow); height: 100%; transition: width 0.3s;" title="Pending"></div>
                    </div>
                    <!-- Summary Stats -->
                    <div id="orchestratorStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                        <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: 700; color: var(--yellow);" id="orchestratorPending">0</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Pending</div>
                        </div>
                        <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent);" id="orchestratorImplementing">0</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Implementing</div>
                        </div>
                        <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: 700; color: var(--green);" id="orchestratorCompleted">0</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Completed</div>
                        </div>
                        <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="orchestratorTotal">0</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total</div>
                        </div>
                    </div>
                    <!-- Recent Tasks List (collapsible) -->
                    <div style="margin-top: 12px;">
                        <div onclick="toggleOrchestratorTasksList()" style="cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);">
                            <span id="orchestratorTasksToggle"></span>
                            <span>Recent Tasks</span>
                        </div>
                        <div id="orchestratorTasksList" style="display: none; margin-top: 8px; max-height: 200px; overflow-y: auto;">
                            <div style="font-size: 12px; color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Queue Summary Cards -->
                <div id="queueSummary" class="queue-summary" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="queue-card" onclick="filterQueue('in_progress')" style="background: var(--bg-card); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; border-left: 3px solid var(--accent);">
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent);" id="queueInProgressCount">0</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">In Progress</div>
                    </div>
                    <div class="queue-card" onclick="filterQueue('run')" style="background: var(--bg-card); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--green);" id="queueApprovalCount">0</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Ready to Start</div>
                    </div>
                    <div class="queue-card" onclick="filterQueue('incident')" style="background: var(--bg-card); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--red);" id="queueIncidentCount">0</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Incidents</div>
                    </div>
                    <div class="queue-card" onclick="filterQueue('blocked')" style="background: var(--bg-card); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--yellow);" id="queueBlockedCount">0</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Blocked</div>
                    </div>
                    <div class="queue-card" onclick="filterQueue('milestone')" style="background: var(--bg-card); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--purple);" id="queueInputCount">0</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Milestones</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="queue-filters" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <button class="queue-filter active" data-filter="all" onclick="filterQueue('all')">All</button>
                    <button class="queue-filter" data-filter="in_progress" onclick="filterQueue('in_progress')">In Progress</button>
                    <button class="queue-filter" data-filter="session" onclick="filterQueue('session')">Sessions</button>
                    <button class="queue-filter" data-filter="event" onclick="filterQueue('event')">Events</button>
                    <button class="queue-filter" data-filter="incident" onclick="filterQueue('incident')">Incidents</button>
                    <span style="border-left: 1px solid var(--border); height: 20px; margin: 0 4px;"></span>
                    <!-- App Filter -->
                    <select id="queueAppFilter" onchange="applyQueueFilters()" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; cursor: pointer;">
                        <option value="all">All Apps</option>
                        <option value="edu_apps">Edu Apps</option>
                        <option value="kanbanflow">KanbanFlow</option>
                        <option value="architect">Architect</option>
                    </select>
                    <!-- Type Filter -->
                    <select id="queueTypeFilter" onchange="applyQueueFilters()" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; cursor: pointer;">
                        <option value="all">All Types</option>
                        <option value="worker">Workers</option>
                        <option value="server">Servers</option>
                        <option value="session_task">Session Tasks</option>
                        <option value="restart">Restarts</option>
                        <option value="error_fix">Error Fixes</option>
                    </select>
                    <span style="flex: 1;"></span>
                    <!-- Sort Controls -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Sort:</span>
                        <select id="queueSortBy" onchange="sortQueueItems()" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; cursor: pointer;">
                            <option value="priority">Priority</option>
                            <option value="status">Status</option>
                            <option value="date">Date</option>
                            <option value="project">Project</option>
                            <option value="type">Type</option>
                        </select>
                        <button id="queueSortDir" onclick="toggleQueueSortDir()" style="padding: 6px 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px;" title="Toggle sort direction"></button>
                    </div>
                </div>

                <!-- Batch Operations Bar (hidden by default) -->
                <div id="queueBatchBar" class="queue-batch-bar" style="display: none; background: var(--bg-tertiary); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; align-items: center; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="queueSelectAll" onchange="toggleQueueSelectAll(this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-size: 13px; font-weight: 500;"><span id="queueSelectedCount">0</span> selected</span>
                    </label>
                    <span style="width: 1px; height: 20px; background: var(--border);"></span>
                    <button class="btn btn-sm btn-success" onclick="batchApproveQueue()" title="Approve selected milestones/runs">Approve</button>
                    <button class="btn btn-sm btn-primary" onclick="batchStartQueue()" title="Start selected runs">Start</button>
                    <button class="btn btn-sm btn-secondary" onclick="showBatchAssignModal()" title="Assign to tmux session">Assign</button>
                    <button class="btn btn-sm btn-warning" onclick="batchDismissQueue()" title="Dismiss selected items">Dismiss</button>
                    <span style="flex: 1;"></span>
                    <button class="btn btn-sm" onclick="clearQueueSelection()" style="background: transparent; border: 1px solid var(--border);">Clear</button>
                </div>

                <!-- Queue Items List -->
                <div id="queueItems" class="queue-items" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 12px; opacity: 0.7;"></div>
                        <div style="font-size: 18px; margin-bottom: 8px;">All caught up!</div>
                        <div style="font-size: 14px;">No items need your attention right now.</div>
                    </div>
                </div>
                </div><!-- End queue-main-area -->

                <!-- Quick Sessions Sidebar -->
                <div class="queue-sessions-pane" id="queueSessionsPane" style="width: 380px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: none; flex-direction: column; overflow: hidden;">
                    <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">Session & Worker Status</span>
                        <button onclick="toggleQueueSessionsPane()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px;" aria-label="Close sessions panel"></button>
                    </div>

                    <div style="flex: 1; overflow-y: auto;">
                        <!-- Workers Status Section -->
                        <div class="sidebar-section" style="border-bottom: 1px solid var(--border);">
                            <div onclick="toggleSidebarSection('workersStatusSection')" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary);">
                                <span style="font-weight: 600; font-size: 13px;"> System Workers</span>
                                <span class="sidebar-section-toggle"></span>
                            </div>
                            <div id="workersStatusSection" class="sidebar-section-content" style="padding: 12px;">
                                <div id="workersStatusList" style="font-size: 12px;">
                                    <div style="color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Claude Wrapper Section -->
                        <div class="sidebar-section" style="border-bottom: 1px solid var(--border);">
                            <div onclick="toggleSidebarSection('wrapperStatusSection')" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary);">
                                <span style="font-weight: 600; font-size: 13px;"> Claude Wrapper</span>
                                <span class="sidebar-section-toggle"></span>
                            </div>
                            <div id="wrapperStatusSection" class="sidebar-section-content" style="padding: 12px;">
                                <div id="wrapperSummary" style="margin-bottom: 12px; padding: 10px; background: var(--bg-card); border-radius: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Wrapped Sessions:</span>
                                        <strong id="wrapperSessionCount">0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Prompts Auto-Approved:</span>
                                        <strong id="wrapperPromptsApproved">0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Prompts Blocked:</span>
                                        <strong id="wrapperPromptsBlocked" style="color: var(--error);">0</strong>
                                    </div>
                                </div>
                                <div id="wrapperSessionsList" style="max-height: 150px; overflow-y: auto; font-size: 12px; margin-bottom: 10px;">
                                    <div style="color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                                </div>
                                <button class="btn btn-primary" style="width: 100%; font-size: 12px; padding: 8px;" onclick="showStartWrapperModal()">
                                    + Start Wrapped Session
                                </button>
                            </div>
                        </div>

                        <!-- Go Wrapper Section -->
                        <div class="sidebar-section" style="border-bottom: 1px solid var(--border);">
                            <div onclick="toggleSidebarSection('goWrapperSection')" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary);">
                                <span style="font-weight: 600; font-size: 13px;"> Go Wrapper</span>
                                <span class="sidebar-section-toggle"></span>
                            </div>
                            <div id="goWrapperSection" class="sidebar-section-content" style="padding: 12px;">
                                <div id="goWrapperSummary" style="margin-bottom: 12px; padding: 10px; background: var(--bg-card); border-radius: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Status:</span>
                                        <strong id="goWrapperStatus" style="color: var(--success);"></strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Running Agents:</span>
                                        <strong id="goWrapperAgentCount">0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Uptime:</span>
                                        <strong id="goWrapperUptime">-</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Events/sec:</span>
                                        <strong id="goWrapperRate">0.00</strong>
                                    </div>
                                </div>
                                <div id="goWrapperAgentsList" style="max-height: 200px; overflow-y: auto; font-size: 12px; margin-bottom: 10px;">
                                    <div style="color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary" style="flex: 1; font-size: 11px; padding: 6px;" onclick="window.open('http://100.112.58.92:8151/', '_blank')">
                                         Dashboard
                                    </button>
                                    <button class="btn btn-secondary" style="flex: 1; font-size: 11px; padding: 6px;" onclick="refreshGoWrapper()">
                                         Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Assigner Activity Section -->
                        <div class="sidebar-section" style="border-bottom: 1px solid var(--border);">
                            <div onclick="toggleSidebarSection('assignerActivitySection')" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary);">
                                <span style="font-weight: 600; font-size: 13px;"> Assigner Activity</span>
                                <span class="sidebar-section-toggle"></span>
                            </div>
                            <div id="assignerActivitySection" class="sidebar-section-content" style="padding: 12px;">
                                <div id="assignerSummary" style="margin-bottom: 12px; padding: 10px; background: var(--bg-card); border-radius: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>Total Assigned:</span>
                                        <strong id="assignerTotalSessions">0</strong>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="badge" style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;" id="assignerEduApps">edu_apps: 0</span>
                                        <span class="badge" style="background: var(--success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;" id="assignerArchitect">architect: 0</span>
                                        <span class="badge" style="background: var(--warning); color: black; padding: 2px 8px; border-radius: 10px; font-size: 11px;" id="assignerKanban">kanbanflow: 0</span>
                                    </div>
                                </div>
                                <div id="assignerHistoryList" style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                                    <div style="color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Sessions Section -->
                        <div class="sidebar-section">
                            <div onclick="toggleSidebarSection('activeSessionsSection')" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary);">
                                <span style="font-weight: 600; font-size: 13px;"> Active Sessions</span>
                                <span class="sidebar-section-toggle"></span>
                            </div>
                            <div id="activeSessionsSection" class="sidebar-section-content" style="padding: 12px;">
                                <div id="queueSessionsList" style="font-size: 12px;">
                                    <div style="color: var(--text-secondary); text-align: center; padding: 10px;">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 12px; border-top: 1px solid var(--border);">
                        <button class="btn btn-primary" style="width: 100%;" onclick="navigateToPanel('tmux')">Full Sessions </button>
                    </div>
                </div>
            </div>

            <!-- Apps Panel - Autopilot Control -->
            <div class="panel" id="panel-apps">
                <div class="panel-header">
                    <h1 class="panel-title">Managed Apps</h1>
                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="showAddAppModal()">+ Add App</button>
                    </div>
                </div>

                <!-- Apps Grid -->
                <div id="appsGrid" class="apps-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                    <!-- Apps will be rendered here -->
                </div>
            </div>

            <!-- Overview Panel -->
            <div class="panel" id="panel-overview">
                <!-- Alert Banner - Shows when issues exist -->
                <div id="alertBanner" class="alert-banner" style="display: none;">
                    <div class="alert-banner-content">
                        <span class="alert-banner-icon"></span>
                        <span id="alertBannerText">2 open errors  1 env offline</span>
                    </div>
                    <div class="alert-banner-actions">
                        <button class="btn btn-sm" onclick="navigateToPanel('errors')">View Errors</button>
                        <button class="btn btn-sm" id="alertBannerEnvAction" style="display: none;" onclick="restartOfflineEnv()">Restart Env</button>
                        <button class="btn-close-banner" onclick="dismissAlertBanner()"></button>
                    </div>
                </div>

                <div class="panel-header">
                    <h1 class="panel-title">Dashboard Overview</h1>
                    <div class="panel-actions" style="display: flex; align-items: center; gap: 12px;">
                        <span id="lastRefreshTime" style="font-size: 12px; color: var(--text-secondary);">Updated just now</span>
                        <div class="refresh-controls" style="display: flex; align-items: center; gap: 8px;">
                            <select id="refreshIntervalSelect" onchange="setRefreshInterval(parseInt(this.value))"
                                    style="background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;"
                                    title="Auto-refresh interval">
                                <option value="5000">5s</option>
                                <option value="10000">10s</option>
                                <option value="15000">15s</option>
                                <option value="30000" selected>30s</option>
                                <option value="60000">1m</option>
                                <option value="120000">2m</option>
                                <option value="300000">5m</option>
                            </select>
                            <label class="auto-refresh-toggle" title="Toggle auto-refresh">
                                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh(this.checked)">
                                <span class="toggle-slider"></span>
                                <span style="font-size: 12px; margin-left: 4px;">Auto</span>
                            </label>
                            <span id="refreshCountdown" style="font-size: 11px; color: var(--text-secondary); min-width: 35px;"></span>
                        </div>
                        <button class="btn btn-secondary" onclick="scanSources()">Scan Sources</button>
                        <button class="btn btn-primary btn-refresh" id="refreshBtn" onclick="refreshAll()" title="Refresh now (Ctrl+R)">
                            <span class="btn-icon" style="display: inline-block;"></span> Refresh
                        </button>
                    </div>
                </div>

                <!-- Main Stats Row -->
                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="overviewProjectCount">0</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="overviewFeatures">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="overviewBugs">0</div>
                        <div class="stat-label">Open Bugs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="overviewErrors">0</div>
                        <div class="stat-label">Open Errors</div>
                    </div>
                </div>

                <!-- System Health & Quick Actions Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- System Health Widget -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Health</div>
                            <span class="badge badge-online" id="overviewSystemStatus">Healthy</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div style="text-align: center;">
                                    <div id="overviewNodesOnline" style="font-size: 24px; font-weight: 600; color: var(--success);">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Nodes Online</div>
                                </div>
                                <div style="text-align: center;">
                                    <div id="overviewAccountsActive" style="font-size: 24px; font-weight: 600; color: var(--accent);">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Active Accounts</div>
                                </div>
                                <div style="text-align: center;">
                                    <div id="overviewTmuxActive" style="font-size: 24px; font-weight: 600; color: var(--purple);">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">tmux Sessions</div>
                                </div>
                                <div style="text-align: center;">
                                    <div id="overviewWorkersActive" style="font-size: 24px; font-weight: 600; color: var(--warning);">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Active Workers</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                <div id="overviewAccountsList" style="margin-bottom: 12px;"></div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px;">
                                    <span>Cluster Uptime</span>
                                    <span id="overviewUptime" style="color: var(--text-secondary);">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                    <span>Last Refresh</span>
                                    <span id="overviewLastRefresh" style="color: var(--text-secondary);">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Widget -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="showModal('newFeature')" style="padding: 10px 16px; flex: 1; min-width: 120px;">
                                    + Feature
                                </button>
                                <button class="btn btn-primary" onclick="showModal('newBug')" style="padding: 10px 16px; flex: 1; min-width: 120px;">
                                    + Bug
                                </button>
                                <button class="btn btn-primary" onclick="showModal('newTmuxSession')" style="padding: 10px 16px; flex: 1; min-width: 120px;">
                                    + Session
                                </button>
                                <div class="quick-actions-dropdown">
                                    <button class="btn btn-secondary" style="padding: 10px 16px;">
                                        More 
                                    </button>
                                    <div class="quick-actions-menu">
                                        <button onclick="showModal('newProject')">+ New Project</button>
                                        <button onclick="navigateToPanel('errors')">View Errors</button>
                                        <button onclick="navigateToPanel('tmux')">View Sessions</button>
                                        <button onclick="scanSources()">Scan Sources</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Environments Status Row -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Environments</div>
                        <button class="btn btn-secondary" onclick="loadEnvironmentsStatus()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="environmentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;"></div>
                    </div>
                </div>

                <!-- Running Services -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Running Services</div>
                        <button class="btn btn-secondary" onclick="loadRunningServices()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="runningServicesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">
                            <p style="color: var(--text-secondary);">Loading services...</p>
                        </div>
                    </div>
                </div>

                <!-- Critical Items & Active Work Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <!-- Critical Items -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Critical Items</div>
                            <span class="badge badge-critical" id="criticalCount">0</span>
                        </div>
                        <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                            <div id="criticalItemsList">
                                <p style="color: var(--text-secondary); text-align: center;">No critical items</p>
                            </div>
                        </div>
                    </div>

                    <!-- Active Work Summary -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Active Work</div>
                        </div>
                        <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                            <div id="activeWorkList">
                                <p style="color: var(--text-secondary); text-align: center;">No active work</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- tmux Sessions Overview -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">tmux Sessions</div>
                        <button class="btn btn-secondary" onclick="navigateToPanel('tmux')">View All</button>
                    </div>
                    <div class="card-body">
                        <div id="tmuxOverviewGrid" style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <p style="color: var(--text-secondary);">Loading sessions...</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity (Full Width) -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">Recent Activity</div>
                    </div>
                    <div class="card-body">
                        <div id="overviewActivityFeed" class="activity-feed" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: var(--text-secondary); text-align: center;">No recent activity</p>
                        </div>
                    </div>
                </div>

                <!-- Projects Grid -->
                <h2 style="margin-bottom: 16px; font-size: 18px;">Projects</h2>
                <div class="cards-grid" id="overviewProjects"></div>
            </div>

            <!-- AI Assistant Panel -->
            <div class="panel" id="panel-ai-assistant">
                <div class="panel-header">
                    <h1 class="panel-title"> AI Task Assistant</h1>
                    <div class="panel-actions">
                        <span style="font-size: 12px; color: var(--text-secondary);">Break down high-level instructions into actionable tasks</span>
                    </div>
                </div>

                <div style="max-width: 900px; margin: 0 auto;">
                    <!-- Input Section -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label for="ai-instruction" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                            What would you like to accomplish?
                        </label>
                        <textarea
                            id="ai-instruction"
                            placeholder="Example: Fix the login bug and add comprehensive tests&#10;Example: Refactor the database layer to use async/await&#10;Example: Add a dark mode toggle to the settings page"
                            style="width: 100%; min-height: 120px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical;"
                        ></textarea>
                    </div>

                    <!-- Options Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 24px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="ai-target-provider" style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Target Provider</label>
                            <select id="ai-target-provider" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                                <option value="auto">Auto (Any Available)</option>
                                <option value="claude">Claude</option>
                                <option value="codex">Codex</option>
                                <option value="comet">Comet</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label for="ai-priority" style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Priority</label>
                            <select id="ai-priority" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                                <option value="1">1 - Low</option>
                                <option value="3">3 - Normal</option>
                                <option value="5" selected>5 - Medium</option>
                                <option value="7">7 - High</option>
                                <option value="10">10 - Urgent</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary);">Auto Execute</label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="ai-auto-execute" checked style="cursor: pointer;">
                                <span style="font-size: 14px; color: var(--text-primary);">Queue tasks</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: transparent;">Action</label>
                            <button id="ai-breakdown-btn" onclick="breakdownInstruction()" class="btn btn-primary" style="padding: 8px 24px; height: 38px;">
                                 Break Down
                            </button>
                        </div>
                    </div>

                    <!-- Quick Examples -->
                    <div style="margin-bottom: 24px;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Quick Examples:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="setAIInstruction('Fix all failing tests and improve coverage to 80%')" class="btn btn-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 6px 12px; font-size: 12px;">Fix failing tests</button>
                            <button onclick="setAIInstruction('Optimize database queries and add caching')" class="btn btn-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 6px 12px; font-size: 12px;">Optimize performance</button>
                            <button onclick="setAIInstruction('Add comprehensive documentation for the API')" class="btn btn-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 6px 12px; font-size: 12px;">Add documentation</button>
                            <button onclick="setAIInstruction('Refactor authentication system to use JWT')" class="btn btn-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 6px 12px; font-size: 12px;">Refactor auth</button>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="ai-results" style="display: none;">
                        <div style="border-top: 1px solid var(--border); padding-top: 24px; margin-top: 24px;">
                            <!-- Status -->
                            <div id="ai-status" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--cyan); color: black; border-radius: 8px; margin-bottom: 16px;">
                                <div class="spinner" style="border: 2px solid rgba(0,0,0,0.1); border-top-color: black; width: 16px; height: 16px;"></div>
                                <span style="font-weight: 600;">Analyzing instruction...</span>
                            </div>

                            <!-- Breakdown Display -->
                            <div id="ai-breakdown" style="display: none;">
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Task Breakdown</div>
                                    <div id="ai-instruction-display" style="padding: 12px; background: var(--bg-tertiary); border-left: 3px solid var(--cyan); border-radius: 4px; color: var(--text-secondary); font-style: italic;"></div>
                                </div>

                                <div id="ai-tasks-list" style="display: grid; gap: 12px;"></div>

                                <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="color: var(--text-secondary); font-size: 12px;">Estimated Total Time:</span>
                                        <span id="ai-total-time" style="margin-left: 8px; font-weight: 600; color: var(--cyan);"></span>
                                    </div>
                                    <div id="ai-queued-info" style="display: none;">
                                        <span style="color: var(--text-secondary); font-size: 12px;">Tasks Queued:</span>
                                        <span id="ai-queued-count" style="margin-left: 8px; font-weight: 600; color: var(--green);"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Error Display -->
                            <div id="ai-error" style="display: none; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red); border-radius: 8px; color: var(--red);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Panel -->
            <div class="panel" id="panel-projects">
                <div class="panel-header">
                    <h1 class="panel-title">Projects</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="scanSources()">Scan Sources</button>
                        <button class="btn btn-primary" onclick="showModal('newProject')">+ New Project</button>
                    </div>
                </div>

                <div class="filters" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <select class="filter-select" id="projectStatusFilter" onchange="loadProjectsList()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="planning">Planning</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                        <option value="archived">Archived</option>
                    </select>
                    <input type="text" class="search-input" placeholder="Search projects..." id="projectSearch" onkeyup="loadProjectsList()">
                    <div class="btn-group" style="margin-left: auto;">
                        <button class="btn btn-secondary" id="viewCompact" onclick="setProjectView('compact')" title="Compact view" style="padding: 6px 10px;"></button>
                        <button class="btn btn-secondary" id="viewExpanded" onclick="setProjectView('expanded')" title="Expanded view" style="padding: 6px 10px;"></button>
                    </div>
                </div>

                <div id="projectsListContainer"></div>
            </div>

            <!-- Features Panel -->
            <div class="panel" id="panel-features">
                <div class="panel-header">
                    <h1 class="panel-title">Features</h1>
                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="showModal('newFeature')">+ New Feature</button>
                    </div>
                </div>

                <div class="filters">
                    <select class="filter-select" id="featureStatusFilter" onchange="loadFeatures()">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="in_progress">In Progress</option>
                        <option value="review">Review</option>
                        <option value="completed">Completed</option>
                    </select>
                    <input type="text" class="search-input" placeholder="Search features..." id="featureSearch" onkeyup="loadFeatures()">
                </div>

                <div class="cards-grid" id="featuresGrid"></div>
            </div>

            <!-- Bugs Panel -->
            <div class="panel" id="panel-bugs">
                <div class="panel-header">
                    <h1 class="panel-title">Bugs</h1>
                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="showModal('newBug')">+ New Bug</button>
                    </div>
                </div>

                <div class="filters">
                    <input type="text" class="search-input" placeholder="Search bugs..." id="bugSearch" onkeyup="filterBugsTable()">
                    <select class="filter-select" id="bugStatusFilter" onchange="loadBugs()">
                        <option value="">All Status</option>
                        <option value="open">Open</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <select class="filter-select" id="bugSeverityFilter" onchange="loadBugs()">
                        <option value="">All Severity</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>

                <div class="cards-grid" id="bugsGrid"></div>
            </div>

            <!-- Errors Panel -->
            <div class="panel" id="panel-errors">
                <div class="panel-header">
                    <h1 class="panel-title">Error Aggregation</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadErrors()">Refresh</button>
                    </div>
                </div>

                <div class="filters">
                    <input type="text" class="search-input" placeholder="Search errors..." id="errorSearch" onkeyup="filterErrorsTable()">
                    <select class="filter-select" id="errorStatusFilter" onchange="loadErrors()">
                        <option value="open">Open</option>
                        <option value="resolved">Resolved</option>
                        <option value="">All</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Source</th>
                                <th>Node</th>
                                <th>Count</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTable"></tbody>
                    </table>
                    <div class="pagination" id="errorsPagination">
                        <div class="pagination-info">
                            Showing <span id="errorsShowing">0</span> of <span id="errorsTotal">0</span> errors
                        </div>
                        <div class="pagination-controls">
                            <select id="errorsPageSize" onchange="changePageSize('errors')">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                            <button onclick="prevPage('errors')" id="errorsPrev" disabled>&laquo; Prev</button>
                            <span id="errorsPageInfo">Page 1</span>
                            <button onclick="nextPage('errors')" id="errorsNext">Next &raquo;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Panel -->
            <div class="panel" id="panel-testing">
                <div class="panel-header">
                    <h1 class="panel-title">Test Suite</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadTestRuns()">Refresh</button>
                        <button class="btn btn-primary" onclick="runSelectedTests()">Run Selected</button>
                        <button class="btn btn-primary" onclick="runAllTests()">Run All Tests</button>
                    </div>
                </div>

                <!-- Test Category Cards -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
                    <!-- UI Tests -->
                    <div class="card test-category-card" id="testCat-ui" onclick="toggleTestCategory('ui')" style="cursor: pointer; padding: 16px; text-align: center; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="testCheck-ui" class="test-category-check" value="ui" checked style="display: none;">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">UI Tests</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Frontend components</div>
                        <div style="margin-top: 8px;">
                            <span class="badge badge-open" id="testCoverage-ui">0%</span>
                        </div>
                    </div>

                    <!-- API Tests -->
                    <div class="card test-category-card" id="testCat-api" onclick="toggleTestCategory('api')" style="cursor: pointer; padding: 16px; text-align: center; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="testCheck-api" class="test-category-check" value="api" checked style="display: none;">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">API Tests</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Endpoint validation</div>
                        <div style="margin-top: 8px;">
                            <span class="badge badge-open" id="testCoverage-api">0%</span>
                        </div>
                    </div>

                    <!-- DB Tests -->
                    <div class="card test-category-card" id="testCat-db" onclick="toggleTestCategory('db')" style="cursor: pointer; padding: 16px; text-align: center; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="testCheck-db" class="test-category-check" value="db" checked style="display: none;">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">DB Tests</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Database integrity</div>
                        <div style="margin-top: 8px;">
                            <span class="badge badge-open" id="testCoverage-db">0%</span>
                        </div>
                    </div>

                    <!-- Auth Tests -->
                    <div class="card test-category-card" id="testCat-auth" onclick="toggleTestCategory('auth')" style="cursor: pointer; padding: 16px; text-align: center; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="testCheck-auth" class="test-category-check" value="auth" checked style="display: none;">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Auth Tests</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Authentication/Authorization</div>
                        <div style="margin-top: 8px;">
                            <span class="badge badge-open" id="testCoverage-auth">0%</span>
                        </div>
                    </div>

                    <!-- A11y Tests -->
                    <div class="card test-category-card" id="testCat-a11y" onclick="toggleTestCategory('a11y')" style="cursor: pointer; padding: 16px; text-align: center; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" id="testCheck-a11y" class="test-category-check" value="a11y" checked style="display: none;">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">A11y Tests</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Accessibility compliance</div>
                        <div style="margin-top: 8px;">
                            <span class="badge badge-open" id="testCoverage-a11y">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Overall Stats -->
                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(6, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="testTotalRuns">0</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="testPassRate" style="color: var(--success);">0%</div>
                        <div class="stat-label">Pass Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="testTotalPassed" style="color: var(--success);">0</div>
                        <div class="stat-label">Passed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="testTotalFailed" style="color: var(--danger);">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="testLastRun">-</div>
                        <div class="stat-label">Last Run</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="testAvgDuration">-</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                </div>

                <!-- Live Test Progress (shown during test run) -->
                <div id="testProgressContainer" style="display: none; margin-bottom: 24px;">
                    <div class="card" style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;">Running Tests...</h3>
                            <span id="testProgressStatus" class="badge badge-warning">In Progress</span>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                            <div id="testProgressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-secondary);">
                            <span id="testProgressCount">0 / 0 tests</span>
                            <span id="testProgressTime">0s elapsed</span>
                        </div>
                    </div>
                </div>

                <!-- Test Results Summary (shown after run) -->
                <div id="testResultsSummary" style="display: none; margin-bottom: 24px;">
                    <div class="card" style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Test Results</h3>
                            <div>
                                <span id="testResultStatus" class="badge">-</span>
                                <span id="testResultDuration" style="margin-left: 8px; color: var(--text-secondary); font-size: 13px;">-</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="testResultPassed">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Passed</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="testResultFailed">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Failed</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="testResultSkipped">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Skipped</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--text-secondary);" id="testResultTotal">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="testResultCoverage">0%</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Coverage</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filters" style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                    <select class="filter-select" id="testCategoryFilter" onchange="filterTestRuns()">
                        <option value="all">All Categories</option>
                        <option value="ui">UI Tests</option>
                        <option value="api">API Tests</option>
                        <option value="db">DB Tests</option>
                        <option value="auth">Auth Tests</option>
                        <option value="a11y">A11y Tests</option>
                    </select>
                    <select class="filter-select" id="testStatusFilter" onchange="filterTestRuns()">
                        <option value="all">All Status</option>
                        <option value="passed">Passed</option>
                        <option value="failed">Failed</option>
                        <option value="running">Running</option>
                    </select>
                </div>

                <h3 style="margin-bottom: 12px;">Test Run History</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Run ID</th>
                                <th>Category</th>
                                <th>Environment</th>
                                <th>Status</th>
                                <th>Passed</th>
                                <th>Failed</th>
                                <th>Coverage</th>
                                <th>Duration</th>
                                <th>Started</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testRunsTable"></tbody>
                    </table>
                    <div class="pagination" id="testRunsPagination">
                        <div class="pagination-info">
                            Showing <span id="testRunsShowing">0</span> of <span id="testRunsTotal">0</span> test runs
                        </div>
                        <div class="pagination-controls">
                            <select id="testRunsPageSize" onchange="changePageSize('testRuns')">
                                <option value="10" selected>10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                            </select>
                            <button onclick="prevPage('testRuns')" id="testRunsPrev" disabled>&laquo; Prev</button>
                            <span id="testRunsPageInfo">Page 1</span>
                            <button onclick="nextPage('testRuns')" id="testRunsNext">Next &raquo;</button>
                        </div>
                    </div>
                </div>

                <div id="testOutputContainer" style="margin-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">Test Output</h3>
                        <button class="btn btn-secondary" onclick="copyTestOutput()" style="font-size: 12px; padding: 4px 8px;">Copy</button>
                    </div>
                    <pre id="testOutput" style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 400px; font-size: 12px;"></pre>
                </div>
            </div>

            <!-- Deployments Panel -->
            <div class="panel" id="panel-deployments">
                <div class="panel-header">
                    <h1 class="panel-title">Deployments</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadDeployments()">Refresh</button>
                        <button class="btn btn-secondary" onclick="checkMigrationStatus()">Migration Status</button>
                        <button class="btn btn-primary" onclick="showModal('newDeployment')">New Deployment</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="deployTotal">0</div>
                        <div class="stat-label">Total Deployments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="deploySuccess" style="color: var(--success);">0</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="deployFailed" style="color: var(--danger);">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="deployPending" style="color: var(--warning);">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>

                <!-- Deployment Thresholds Progress -->
                <div class="card" style="margin-bottom: 24px; padding: 20px;">
                    <h3 style="margin-bottom: 16px;">Auto-Deployment Progress</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- DEV  QA Progress -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>DEV  QA</span>
                                <span id="devQaProgress">0 / 3 commits</span>
                            </div>
                            <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="devQaProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: var(--text-secondary);">
                                <span id="devQaFeaturesProgress">0 / 2 features</span>
                                <span id="devQaStatus">Waiting...</span>
                            </div>
                        </div>
                        <!-- QA  PROD Progress -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>QA  PROD</span>
                                <span id="qaProdProgress">0 / 5 commits</span>
                            </div>
                            <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="qaProdProgressBar" style="background: var(--warning); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: var(--text-secondary);">
                                <span id="qaProdFeaturesProgress">0 / 3 features</span>
                                <span id="qaProdStatus">Waiting...</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <button class="btn btn-secondary" onclick="checkDeploymentThresholds()">Check Thresholds</button>
                        <button class="btn btn-secondary" onclick="triggerAutoDeployCheck()">Trigger Auto-Deploy Check</button>
                    </div>
                </div>

                <div class="filters" style="margin-bottom: 16px;">
                    <input type="text" class="search-input" placeholder="Search deployments..." id="deploymentSearch" onkeyup="filterDeploymentsTable()">
                    <select class="filter-select" id="deployEnvFilter" onchange="loadDeployments()">
                        <option value="">All Environments</option>
                        <option value="dev">Development</option>
                        <option value="qa">QA</option>
                        <option value="prod">Production</option>
                    </select>
                    <select class="filter-select" id="deployStatusFilter" onchange="loadDeployments()">
                        <option value="">All Status</option>
                        <option value="success">Success</option>
                        <option value="failed">Failed</option>
                        <option value="in_progress">In Progress</option>
                    </select>
                </div>

                <h3 style="margin-bottom: 12px;">Deployment History</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tag</th>
                                <th>Environment</th>
                                <th>Status</th>
                                <th>Tests</th>
                                <th>Deployed By</th>
                                <th>Started</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deploymentsTable"></tbody>
                    </table>
                    <div class="pagination" id="deploymentsPagination">
                        <div class="pagination-info">
                            Showing <span id="deploymentsShowing">0</span> of <span id="deploymentsTotal">0</span> deployments
                        </div>
                        <div class="pagination-controls">
                            <select id="deploymentsPageSize" onchange="changePageSize('deployments')">
                                <option value="10" selected>10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                            </select>
                            <button onclick="prevPage('deployments')" id="deploymentsPrev" disabled>&laquo; Prev</button>
                            <span id="deploymentsPageInfo">Page 1</span>
                            <button onclick="nextPage('deployments')" id="deploymentsNext">Next &raquo;</button>
                        </div>
                    </div>
                </div>

                <div id="migrationStatus" style="margin-top: 20px; display: none;">
                    <h3 style="margin-bottom: 12px;">Database Migration Status</h3>
                    <div class="card" style="padding: 16px;">
                        <div id="migrationContent"></div>
                    </div>
                </div>
            </div>

            <!-- tmux Panel - Clean 2-Column Layout -->
            <div class="panel" id="panel-tmux" style="padding: 0; display: flex; flex-direction: column; height: calc(100vh - 57px); overflow: hidden;">
                <div class="sessions-container" style="display: flex; flex: 1; overflow: hidden;">

                    <!-- Left: Sessions List -->
                    <div class="sessions-sidebar" id="sessionsSidebar" style="width: 280px; min-width: 200px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; position: relative; transition: width 0.2s ease;">
                        <!-- Collapse toggle button -->
                        <button class="sidebar-collapse-btn" onclick="toggleSessionsSidebar()" title="Toggle sidebar"></button>
                        <!-- Header with New Session button -->
                        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 13px; color: var(--text-secondary);" id="sessionCount">0 sessions</span>
                                <button onclick="showModal('newTmuxSession')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">+ New Session</button>
                            </div>
                            <!-- Search -->
                            <input type="text" id="sessionFilter" placeholder="Search sessions..."
                                   onkeyup="filterSessions(this.value)"
                                   style="width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; outline: none;"
                                   onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
                        </div>

                        <!-- Filter Chips -->
                        <div style="padding: 8px 16px; display: flex; gap: 6px; flex-wrap: wrap; border-bottom: 1px solid var(--border);">
                            <button class="filter-chip active" data-filter="all" onclick="setSessionFilter('all')">All</button>
                            <button class="filter-chip" data-filter="attached" onclick="setSessionFilter('attached')">Attached</button>
                            <button class="filter-chip" data-filter="detached" onclick="setSessionFilter('detached')">Detached</button>
                            <span style="width: 1px; background: var(--border); margin: 0 4px;"></span>
                            <button class="sort-chip active" data-sort="name" onclick="setSessionSort('name')" title="Sort by name">A-Z</button>
                            <button class="sort-chip" data-sort="status" onclick="setSessionSort('status')" title="Sort by status">Status</button>
                            <button class="sort-chip" data-sort="activity" onclick="setSessionSort('activity')" title="Sort by activity">Recent</button>
                            <span style="width: 1px; background: var(--border); margin: 0 4px;"></span>
                            <button class="view-toggle-btn" data-view="list" onclick="setSessionView('list')" title="Flat list view"></button>
                            <button class="view-toggle-btn active" data-view="tree" onclick="setSessionView('tree')" title="Tree view by project"></button>
                        </div>

                        <!-- Group Controls (shown in tree view) -->
                        <div id="groupControls" style="padding: 6px 16px; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg-tertiary);">
                            <span style="font-size: 11px; color: var(--text-secondary);">Groups:</span>
                            <button onclick="expandAllGroups()" class="group-control-btn" title="Expand all groups">
                                <span style="font-size: 10px;"></span> Expand All
                            </button>
                            <button onclick="collapseAllGroups()" class="group-control-btn" title="Collapse all groups">
                                <span style="font-size: 10px;"></span> Collapse All
                            </button>
                            <span style="flex: 1;"></span>
                            <button onclick="autoAssignSessions()" class="group-control-btn" title="Auto-assign sessions to projects based on naming">
                                 Auto-Assign
                            </button>
                        </div>

                        <!-- Sessions List -->
                        <div id="tmuxSessionsList" style="flex: 1; overflow-y: auto; padding: 8px;">
                            <div style="color: var(--text-secondary); text-align: center; padding: 40px 20px; font-size: 13px;">Loading sessions...</div>
                        </div>

                        <!-- Refresh indicator -->
                        <div style="padding: 8px 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span id="lastRefresh">Last updated: --</span>
                            <button onclick="refreshTmuxSessions()" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 11px;">Refresh</button>
                        </div>
                    </div>

                    <!-- Main: Terminal Area -->
                    <div class="terminal-area" style="flex: 1; display: flex; flex-direction: column; background: #0d1117; overflow: hidden;">

                        <!-- Session Control Bar -->
                        <div id="sessionControlBar" style="padding: 10px 16px; background: #161b22; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                            <!-- Left: Session info -->
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="color: #58a6ff; font-weight: 600; font-size: 15px;" id="currentTmuxSession">Select a session</span>
                                <span id="sessionStatus" class="status-badge">--</span>
                                <span id="sessionEnv" class="env-badge" style="display: none;"></span>
                                <span id="terminalDims" style="color: #6e7681; font-size: 11px; font-family: var(--terminal-font-family); padding: 2px 6px; background: #21262d; border-radius: 4px;">--x--</span>
                            </div>
                            <!-- Right: Actions -->
                            <div style="display: flex; gap: 6px;" id="sessionActions">
                                <button class="action-btn" onclick="toggleAttach()" title="Attach/Detach" disabled>
                                    <span id="attachIcon"></span>
                                </button>
                                <button class="action-btn" onclick="restartSession()" title="Restart Session" disabled></button>
                                <button class="action-btn" onclick="copyLogs()" title="Copy Logs" disabled></button>
                                <button class="action-btn" onclick="killSessionConfirm()" title="Kill Session" disabled></button>
                                <span style="width: 1px; background: #30363d; margin: 0 4px;"></span>
                                <button class="action-btn" onclick="toggleTmuxFocusMode()" title="Focus Mode (expand terminal)"></button>
                            </div>
                        </div>

                        <!-- Auto-refresh indicator with terminal view toggle -->
                        <div id="autoRefreshBar" style="padding: 4px 16px; background: #21262d; font-size: 11px; color: #8b949e; display: flex; justify-content: space-between; align-items: center;">
                            <span>Auto-refresh: <span id="autoRefreshStatus">On</span></span>

                            <!-- Scrollback Controls -->
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="scrollbackInfo" style="color: #6e7681;">Lines: <span id="lineCount">--</span></span>
                                <select id="scrollbackSelect" onchange="updateScrollbackSetting()" style="background: #161b22; border: 1px solid #30363d; color: #c9d1d9; border-radius: 4px; padding: 2px 6px; font-size: 11px;">
                                    <option value="0">Current pane</option>
                                    <option value="500">500 lines</option>
                                    <option value="1000">1000 lines</option>
                                    <option value="3000">3000 lines</option>
                                    <option value="10000">Full history</option>
                                </select>
                            </div>

                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" style="cursor: pointer;">
                                <span>Every 2s</span>
                            </label>
                        </div>

                        <!-- Terminal Output - Dual View Container -->
                        <div class="terminal-area-wrapper" style="position: relative; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div id="tmuxOutput" class="terminal-output terminal-container" style="flex: 1; overflow-y: auto; overflow-x: auto; padding: 16px 20px; background: #0d1117; color: #c9d1d9;" onscroll="handleTerminalScroll(this)">
                                <div style="color: #6e7681; text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 32px; margin-bottom: 16px;"></div>
                                    <div style="font-size: 15px; margin-bottom: 8px;">No session selected</div>
                                    <div style="font-size: 13px;">Choose a session from the sidebar to connect</div>
                                </div>
                            </div>
                            <button id="scrollToBottomBtn" class="scroll-to-bottom" onclick="scrollTerminalToBottom()" title="Scroll to bottom"></button>
                        </div>

                        <!-- Command Input (Clean & Minimal) -->
                        <div id="commandInput" style="background: #161b22; border-top: 1px solid #30363d; padding: 12px 16px;">
                            <!-- Quick responses (compact) -->
                            <div id="quickResponses" style="display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;">
                                <button class="quick-btn yes" onclick="sendTmuxQuickCmd('y')"> Yes</button>
                                <button class="quick-btn no" onclick="sendTmuxQuickCmd('n')"> No</button>
                                <button class="quick-btn" onclick="sendTmuxQuickCmd('continue')">Continue</button>
                                <span style="flex: 1;"></span>
                                <button class="quick-btn toggle" onclick="toggleKeyboard()" id="keyboardToggle"> Keys</button>
                            </div>

                            <!-- Collapsible keyboard (hidden by default) -->
                            <div id="keyboardPanel" style="display: none; margin-bottom: 10px; padding: 8px; background: #21262d; border-radius: 6px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                    <button class="tkey" onclick="sendTmuxKey('Enter')">Enter </button>
                                    <button class="tkey" onclick="sendTmuxKey('Escape')">Esc</button>
                                    <button class="tkey" onclick="sendTmuxKey('Tab')">Tab</button>
                                    <button class="tkey" onclick="sendTmuxKey('C-c')">^C</button>
                                    <button class="tkey" onclick="sendTmuxKey('C-d')">^D</button>
                                    <button class="tkey" onclick="sendTmuxKey('C-z')">^Z</button>
                                    <button class="tkey" onclick="sendTmuxKey('C-l')">^L</button>
                                    <button class="tkey" onclick="sendTmuxKey('Up')"></button>
                                    <button class="tkey" onclick="sendTmuxKey('Down')"></button>
                                </div>
                            </div>

                            <!-- Main input row -->
                            <div style="display: flex; gap: 8px; align-items: flex-end;" data-command-composer="true">
                                <textarea id="tmuxInput"
                                    placeholder="Type command..."
                                    rows="1"
                                    style="flex: 1; padding: 10px 14px; font-size: 14px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: #c9d1d9; font-family: 'SF Mono', 'Monaco', 'Menlo', monospace; resize: none; min-height: 40px; max-height: 100px; line-height: 1.4;"
                                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                                    onkeydown="handleTmuxInputKey(event)"
                                    oninput="autoResizeInput(this)"
                                    oncompositionstart="handleTmuxInputCompositionStart()"
                                    oncompositionend="handleTmuxInputCompositionEnd()"></textarea>
                                <button onclick="sendTmuxInput()" class="send-btn" type="button">Send</button>
                            </div>

                            <!-- Hints row -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 11px; color: #6e7681;">
                                <span><kbd>Enter</kbd> send  <kbd>Shift+Enter</kbd> newline  <kbd>Enter</kbd> force send</span>
                                <button onclick="toggleSnippets()" style="background: none; border: none; color: #58a6ff; cursor: pointer; font-size: 11px;"> Snippets</button>
                            </div>

                            <!-- Snippets dropdown -->
                            <div id="snippetMenu" style="display: none; position: absolute; bottom: 100%; right: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; min-width: 220px; padding: 4px; z-index: 100; margin-bottom: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
                                <div class="snippet-category">Health Checks</div>
                                <button class="snippet-item" onclick="insertSnippet('curl -s http://localhost:8080/health | jq .')">curl health</button>
                                <button class="snippet-item" onclick="insertSnippet('for p in 8080 8081 8082 8085; do echo \"Port $p:\"; curl -s http://localhost:$p/health; echo; done')">check all ports</button>
                                <div class="snippet-category" style="border-top: 1px solid #30363d; margin-top: 4px;">Git</div>
                                <button class="snippet-item" onclick="insertSnippet('git status')">git status</button>
                                <button class="snippet-item" onclick="insertSnippet('git log --oneline -10')">git log</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden for compatibility -->
                <select id="tmuxSessionSelect" style="display: none;"></select>
                <div id="tmuxSessionsGrid" style="display: none;"></div>
            </div>

            <style>
                /* Filter Chips */
                .filter-chip {
                    padding: 4px 10px;
                    font-size: 11px;
                    background: transparent;
                    border: 1px solid var(--border);
                    border-radius: 12px;
                    color: var(--text-secondary);
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .filter-chip:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }
                .filter-chip.active {
                    background: var(--accent);
                    border-color: var(--accent);
                    color: white;
                }

                .sort-chip {
                    padding: 4px 8px;
                    font-size: 10px;
                    background: transparent;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                    color: var(--text-secondary);
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .sort-chip:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }
                .sort-chip.active {
                    background: var(--purple);
                    border-color: var(--purple);
                    color: white;
                }

                /* Status Badge */
                .status-badge {
                    padding: 3px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 500;
                    background: #30363d;
                    color: #8b949e;
                }
                .status-badge.attached {
                    background: rgba(35, 134, 54, 0.2);
                    color: #3fb950;
                }
                .status-badge.detached {
                    background: rgba(139, 148, 158, 0.2);
                    color: #8b949e;
                }
                .status-badge.error {
                    background: rgba(248, 81, 73, 0.2);
                    color: #f85149;
                }

                /* Env Badge */
                .env-badge {
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    background: #30363d;
                    color: #8b949e;
                }

                /* Action Buttons */
                .action-btn {
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    color: #8b949e;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.15s;
                }
                .action-btn:hover:not(:disabled) {
                    background: #30363d;
                    color: #c9d1d9;
                    border-color: #8b949e;
                }
                .action-btn:disabled {
                    opacity: 0.4;
                    cursor: not-allowed;
                }

                /* Quick Buttons */
                .quick-btn {
                    padding: 6px 12px;
                    font-size: 12px;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    color: #8b949e;
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .quick-btn:hover {
                    background: #30363d;
                    color: #c9d1d9;
                }
                .quick-btn.yes {
                    color: #3fb950;
                    border-color: #238636;
                }
                .quick-btn.yes:hover {
                    background: rgba(35, 134, 54, 0.2);
                }
                .quick-btn.no {
                    color: #f85149;
                    border-color: #f85149;
                }
                .quick-btn.no:hover {
                    background: rgba(248, 81, 73, 0.2);
                }
                .quick-btn.toggle {
                    color: #58a6ff;
                }

                /* Send Button */
                .send-btn {
                    padding: 10px 20px;
                    background: #238636;
                    border: none;
                    border-radius: 6px;
                    color: white;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 14px;
                    height: 40px;
                    transition: all 0.15s;
                }
                .send-btn:hover {
                    background: #2ea043;
                }

                /* Snippet Category */
                .snippet-category {
                    padding: 6px 8px;
                    font-size: 10px;
                    color: #8b949e;
                    text-transform: uppercase;
                }

                /* Termius-style keys */
                .tkey {
                    padding: 6px 10px;
                    font-size: 12px;
                    font-weight: 500;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 4px;
                    color: #c9d1d9;
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .tkey:hover {
                    background: #30363d;
                    border-color: #8b949e;
                }
                .tkey:active {
                    transform: scale(0.95);
                }

                /* Session item in sidebar - Enhanced */
                .session-item {
                    padding: 10px 12px;
                    margin-bottom: 6px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    transition: all 0.15s;
                    border: 1px solid transparent;
                    background: var(--bg-tertiary);
                    min-width: 0;
                }
                .session-item:hover {
                    background: var(--bg-hover);
                    border-color: var(--border);
                }
                .session-item.active {
                    background: rgba(88, 166, 255, 0.1);
                    border-color: var(--accent);
                }
                .session-item .session-icon {
                    font-size: 16px;
                    flex-shrink: 0;
                }
                .session-item .session-name {
                    flex: 1;
                    font-size: 13px;
                    color: #c9d1d9;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    min-width: 0;
                }
                .session-item .session-status {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: #8b949e;
                    flex-shrink: 0;
                }
                .session-item .session-status.attached {
                    background: #3fb950;
                }

                /* Session item content truncation */
                .session-item-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    min-width: 0;
                    gap: 8px;
                }
                .session-item-name {
                    font-weight: 500;
                    color: var(--text-primary);
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    min-width: 0;
                    flex: 1;
                }
                .session-item-badges {
                    display: flex;
                    gap: 4px;
                    align-items: center;
                    flex-shrink: 0;
                }
                .session-item-assignment {
                    font-size: 11px;
                    margin-top: 4px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                .session-item-meta {
                    display: flex;
                    justify-content: space-between;
                    font-size: 11px;
                    color: var(--text-secondary);
                    margin-top: 2px;
                    gap: 8px;
                }
                .session-item-meta span {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    min-width: 0;
                }

                /* Session Hierarchy Tree View */
                .session-group {
                    margin-bottom: 4px;
                }
                .session-group-header {
                    display: flex;
                    align-items: center;
                    padding: 8px 12px;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: background 0.15s;
                    gap: 8px;
                    user-select: none;
                }
                .session-group-header:hover {
                    background: var(--bg-tertiary);
                }
                .session-group-toggle {
                    font-size: 10px;
                    color: var(--text-secondary);
                    transition: transform 0.2s;
                    width: 16px;
                    text-align: center;
                }
                .session-group.collapsed .session-group-toggle {
                    transform: rotate(-90deg);
                }
                .session-group-icon {
                    font-size: 14px;
                }
                .session-group-name {
                    flex: 1;
                    font-size: 12px;
                    font-weight: 600;
                    color: var(--text-primary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .session-group-count {
                    font-size: 11px;
                    color: var(--text-secondary);
                    background: var(--bg-tertiary);
                    padding: 2px 6px;
                    border-radius: 10px;
                }
                .session-group-sessions {
                    margin-left: 24px;
                    border-left: 1px solid var(--border);
                    padding-left: 8px;
                }
                .session-group.collapsed .session-group-sessions {
                    display: none;
                }
                .session-group-sessions .session-item {
                    margin-left: 0;
                }

                /* Group Control Buttons */
                .group-control-btn {
                    padding: 3px 8px;
                    font-size: 10px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border);
                    border-radius: 4px;
                    color: var(--text-secondary);
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .group-control-btn:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                    border-color: var(--accent);
                }

                /* Session Context Menu */
                .session-context-menu {
                    position: fixed;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    min-width: 180px;
                    padding: 4px 0;
                }
                .session-context-menu-item {
                    padding: 8px 12px;
                    font-size: 12px;
                    color: var(--text-primary);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .session-context-menu-item:hover {
                    background: var(--bg-tertiary);
                }
                .session-context-menu-divider {
                    height: 1px;
                    background: var(--border);
                    margin: 4px 0;
                }
                .session-context-submenu {
                    position: relative;
                }
                .session-context-submenu-content {
                    display: none;
                    position: absolute;
                    left: 100%;
                    top: 0;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    min-width: 150px;
                    padding: 4px 0;
                }
                .session-context-submenu:hover .session-context-submenu-content {
                    display: block;
                }

                /* View Toggle Button */
                .view-toggle-btn {
                    padding: 4px 8px;
                    font-size: 11px;
                    background: transparent;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                    color: var(--text-secondary);
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .view-toggle-btn:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }
                .view-toggle-btn.active {
                    background: var(--accent);
                    border-color: var(--accent);
                    color: white;
                }

                /* Collapsible sessions sidebar */
                .sessions-sidebar.collapsed {
                    width: 60px !important;
                    min-width: 60px !important;
                }
                .sessions-sidebar.collapsed .session-item-name,
                .sessions-sidebar.collapsed .session-item-assignment,
                .sessions-sidebar.collapsed .session-item-meta,
                .sessions-sidebar.collapsed .env-tag,
                .sessions-sidebar.collapsed #sessionFilter,
                .sessions-sidebar.collapsed .filter-chips-row,
                .sessions-sidebar.collapsed .sidebar-header-text {
                    display: none !important;
                }
                .sessions-sidebar.collapsed .session-item {
                    padding: 10px;
                    justify-content: center;
                    align-items: center;
                }
                .sidebar-collapse-btn {
                    position: absolute;
                    right: -12px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 24px;
                    height: 48px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border);
                    border-left: none;
                    border-radius: 0 6px 6px 0;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: var(--text-secondary);
                    z-index: 10;
                    font-size: 12px;
                }
                .sidebar-collapse-btn:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }

                /* Responsive tmux panel */
                @media (max-width: 1200px) {
                    .sessions-sidebar {
                        width: 220px !important;
                        min-width: 180px !important;
                    }
                }
                @media (max-width: 992px) {
                    .sessions-sidebar {
                        width: 180px !important;
                        min-width: 140px !important;
                    }
                    .session-item-assignment {
                        display: none;
                    }
                }
                @media (max-width: 768px) {
                    .sessions-sidebar {
                        width: 60px !important;
                        min-width: 60px !important;
                    }
                    .sessions-sidebar .session-item-name,
                    .sessions-sidebar .session-item-assignment,
                    .sessions-sidebar .session-item-meta,
                    .sessions-sidebar #sessionFilter,
                    .sessions-sidebar .filter-chips-row {
                        display: none !important;
                    }
                    .sessions-sidebar .session-item {
                        padding: 10px;
                        justify-content: center;
                    }
                    .tkey {
                        padding: 8px 12px;
                        font-size: 13px;
                    }
                    #quickResponses {
                        flex-wrap: wrap;
                    }
                    #commandInput {
                        padding: 8px 12px !important;
                    }
                }

                    .special-key {
                        padding: 8px 12px;
                        font-size: 12px;
                        font-weight: 600;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                        color: var(--text-primary);
                        cursor: pointer;
                        min-width: 44px;
                        text-align: center;
                    }
                    .special-key:hover {
                        background: var(--primary);
                        color: white;
                    }
                    .special-key:active {
                        transform: scale(0.95);
                    }
                    .quick-cmd {
                        padding: 6px 10px;
                        font-size: 11px;
                        background: var(--bg-secondary);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                        color: var(--text-secondary);
                        cursor: pointer;
                    }
                    .quick-cmd:hover {
                        background: var(--success);
                        color: white;
                        border-color: var(--success);
                    }
                    .quick-cmd.quick-yes {
                        background: rgba(40, 167, 69, 0.2);
                        border-color: var(--success);
                        color: var(--success);
                    }
                    .quick-cmd.quick-yes:hover {
                        background: var(--success);
                        color: white;
                    }
                    .quick-cmd.quick-no {
                        background: rgba(220, 53, 69, 0.2);
                        border-color: var(--danger);
                        color: var(--danger);
                    }
                    .quick-cmd.quick-no:hover {
                        background: var(--danger);
                        color: white;
                    }
                    @media (max-width: 768px) {
                        .special-key {
                            padding: 12px 14px;
                            font-size: 14px;
                            min-width: 48px;
                        }
                        .quick-cmd {
                            padding: 10px 14px;
                            font-size: 13px;
                        }
                        #tmuxCommand {
                            font-size: 18px !important;
                            padding: 14px !important;
                        }
                        #tmuxOutput {
                            font-size: 12px !important;
                            min-height: 200px;
                        }
                        .tmux-input button {
                            padding: 14px 20px !important;
                        }
                    }
                </style>

            <!-- Regions Panel -->
            <div class="panel" id="panel-regions">
                <div class="panel-header">
                    <h1 class="panel-title"> Deployment Regions</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadRegions()">Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('newRegion')">+ Add Region</button>
                    </div>
                </div>

                <!-- Region Summary Cards -->
                <div class="regions-summary" id="regionsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Regions</div>
                        <div class="stat-value" id="totalRegions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active</div>
                        <div class="stat-value" id="activeRegions" style="color: var(--green);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Nodes</div>
                        <div class="stat-value" id="totalRegionNodes">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Online Nodes</div>
                        <div class="stat-value" id="onlineRegionNodes" style="color: var(--cyan);">0</div>
                    </div>
                </div>

                <!-- Regions Grid -->
                <div class="cards-grid" id="regionsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                    <p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center; padding: 40px;">
                        Loading regions...
                    </p>
                </div>

                <!-- Region Topology Section -->
                <div class="section-divider" style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <h2 style="font-size: 16px; margin-bottom: 15px; color: var(--text-secondary);">Region Topology</h2>
                    <div id="regionTopologyContainer" style="min-height: 200px; background: var(--bg-secondary); border-radius: 8px; padding: 20px;">
                        <p style="color: var(--text-secondary); text-align: center;">
                            Region topology visualization will appear here once regions are configured.
                        </p>
                    </div>
                </div>
            </div>

            <!-- New Region Modal -->
            <div class="modal" id="modal-newRegion" role="dialog" aria-modal="true" aria-labelledby="newRegionTitle">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title" id="newRegionTitle">Add New Region</h2>
                        <button class="modal-close" onclick="hideModal('newRegion')" aria-label="Close">&times;</button>
                    </div>
                    <form onsubmit="createRegion(event)">
                        <div class="form-group">
                            <label for="regionName">Region Name *</label>
                            <input type="text" id="regionName" placeholder="e.g., US East" required>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="regionCode">Region Code *</label>
                                <input type="text" id="regionCode" placeholder="e.g., us-east-1" pattern="[a-z0-9][a-z0-9\-_]*[a-z0-9]|[a-z0-9]" required>
                                <small style="color: var(--text-secondary);">Lowercase, alphanumeric with hyphens</small>
                            </div>
                            <div class="form-group">
                                <label for="regionProvider">Provider</label>
                                <select id="regionProvider">
                                    <option value="on-premise">On-Premise</option>
                                    <option value="aws">AWS</option>
                                    <option value="gcp">Google Cloud</option>
                                    <option value="azure">Azure</option>
                                    <option value="digitalocean">DigitalOcean</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="regionDescription">Description</label>
                            <textarea id="regionDescription" rows="2" placeholder="Optional description of this region"></textarea>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="regionLocation">Location</label>
                                <input type="text" id="regionLocation" placeholder="e.g., Virginia, USA">
                            </div>
                            <div class="form-group">
                                <label for="regionTimezone">Timezone</label>
                                <input type="text" id="regionTimezone" placeholder="e.g., America/New_York">
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="regionLatitude">Latitude</label>
                                <input type="number" id="regionLatitude" step="0.0001" placeholder="37.7749">
                            </div>
                            <div class="form-group">
                                <label for="regionLongitude">Longitude</label>
                                <input type="number" id="regionLongitude" step="0.0001" placeholder="-122.4194">
                            </div>
                            <div class="form-group">
                                <label for="regionMaxNodes">Max Nodes</label>
                                <input type="number" id="regionMaxNodes" min="1" value="100">
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="regionPriority">Failover Priority</label>
                                <input type="number" id="regionPriority" min="1" value="100">
                                <small style="color: var(--text-secondary);">Lower = higher priority</small>
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 8px; padding-top: 24px;">
                                <input type="checkbox" id="regionIsPrimary">
                                <label for="regionIsPrimary" style="margin: 0;">Set as Primary Region</label>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideModal('newRegion')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Region</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Region Modal -->
            <div class="modal" id="modal-editRegion" role="dialog" aria-modal="true" aria-labelledby="editRegionTitle">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title" id="editRegionTitle">Edit Region</h2>
                        <button class="modal-close" onclick="hideModal('editRegion')" aria-label="Close">&times;</button>
                    </div>
                    <form onsubmit="updateRegion(event)">
                        <input type="hidden" id="editRegionId">
                        <div class="form-group">
                            <label for="editRegionName">Region Name *</label>
                            <input type="text" id="editRegionName" required>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label>Region Code</label>
                                <input type="text" id="editRegionCode" disabled style="opacity: 0.7;">
                            </div>
                            <div class="form-group">
                                <label for="editRegionStatus">Status</label>
                                <select id="editRegionStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="draining">Draining</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editRegionDescription">Description</label>
                            <textarea id="editRegionDescription" rows="2"></textarea>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="editRegionLocation">Location</label>
                                <input type="text" id="editRegionLocation">
                            </div>
                            <div class="form-group">
                                <label for="editRegionProvider">Provider</label>
                                <select id="editRegionProvider">
                                    <option value="on-premise">On-Premise</option>
                                    <option value="aws">AWS</option>
                                    <option value="gcp">Google Cloud</option>
                                    <option value="azure">Azure</option>
                                    <option value="digitalocean">DigitalOcean</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="editRegionPriority">Failover Priority</label>
                                <input type="number" id="editRegionPriority" min="1">
                            </div>
                            <div class="form-group">
                                <label for="editRegionMaxNodes">Max Nodes</label>
                                <input type="number" id="editRegionMaxNodes" min="1">
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 8px; padding-top: 24px;">
                                <input type="checkbox" id="editRegionIsPrimary">
                                <label for="editRegionIsPrimary" style="margin: 0;">Primary Region</label>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-danger" onclick="confirmDeleteRegion()">Delete</button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('editRegion')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Nodes Panel -->
            <div class="panel" id="panel-nodes">
                <div class="panel-header">
                    <h1 class="panel-title">Cluster Nodes</h1>
                    <div class="panel-actions">
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="nodesAutoRefresh" onchange="toggleNodesAutoRefresh(this.checked)">
                            Auto-refresh
                            <span id="nodesRefreshCountdown" class="refresh-countdown"></span>
                        </label>
                        <button class="btn btn-secondary" onclick="loadNodes()">Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('newNode')">+ Add Node</button>
                    </div>
                </div>

                <div class="filters" style="margin-bottom: 16px;">
                    <input type="text" class="search-input" placeholder="Search nodes..." id="nodeSearch" onkeyup="filterNodesGrid()">
                    <select class="filter-select" id="nodeStatusFilter" onchange="filterNodesGrid()">
                        <option value="">All Status</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>

                <div id="nodesLastUpdated" class="node-last-updated"></div>
                <div class="cards-grid" id="nodesGrid"></div>

                <!-- Termius Export Section -->
                <div class="section-divider" style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <h2 style="font-size: 16px; margin-bottom: 15px; color: var(--text-secondary);">Termius Export</h2>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">
                        Export hosts and tmux sessions for import into Termius SSH client.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="previewTermiusExport()">
                            Preview Export
                        </button>
                        <button class="btn btn-primary" onclick="downloadTermiusExport('basic')">
                            Download Basic (Hosts Only)
                        </button>
                        <button class="btn btn-primary" onclick="downloadTermiusExport('full')">
                            Download Full (Hosts + tmux Snippets)
                        </button>
                    </div>
                    <div id="termiusPreview" style="margin-top: 15px; display: none;">
                        <div class="card" style="padding: 15px;">
                            <div id="termiusPreviewContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Overview Panel -->
            <div class="panel" id="panel-system-overview">
                <div class="panel-header">
                    <h1 class="panel-title"> System Overview</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="if(window.systemOverview) window.systemOverview.refresh()">Refresh</button>
                    </div>
                </div>
                <div id="systemOverviewContainer">
                    <p style="color: var(--text-secondary);">Loading system overview...</p>
                </div>
            </div>

            <!-- Tasks Panel -->
            <div class="panel" id="panel-tasks">
                <div class="panel-header">
                    <h1 class="panel-title">Task Queue</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadTasks()">Refresh</button>
                        <button class="btn btn-primary" onclick="processNextTask()">Process Next</button>
                        <button class="btn btn-secondary" onclick="showModal('newTask')">+ New Task</button>
                    </div>
                </div>

                <div class="filters">
                    <input type="text" class="search-input" placeholder="Search tasks..." id="taskSearch" onkeyup="filterTasksTable()">
                    <select class="filter-select" id="taskStatusFilter" onchange="loadTasks()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="running">Running</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                    <select class="filter-select" id="taskTypeFilter" onchange="loadTasks()">
                        <option value="">All Types</option>
                        <option value="shell">Shell</option>
                        <option value="python">Python</option>
                        <option value="git">Git</option>
                        <option value="deploy">Deploy</option>
                        <option value="test">Test</option>
                        <option value="build">Build</option>
                    </select>
                    <select class="filter-select" id="taskRiskFilter" onchange="loadTasks()">
                        <option value="">All Risk Levels</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <button class="btn btn-secondary" onclick="autoAssessTaskRisk()" title="Auto-assess risk for pending tasks">Assess Risk</button>
                </div>

                <!-- Worker Status -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <div class="card-title">Workers</div>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="loadWorkerStatus()">Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 12px;">
                        <div id="workerStatusGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                            <!-- Workers loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Suggested Tasks (from Claude) -->
                <div class="card" id="suggestedTasksCard" style="margin-bottom: 20px; display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="card-title" style="color: white;">
                            <span style="margin-right: 8px;"></span> Suggested Tasks
                        </div>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="loadSuggestedTasks()">Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="suggestedTasksList">
                            <!-- Suggested tasks loaded here -->
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Risk</th>
                                <th>Priority</th>
                                <th>Worker</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTable"></tbody>
                    </table>
                    <div class="pagination" id="tasksPagination">
                        <div class="pagination-info">
                            Showing <span id="tasksShowing">0</span> of <span id="tasksTotal">0</span> tasks
                        </div>
                        <div class="pagination-controls">
                            <select id="tasksPageSize" onchange="changePageSize('tasks')">
                                <option value="10">10 per page</option>
                                <option value="25" selected>25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                            <button onclick="prevPage('tasks')" id="tasksPrev" disabled>&laquo; Prev</button>
                            <span id="tasksPageInfo">Page 1</span>
                            <button onclick="nextPage('tasks')" id="tasksNext">Next &raquo;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workers Panel -->
            <div class="panel" id="panel-workers">
                <div class="panel-header">
                    <h1 class="panel-title">Offline Workers</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadWorkers()">Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('newWorker')">+ Register Worker</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="workerTotal">0</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="workerActive">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="workerIdle">0</div>
                        <div class="stat-label">Idle</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="workerOffline">0</div>
                        <div class="stat-label">Offline</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;">Worker Types</h3>
                <div class="cards-grid" style="margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Task Worker</div>
                            <span class="badge badge-online" id="taskWorkerStatus">Unknown</span>
                        </div>
                        <div class="card-body">
                            Processes background tasks from the queue (shell, git, deploy, test, build)
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" onclick="startWorker('task')">Start</button>
                            <button class="btn btn-danger" onclick="stopWorker('task')">Stop</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Error Daemon</div>
                            <span class="badge badge-offline" id="errorDaemonStatus">Unknown</span>
                        </div>
                        <div class="card-body">
                            Monitors errors and auto-assigns them to tmux sessions for fixing
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" onclick="startWorker('error_daemon')">Start</button>
                            <button class="btn btn-danger" onclick="stopWorker('error_daemon')">Stop</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Deploy Worker</div>
                            <span class="badge badge-offline" id="deployWorkerStatus">Unknown</span>
                        </div>
                        <div class="card-body">
                            CI/CD automation - watches for git events and deploys to cluster nodes
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" onclick="startWorker('deploy')">Start</button>
                            <button class="btn btn-danger" onclick="stopWorker('deploy')">Stop</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Confirmation Worker</div>
                            <span class="badge badge-offline" id="confirmWorkerStatus">Unknown</span>
                        </div>
                        <div class="card-body">
                            Monitors tmux sessions for confirmation requests and auto-responds
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" onclick="startWorker('confirm')">Start</button>
                            <button class="btn btn-danger" onclick="stopWorker('confirm')">Stop</button>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;">Registered Workers</h3>
                <div class="filters" style="margin-bottom: 12px;">
                    <input type="text" class="search-input" placeholder="Search workers..." id="workerSearch" onkeyup="filterWorkersTable()">
                    <select class="filter-select" id="workerStatusFilter" onchange="filterWorkersTable()">
                        <option value="">All Status</option>
                        <option value="idle">Idle</option>
                        <option value="busy">Busy</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Node</th>
                                <th>Status</th>
                                <th>Tasks Completed</th>
                                <th>Last Heartbeat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workersTable"></tbody>
                    </table>
                    <div class="pagination" id="workersPagination">
                        <div class="pagination-info">
                            Showing <span id="workersShowing">0</span> of <span id="workersTotal">0</span> workers
                        </div>
                        <div class="pagination-controls">
                            <select id="workersPageSize" onchange="changePageSize('workers')">
                                <option value="10" selected>10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                            </select>
                            <button onclick="prevPage('workers')" id="workersPrev" disabled>&laquo; Prev</button>
                            <span id="workersPageInfo">Page 1</span>
                            <button onclick="nextPage('workers')" id="workersNext">Next &raquo;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Health Panel -->
            <div class="panel" id="panel-services">
                <div class="panel-header">
                    <h1 class="panel-title">Service Health</h1>
                    <div class="panel-actions">
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="servicesAutoRefresh" checked onchange="toggleServicesAutoRefresh(this.checked)">
                            Auto-refresh
                            <span id="servicesRefreshCountdown" class="refresh-countdown"></span>
                        </label>
                        <button class="btn btn-secondary" onclick="loadServiceHealth()">Refresh</button>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="servicesTotal">0</div>
                        <div class="stat-label">Total Services</div>
                    </div>
                    <div class="stat-item" style="background: rgba(63, 185, 80, 0.1); border: 1px solid rgba(63, 185, 80, 0.3);">
                        <div class="stat-value" style="color: #3fb950;" id="servicesHealthy">0</div>
                        <div class="stat-label">Healthy</div>
                    </div>
                    <div class="stat-item" style="background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3);">
                        <div class="stat-value" style="color: #f85149;" id="servicesDown">0</div>
                        <div class="stat-label">Down</div>
                    </div>
                    <div class="stat-item" style="background: rgba(210, 153, 34, 0.1); border: 1px solid rgba(210, 153, 34, 0.3);">
                        <div class="stat-value" style="color: #d29922;" id="servicesUnknown">0</div>
                        <div class="stat-label">Unknown</div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div id="servicesLastUpdated" style="color: var(--text-secondary); font-size: 12px; margin-bottom: 16px;"></div>

                <!-- Services Grid -->
                <div id="servicesGrid" class="cards-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    <!-- Services loaded here -->
                </div>

                <!-- Empty State -->
                <div id="servicesEmpty" style="display: none; text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                    <h3 style="margin-bottom: 8px;">No Services Found</h3>
                    <p>No running services detected. Start some services or check the configuration.</p>
                </div>
            </div>

            <!-- System Health Monitoring Panel -->
            <div class="panel" id="panel-health">
                <div class="panel-header">
                    <h1 class="panel-title"> System Health Monitoring</h1>
                    <div class="panel-actions">
                        <select id="healthTimeRange" onchange="loadHealthData()" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); margin-right: 8px;">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last 7 Days</option>
                        </select>
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="healthAutoRefresh" checked onchange="toggleHealthAutoRefresh(this.checked)">
                            Auto-refresh
                        </label>
                        <button class="btn btn-secondary" onclick="loadHealthData()">Refresh</button>
                    </div>
                </div>

                <!-- Current System Status Cards -->
                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-item">
                        <div class="stat-value" id="currentCpu">--</div>
                        <div class="stat-label">CPU Usage</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentMemory">--</div>
                        <div class="stat-label">Memory Usage</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentDisk">--</div>
                        <div class="stat-label">Disk Usage</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentServices">--</div>
                        <div class="stat-label">Services Running</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentWorkers">--</div>
                        <div class="stat-label">Workers Active</div>
                    </div>
                </div>

                <!-- Charts Row 1: CPU & Memory -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                        <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">CPU Usage Over Time</h3>
                        <canvas id="cpuChart" height="80"></canvas>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                        <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Memory Usage Over Time</h3>
                        <canvas id="memoryChart" height="80"></canvas>
                    </div>
                </div>

                <!-- Charts Row 2: Disk & Load -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                        <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Disk Usage Over Time</h3>
                        <canvas id="diskChart" height="80"></canvas>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                        <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Services & Workers</h3>
                        <canvas id="servicesChart" height="80"></canvas>
                    </div>
                </div>

                <!-- Service Health Timeline -->
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Service Uptime</h3>
                    <div id="serviceTimeline" style="min-height: 200px;">
                        <!-- Service timeline loaded here -->
                    </div>
                </div>
            </div>

            <!-- Vault Panel (Secure Secrets Storage) -->
            <div class="panel" id="panel-vault">
                <div class="panel-header">
                    <h1 class="panel-title">Secure Vault</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadSecrets()">Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('newSecret')">+ Add Secret</button>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #30363d;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 40px;"></div>
                        <div>
                            <h3 style="margin: 0 0 4px 0; color: #58a6ff;">Encrypted Storage</h3>
                            <p style="margin: 0; color: #8b949e; font-size: 13px;">
                                Secrets are encrypted at rest using the application's secret key.
                                Access is logged for security auditing.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="secretTotal">0</div>
                        <div class="stat-label">Total Secrets</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="secretApiKeys">0</div>
                        <div class="stat-label">API Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="secretPasswords">0</div>
                        <div class="stat-label">Passwords</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="secretExpiring">0</div>
                        <div class="stat-label">Expiring Soon</div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="filters" style="margin-bottom: 16px;">
                    <select class="filter-select" id="secretCategoryFilter" onchange="filterSecrets()">
                        <option value="">All Categories</option>
                        <option value="api_key">API Keys</option>
                        <option value="password">Passwords</option>
                        <option value="token">Tokens</option>
                        <option value="certificate">Certificates</option>
                        <option value="ssh_key">SSH Keys</option>
                        <option value="env_var">Environment Variables</option>
                        <option value="general">General</option>
                    </select>
                    <input type="text" class="filter-input" id="secretSearch" placeholder="Search secrets..." onkeyup="filterSecrets()" style="flex: 1; max-width: 300px;">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Project</th>
                                <th>Description</th>
                                <th>Last Accessed</th>
                                <th>Access Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="secretsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Accounts Panel -->
            <div class="panel" id="panel-accounts">
                <div class="panel-header">
                    <h1 class="panel-title">Cross-Node Accounts</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadAccounts()">Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('newAccount')">+ Add Account</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-item">
                        <div class="stat-value" id="accountTotal">0</div>
                        <div class="stat-label">Total Accounts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accountOnline">0</div>
                        <div class="stat-label">Online</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accountSessions">0</div>
                        <div class="stat-label">Active Sessions</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;">Aggregated Data</h3>
                <div class="cards-grid" style="margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Errors Across Nodes</div>
                        </div>
                        <div class="card-body" id="crossNodeErrors">
                            Loading...
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Active Features</div>
                        </div>
                        <div class="card-body" id="crossNodeFeatures">
                            Loading...
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">tmux Sessions</div>
                        </div>
                        <div class="card-body" id="crossNodeSessions">
                            Loading...
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px;">Accounts by Node</h3>
                <div class="cards-grid" id="accountsGrid"></div>
            </div>

            <!-- Project Focus Panel -->
            <div class="panel" id="panel-focus">
                <div class="panel-header">
                    <h1 class="panel-title">
                        <span id="focusProjectName">Select a Project</span>
                        <a id="focusProjectLink" href="#" style="font-size: 12px; color: var(--accent); margin-left: 12px; display: none;" onclick="copyFocusLink(event)">Copy Link</a>
                    </h1>
                    <div class="panel-actions" style="display: flex; gap: 8px; align-items: center;">
                        <div style="position: relative;">
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="focusProjectSearch" placeholder="Search projects..."
                                    oninput="filterFocusProjects()" onfocus="showProjectList()"
                                    style="padding: 8px 12px; width: 200px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px 0 0 6px; color: var(--text-primary);">
                                <button class="btn btn-secondary" onclick="toggleProjectDropdown()" style="padding: 8px 12px; border-radius: 0 6px 6px 0;"></button>
                            </div>
                            <div id="focusProjectList" style="display: none; position: absolute; top: 100%; left: 0; width: 300px; max-height: 400px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; z-index: 100; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="loadProjectFocus(focusedProjectId)">Refresh</button>
                    </div>
                </div>

                <div id="focusContent" style="display: none;">
                    <!-- Project Info Bar -->
                    <div style="display: flex; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--text-secondary);">Status</div>
                            <span class="badge" id="focusProjectStatus">-</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--text-secondary);">Source Path</div>
                            <div id="focusProjectPath" style="font-size: 13px; font-family: monospace;">-</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--text-secondary);">Tech Stack</div>
                            <div id="focusProjectTech" style="font-size: 13px;">-</div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="showModal('focusNewFeature')">+ Add Feature</button>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="stats-grid" style="margin-bottom: 24px; grid-template-columns: repeat(5, 1fr);">
                        <div class="stat-item">
                            <div class="stat-value" id="focusTotalFeatures">0</div>
                            <div class="stat-label">Features</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="focusInProgress">0</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="focusCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="focusBugs">0</div>
                            <div class="stat-label">Open Bugs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="focusErrors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <!-- Left Column: Features -->
                        <div>
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header">
                                    <div class="card-title">Features</div>
                                    <div style="display: flex; gap: 8px;">
                                        <select id="focusFeatureFilter" onchange="filterFocusFeatures()" style="padding: 6px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                            <option value="">All Status</option>
                                            <option value="draft">Draft</option>
                                            <option value="in_progress">In Progress</option>
                                            <option value="review">Review</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th>Status</th>
                                                <th>Priority</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="focusFeaturesTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Feedback Section -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Feedback & Notes</div>
                                    <button class="btn btn-secondary" onclick="addFocusFeedback()">+ Add Note</button>
                                </div>
                                <div class="card-body">
                                    <div id="focusFeedbackList" style="max-height: 200px; overflow-y: auto;">
                                        <p style="color: var(--text-secondary); text-align: center;">No feedback yet</p>
                                    </div>
                                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                                        <input type="text" id="focusFeedbackInput" placeholder="Add feedback or note..." style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                        <button class="btn btn-primary" onclick="submitFocusFeedback()">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Quick Actions & Related -->
                        <div>
                            <!-- Server & Environment Status -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header">
                                    <div class="card-title">Environment Status</div>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="loadFocusServerStatus()">Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div id="focusServerStatus" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                        <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-size: 11px; color: var(--text-secondary);">Dashboard</div>
                                            <div id="focusDashboardStatus" style="font-size: 12px;">Checking...</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                            <div style="font-size: 11px; color: var(--text-secondary);">Project Server</div>
                                            <div id="focusProjectServerStatus" style="font-size: 12px;">N/A</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Active Workers</div>
                                    <div id="focusWorkersStatus" style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span style="padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 11px;">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Assign to tmux -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header">
                                    <div class="card-title">Work on Feature</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Select Feature</label>
                                        <select id="focusAssignFeature" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Assign to Session</label>
                                        <select id="focusAssignSession" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></select>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <button class="btn btn-primary" style="flex: 1;" onclick="queueFeature()">Add to Queue</button>
                                        <button class="btn btn-secondary" style="flex: 1;" onclick="assignFeatureToSession()">Send Direct</button>
                                    </div>
                                    <div style="margin-top: 8px;">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Quick Send:</div>
                                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="sendQuickCommand('list features')">List</button>
                                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="sendQuickCommand('run tests')">Test</button>
                                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="sendQuickCommand('git status')">Status</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- tmux Session Output -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header">
                                    <div class="card-title">Session Output</div>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="captureFocusSession()">Capture</button>
                                </div>
                                <div class="card-body">
                                    <pre id="focusSessionOutput" style="max-height: 150px; overflow-y: auto; background: var(--bg-primary); padding: 8px; border-radius: 4px; font-size: 11px; white-space: pre-wrap; color: var(--text-secondary);">Select a session and click Capture</pre>
                                </div>
                            </div>

                            <!-- Related Errors -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header">
                                    <div class="card-title">Related Errors</div>
                                </div>
                                <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                                    <div id="focusErrorsList">
                                        <p style="color: var(--text-secondary); text-align: center;">No errors</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Recent Activity</div>
                                </div>
                                <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                                    <div id="focusActivityList" class="activity-feed">
                                        <p style="color: var(--text-secondary); text-align: center;">No activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="focusEmpty" style="text-align: center; padding: 60px; color: var(--text-secondary);">
                    <div style="font-size: 32px; margin-bottom: 12px; opacity: 0.7;"></div>
                    <h3>Select a Project to Focus</h3>
                    <p>Choose a project from the dropdown above to view details, manage features, and track progress.</p>
                </div>
            </div>

            <!-- Documentation Panel -->
            <div class="panel" id="panel-docs">
                <div class="panel-header">
                    <h1 class="panel-title">Documentation</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="refreshDocumentation()">Refresh</button>
                        <button class="btn btn-secondary" onclick="updateDocumentation()">Update Docs</button>
                        <button class="btn btn-primary" onclick="copyDocumentation()">
                            <span id="copyDocsBtn">Copy to Clipboard</span>
                        </button>
                    </div>
                </div>

                <div class="docs-container">
                    <div class="docs-header">
                        <div class="docs-meta">
                            <span class="docs-version" id="docsVersion">v1.0.0</span>
                            <span class="docs-updated" id="docsUpdated">Updated: --</span>
                        </div>
                    </div>

                    <div class="docs-content" id="docsContent">
                        <!-- Documentation content loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- SOP Editor Panel -->
            <div class="panel" id="panel-sop">
                <div class="panel-header">
                    <h1 class="panel-title">Standard Operating Procedures</h1>
                    <div class="panel-actions">
                        <select id="sopFileSelect" onchange="loadSopFile(this.value)" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card);">
                            <option value="">Select SOP file...</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadSopList()">Refresh</button>
                        <button class="btn btn-primary" onclick="saveSopFile()" id="saveSopBtn" disabled>Save Changes</button>
                    </div>
                </div>

                <div class="sop-container" style="display: flex; gap: 20px; height: calc(100vh - 150px);">
                    <!-- SOP Editor -->
                    <div class="sop-editor-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none;">
                            <span id="sopFileName" style="font-weight: 600;">No file selected</span>
                            <span id="sopModified" style="margin-left: 12px; font-size: 12px; color: var(--text-secondary);"></span>
                        </div>
                        <textarea id="sopEditor" style="flex: 1; padding: 16px; font-family: monospace; font-size: 13px; line-height: 1.6; border: 1px solid var(--border); border-radius: 0 0 8px 8px; resize: none; background: var(--bg-card);" placeholder="Select an SOP file to edit..." oninput="markSopDirty()"></textarea>
                    </div>

                    <!-- SOP Preview -->
                    <div class="sop-preview-section" style="flex: 1; display: flex; flex-direction: column;">
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none;">
                            <span style="font-weight: 600;">Preview</span>
                            <button class="btn btn-sm" onclick="toggleSopPreview()" style="float: right; padding: 4px 8px; font-size: 11px;">Toggle</button>
                        </div>
                        <div id="sopPreview" style="flex: 1; padding: 16px; border: 1px solid var(--border); border-radius: 0 0 8px 8px; overflow-y: auto; background: var(--bg-card);">
                            <p style="color: var(--text-secondary);">Markdown preview will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports & Audits Panel -->
            <div class="panel" id="panel-reports">
                <div class="panel-header">
                    <h1 class="panel-title"> Reports & Audits</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="loadReports()">
                            <span></span> Refresh
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; height: calc(100vh - 150px);">
                    <!-- Reports List -->
                    <div style="width: 350px; display: flex; flex-direction: column; gap: 12px;">
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="font-size: 13px; color: var(--text-secondary);">Available Reports</div>
                            <div id="reportsCount" style="font-size: 24px; font-weight: 600; margin-top: 4px;">0</div>
                        </div>

                        <div id="reportsList" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                            <!-- Reports loaded dynamically -->
                        </div>
                    </div>

                    <!-- Report Viewer -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span id="reportFileName" style="font-weight: 600;">Select a report to view</span>
                                <span id="reportModified" style="margin-left: 12px; font-size: 12px; color: var(--text-secondary);"></span>
                            </div>
                            <button class="btn btn-sm" onclick="copyReportContent()" id="copyReportBtn" style="padding: 4px 8px; font-size: 11px;">Copy</button>
                        </div>
                        <div id="reportViewer" style="flex: 1; padding: 16px; border: 1px solid var(--border); border-radius: 0 0 8px 8px; overflow-y: auto; background: var(--bg-card); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6;">
                            <p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">Select a report from the list to view its contents</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Tracking Panel -->
            <div class="panel" id="panel-tokens">
                <div class="panel-header">
                    <h1 class="panel-title">Token Usage & Cost Tracking</h1>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="refreshTokenMetrics()">
                            <span></span> Refresh
                        </button>
                    </div>
                </div>

                <!-- Global Metrics Summary -->
                <div class="token-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="metric-card" style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Tokens/Hour</div>
                        <div style="font-size: 28px; font-weight: 600; margin-bottom: 4px;" id="tokensHourValue">0</div>
                        <div class="progress-bar" style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                            <div id="tokensHourProgress" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="tokensHourPercent">0%</span> of 500K limit
                        </div>
                    </div>

                    <div class="metric-card" style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Tokens/Day</div>
                        <div style="font-size: 28px; font-weight: 600; margin-bottom: 4px;" id="tokensDayValue">0</div>
                        <div class="progress-bar" style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                            <div id="tokensDayProgress" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="tokensDayPercent">0%</span> of 5M limit
                        </div>
                    </div>

                    <div class="metric-card" style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Cost/Hour</div>
                        <div style="font-size: 28px; font-weight: 600; margin-bottom: 4px;" id="costHourValue">$0.00</div>
                        <div class="progress-bar" style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                            <div id="costHourProgress" style="height: 100%; background: #4ade80; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="costHourPercent">0%</span> of $5.00 limit
                        </div>
                    </div>

                    <div class="metric-card" style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Cost/Day</div>
                        <div style="font-size: 28px; font-weight: 600; margin-bottom: 4px;" id="costDayValue">$0.00</div>
                        <div class="progress-bar" style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                            <div id="costDayProgress" style="height: 100%; background: #4ade80; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                            <span id="costDayPercent">0%</span> of $50.00 limit
                        </div>
                    </div>
                </div>

                <!-- Per-Session Metrics -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; margin-bottom: 16px;">Session Breakdown</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Session</th>
                                    <th>Tasks</th>
                                    <th>Tokens (Hour)</th>
                                    <th>Tokens (Day)</th>
                                    <th>Cost (Hour)</th>
                                    <th>Cost (Day)</th>
                                    <th>Throttle</th>
                                </tr>
                            </thead>
                            <tbody id="sessionMetricsTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        Loading session metrics...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Tasks with Token Details -->
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 16px;">Recent Tasks (Last 24 Hours)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Session</th>
                                    <th>Status</th>
                                    <th>Tokens In</th>
                                    <th>Tokens Out</th>
                                    <th>Cost</th>
                                    <th>Model</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="taskTokensTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        Loading task data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-newProject">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New Project</h2>
                <button class="modal-close" onclick="hideModal('newProject')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="newProjectName" placeholder="My Project">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="newProjectDescription" placeholder="Project description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Source Path (optional)</label>
                    <input type="text" id="newProjectPath" placeholder="/path/to/project">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newProject')">Cancel</button>
                <button class="btn btn-primary" onclick="createProject()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-editProject">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Project</h2>
                <button class="modal-close" onclick="hideModal('editProject')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProjectId">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="editProjectName" placeholder="My Project">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editProjectDescription" placeholder="Project description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Source Path (optional)</label>
                    <input type="text" id="editProjectPath" placeholder="/path/to/project">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editProjectStatus">
                        <option value="active">Active</option>
                        <option value="planning">Planning</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="archiveProject()" style="margin-right: auto;">Archive</button>
                <button class="btn btn-secondary" onclick="hideModal('editProject')">Cancel</button>
                <button class="btn btn-primary" onclick="updateProject()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Project Members/Permissions Modal -->
    <div class="modal-overlay" id="modal-projectMembers">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Project Access Control</h2>
                <button class="modal-close" onclick="hideModal('projectMembers')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="projectMembersProjectId">
                <div id="projectMembersProjectName" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;"></div>

                <!-- Access Summary -->
                <div id="projectAccessSummary" style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;"></div>

                <!-- Add Member Form -->
                <div class="card" style="margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary);">
                    <h4 style="margin-bottom: 12px;">Add Member</h4>
                    <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                            <label style="font-size: 12px;">User</label>
                            <select id="addMemberUserId" style="width: 100%;">
                                <option value="">Select user...</option>
                            </select>
                        </div>
                        <div class="form-group" style="width: 140px; margin: 0;">
                            <label style="font-size: 12px;">Access Level</label>
                            <select id="addMemberLevel">
                                <option value="read">Read</option>
                                <option value="write">Write</option>
                                <option value="admin">Admin</option>
                                <option value="owner">Owner</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addProjectMember()">Add</button>
                    </div>
                </div>

                <!-- Current Members List -->
                <h4 style="margin-bottom: 12px;">Current Members</h4>
                <div id="projectMembersList">
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading...</div>
                </div>

                <!-- Pending Invitations -->
                <div id="projectInvitationsSection" style="margin-top: 20px; display: none;">
                    <h4 style="margin-bottom: 12px;">Pending Invitations</h4>
                    <div id="projectInvitationsList"></div>
                </div>

                <!-- Permission Log -->
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: var(--text-secondary); font-size: 13px;">Permission History</summary>
                    <div id="projectPermissionLog" style="margin-top: 12px; max-height: 200px; overflow-y: auto;"></div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('projectMembers')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-newFeature">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New Feature</h2>
                <button class="modal-close" onclick="hideModal('newFeature')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project</label>
                    <select id="newFeatureProject"></select>
                </div>
                <div class="form-group">
                    <label>Feature Name</label>
                    <input type="text" id="newFeatureName" placeholder="Feature name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="newFeatureDescription" placeholder="Feature description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="newFeaturePriority">
                        <option value="0">Normal</option>
                        <option value="1">High</option>
                        <option value="2">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newFeature')">Cancel</button>
                <button class="btn btn-primary" onclick="createFeature()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-editFeature">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Feature</h2>
                <button class="modal-close" onclick="hideModal('editFeature')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editFeatureId">
                <div class="form-group">
                    <label>Feature Name</label>
                    <input type="text" id="editFeatureName" placeholder="Feature name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editFeatureDescription" placeholder="Feature description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editFeatureStatus">
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="editFeaturePriority">
                        <option value="0">Normal</option>
                        <option value="1">High</option>
                        <option value="2">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('editFeature')">Cancel</button>
                <button class="btn btn-primary" onclick="updateFeature()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-focusNewFeature">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Feature to <span id="focusModalProjectName"></span></h2>
                <button class="modal-close" onclick="hideModal('focusNewFeature')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Feature Name</label>
                    <input type="text" id="focusNewFeatureName" placeholder="Feature name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="focusNewFeatureDescription" placeholder="What should this feature do?"></textarea>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="focusNewFeaturePriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="focusNewFeatureStatus">
                        <option value="draft">Draft</option>
                        <option value="in_progress">In Progress</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('focusNewFeature')">Cancel</button>
                <button class="btn btn-primary" onclick="createFocusFeature()">Add Feature</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-newBug">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New Bug</h2>
                <button class="modal-close" onclick="hideModal('newBug')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project</label>
                    <select id="newBugProject"></select>
                </div>
                <div class="form-group">
                    <label>Bug Title</label>
                    <input type="text" id="newBugTitle" placeholder="Bug title">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="newBugDescription" placeholder="Bug description and steps to reproduce..."></textarea>
                </div>
                <div class="form-group">
                    <label>Severity</label>
                    <select id="newBugSeverity">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newBug')">Cancel</button>
                <button class="btn btn-primary" onclick="createBug()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-editBug">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Bug</h2>
                <button class="modal-close" onclick="hideModal('editBug')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Bug Title</label>
                    <input type="text" id="editBugTitle" placeholder="Bug title">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editBugDescription" placeholder="Bug description and steps to reproduce..."></textarea>
                </div>
                <div class="form-group">
                    <label>Severity</label>
                    <select id="editBugSeverity">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editBugStatus">
                        <option value="open">Open</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('editBug')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditBug()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-newTmuxSession">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New tmux Session</h2>
                <button class="modal-close" onclick="hideModal('newTmuxSession')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Session Name</label>
                    <input type="text" id="newTmuxSessionName" placeholder="session-name">
                </div>
                <div class="form-group">
                    <label>Initial Command (optional)</label>
                    <input type="text" id="newTmuxSessionCommand" placeholder="bash">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newTmuxSession')">Cancel</button>
                <button class="btn btn-primary" onclick="createTmuxSession()">Create</button>
            </div>
        </div>
    </div>

    <!-- New Task Modal -->
    <div class="modal-overlay" id="modal-newTask">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New Task</h2>
                <button class="modal-close" onclick="hideModal('newTask')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Type</label>
                    <select id="newTaskType">
                        <option value="shell">Shell Command</option>
                        <option value="python">Python Script</option>
                        <option value="git">Git Operation</option>
                        <option value="deploy">Deployment</option>
                        <option value="test">Run Tests</option>
                        <option value="build">Build</option>
                        <option value="tmux">tmux Command</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Command / Data</label>
                    <textarea id="newTaskData" rows="4" placeholder="Enter command or JSON data..."></textarea>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="newTaskPriority">
                        <option value="0">Normal</option>
                        <option value="1">High</option>
                        <option value="2">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Risk Level</label>
                    <select id="newTaskRiskLevel">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Attachments <span style="color: var(--text-secondary); font-weight: normal;">(optional)</span></label>
                    <div class="attachment-upload-area" id="newTaskAttachmentArea">
                        <input type="file" id="newTaskAttachments" multiple style="display: none;" onchange="handleTaskFileSelect(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('newTaskAttachments').click()">
                             Add Files
                        </button>
                        <span style="margin-left: 10px; color: var(--text-secondary); font-size: 12px;">Max 16MB per file</span>
                        <div id="newTaskFileList" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newTask')">Cancel</button>
                <button class="btn btn-primary" onclick="createTaskWithAttachments()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Task Details Modal with Attachments -->
    <div class="modal-overlay" id="modal-taskDetails">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Task Details</h2>
                <button class="modal-close" onclick="hideModal('taskDetails')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="taskDetailsContent">Loading...</div>
                <div class="form-group" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
                    <label>Attachments</label>
                    <div id="taskAttachmentsList" style="margin-bottom: 10px;">
                        <span style="color: var(--text-secondary);">Loading attachments...</span>
                    </div>
                    <div class="attachment-upload-area">
                        <input type="file" id="taskDetailAttachment" multiple style="display: none;" onchange="uploadTaskAttachment(event)">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('taskDetailAttachment').click()">
                             Upload Files
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('taskDetails')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-newNode">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Node</h2>
                <button class="modal-close" onclick="hideModal('newNode')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Hostname</label>
                    <input type="text" id="newNodeHostname" placeholder="node-1">
                </div>
                <div class="form-group">
                    <label>IP Address</label>
                    <input type="text" id="newNodeIP" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label>SSH Port</label>
                    <input type="number" id="newNodePort" value="22">
                </div>
                <div class="form-group">
                    <label>SSH User</label>
                    <input type="text" id="newNodeUser" placeholder="root">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="newNodeRole">
                        <option value="worker">Worker</option>
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newNode')">Cancel</button>
                <button class="btn btn-primary" onclick="addNode()">Add Node</button>
            </div>
        </div>
    </div>

    <!-- Critical Item Detail Modal -->
    <div class="modal-overlay" id="modal-criticalDetail">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="criticalDetailTitle">Critical Item</h2>
                <button class="modal-close" onclick="hideModal('criticalDetail')">&times;</button>
            </div>
            <div class="modal-body" id="criticalDetailBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer" id="criticalDetailFooter">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-assignTmux">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Assign to tmux Session</h2>
                <button class="modal-close" onclick="hideModal('assignTmux')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Session</label>
                    <select id="assignTmuxSession"></select>
                </div>
                <div class="form-group">
                    <label>Message (optional)</label>
                    <textarea id="assignTmuxMessage" placeholder="Custom message to send..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('assignTmux')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAssignToTmux()">Assign</button>
            </div>
        </div>
    </div>

    <!-- Error Detail Modal -->
    <div class="modal-overlay" id="modal-errorDetail">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Error Details</h2>
                <button class="modal-close" onclick="hideModal('errorDetail')">&times;</button>
            </div>
            <div class="modal-body" id="errorDetailBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer" id="errorDetailFooter">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Fullscreen Tmux Terminal Modal -->
    <div class="modal-overlay" id="modal-tmuxFullscreen" style="background: rgba(0,0,0,0.95);">
        <div style="width: 100%; height: 100%; max-width: none; display: flex; flex-direction: column; background: #0a0a0a; border-radius: 0;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #1a1a2e; border-bottom: 2px solid #e94560;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5em;"></span>
                    <div>
                        <h2 style="margin: 0; font-size: 1.1rem; color: #e94560;">Terminal Session</h2>
                        <span id="fullscreenTmuxSession" style="color: #aaa; font-size: 0.9rem;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn btn-secondary" onclick="captureTmuxFullscreen(document.getElementById('fullscreenTmuxSession').textContent)" style="padding: 8px 16px;"> Refresh</button>
                    <button class="btn btn-danger" onclick="closeTmuxFullscreen()" style="padding: 8px 16px;"> Close</button>
                </div>
            </div>

            <!-- Terminal Output -->
            <div id="fullscreenTmuxOutput" class="terminal-output terminal-container" style="flex: 1; overflow-y: auto; padding: 20px 24px; font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Liberation Mono', monospace; font-size: 14px; line-height: 1.7; background: #0d1117; color: #c9d1d9; white-space: pre-wrap; word-break: break-word; letter-spacing: 0.02em;"></div>

            <!-- Controls -->
            <div style="background: #1a1a2e; padding: 12px 16px; border-top: 1px solid #333;">
                <!-- Special Keys -->
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                    <button class="special-key" style="background: var(--primary); color: white;" onclick="sendFullscreenKey('Enter')">Enter </button>
                    <button class="special-key" onclick="sendFullscreenKey('Escape')">Esc</button>
                    <button class="special-key" onclick="sendFullscreenKey('Tab')">Tab</button>
                    <button class="special-key" onclick="sendFullscreenKey('C-c')">Ctrl+C</button>
                    <button class="special-key" onclick="sendFullscreenKey('C-d')">Ctrl+D</button>
                    <button class="special-key" onclick="sendFullscreenKey('C-z')">Ctrl+Z</button>
                    <button class="special-key" onclick="sendFullscreenKey('C-l')">Ctrl+L</button>
                    <button class="special-key" onclick="sendFullscreenKey('Up')"></button>
                    <button class="special-key" onclick="sendFullscreenKey('Down')"></button>
                    <button class="special-key" onclick="sendFullscreenKey('Left')"></button>
                    <button class="special-key" onclick="sendFullscreenKey('Right')"></button>
                </div>

                <!-- Quick Commands -->
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                    <button class="quick-cmd quick-yes" onclick="sendFullscreenQuick('y')"> yes</button>
                    <button class="quick-cmd quick-no" onclick="sendFullscreenQuick('n')"> no</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('continue')"> continue</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('/status')"> /status</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('/help')"> /help</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('/clear')"> /clear</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('q')">quit</button>
                    <button class="quick-cmd" onclick="sendFullscreenQuick('exit')">exit</button>
                </div>

                <!-- Input -->
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="fullscreenTmuxInput"
                        placeholder="Type command (speech-to-text compatible)..."
                        style="flex: 1; padding: 14px 16px; font-size: 16px; border-radius: 8px; border: 1px solid #444; background: #1e1e2e; color: #fff;"
                        autocomplete="off" autocorrect="on" autocapitalize="off" spellcheck="true"
                        onkeydown="if(event.key==='Enter'){event.preventDefault(); sendTmuxFullscreenCommand();}">
                    <button class="btn btn-primary" style="padding: 14px 28px; font-size: 16px; font-weight: bold;" onclick="sendTmuxFullscreenCommand()">Send </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Secret Modal -->
    <div class="modal-overlay" id="modal-newSecret">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Secret</h2>
                <button class="modal-close" onclick="hideModal('newSecret')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name <span style="color: #ff7b72;">*</span></label>
                    <input type="text" id="newSecretName" placeholder="e.g., OPENAI_API_KEY">
                </div>
                <div class="form-group">
                    <label>Value <span style="color: #ff7b72;">*</span></label>
                    <div style="position: relative;">
                        <input type="password" id="newSecretValue" placeholder="Secret value (will be encrypted)">
                        <button type="button" onclick="toggleSecretVisibility('newSecretValue')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer;"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="newSecretCategory">
                        <option value="general">General</option>
                        <option value="api_key">API Key</option>
                        <option value="password">Password</option>
                        <option value="token">Token</option>
                        <option value="certificate">Certificate</option>
                        <option value="ssh_key">SSH Key</option>
                        <option value="env_var">Environment Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project (Optional)</label>
                    <select id="newSecretProject">
                        <option value="">No specific project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="newSecretDescription" placeholder="What is this secret used for?"></textarea>
                </div>
                <div class="form-group">
                    <label>Expires At (Optional)</label>
                    <input type="datetime-local" id="newSecretExpires">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('newSecret')">Cancel</button>
                <button class="btn btn-primary" onclick="createSecret()">Add Secret</button>
            </div>
        </div>
    </div>

    <!-- Edit Secret Modal -->
    <div class="modal-overlay" id="modal-editSecret">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Secret</h2>
                <button class="modal-close" onclick="hideModal('editSecret')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSecretId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editSecretName" placeholder="Secret name">
                </div>
                <div class="form-group">
                    <label>New Value (leave blank to keep current)</label>
                    <div style="position: relative;">
                        <input type="password" id="editSecretValue" placeholder="New value (optional)">
                        <button type="button" onclick="toggleSecretVisibility('editSecretValue')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer;"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="editSecretCategory">
                        <option value="general">General</option>
                        <option value="api_key">API Key</option>
                        <option value="password">Password</option>
                        <option value="token">Token</option>
                        <option value="certificate">Certificate</option>
                        <option value="ssh_key">SSH Key</option>
                        <option value="env_var">Environment Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="editSecretProject">
                        <option value="">No specific project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editSecretDescription" placeholder="Description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('editSecret')">Cancel</button>
                <button class="btn btn-primary" onclick="updateSecret()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- View Secret Modal -->
    <div class="modal-overlay" id="modal-viewSecret">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Secret Value</h2>
                <button class="modal-close" onclick="hideModal('viewSecret')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Secret Name</span>
                        <span id="viewSecretName" style="font-weight: 600;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Category</span>
                        <span id="viewSecretCategory" class="badge"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Decrypted Value</label>
                    <div style="position: relative;">
                        <input type="password" id="viewSecretValue" readonly style="background: #0d1117; font-family: monospace;">
                        <button type="button" onclick="toggleSecretVisibility('viewSecretValue')" style="position: absolute; right: 40px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer;"></button>
                        <button type="button" onclick="copySecretValue()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer;"></button>
                    </div>
                    <p style="font-size: 11px; color: #ff7b72; margin-top: 8px;">This access has been logged for security purposes.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('viewSecret')">Close</button>
            </div>
        </div>
    </div>

    <!-- Status Narrator Blob - Collapsible -->
    <div id="narratorContainer" style="position: fixed; bottom: 90px; right: 20px; z-index: 9998; display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
        <!-- Main narrator button - toggles speech on/off -->
        <div id="narratorBlob" title="Speech narrator OFF - click to enable" style="
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #21262d, #161b22);
            border: 3px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            user-select: none;
            -webkit-user-select: none;
        "></div>
        <!-- Collapse/minimize toggle -->
        <button id="narratorToggle" onclick="toggleNarratorWidget()" title="Hide status button" style="
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary, #21262d);
            border: 1px solid var(--border, #30363d);
            color: var(--text-secondary, #8b949e);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        "></button>
    </div>
    <!-- Minimized narrator indicator -->
    <button id="narratorMinimized" onclick="toggleNarratorWidget()" title="Show status button" style="
        display: none;
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg-tertiary, #21262d);
        border: 1px solid var(--border, #30363d);
        color: var(--text-secondary, #8b949e);
        font-size: 14px;
        cursor: pointer;
        z-index: 9998;
        transition: all 0.2s ease;
        align-items: center;
        justify-content: center;
    " onmouseover="this.style.borderColor='var(--success, #3fb950)';this.style.color='var(--success, #3fb950)'" onmouseout="this.style.borderColor='var(--border, #30363d)';this.style.color='var(--text-secondary, #8b949e)'"></button>

    <!-- Narrator Panel -->
    <div id="narratorPanel" style="display: none; position: fixed; bottom: 160px; right: 20px; width: 380px; max-height: 70vh; background: var(--bg-card, #161b22); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 9997; overflow: hidden; border: 1px solid var(--border, #30363d);">
        <div style="padding: 16px 20px; background: linear-gradient(135deg, #238636, #2ea043); display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;"></span>
                <div>
                    <div style="font-weight: 600; color: white;">System Status</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);" id="narratorTime">Updated just now</div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="speakStatus()" id="speakBtn" title="Listen" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 16px; cursor: pointer;"></button>
                <button onclick="toggleNarratorPanel()" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 18px; cursor: pointer;"></button>
            </div>
        </div>
        <div style="padding: 20px; overflow-y: auto; max-height: calc(70vh - 80px);">
            <div id="narratorHealth" style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 8px;"></div>
                <div style="font-size: 18px; font-weight: 600; color: var(--green, #3fb950);">System Healthy</div>
            </div>
            <div style="display: flex; justify-content: center; margin-bottom: 24px;">
                <div style="position: relative; width: 120px; height: 120px;">
                    <svg width="120" height="120" style="transform: rotate(-90deg);">
                        <circle cx="60" cy="60" r="50" stroke="var(--border, #30363d)" stroke-width="10" fill="none"/>
                        <circle id="progressRing" cx="60" cy="60" r="50" stroke="var(--accent, #58a6ff)" stroke-width="10" fill="none" stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round" style="transition: stroke-dashoffset 1s ease;"/>
                    </svg>
                    <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <span id="progressPercent" style="font-size: 28px; font-weight: 700; color: var(--text-primary);">0%</span>
                        <span style="font-size: 11px; color: var(--text-secondary);">Complete</span>
                    </div>
                </div>
            </div>
            <div id="narratorStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;"></div>
            <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Active Sessions</div>
                <div id="narratorSessions" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
            <div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Summary</div>
                <div id="narratorSummary" style="font-size: 13px; color: var(--text-primary); line-height: 1.6; background: var(--bg-tertiary); padding: 12px; border-radius: 8px;"></div>
            </div>
        </div>
        <div id="speakingIndicator" style="display: none; padding: 16px 20px; background: linear-gradient(135deg, #1a2233, #0d1117); border-top: 1px solid var(--border); text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="speaking-wave" style="display: flex; gap: 2px; height: 16px; align-items: center;">
                        <span style="width: 3px; height: 8px; background: var(--accent); border-radius: 2px; animation: wave 0.5s ease-in-out infinite;"></span>
                        <span style="width: 3px; height: 16px; background: var(--accent); border-radius: 2px; animation: wave 0.5s ease-in-out 0.1s infinite;"></span>
                        <span style="width: 3px; height: 10px; background: var(--accent); border-radius: 2px; animation: wave 0.5s ease-in-out 0.2s infinite;"></span>
                        <span style="width: 3px; height: 14px; background: var(--accent); border-radius: 2px; animation: wave 0.5s ease-in-out 0.3s infinite;"></span>
                    </span>
                    <span style="color: var(--accent); font-weight: 500;">Speaking...</span>
                </div>
                <button onclick="stopSpeaking()" style="background: var(--error, #f85149); border: none; color: white; cursor: pointer; font-size: 13px; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                     Stop
                </button>
            </div>
        </div>
        <style>
            @keyframes wave { 0%, 100% { height: 8px; } 50% { height: 16px; } }
        </style>
    </div>

    <style>
        /* Narrator blob states */
        #narratorBlob {
            background: linear-gradient(135deg, #484f58, #6e7681);
            box-shadow: 0 4px 12px rgba(110, 118, 129, 0.3);
        }
        #narratorBlob.active {
            background: linear-gradient(135deg, #238636, #2ea043);
            box-shadow: 0 4px 20px rgba(35, 134, 54, 0.5);
            animation: blob-pulse 3s infinite ease-in-out;
        }
        @keyframes blob-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(35, 134, 54, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 6px 30px rgba(35, 134, 54, 0.7); }
        }
        #narratorBlob:hover { transform: scale(1.15) !important; }
        #narratorBlob.speaking { animation: blob-speaking 0.5s infinite ease-in-out; background: linear-gradient(135deg, #58a6ff, #388bfd); }
        @keyframes blob-speaking { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .stat-card { background: var(--bg-tertiary, #0d1117); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border, #30363d); }
        .stat-card .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .stat-card .stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .session-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-tertiary); border-radius: 16px; font-size: 12px; color: var(--text-primary); }
        .session-chip .dot { width: 8px; height: 8px; border-radius: 50%; }
        .session-chip .dot.active { background: var(--green, #3fb950); }
        .session-chip .dot.busy { background: var(--accent, #58a6ff); animation: pulse 1.5s infinite; }
        .session-chip .dot.idle { background: var(--text-secondary, #8b949e); }
    </style>

    <!-- Feedback Widget - Collapsible -->
    <div id="feedbackContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
        <!-- Main feedback button -->
        <button id="feedbackBtn" onclick="openFeedbackWidget()" title="Report Bug / Give Feedback" style="
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f85149, #da3633);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(248, 81, 73, 0.4);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            
        </button>
        <!-- Collapse/minimize toggle -->
        <button id="feedbackToggle" onclick="toggleFeedbackWidget()" title="Hide feedback button" style="
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary, #21262d);
            border: 1px solid var(--border, #30363d);
            color: var(--text-secondary, #8b949e);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        "></button>
    </div>
    <!-- Minimized feedback indicator -->
    <button id="feedbackMinimized" onclick="toggleFeedbackWidget()" title="Show feedback button" style="
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg-tertiary, #21262d);
        border: 1px solid var(--border, #30363d);
        color: var(--text-secondary, #8b949e);
        font-size: 14px;
        cursor: pointer;
        z-index: 9999;
        transition: all 0.2s ease;
        align-items: center;
        justify-content: center;
    " onmouseover="this.style.borderColor='var(--accent, #58a6ff)';this.style.color='var(--accent, #58a6ff)'" onmouseout="this.style.borderColor='var(--border, #30363d)';this.style.color='var(--text-secondary, #8b949e)'"></button>

    <!-- Feedback Modal -->
    <div id="feedbackOverlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; backdrop-filter: blur(4px);" onclick="if(event.target===this)closeFeedbackWidget()">
        <div id="feedbackModal" style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card, #161b22);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 48px rgba(0,0,0,0.4);
        ">
            <!-- Header -->
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border, #30363d); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; color: var(--text-primary, #fff);"> Report Bug / Feedback</h2>
                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-secondary, #8b949e);">Describe the issue and highlight the problem area</p>
                </div>
                <button onclick="closeFeedbackWidget()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <!-- Body -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                <!-- Step 1: Description -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary, #fff); margin-bottom: 8px;">
                        1. Describe the issue
                        <span style="font-weight: normal; color: var(--text-secondary);">(speak or type)</span>
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <textarea id="feedbackText" placeholder="Click the microphone to speak or type your feedback here..."
                            style="flex: 1; min-height: 100px; padding: 12px; font-size: 14px; border-radius: 8px; border: 1px solid var(--border, #30363d); background: var(--bg-tertiary, #0d1117); color: var(--text-primary, #fff); resize: vertical; font-family: inherit;"></textarea>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button id="voiceBtn" onclick="toggleVoiceInput()" title="Voice input" style="
                                width: 48px;
                                height: 48px;
                                border-radius: 50%;
                                border: 2px solid var(--border, #30363d);
                                background: var(--bg-tertiary, #0d1117);
                                color: var(--text-secondary);
                                font-size: 20px;
                                cursor: pointer;
                                transition: all 0.2s;
                            "></button>
                            <div id="voiceStatus" style="font-size: 10px; text-align: center; color: var(--text-secondary);">Click to speak</div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Screenshot -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary, #fff); margin-bottom: 8px;">
                        2. Capture & annotate screenshot
                        <span style="font-weight: normal; color: var(--text-secondary);">(click areas to highlight)</span>
                    </label>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <button onclick="captureScreenshot()" class="btn btn-primary" style="padding: 10px 16px;"> Capture Screenshot</button>
                        <button onclick="clearAnnotations()" class="btn btn-secondary" style="padding: 10px 16px;" id="clearAnnotationsBtn" disabled> Clear Marks</button>
                        <div style="flex: 1;"></div>
                        <div id="annotationTools" style="display: none; gap: 8px;">
                            <button onclick="setAnnotationTool('highlight')" class="annotation-tool active" data-tool="highlight" title="Highlight area"></button>
                            <button onclick="setAnnotationTool('circle')" class="annotation-tool" data-tool="circle" title="Circle area"></button>
                            <button onclick="setAnnotationTool('arrow')" class="annotation-tool" data-tool="arrow" title="Draw arrow"></button>
                        </div>
                    </div>
                    <div id="screenshotContainer" style="
                        position: relative;
                        background: var(--bg-tertiary, #0d1117);
                        border: 2px dashed var(--border, #30363d);
                        border-radius: 8px;
                        min-height: 200px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        overflow: hidden;
                    ">
                        <div id="screenshotPlaceholder" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 12px;"></div>
                            <div>Click "Capture Screenshot" to take a snapshot</div>
                            <div style="font-size: 12px; margin-top: 8px;">Then click on problem areas to highlight them</div>
                        </div>
                        <canvas id="screenshotCanvas" style="display: none; max-width: 100%; cursor: crosshair;"></canvas>
                    </div>
                </div>

                <!-- Step 3: Category -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary, #fff); margin-bottom: 8px;">
                        3. Category & Priority
                    </label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <select id="feedbackCategory" style="flex: 1; min-width: 150px; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);">
                            <option value="bug"> Bug</option>
                            <option value="ui"> UI Issue</option>
                            <option value="feature"> Feature Request</option>
                            <option value="performance"> Performance</option>
                            <option value="other"> Other</option>
                        </select>
                        <select id="feedbackPriority" style="flex: 1; min-width: 150px; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);">
                            <option value="low"> Low Priority</option>
                            <option value="medium" selected> Medium Priority</option>
                            <option value="high"> High Priority</option>
                            <option value="critical"> Critical</option>
                        </select>
                        <select id="feedbackProject" style="flex: 1; min-width: 150px; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);">
                            <option value="">Select Project...</option>
                        </select>
                    </div>
                </div>

                <!-- Context info (auto-filled) -->
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                    <strong>Auto-captured context:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 8px;">
                        <span> Page: <span id="feedbackPage">-</span></span>
                        <span> Screen: <span id="feedbackScreen">-</span></span>
                        <span> Time: <span id="feedbackTime">-</span></span>
                        <span> Browser: <span id="feedbackBrowser">-</span></span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 16px 24px; border-top: 1px solid var(--border, #30363d); display: flex; justify-content: space-between; align-items: center;">
                <button onclick="closeFeedbackWidget()" class="btn btn-secondary">Cancel</button>
                <button onclick="submitFeedback()" class="btn btn-primary" style="padding: 12px 32px; font-size: 15px;">
                     Submit Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Start Wrapped Session Modal -->
    <div class="modal-overlay" id="modal-startWrapper">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Start Wrapped Claude Session</h2>
                <button class="modal-close" onclick="hideModal('startWrapper')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Session Name</label>
                    <input type="text" id="wrapperSessionName" placeholder="my_worker" value="">
                    <small style="color: var(--text-secondary); font-size: 11px;">tmux session name (alphanumeric and underscores)</small>
                </div>
                <div class="form-group">
                    <label>Auto-Response Mode</label>
                    <select id="wrapperAutoMode">
                        <option value="auto_respond">Auto-Respond (Safe operations only)</option>
                        <option value="approve_all">Approve All (Dangerous patterns still blocked)</option>
                        <option value="none">Manual (No auto-response)</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 11px;">How the wrapper handles permission prompts</small>
                </div>
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 12px;">
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <strong style="color: var(--text-primary);">Wrapper Features:</strong>
                        <ul style="margin: 8px 0 0 16px; padding: 0;">
                            <li>Auto-approves safe operations (git, read, edit, etc.)</li>
                            <li>Blocks dangerous commands (rm -rf /, etc.)</li>
                            <li>Logs all prompts and responses</li>
                            <li>Hot-reloadable configuration</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('startWrapper')">Cancel</button>
                <button class="btn btn-primary" onclick="startWrappedSession()">Start Session</button>
            </div>
        </div>
    </div>

    <!-- Annotation tool styles -->
    <style>
        .annotation-tool {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--border, #30363d);
            background: var(--bg-tertiary, #0d1117);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.15s;
        }
        .annotation-tool:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }
        .annotation-tool.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        #voiceBtn.recording {
            background: #f85149 !important;
            border-color: #f85149 !important;
            animation: pulse-recording 1s infinite;
        }
        @keyframes pulse-recording {
            0%, 100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(248, 81, 73, 0); }
        }
    </style>

    <!-- Centralized Data Store -->
    <script src="{{ url_for('static', filename='js/dataStore.js') }}"></script>
    <!-- Dashboard Refresh Manager -->
    <script src="{{ url_for('static', filename='js/dashboardRefresh.js') }}"></script>
    <!-- System Overview Component -->
    <script src="{{ url_for('static', filename='js/systemOverview.js') }}"></script>
    <!-- Table Search & Filter Functions -->
    <script src="{{ url_for('static', filename='js/tableFilters.js') }}"></script>

    <script>
        // State
        let currentProject = 'all';
        let currentPanel = 'overview';
        let projects = [];
        let tmuxSessions = [];
        let assignContext = null;

        // Forward declarations for functions called via onclick (defined later in the file)
        var refreshQueue = async function() { console.warn('refreshQueue not yet loaded'); };
        var toggleQueueAutoRefresh = function(enabled) { console.warn('toggleQueueAutoRefresh not yet loaded'); };
        var refreshLiveTaskMonitor = async function() { console.warn('refreshLiveTaskMonitor not yet loaded'); };
        var toggleLiveMonitorAutoRefresh = function(enabled) { console.warn('toggleLiveMonitorAutoRefresh not yet loaded'); };

        // ========================================
        // Live Task Monitor
        // ========================================
        let liveMonitorInterval = null;
        let liveMonitorAutoRefreshEnabled = true;

        async function fetchLiveTaskStatus() {
            try {
                const response = await fetch('/api/tasks/live-status');
                const data = await response.json();
                if (data.success) {
                    return data.tasks;
                }
                return [];
            } catch (error) {
                console.error('Error fetching live task status:', error);
                return [];
            }
        }

        function getStatusColor(status) {
            const colors = {
                'working': 'var(--green)',
                'idle': 'var(--accent)',
                'error': 'var(--red)',
                'completed': 'var(--text-secondary)',
                'unknown': 'var(--yellow)'
            };
            return colors[status] || colors['unknown'];
        }

        function getStatusIcon(status) {
            const icons = {
                'working': '',
                'idle': '',
                'error': '',
                'completed': '',
                'unknown': ''
            };
            return icons[status] || icons['unknown'];
        }

        function renderLiveTaskCard(task) {
            const statusClass = task.status;
            const progressPercent = Math.max(0, Math.min(100, task.progress));

            return `
                <div class="task-monitor-card ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">
                                Task #${task.task_id} - ${task.session}
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                                ${task.description}
                            </div>
                        </div>
                        <div style="margin-left: 8px;">
                            <span style="font-size: 16px;" title="${task.status}">${getStatusIcon(task.status)}</span>
                        </div>
                    </div>
                    <div class="task-progress-bar">
                        <div class="task-progress-fill ${statusClass}" style="width: ${progressPercent}%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 11px;">
                        <div style="color: var(--text-secondary); flex: 1; min-width: 0;">
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${task.current_step}">
                                ${task.current_step}
                            </div>
                        </div>
                        <div style="color: ${getStatusColor(task.status)}; font-weight: 600; margin-left: 8px;">
                            ${progressPercent}%
                        </div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 6px;">
                        Last update: ${task.last_activity ? new Date(task.last_activity).toLocaleTimeString() : 'Never'}
                    </div>
                </div>
            `;
        }

        refreshLiveTaskMonitor = async function() {
            const tasks = await fetchLiveTaskStatus();
            const grid = document.getElementById('liveTaskGrid');
            const statusDot = document.getElementById('liveMonitorStatus');
            const lastUpdate = document.getElementById('liveMonitorLastUpdate');

            if (!grid) return;

            if (tasks.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; grid-column: span 2;">No tasks being monitored</div>';
                return;
            }

            grid.innerHTML = tasks.map(task => renderLiveTaskCard(task)).join('');

            // Update status indicator
            const hasWorking = tasks.some(t => t.status === 'working');
            const hasErrors = tasks.some(t => t.status === 'error');

            if (hasErrors) {
                statusDot.style.background = 'var(--red)';
            } else if (hasWorking) {
                statusDot.style.background = 'var(--green)';
            } else {
                statusDot.style.background = 'var(--accent)';
            }

            lastUpdate.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        };

        toggleLiveMonitorAutoRefresh = function(enabled) {
            liveMonitorAutoRefreshEnabled = enabled;

            if (liveMonitorInterval) {
                clearInterval(liveMonitorInterval);
                liveMonitorInterval = null;
            }

            if (enabled) {
                liveMonitorInterval = setInterval(refreshLiveTaskMonitor, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Reduced from 10s // 10 seconds
                refreshLiveTaskMonitor(); // Immediate refresh
            }
        };

        // Initialize live monitor when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                refreshLiveTaskMonitor();
                toggleLiveMonitorAutoRefresh(true);
            }, 1000);
        });

        // ========================================
        // Socket.IO Real-time Updates Manager
        // ========================================
        const SocketManager = {
            socket: null,
            connected: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            currentRooms: new Set(),

            init() {
                if (typeof io === 'undefined') {
                    console.warn('[Socket] socket.io client not loaded, using polling fallback');
                    return;
                }

                try {
                    this.socket = io({
                        transports: ['websocket', 'polling'],
                        reconnection: true,
                        reconnectionAttempts: this.maxReconnectAttempts,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000
                    });

                    this.socket.on('connect', () => {
                        console.log('[Socket] Connected to server');
                        this.connected = true;
                        this.reconnectAttempts = 0;
                        this.updateIndicator(true);

                        // Rejoin rooms based on current panel after reconnect
                        const panelRoomMap = {
                            'overview': ['stats', 'activity'],
                            'errors': ['errors', 'stats'],
                            'tmux': ['tmux'],
                            'queue': ['queue', 'stats'],
                            'nodes': ['nodes'],
                            'features': ['stats'],
                            'bugs': ['stats']
                        };

                        const rooms = panelRoomMap[currentPanel] || ['stats', 'tasks'];
                        console.log(`[Socket] Rejoining rooms for panel ${currentPanel}:`, rooms);
                        rooms.forEach(room => this.joinRoom(room));
                    });

                    this.socket.on('disconnect', (reason) => {
                        console.log('[Socket] Disconnected:', reason);
                        this.connected = false;
                        this.updateIndicator(false);
                    });

                    this.socket.on('connect_error', (error) => {
                        console.warn('[Socket] Connection error:', error.message);
                        this.reconnectAttempts++;
                        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                            console.log('[Socket] Max reconnects reached, using polling');
                        }
                    });

                    // Data event handlers
                    this.socket.on('stats_update', (data) => {
                        console.log('[Socket] Stats update received');
                        this.handleStatsUpdate(data);
                    });

                    this.socket.on('errors_update', (data) => {
                        console.log('[Socket] Errors update received');
                        this.handleErrorsUpdate(data);
                    });

                    this.socket.on('tmux_update', (data) => {
                        console.log('[Socket] tmux update received');
                        this.handleTmuxUpdate(data);
                    });

                    this.socket.on('queue_update', (data) => {
                        console.log('[Socket] Queue update received');
                        this.handleQueueUpdate(data);
                    });

                    this.socket.on('nodes_update', (data) => {
                        console.log('[Socket] Nodes update received');
                        this.handleNodesUpdate(data);
                    });

                    this.socket.on('activity_update', (data) => {
                        console.log('[Socket] Activity update:', data.action);
                        this.handleActivityUpdate(data);
                    });

                    this.socket.on('task_status_update', (data) => {
                        console.log('[Socket] Task status update:', data.updates?.length, 'tasks');
                        // Refresh live task monitor when we get updates
                        if (typeof refreshLiveTaskMonitor === 'function') {
                            refreshLiveTaskMonitor();
                        }
                    });

                    this.socket.on('room_joined', (data) => {
                        console.log('[Socket] Joined room:', data.room);
                    });

                    // Collaboration event handlers
                    this.socket.on('user_typing', (data) => {
                        console.log('[Socket] User typing:', data.username);
                        CollaborationManager.handleUserTyping(data);
                    });

                    this.socket.on('user_stopped_typing', (data) => {
                        console.log('[Socket] User stopped typing:', data.user_id);
                        CollaborationManager.handleUserStoppedTyping(data);
                    });

                    this.socket.on('user_viewing', (data) => {
                        console.log('[Socket] User viewing:', data.username);
                        CollaborationManager.handleUserViewing(data);
                    });

                    this.socket.on('user_left', (data) => {
                        console.log('[Socket] User left:', data.user_id);
                        CollaborationManager.handleUserLeft(data);
                    });

                    this.socket.on('entity_activity', (data) => {
                        console.log('[Socket] Entity activity:', data);
                        CollaborationManager.handleEntityActivity(data);
                    });

                    this.socket.on('heartbeat_ack', () => {
                        // Heartbeat acknowledged
                    });

                } catch (error) {
                    console.error('[Socket] Failed to initialize:', error);
                }
            },

            joinRoom(room, rejoin = false) {
                if (this.connected && this.socket) {
                    this.socket.emit('join_room', { room });
                    if (!rejoin) this.currentRooms.add(room);
                }
            },

            leaveRoom(room) {
                if (this.connected && this.socket) {
                    this.socket.emit('leave_room', { room });
                    this.currentRooms.delete(room);
                }
            },

            leaveAllRooms() {
                this.currentRooms.forEach(room => {
                    if (room !== 'stats') {  // Always keep stats subscription
                        this.leaveRoom(room);
                    }
                });
            },

            updateIndicator(connected) {
                const indicator = document.getElementById('socketStatus');
                if (indicator) {
                    indicator.className = connected ? 'socket-status online' : 'socket-status offline';
                    indicator.title = connected ? 'Real-time updates active' : 'Polling mode (WebSocket disconnected)';
                }
            },

            // Update handlers
            handleStatsUpdate(stats) {
                // Update sidebar stats if they exist
                if (stats.features) {
                    const inProgress = document.getElementById('sidebarFeaturesInProgress');
                    if (inProgress) inProgress.textContent = stats.features.in_progress || 0;
                }
                if (stats.bugs) {
                    const openBugs = document.getElementById('sidebarBugsOpen');
                    if (openBugs) openBugs.textContent = stats.bugs.open || 0;
                }
                if (stats.errors) {
                    const openErrors = document.getElementById('sidebarErrorsOpen');
                    if (openErrors) openErrors.textContent = stats.errors.open?.count || stats.errors.queued?.count || 0;
                }
                // Trigger refresh if on relevant panel
                if (currentPanel === 'overview') {
                    loadOverview();
                }
            },

            handleErrorsUpdate(errors) {
                if (currentPanel === 'errors') {
                    loadErrors();
                }
            },

            handleTmuxUpdate(sessions) {
                tmuxSessions = sessions;
                if (currentPanel === 'tmux') {
                    loadTmuxSessions();
                }
            },

            handleQueueUpdate(queue) {
                if (currentPanel === 'queue') {
                    refreshQueue();
                }
            },

            handleNodesUpdate(nodes) {
                if (currentPanel === 'nodes') {
                    loadNodes();
                }
            },

            handleActivityUpdate(activity) {
                // Could add toast notification for activity
                console.log(`[Activity] ${activity.username}: ${activity.action}`);
            }
        };

        // Initialize SocketManager on page load
        document.addEventListener('DOMContentLoaded', () => {
            SocketManager.init();
        });

        // =====================================================
        // COLLABORATION MANAGER - Real-time presence & typing
        // =====================================================

        const CollaborationManager = {
            // Current user info
            currentUser: {
                id: null,
                username: null,
                avatarColor: null,
                sessionId: null
            },

            // Active entity being viewed/edited
            currentEntity: {
                type: null,
                id: null
            },

            // Track typing state
            typingTimeout: null,
            isTyping: false,

            // Cache of collaboration data per entity
            entityActivity: new Map(), // entity_key -> { typing: [], viewers: [] }

            // Heartbeat interval
            heartbeatInterval: null,

            // Avatar color palette
            avatarColors: [
                '#3fb950', '#58a6ff', '#a371f7', '#db61a2',
                '#f85149', '#d29922', '#1f6feb', '#238636'
            ],

            init() {
                // Generate session-specific user info
                this.currentUser.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.currentUser.username = this.getUsername();
                this.currentUser.id = this.currentUser.username.toLowerCase().replace(/\s+/g, '_');
                this.currentUser.avatarColor = this.getAvatarColor(this.currentUser.username);

                // Start heartbeat
                this.startHeartbeat();

                // Listen for beforeunload to clean up
                window.addEventListener('beforeunload', () => this.cleanup());

                console.log('[Collab] Initialized for user:', this.currentUser.username);
            },

            getUsername() {
                // Try to get username from session or localStorage
                const sessionUser = document.body.dataset?.username ||
                                    localStorage.getItem('architect_username') ||
                                    'User';
                return sessionUser;
            },

            getAvatarColor(name) {
                // Consistent color based on name hash
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                return this.avatarColors[Math.abs(hash) % this.avatarColors.length];
            },

            getInitials(name) {
                if (!name) return '?';
                const parts = name.split(/[\s_-]+/);
                if (parts.length >= 2) {
                    return (parts[0][0] + parts[1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            },

            startHeartbeat() {
                // Send presence heartbeat every 30 seconds
                this.heartbeatInterval = setInterval(() => {
                    if (SocketManager.connected && SocketManager.socket) {
                        SocketManager.socket.emit('presence_heartbeat', {
                            entity_type: this.currentEntity.type,
                            entity_id: this.currentEntity.id
                        });
                    }
                }, 30000);
            },

            cleanup() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }
                this.leaveCurrentEntity();
            },

            // === Entity viewing/leaving ===

            viewEntity(entityType, entityId) {
                // Leave previous entity if any
                if (this.currentEntity.type && this.currentEntity.id) {
                    this.leaveCurrentEntity();
                }

                this.currentEntity = { type: entityType, id: String(entityId) };

                if (SocketManager.connected && SocketManager.socket) {
                    SocketManager.socket.emit('view_entity', {
                        entity_type: entityType,
                        entity_id: String(entityId),
                        user_id: this.currentUser.id,
                        username: this.currentUser.username,
                        avatar_color: this.currentUser.avatarColor
                    });

                    // Join the entity's room for updates
                    SocketManager.joinRoom(`entity:${entityType}:${entityId}`);
                }

                console.log('[Collab] Viewing entity:', entityType, entityId);
            },

            leaveCurrentEntity() {
                if (!this.currentEntity.type || !this.currentEntity.id) return;

                if (SocketManager.connected && SocketManager.socket) {
                    SocketManager.socket.emit('leave_entity', {
                        entity_type: this.currentEntity.type,
                        entity_id: this.currentEntity.id,
                        user_id: this.currentUser.id
                    });

                    SocketManager.leaveRoom(`entity:${this.currentEntity.type}:${this.currentEntity.id}`);
                }

                // Clear typing if active
                if (this.isTyping) {
                    this.stopTyping();
                }

                this.currentEntity = { type: null, id: null };
            },

            // === Typing indicators ===

            startTyping(field = null) {
                if (!this.currentEntity.type || !this.currentEntity.id) return;

                // Debounce: only emit if not already typing
                if (!this.isTyping) {
                    this.isTyping = true;

                    if (SocketManager.connected && SocketManager.socket) {
                        SocketManager.socket.emit('typing_start', {
                            entity_type: this.currentEntity.type,
                            entity_id: this.currentEntity.id,
                            field: field,
                            user_id: this.currentUser.id,
                            username: this.currentUser.username,
                            avatar_color: this.currentUser.avatarColor
                        });
                    }
                }

                // Reset timeout
                if (this.typingTimeout) {
                    clearTimeout(this.typingTimeout);
                }

                // Auto-stop after 5 seconds of no activity
                this.typingTimeout = setTimeout(() => {
                    this.stopTyping(field);
                }, 5000);
            },

            stopTyping(field = null) {
                if (!this.isTyping) return;

                this.isTyping = false;

                if (this.typingTimeout) {
                    clearTimeout(this.typingTimeout);
                    this.typingTimeout = null;
                }

                if (SocketManager.connected && SocketManager.socket) {
                    SocketManager.socket.emit('typing_stop', {
                        entity_type: this.currentEntity.type,
                        entity_id: this.currentEntity.id,
                        field: field,
                        user_id: this.currentUser.id
                    });
                }
            },

            // === Event handlers for incoming socket events ===

            handleUserTyping(data) {
                const key = `${data.entity_type}:${data.entity_id}`;
                if (!this.entityActivity.has(key)) {
                    this.entityActivity.set(key, { typing: [], viewers: [] });
                }

                const activity = this.entityActivity.get(key);

                // Add/update typing user
                const existingIdx = activity.typing.findIndex(u => u.user_id === data.user_id);
                const userData = {
                    user_id: data.user_id,
                    username: data.username,
                    field: data.field,
                    avatar_color: data.avatar_color || this.getAvatarColor(data.username),
                    timestamp: Date.now()
                };

                if (existingIdx >= 0) {
                    activity.typing[existingIdx] = userData;
                } else {
                    activity.typing.push(userData);
                }

                this.updateCollaborationUI(data.entity_type, data.entity_id);
            },

            handleUserStoppedTyping(data) {
                const key = `${data.entity_type}:${data.entity_id}`;
                const activity = this.entityActivity.get(key);
                if (activity) {
                    activity.typing = activity.typing.filter(u => u.user_id !== data.user_id);
                    this.updateCollaborationUI(data.entity_type, data.entity_id);
                }
            },

            handleUserViewing(data) {
                const key = `${data.entity_type}:${data.entity_id}`;
                if (!this.entityActivity.has(key)) {
                    this.entityActivity.set(key, { typing: [], viewers: [] });
                }

                const activity = this.entityActivity.get(key);

                // Add viewer if not already present
                const existingIdx = activity.viewers.findIndex(u => u.user_id === data.user_id);
                const userData = {
                    user_id: data.user_id,
                    username: data.username,
                    avatar_color: data.avatar_color || this.getAvatarColor(data.username),
                    timestamp: Date.now()
                };

                if (existingIdx >= 0) {
                    activity.viewers[existingIdx] = userData;
                } else {
                    activity.viewers.push(userData);
                }

                this.updateCollaborationUI(data.entity_type, data.entity_id);
            },

            handleUserLeft(data) {
                const key = `${data.entity_type}:${data.entity_id}`;
                const activity = this.entityActivity.get(key);
                if (activity) {
                    activity.viewers = activity.viewers.filter(u => u.user_id !== data.user_id);
                    activity.typing = activity.typing.filter(u => u.user_id !== data.user_id);
                    this.updateCollaborationUI(data.entity_type, data.entity_id);
                }
            },

            handleEntityActivity(data) {
                const key = `${data.entity_type}:${data.entity_id}`;
                this.entityActivity.set(key, {
                    typing: data.typing || [],
                    viewers: data.viewers || []
                });
                this.updateCollaborationUI(data.entity_type, data.entity_id);
            },

            // === UI Rendering ===

            updateCollaborationUI(entityType, entityId) {
                // Only update if this is the current entity being viewed
                if (this.currentEntity.type !== entityType ||
                    this.currentEntity.id !== String(entityId)) {
                    return;
                }

                const key = `${entityType}:${entityId}`;
                const activity = this.entityActivity.get(key) || { typing: [], viewers: [] };

                // Filter out current user
                const otherViewers = activity.viewers.filter(u => u.user_id !== this.currentUser.id);
                const otherTyping = activity.typing.filter(u => u.user_id !== this.currentUser.id);

                this.renderCollaborationBar(otherViewers, otherTyping);
            },

            renderCollaborationBar(viewers, typing) {
                let bar = document.getElementById('collaborationBar');

                // Create bar if it doesn't exist
                if (!bar) {
                    bar = document.createElement('div');
                    bar.id = 'collaborationBar';
                    bar.className = 'collaboration-bar';

                    // Insert at top of main content area
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        mainContent.insertBefore(bar, mainContent.firstChild);
                    }
                }

                // Hide if no activity
                if (viewers.length === 0 && typing.length === 0) {
                    bar.classList.add('hidden');
                    return;
                }

                bar.classList.remove('hidden');

                let html = '';

                // Viewer avatars
                if (viewers.length > 0) {
                    html += '<div class="viewer-count"><span class="icon"></span><span>' + viewers.length + ' viewing</span></div>';
                    html += '<div class="avatar-stack">';

                    const maxAvatars = 5;
                    const displayViewers = viewers.slice(0, maxAvatars);

                    displayViewers.forEach((user, idx) => {
                        const initials = this.getInitials(user.username);
                        const isTyping = typing.some(t => t.user_id === user.user_id);
                        const presenceClass = isTyping ? 'typing' : 'online';

                        html += `<div class="avatar" style="background: ${user.avatar_color}; z-index: ${maxAvatars - idx};" title="${user.username}">
                            ${initials}
                            <span class="presence-dot ${presenceClass}"></span>
                        </div>`;
                    });

                    if (viewers.length > maxAvatars) {
                        html += `<div class="avatar avatar-more">+${viewers.length - maxAvatars}</div>`;
                    }

                    html += '</div>';
                }

                // Typing indicator
                if (typing.length > 0) {
                    html += '<div class="typing-indicator">';

                    const typingNames = typing.map(t => t.username);
                    let typingText = '';

                    if (typingNames.length === 1) {
                        typingText = typingNames[0] + ' is typing';
                    } else if (typingNames.length === 2) {
                        typingText = typingNames.join(' and ') + ' are typing';
                    } else {
                        typingText = typingNames.length + ' people are typing';
                    }

                    html += `<div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
                    html += `<span>${typingText}</span>`;
                    html += '</div>';
                }

                bar.innerHTML = html;
            },

            // Render mini collaboration badge for list items
            renderEntityBadge(entityType, entityId) {
                const key = `${entityType}:${entityId}`;
                const activity = this.entityActivity.get(key);

                if (!activity || (activity.viewers.length === 0 && activity.typing.length === 0)) {
                    return '';
                }

                const others = activity.viewers.filter(u => u.user_id !== this.currentUser.id);
                if (others.length === 0) return '';

                let html = '<span class="entity-collab-badge has-activity">';
                html += '<span class="mini-avatars">';

                others.slice(0, 3).forEach(user => {
                    const initials = this.getInitials(user.username);
                    html += `<span class="mini-avatar" style="background: ${user.avatar_color};" title="${user.username}">${initials}</span>`;
                });

                html += '</span>';

                if (activity.typing.some(t => others.find(v => v.user_id === t.user_id))) {
                    html += '<span style="margin-left: 4px;"></span>';
                }

                html += '</span>';

                return html;
            },

            // Create field-level typing indicator
            createFieldTypingIndicator(fieldId) {
                const indicator = document.createElement('div');
                indicator.id = `typing-${fieldId}`;
                indicator.className = 'field-typing-indicator';
                indicator.style.display = 'none';
                return indicator;
            },

            updateFieldTypingIndicator(fieldId, typingUsers) {
                let indicator = document.getElementById(`typing-${fieldId}`);

                if (!typingUsers || typingUsers.length === 0) {
                    if (indicator) indicator.style.display = 'none';
                    return;
                }

                if (!indicator) return;

                indicator.style.display = 'flex';

                let html = '';
                typingUsers.forEach(user => {
                    const initials = this.getInitials(user.username);
                    html += `<span class="mini-avatar" style="background: ${user.avatar_color};">${initials}</span>`;
                });

                const names = typingUsers.map(u => u.username);
                if (names.length === 1) {
                    html += `<span>${names[0]} is typing...</span>`;
                } else {
                    html += `<span>${names.length} people typing...</span>`;
                }

                indicator.innerHTML = html;
            },

            // Check for edit conflicts
            checkEditConflict(entityType, entityId) {
                const key = `${entityType}:${entityId}`;
                const activity = this.entityActivity.get(key);

                if (!activity) return null;

                const otherEditors = activity.typing.filter(u => u.user_id !== this.currentUser.id);

                if (otherEditors.length > 0) {
                    return {
                        hasConflict: true,
                        editors: otherEditors
                    };
                }

                return { hasConflict: false };
            },

            // Show edit conflict warning
            showEditConflictWarning(container, editors) {
                let warning = container.querySelector('.edit-conflict-warning');

                if (!warning) {
                    warning = document.createElement('div');
                    warning.className = 'edit-conflict-warning';
                    container.insertBefore(warning, container.firstChild);
                }

                const names = editors.map(e => e.username).join(', ');
                warning.innerHTML = `<span class="icon"></span><span>${names} ${editors.length === 1 ? 'is' : 'are'} also editing this. Your changes may conflict.</span>`;
            },

            hideEditConflictWarning(container) {
                const warning = container.querySelector('.edit-conflict-warning');
                if (warning) warning.remove();
            }
        };

        // Initialize CollaborationManager on page load
        document.addEventListener('DOMContentLoaded', () => {
            CollaborationManager.init();
        });

        // =====================
        // Data Store Integration
        // =====================

        // Subscribe to all data changes for Quick Access counts
        DataStore.subscribe('*', function(dataType, data, state) {
            updateQuickAccessCounts();
            updatePinnedBadges();
        });

        function updateQuickAccessCounts() {
            const counts = DataStore.getCounts();
            const el = (id) => document.getElementById(id);
            if (el('statFeatures')) el('statFeatures').textContent = counts.features.total;
            if (el('statBugs')) el('statBugs').textContent = counts.bugs.open;
            if (el('statErrors')) el('statErrors').textContent = counts.errors.open;
            if (el('statNodes')) el('statNodes').textContent = counts.nodes.total;
            if (el('overviewFeatures')) el('overviewFeatures').textContent = counts.features.in_progress;
            if (el('overviewBugs')) el('overviewBugs').textContent = counts.bugs.open;
            if (el('overviewErrors')) el('overviewErrors').textContent = counts.errors.open;
            if (el('overviewNodesOnline')) el('overviewNodesOnline').textContent = counts.nodes.online;
            if (el('overviewWorkersActive')) el('overviewWorkersActive').textContent = counts.workers.active;
            if (typeof renderPinnedPanels === 'function') renderPinnedPanels();
        }

        function updatePinnedBadges() {
            const counts = DataStore.getCounts();
            const container = document.getElementById('pinnedPanels');
            if (!container) return;
            container.querySelectorAll('.pinned-panel-chip').forEach(chip => {
                const match = chip.getAttribute('onclick')?.match(/navigateToPanel\('(\w+)'\)/);
                if (!match) return;
                const badge = chip.querySelector('.chip-badge');
                let count = 0;
                switch (match[1]) {
                    case 'features': count = counts.features.total; break;
                    case 'bugs': count = counts.bugs.open; break;
                    case 'errors': count = counts.errors.open; break;
                    case 'nodes': count = counts.nodes.total; break;
                    case 'tasks': count = counts.tasks.pending; break;
                }
                if (badge) { badge.textContent = count; badge.style.display = count > 0 ? '' : 'none'; }
            });
        }

        async function initDataStore() {
            try {
                // Batch requests to avoid rate limiting (max 4 simultaneous)
                // First batch: Critical data
                await Promise.allSettled([
                    DataStore.fetch('projects', { force: true }),
                    DataStore.fetch('tasks', { force: true }),
                    DataStore.fetch('stats', { force: true })
                ]);

                // Small delay before second batch
                await new Promise(resolve => setTimeout(resolve, 100));

                // Second batch: Secondary data
                await Promise.allSettled([
                    DataStore.fetch('features', { force: true }),
                    DataStore.fetch('bugs', { force: true }),
                    DataStore.fetch('errors', { force: true })
                ]);

                // Small delay before third batch
                await new Promise(resolve => setTimeout(resolve, 100));

                // Third batch: Status data
                await Promise.allSettled([
                    DataStore.fetch('workers', { force: true }),
                    DataStore.fetch('nodes', { force: true })
                ]);

                projects = DataStore.get('projects') || [];
                updateOverviewWorkersNodes();
            } catch (e) { console.error('DataStore init error:', e); }
        }

        function updateOverviewWorkersNodes() {
            const workers = DataStore.get('workers');
            const nodes = DataStore.get('nodes') || [];
            const wc = document.getElementById('workersDetailContainer');
            if (wc && workers) {
                const sw = workers.system_workers || {};
                let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
                [{k:'task_worker',n:'Task Worker',i:''},{k:'error_daemon',n:'Error Daemon',i:''},{k:'deploy_worker',n:'Deploy Worker',i:''},{k:'confirm_worker',n:'Confirm Worker',i:''}].forEach(w => {
                    const info = sw[w.k], run = info?.running || false;
                    const col = run ? 'var(--success)' : 'var(--error)';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;border-left:3px solid '+col+';"><div style="display:flex;align-items:center;gap:8px;"><span>'+w.i+'</span><span style="font-weight:500;">'+w.n+'</span></div><span style="font-size:12px;color:'+col+';">'+(run?'Running (PID: '+info.pid+')':'Stopped')+'</span></div>';
                });
                html += '</div>';
                wc.innerHTML = html;
            }
            const nc = document.getElementById('nodesDetailContainer');
            if (nc) {
                if (nodes.length === 0) { nc.innerHTML = '<p style="color:var(--text-secondary);text-align:center;">No nodes registered</p>'; }
                else {
                    let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
                    nodes.forEach(n => {
                        const col = n.status === 'online' ? 'var(--success)' : 'var(--error)';
                        html += '<div style="padding:10px 12px;background:var(--bg-tertiary);border-radius:6px;border-left:3px solid '+col+';"><div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-weight:500;">'+(n.hostname||'Unknown')+'</span><span class="badge badge-'+n.status+'">'+n.status+'</span></div><div style="display:flex;gap:16px;font-size:12px;"><span>CPU: '+(n.cpu_usage||0).toFixed(0)+'%</span><span>Mem: '+(n.memory_usage||0).toFixed(0)+'%</span></div></div>';
                    });
                    html += '</div>';
                    nc.innerHTML = html;
                }
            }
        }

        async function loadOverviewWorkersDetail() { try { await DataStore.fetch('workers', { force: true }); updateOverviewWorkersNodes(); } catch(e) { console.error(e); } }
        async function loadOverviewNodesDetail() { try { await DataStore.fetch('nodes', { force: true }); updateOverviewWorkersNodes(); } catch(e) { console.error(e); } }

        // =====================
        // Global Error Catching
        // =====================

        // Log error to backend
        async function logErrorToBackend(errorData, autoQueue = true) {
            try {
                // Log the error
                const response = await fetch('/api/errors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        error_type: errorData.type || 'javascript',
                        message: errorData.message,
                        source: errorData.source || 'dashboard',
                        stack_trace: errorData.stack || '',
                        node_id: 'dashboard-frontend'
                    })
                });

                // Auto-queue for agent to fix
                if (autoQueue && response.ok) {
                    const result = await response.json();
                    const errorId = result.id || result.error_id;

                    if (errorId) {
                        // Queue task for error_fixer or available worker
                        await fetch('/api/autopilot/queue', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'error_fix',
                                priority: errorData.type === 'speech_synthesis' ? 'medium' : 'high',
                                payload: {
                                    error_id: errorId,
                                    error_type: errorData.type,
                                    message: errorData.message,
                                    source: errorData.source,
                                    auto_assign: true
                                }
                            })
                        });
                        console.log(`Error ${errorId} queued for auto-fix`);
                    }
                }
            } catch (e) {
                console.error('Failed to log error to backend:', e);
            }
        }

        // Catch unhandled JavaScript errors
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', message, source, lineno);
            logErrorToBackend({
                type: 'javascript',
                message: `${message} at ${source}:${lineno}:${colno}`,
                source: source,
                stack: error?.stack || ''
            });
            showNotification(`Error: ${message}`, 'error');
            return false;
        };

        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            const message = event.reason?.message || String(event.reason);

            // Ignore expected network errors (servers being offline is normal)
            const ignoredErrors = [
                'Failed to fetch',
                'NetworkError',
                'Network request failed',
                'Load failed',
                'The operation was aborted',
                'AbortError',
                'signal is aborted'
            ];

            if (ignoredErrors.some(err => message.includes(err))) {
                console.log('Network error (ignored):', message);
                event.preventDefault(); // Prevent default browser error
                return;
            }

            console.error('Unhandled rejection:', event.reason);
            logErrorToBackend({
                type: 'promise_rejection',
                message: message,
                source: 'dashboard',
                stack: event.reason?.stack || ''
            });
            showNotification(`Async Error: ${message}`, 'error');
        });

        // Catch resource loading errors (broken images, CSS, scripts)
        window.addEventListener('error', function(event) {
            // Only handle resource loading errors, not script errors (those go to window.onerror)
            if (event.target && event.target !== window) {
                const element = event.target;
                const tagName = element.tagName?.toLowerCase();
                const resourceUrl = element.src || element.href || 'unknown';

                // Skip if it's a data URL or blob
                if (resourceUrl.startsWith('data:') || resourceUrl.startsWith('blob:')) {
                    return;
                }

                // Determine resource type
                let resourceType = 'resource';
                if (tagName === 'img') resourceType = 'image';
                else if (tagName === 'link') resourceType = 'stylesheet';
                else if (tagName === 'script') resourceType = 'script';
                else if (tagName === 'video' || tagName === 'audio') resourceType = 'media';
                else if (tagName === 'iframe') resourceType = 'iframe';

                console.error(`Resource load error: ${resourceType} - ${resourceUrl}`);

                logErrorToBackend({
                    type: `broken_${resourceType}`,
                    message: `Failed to load ${resourceType}: ${resourceUrl}`,
                    source: window.location.pathname,
                    stack: `Element: <${tagName}>\nURL: ${resourceUrl}\nPage: ${window.location.href}`
                });
            }
        }, true); // Use capture phase to catch resource errors

        // Monitor for broken links when clicked
        document.addEventListener('click', function(event) {
            const link = event.target.closest('a[href]');
            if (!link) return;

            const href = link.getAttribute('href');
            // Skip empty, hash, javascript, and external links
            if (!href || href === '#' || href.startsWith('javascript:') || href.startsWith('mailto:') || href.startsWith('tel:')) {
                return;
            }

            // For internal links, validate they're not obviously broken
            if (href.startsWith('/') && !href.startsWith('//')) {
                // Track the click for potential 404 correlation
                sessionStorage.setItem('lastClickedLink', JSON.stringify({
                    href: href,
                    text: link.textContent?.trim().substring(0, 50),
                    time: Date.now(),
                    page: window.location.pathname
                }));
            }
        });

        // Notification system with history
        const notificationHistory = [];
        const MAX_NOTIFICATIONS = 50;

        function showNotification(message, type = 'info', duration = 5000, correlationId = null) {
            // Get correlation ID for error messages
            const corrId = correlationId || (typeof Correlation !== 'undefined' ? Correlation.getId() : null);

            // Add to history
            const notification = {
                id: Date.now(),
                message,
                type,
                time: new Date(),
                read: false,
                correlationId: type === 'error' ? corrId : null
            };
            notificationHistory.unshift(notification);
            if (notificationHistory.length > MAX_NOTIFICATIONS) {
                notificationHistory.pop();
            }
            updateNotificationBadge();
            renderNotificationPanel();

            // Show toast notification with optional correlation ID for errors
            const container = document.getElementById('notificationContainer');
            const toastEl = document.createElement('div');
            toastEl.className = `notification ${type}`;

            // Include correlation ID in error notifications for debugging
            let notificationHtml = `<div class="notification-content">${message}</div>`;
            if (type === 'error' && corrId) {
                notificationHtml += `<div class="notification-correlation" style="font-size: 10px; opacity: 0.7; margin-top: 4px;">Request ID: ${corrId}</div>`;
            }
            notificationHtml += `<button class="notification-close" onclick="this.parentElement.remove()"></button>`;

            toastEl.innerHTML = notificationHtml;
            container.appendChild(toastEl);

            // Auto-remove toast after duration
            if (duration > 0) {
                setTimeout(() => {
                    toastEl.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => toastEl.remove(), 300);
                }, duration);
            }
        }

        // Alias for backwards compatibility
        const showToast = showNotification;
        window.showToast = showToast;

        function updateNotificationBadge() {
            const unreadCount = notificationHistory.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');

            if (panel.classList.contains('active')) {
                // Mark all as read when panel opens
                notificationHistory.forEach(n => n.read = true);
                updateNotificationBadge();
                renderNotificationPanel();
            }
        }

        function renderNotificationPanel() {
            const body = document.getElementById('notificationPanelBody');

            if (notificationHistory.length === 0) {
                body.innerHTML = '<div class="notification-panel-empty">No notifications</div>';
                return;
            }

            const icons = {
                error: '',
                success: '',
                warning: '',
                info: ''
            };

            body.innerHTML = notificationHistory.slice(0, 20).map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}">
                    <div class="notification-icon ${n.type}">${icons[n.type] || ''}</div>
                    <div class="notification-content-wrap">
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${formatTimeAgo(n.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        function clearNotifications() {
            notificationHistory.length = 0;
            updateNotificationBadge();
            renderNotificationPanel();
            toggleNotificationPanel();
        }

        // ========================
        // Online Users Panel
        // ========================

        let onlineUsersPanelOpen = false;
        let onlineUsersCache = [];

        function toggleOnlineUsersPanel() {
            const panel = document.getElementById('onlineUsersPanel');
            const notificationPanel = document.getElementById('notificationPanel');

            // Close notification panel if open
            if (notificationPanel.classList.contains('active')) {
                notificationPanel.classList.remove('active');
            }

            onlineUsersPanelOpen = !onlineUsersPanelOpen;

            if (onlineUsersPanelOpen) {
                panel.classList.add('active');
                fetchOnlineUsers();
            } else {
                panel.classList.remove('active');
            }
        }

        async function fetchOnlineUsers() {
            try {
                const result = await api('/collaboration/presence');
                if (result.users) {
                    onlineUsersCache = result.users;
                    renderOnlineUsersPanel(result.users);
                }
            } catch (e) {
                console.error('Failed to fetch online users:', e);
                // Show at least the current user
                renderOnlineUsersPanel([{
                    user_id: CollaborationManager.currentUser.id,
                    display_name: CollaborationManager.currentUser.username,
                    avatar_color: CollaborationManager.currentUser.avatarColor,
                    status: 'active'
                }]);
            }
        }

        function renderOnlineUsersPanel(users) {
            const body = document.getElementById('onlineUsersPanelBody');
            const countEl = document.getElementById('onlineUsersTotalCount');
            const headerCount = document.getElementById('onlineUsersCount');

            const uniqueUsers = users.length > 0 ? users : [{
                user_id: CollaborationManager.currentUser.id,
                display_name: CollaborationManager.currentUser.username,
                avatar_color: CollaborationManager.currentUser.avatarColor,
                status: 'active'
            }];

            countEl.textContent = `${uniqueUsers.length} online`;
            headerCount.textContent = uniqueUsers.length;

            if (uniqueUsers.length === 0) {
                body.innerHTML = '<div class="online-users-empty">No one else is online</div>';
                return;
            }

            body.innerHTML = uniqueUsers.map(user => {
                const isYou = user.user_id === CollaborationManager.currentUser.id ||
                              user.display_name === CollaborationManager.currentUser.username;
                const initials = CollaborationManager.getInitials(user.display_name || user.user_id);
                const color = user.avatar_color || CollaborationManager.getAvatarColor(user.display_name || user.user_id);

                let activity = 'Active';
                if (user.current_entity_type && user.current_entity_id) {
                    activity = `Viewing ${user.current_entity_type} #${user.current_entity_id}`;
                } else if (user.current_action) {
                    activity = user.current_action;
                }

                const presenceClass = user.status === 'typing' ? 'typing' : 'online';

                return `
                    <div class="online-user-item ${isYou ? 'is-you' : ''}">
                        <div class="user-avatar" style="background: ${color};">
                            ${initials}
                            <span class="presence-dot ${presenceClass}"></span>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(user.display_name || user.user_id)}</div>
                            <div class="user-activity">${activity}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Periodically refresh online users if panel is open
        setInterval(() => {
            if (onlineUsersPanelOpen) {
                fetchOnlineUsers();
            }
        }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 10s

        // Close panels when clicking outside
        document.addEventListener('click', (e) => {
            const onlinePanel = document.getElementById('onlineUsersPanel');
            const onlineIndicator = document.getElementById('onlineUsersIndicator');

            if (onlineUsersPanelOpen &&
                !onlinePanel.contains(e.target) &&
                !onlineIndicator.contains(e.target)) {
                onlineUsersPanelOpen = false;
                onlinePanel.classList.remove('active');
            }
        });

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationPanel');
            const bell = document.getElementById('notificationBell');
            if (panel.classList.contains('active') && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.remove('active');
            }
        });

        // Confirmation modal system (replaces confirm())
        let confirmResolve = null;
        let confirmReject = null;

        function showConfirm(message, title = 'Confirm', buttonText = 'Confirm') {
            return new Promise((resolve, reject) => {
                confirmResolve = () => resolve(true);
                confirmReject = () => resolve(false);

                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmButton').textContent = buttonText;
                showModal('confirm');
            });
        }

        // === Loading Progress Helpers ===
        let loadingCount = 0;

        function showLoadingProgress(indeterminate = true) {
            loadingCount++;
            const progress = document.getElementById('loadingProgress');
            const bar = document.getElementById('loadingProgressBar');
            if (progress) {
                progress.style.display = 'block';
                if (indeterminate) {
                    progress.classList.add('indeterminate');
                }
            }
        }

        function hideLoadingProgress() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                const progress = document.getElementById('loadingProgress');
                const bar = document.getElementById('loadingProgressBar');
                if (progress) {
                    progress.classList.remove('indeterminate');
                    if (bar) bar.style.width = '100%';
                    setTimeout(() => {
                        progress.style.display = 'none';
                        if (bar) bar.style.width = '0%';
                    }, 300);
                }
            }
        }

        function setLoadingProgress(percent) {
            const bar = document.getElementById('loadingProgressBar');
            const progress = document.getElementById('loadingProgress');
            if (progress && bar) {
                progress.classList.remove('indeterminate');
                bar.style.width = `${percent}%`;
            }
        }

        // Button loading helpers
        function setButtonLoading(button, loading = true) {
            if (!button) return;
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        // Add stagger animation to container
        function animateStagger(container) {
            if (container) {
                container.classList.add('stagger-in');
                // Remove class after animation to allow re-animation
                setTimeout(() => container.classList.remove('stagger-in'), 1000);
            }
        }

        // === Performance: Caching & Lazy Loading ===
        const apiCache = new Map();
        const CACHE_TTL = 30000; // 30 seconds
        const loadedPanels = new Set();
        let pendingRequests = new Map();

        // Debounce helper
        function debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Throttle helper
        function throttle(fn, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    fn.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // Cache management
        function getCached(key) {
            const cached = apiCache.get(key);
            if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
                return cached.data;
            }
            apiCache.delete(key);
            return null;
        }

        function setCache(key, data) {
            apiCache.set(key, { data, timestamp: Date.now() });
        }

        function invalidateCache(pattern = null) {
            if (pattern) {
                for (const key of apiCache.keys()) {
                    if (key.includes(pattern)) {
                        apiCache.delete(key);
                    }
                }
            } else {
                apiCache.clear();
            }
        }

        // Show skeleton loading in a container
        function showSkeletonLoading(containerId, count = 3, type = 'row') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const skeletons = Array(count).fill(0).map(() =>
                type === 'card'
                    ? '<div class="skeleton skeleton-card"></div>'
                    : '<div class="skeleton skeleton-row"></div>'
            ).join('');

            container.innerHTML = skeletons;
        }

        // Check if panel needs loading
        function isPanelLoaded(panel) {
            return loadedPanels.has(panel);
        }

        function markPanelLoaded(panel) {
            loadedPanels.add(panel);
        }

        // Prefetch next likely panels based on current panel
        const prefetchMap = {
            'queue': ['features', 'bugs'],
            'overview': ['projects', 'features'],
            'projects': ['features', 'bugs'],
            'features': ['bugs'],
            'bugs': ['errors']
        };

        async function prefetchPanels(currentPanel) {
            const panelsToPrefetch = prefetchMap[currentPanel] || [];
            for (const panel of panelsToPrefetch) {
                if (!isPanelLoaded(panel)) {
                    // Prefetch in background with low priority
                    setTimeout(() => {
                        if (!isPanelLoaded(panel)) {
                            loadPanelData(panel).catch(() => {}); // Silently fail prefetch
                        }
                    }, 2000);
                }
            }
        }

        // API helpers with caching and automatic retry logic
        const API_RETRY_CONFIG = {
            maxRetries: 3,
            baseDelay: 1000,      // 1 second
            maxDelay: 10000,      // 10 seconds
            retryableStatuses: [500, 502, 503, 504, 408, 429]  // Server errors + timeout + rate limit
        };

        async function api(endpoint, method = 'GET', data = null, useCache = true) {
            const cacheKey = `${method}:${endpoint}`;

            // Check cache for GET requests
            if (method === 'GET' && useCache) {
                const cached = getCached(cacheKey);
                if (cached) return cached;
                // Deduplicate concurrent identical requests
                if (pendingRequests.has(cacheKey)) {
                    return pendingRequests.get(cacheKey);
                }
            }

            // Get CSRF token for state-changing requests
            const csrfToken = typeof CSRF !== 'undefined' ? CSRF.getToken() : null;
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken && ['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            const options = {
                method,
                headers,
                credentials: 'include'  // Always include cookies for authentication
            };
            if (data) options.body = JSON.stringify(data);

            // Calculate delay with exponential backoff and jitter
            const getRetryDelay = (attempt) => {
                const exponentialDelay = API_RETRY_CONFIG.baseDelay * Math.pow(2, attempt);
                const jitter = Math.random() * 500;  // Add 0-500ms jitter
                return Math.min(exponentialDelay + jitter, API_RETRY_CONFIG.maxDelay);
            };

            // Check if we should retry based on response status
            const shouldRetry = (status, attempt) => {
                if (attempt >= API_RETRY_CONFIG.maxRetries) return false;
                return API_RETRY_CONFIG.retryableStatuses.includes(status);
            };

            const doRequest = async () => {
                const response = await fetch(`/api${endpoint}`, options);
                const result = await response.json();

                // Cache successful GET responses
                if (method === 'GET' && response.ok && !result.error) {
                    setCache(cacheKey, result);
                }
                // Invalidate related caches on mutations
                if (method !== 'GET' && response.ok) {
                    const entity = endpoint.split('/')[1];
                    if (entity) invalidateCache(entity);
                }
                return { response, result };
            };

            // Retry wrapper for network and server errors
            const doRequestWithRetry = async (attempt = 0) => {
                try {
                    const { response, result } = await doRequest();

                    // Check if we should retry server errors
                    if (shouldRetry(response.status, attempt)) {
                        const delay = getRetryDelay(attempt);
                        console.warn(`[API Retry] ${method} ${endpoint} returned ${response.status}, retrying in ${Math.round(delay)}ms (attempt ${attempt + 1}/${API_RETRY_CONFIG.maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return doRequestWithRetry(attempt + 1);
                    }

                    return { response, result, retried: attempt > 0 };
                } catch (networkError) {
                    // Retry on network errors (fetch failures)
                    if (attempt < API_RETRY_CONFIG.maxRetries) {
                        const delay = getRetryDelay(attempt);
                        console.warn(`[API Retry] ${method} ${endpoint} network error: ${networkError.message}, retrying in ${Math.round(delay)}ms (attempt ${attempt + 1}/${API_RETRY_CONFIG.maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return doRequestWithRetry(attempt + 1);
                    }
                    throw networkError;  // Exhausted retries
                }
            };

            // Track pending request for deduplication
            if (method === 'GET') {
                const promise = doRequestWithRetry().finally(() => pendingRequests.delete(cacheKey));
                pendingRequests.set(cacheKey, promise.then(r => r.result));
            }

            try {
                const { response, result, retried } = method === 'GET' && pendingRequests.has(cacheKey)
                    ? { response: { ok: true }, result: await pendingRequests.get(cacheKey), retried: false }
                    : await doRequestWithRetry();

                // Log successful retry for debugging
                if (retried) {
                    console.log(`[API Retry] ${method} ${endpoint} succeeded after retry`);
                }

                // Handle authentication errors - redirect to login
                if (response.status === 401) {
                    console.warn('Session expired, redirecting to login');
                    window.location.href = '/login?expired=1';
                    return result;
                }

                // Handle CSRF errors - refresh token and notify user
                if (response.status === 403 && result.code === 'CSRF_INVALID') {
                    console.warn('[CSRF] Token rejected, refreshing...');
                    if (typeof CSRF !== 'undefined') {
                        await CSRF.refresh();
                        showNotification('Security token refreshed. Please try again.', 'warning');
                    }
                    return result;
                }

                // Log API errors to backend error tracking (skip auth errors - they're expected)
                if (!response.ok || result.error) {
                    const errorMessage = result.error || `HTTP ${response.status}: ${response.statusText}`;

                    // Only log server errors (5xx) and unexpected client errors (not 401/403)
                    if (response.status >= 500 || (response.status >= 400 && response.status !== 401 && response.status !== 403)) {
                        logErrorToBackend({
                            type: 'api_error',
                            message: `API ${method} ${endpoint}: ${errorMessage}`,
                            source: `api:${endpoint}`,
                            stack: JSON.stringify({ endpoint, method, status: response.status, data: data ? '(data sent)' : null })
                        });
                    }

                    // Show notification for API errors (user-friendly)
                    if (result.error) {
                        let userMessage = result.error;
                        // Make common errors more user-friendly
                        if (result.error.includes('no such table')) {
                            const table = result.error.match(/no such table: (\w+)/)?.[1] || 'table';
                            userMessage = `Database needs update: missing "${table}" table. Run migrations.`;
                        } else if (result.error.includes('UNIQUE constraint')) {
                            userMessage = 'This item already exists.';
                        } else if (result.error.includes('FOREIGN KEY')) {
                            userMessage = 'Cannot complete: referenced item not found.';
                        } else if (result.error.includes('Authentication required')) {
                            // Session expired - redirect to login
                            window.location.href = '/login?expired=1';
                            return result;
                        }
                        showNotification(userMessage, 'error', 8000);
                    }
                }

                return result;
            } catch (e) {
                // Network or parsing errors
                logErrorToBackend({
                    type: 'api_error',
                    message: `API ${method} ${endpoint} failed: ${e.message}`,
                    source: `api:${endpoint}`,
                    stack: e.stack || ''
                });
                throw e;
            }
        }

        // Navigation with deep URL routing
        // Supports: #panel, #panel/id, #panel/id/subtype/subid
        function parseHash(hash) {
            const parts = hash.replace(/^#/, '').split('/');
            return {
                panel: parts[0] || 'overview',
                id: parts[1] || null,
                subtype: parts[2] || null,
                subid: parts[3] || null
            };
        }

        function buildHash(panel, id = null, subtype = null, subid = null) {
            let hash = panel;
            if (id) hash += '/' + id;
            if (subtype && subid) hash += '/' + subtype + '/' + subid;
            return hash;
        }

        async function navigateToPanel(panelName, id = null, subtype = null, subid = null) {
            console.log('[Navigation] navigateToPanel called with:', { panelName, id, subtype, subid });

            // Handle string with slashes (legacy support)
            if (panelName && panelName.includes('/')) {
                const parsed = parseHash(panelName);
                panelName = parsed.panel;
                id = parsed.id;
                subtype = parsed.subtype;
                subid = parsed.subid;
                console.log('[Navigation] Parsed hash:', { panelName, id, subtype, subid });
            }

            // Validate panel name
            if (!panelName) {
                console.error('[Navigation] Invalid panel name:', panelName);
                panelName = 'queue';
            }

            console.log('[Navigation] Navigating to panel:', panelName);

            // Clear all active states
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-btn').forEach(b => b.classList.remove('has-active'));

            // Handle focus toggle button state
            const focusToggle = document.getElementById('focusToggle');
            if (focusToggle) {
                focusToggle.classList.toggle('active', panelName === 'focus');
            }

            // Activate the right button (top-level or dropdown item)
            const btn = document.querySelector(`.nav-btn[data-panel="${panelName}"]`);
            const dropdownItem = document.querySelector(`.nav-dropdown-item[data-panel="${panelName}"]`);

            if (btn) {
                btn.classList.add('active');
                console.log('[Navigation] Activated nav button:', panelName);
            } else if (dropdownItem) {
                dropdownItem.classList.add('active');
                console.log('[Navigation] Activated dropdown item:', panelName);
                // Also highlight parent dropdown button
                const parentDropdown = dropdownItem.closest('.nav-dropdown');
                if (parentDropdown) {
                    const dropdownBtn = parentDropdown.querySelector('.nav-dropdown-btn');
                    if (dropdownBtn) {
                        dropdownBtn.classList.add('has-active');
                    }
                }
            } else {
                console.warn('[Navigation] No navigation button found for panel:', panelName);
            }

            // Hide all panels
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            // Show target panel
            const panel = document.getElementById(`panel-${panelName}`);
            if (panel) {
                panel.classList.add('active');
                console.log('[Navigation] Panel activated:', `panel-${panelName}`);
            } else {
                console.error('[Navigation] Panel not found:', `panel-${panelName}`);
                // Fallback to queue panel
                const fallbackPanel = document.getElementById('panel-queue');
                if (fallbackPanel) {
                    fallbackPanel.classList.add('active');
                    panelName = 'queue';
                    console.log('[Navigation] Fell back to queue panel');
                }
            }

            // Reset scroll position to top when switching panels
            const contentArea = document.getElementById('main-content');
            if (contentArea) {
                // Force scroll to absolute top
                contentArea.scrollTop = 0;
                contentArea.scrollLeft = 0;

                // Also reset window/document scroll
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;

                // Reset panel's own scroll if it has overflow
                const activePanel = document.getElementById(`panel-${panelName}`);
                if (activePanel) {
                    activePanel.scrollTop = 0;
                }
            }

            // Update state and URL (use pushState to avoid scroll jump)
            currentPanel = panelName;
            const newHash = buildHash(panelName, id, subtype, subid);
            if (window.location.hash.slice(1) !== newHash) {
                // Use pushState instead of location.hash to prevent browser scroll
                history.pushState(null, '', '#' + newHash);
            }

            // Manage WebSocket room subscriptions based on panel
            if (SocketManager.connected) {
                // Leave panel-specific rooms
                SocketManager.leaveAllRooms();

                // Subscribe to rooms based on current panel
                const panelRoomMap = {
                    'overview': ['stats', 'activity'],
                    'errors': ['errors', 'stats'],
                    'tmux': ['tmux'],
                    'queue': ['queue', 'stats'],
                    'nodes': ['nodes'],
                    'features': ['stats'],
                    'bugs': ['stats']
                };

                const rooms = panelRoomMap[panelName] || ['stats'];
                rooms.forEach(room => SocketManager.joinRoom(room));
            }

            // Load panel data
            console.log('[Navigation] Loading panel data for:', panelName);
            await loadPanelData(currentPanel, id, subtype, subid);

            // Reset scroll again after content loads (content might cause scroll)
            setTimeout(() => {
                const contentArea = document.getElementById('main-content');
                if (contentArea) contentArea.scrollTop = 0;
                window.scrollTo(0, 0);
            }, 50);
        }

        function updateUrlState(id = null, subtype = null, subid = null) {
            // Update URL without triggering navigation
            const newHash = buildHash(currentPanel, id, subtype, subid);
            if (window.location.hash.slice(1) !== newHash) {
                history.replaceState(null, '', '#' + newHash);
            }
        }

        // Attach navigation handlers - wrapped in function for reliability
        function attachNavigationHandlers() {
            console.log('[Navigation] Attaching navigation handlers...');

            const navButtons = document.querySelectorAll('.nav-btn');
            console.log('[Navigation] Found nav buttons:', navButtons.length);

            navButtons.forEach(btn => {
                if (btn.dataset.panel && !btn.hasAttribute('data-handler-attached')) {
                    btn.setAttribute('data-handler-attached', 'true');
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('[Navigation] Nav button clicked:', btn.dataset.panel);
                        navigateToPanel(btn.dataset.panel);
                    });
                    console.log('[Navigation] Attached handler to nav button:', btn.dataset.panel);
                }
            });

            // Add click handlers to dropdown buttons to toggle open/closed
            document.querySelectorAll('.nav-dropdown-btn').forEach(btn => {
                if (!btn.hasAttribute('data-handler-attached')) {
                    btn.setAttribute('data-handler-attached', 'true');
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const dropdown = btn.closest('.nav-dropdown');
                        if (dropdown) {
                            const isOpen = dropdown.classList.contains('open');
                            // Close all other dropdowns first
                            document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
                            // Toggle this dropdown
                            if (!isOpen) {
                                dropdown.classList.add('open');
                                btn.setAttribute('aria-expanded', 'true');
                                console.log('[Navigation] Opened dropdown:', dropdown.id);
                            } else {
                                dropdown.classList.remove('open');
                                btn.setAttribute('aria-expanded', 'false');
                                console.log('[Navigation] Closed dropdown:', dropdown.id);
                            }
                        }
                    });
                    console.log('[Navigation] Attached handler to dropdown button:', btn.textContent.trim());
                }
            });

            // Add click handlers for dropdown items
            const dropdownItems = document.querySelectorAll('.nav-dropdown-item');
            console.log('[Navigation] Found dropdown items:', dropdownItems.length);

            dropdownItems.forEach(item => {
                if (item.dataset.panel && !item.hasAttribute('data-handler-attached')) {
                    item.setAttribute('data-handler-attached', 'true');
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('[Navigation] Dropdown item clicked:', item.dataset.panel);
                        // Close dropdown after clicking
                        const dropdown = item.closest('.nav-dropdown');
                        if (dropdown) {
                            dropdown.classList.remove('open');
                            const btn = dropdown.querySelector('.nav-dropdown-btn');
                            if (btn) btn.setAttribute('aria-expanded', 'false');
                        }
                        navigateToPanel(item.dataset.panel);
                    });
                    console.log('[Navigation] Attached handler to dropdown item:', item.dataset.panel);
                }
            });

            console.log('[Navigation] All handlers attached successfully');
        }

        // Attach handlers immediately (for scripts at bottom of body)
        attachNavigationHandlers();

        // Also attach after DOM ready (as fallback)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachNavigationHandlers);
        }

        // Retry handler attachment after a delay (ensures DOM is fully ready)
        setTimeout(() => {
            console.log('[Navigation] Retry: Re-attaching navigation handlers...');
            attachNavigationHandlers();
        }, 500);

        // FALLBACK: Delegate click handler on document for nav buttons
        // This ensures navigation works even if direct handlers fail
        document.addEventListener('click', (e) => {
            // Handle nav-btn clicks via delegation
            const navBtn = e.target.closest('.nav-btn[data-panel]');
            if (navBtn) {
                e.preventDefault();
                const panel = navBtn.dataset.panel;
                console.log('[Navigation] Delegated click handler - nav button:', panel);
                navigateToPanel(panel);
                return;
            }

            // Handle dropdown item clicks via delegation
            const dropdownItem = e.target.closest('.nav-dropdown-item[data-panel]');
            if (dropdownItem) {
                e.preventDefault();
                const panel = dropdownItem.dataset.panel;
                console.log('[Navigation] Delegated click handler - dropdown item:', panel);
                // Close dropdown
                const dropdown = dropdownItem.closest('.nav-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('open');
                    const btn = dropdown.querySelector('.nav-dropdown-btn');
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
                navigateToPanel(panel);
                return;
            }

            // Handle dropdown button clicks
            const dropdownBtn = e.target.closest('.nav-dropdown-btn');
            if (dropdownBtn) {
                e.preventDefault();
                e.stopPropagation();
                const dropdown = dropdownBtn.closest('.nav-dropdown');
                if (dropdown) {
                    const isOpen = dropdown.classList.contains('open');
                    document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
                    if (!isOpen) {
                        dropdown.classList.add('open');
                        dropdownBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        dropdownBtn.setAttribute('aria-expanded', 'false');
                    }
                }
                return;
            }

            // Close dropdowns when clicking outside
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Global Search functionality
        let searchCache = { projects: [], features: [], bugs: [], sessions: [] };

        async function updateSearchCache() {
            try {
                const [projectsResp, featuresResp, bugsResp] = await Promise.all([
                    fetch('/api/projects').then(r => r.json()).catch(() => []),
                    fetch('/api/features').then(r => r.json()).catch(() => []),
                    fetch('/api/bugs').then(r => r.json()).catch(() => [])
                ]);
                searchCache.projects = Array.isArray(projectsResp) ? projectsResp : [];
                searchCache.features = Array.isArray(featuresResp) ? featuresResp : [];
                searchCache.bugs = Array.isArray(bugsResp) ? bugsResp : [];
                // Add tmux sessions
                const sessionsResp = await fetch('/api/tmux/sessions').then(r => r.json()).catch(() => []);
                searchCache.sessions = Array.isArray(sessionsResp) ? sessionsResp : [];
            } catch (e) {
                console.error('Search cache update failed:', e);
            }
        }

        let searchSelectedIndex = -1;
        let searchResultsCache = [];

        function handleGlobalSearch(event) {
            const resultsEl = document.getElementById('searchResults');
            const rawQuery = event.target.value.trim();

            // Handle keyboard navigation
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                searchSelectedIndex = Math.min(searchSelectedIndex + 1, searchResultsCache.length - 1);
                updateSearchSelection();
                return;
            }
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                searchSelectedIndex = Math.max(searchSelectedIndex - 1, 0);
                updateSearchSelection();
                return;
            }
            if (event.key === 'Enter' && searchSelectedIndex >= 0 && searchResultsCache[searchSelectedIndex]) {
                event.preventDefault();
                const r = searchResultsCache[searchSelectedIndex];
                handleSearchResult(r.panel, r.id, r.type);
                return;
            }

            // Parse filter prefixes: p: for projects, f: for features, b: for bugs, s: for sessions
            let filter = null;
            let query = rawQuery.toLowerCase();
            const prefixMatch = rawQuery.match(/^([pfbs]):(.*)$/i);
            if (prefixMatch) {
                filter = prefixMatch[1].toLowerCase();
                query = prefixMatch[2].toLowerCase().trim();
            }

            if (query.length < 1) {
                resultsEl.style.display = 'none';
                searchResultsCache = [];
                searchSelectedIndex = -1;
                return;
            }

            const results = [];

            // Search projects (p: or no filter)
            if (!filter || filter === 'p') {
                searchCache.projects.forEach(p => {
                    if (p.name?.toLowerCase().includes(query) || p.description?.toLowerCase().includes(query)) {
                        results.push({ type: 'project', icon: '', name: p.name, id: p.id, panel: 'projects' });
                    }
                });
            }

            // Search features (f: or no filter)
            if (!filter || filter === 'f') {
                searchCache.features.forEach(f => {
                    if (f.name?.toLowerCase().includes(query) || f.description?.toLowerCase().includes(query)) {
                        results.push({ type: 'feature', icon: '', name: f.name, id: f.id, panel: 'features' });
                    }
                });
            }

            // Search bugs (b: or no filter)
            if (!filter || filter === 'b') {
                searchCache.bugs.forEach(b => {
                    if (b.title?.toLowerCase().includes(query) || b.description?.toLowerCase().includes(query)) {
                        results.push({ type: 'bug', icon: '', name: b.title, id: b.id, panel: 'bugs' });
                    }
                });
            }

            // Search sessions (s: or no filter)
            if (!filter || filter === 's') {
                searchCache.sessions.forEach(s => {
                    if (s.name?.toLowerCase().includes(query)) {
                        results.push({ type: 'session', icon: '', name: s.name, id: s.name, panel: 'tmux' });
                    }
                });
            }

            searchResultsCache = results.slice(0, 10);
            searchSelectedIndex = searchResultsCache.length > 0 ? 0 : -1;

            if (results.length === 0) {
                resultsEl.innerHTML = `
                    <div class="search-result-item" style="color: var(--text-secondary); pointer-events: none;">No results</div>
                    <div class="search-hints" style="padding: 8px 12px; font-size: 11px; color: var(--text-secondary); border-top: 1px solid var(--border);">
                        <b>p:</b> projects &nbsp; <b>f:</b> features &nbsp; <b>b:</b> bugs &nbsp; <b>s:</b> sessions
                    </div>`;
            } else {
                resultsEl.innerHTML = searchResultsCache.map((r, i) => `
                    <div class="search-result-item ${i === searchSelectedIndex ? 'selected' : ''}"
                         data-index="${i}"
                         onclick="handleSearchResult('${r.panel}', '${r.id}', '${r.type}')"
                         onmouseenter="searchSelectedIndex=${i}; updateSearchSelection()">
                        <span class="search-result-icon">${r.icon}</span>
                        <span class="search-result-type">${r.type}</span>
                        <span class="search-result-name">${r.name}</span>
                    </div>
                `).join('') + `
                    <div class="search-hints" style="padding: 6px 12px; font-size: 10px; color: var(--text-secondary); border-top: 1px solid var(--border);">
                         navigate &nbsp;  select &nbsp; esc close
                    </div>`;
            }

            resultsEl.style.display = 'block';
        }

        function updateSearchSelection() {
            document.querySelectorAll('.search-result-item[data-index]').forEach((el) => {
                el.classList.toggle('selected', parseInt(el.dataset.index) === searchSelectedIndex);
            });
        }

        function handleSearchResult(panel, id, type) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('globalSearch').value = '';
            if (type === 'session') {
                navigateToPanel('tmux');
                setTimeout(() => selectSession(id), 300);
            } else {
                navigateToPanel(panel, id);
            }
        }

        // Close search results on outside click
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.global-search');
            if (!searchContainer?.contains(e.target)) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        // Keyboard shortcut: Cmd/Ctrl+K for search
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('globalSearch');
                searchInput.focus();
                searchInput.select();
            }
            // Escape to close search
            if (e.key === 'Escape') {
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('globalSearch').blur();
            }
        });

        // Update search cache periodically
        updateSearchCache();
        setInterval(updateSearchCache, 60000);

        // Handle URL hash changes (for direct linking)
        window.addEventListener('hashchange', () => {
            const parsed = parseHash(window.location.hash);
            if (parsed.panel !== currentPanel || parsed.id) {
                navigateToPanel(parsed.panel, parsed.id, parsed.subtype, parsed.subid);
            }
        });

        // Modal functions
        function showModal(name) {
            const modal = document.getElementById(`modal-${name}`);
            if (!modal) {
                console.warn(`Modal not found: modal-${name}`);
                return;
            }
            modal.classList.add('active');
            if (name === 'newFeature' || name === 'newBug') {
                populateProjectSelect(name === 'newFeature' ? 'newFeatureProject' : 'newBugProject');
            }
        }

        function hideModal(name) {
            const modal = document.getElementById(`modal-${name}`);
            if (!modal) {
                console.warn(`Modal not found: modal-${name}`);
                return;
            }
            modal.classList.remove('active');
            // Also reset display style for dynamically created modals
            modal.style.display = 'none';

            // Leave entity collaboration when closing edit/detail modals
            if (name === 'editFeature' || name === 'editBug' || name === 'editTask' ||
                name === 'taskDetails' || name === 'errorDetail') {
                CollaborationManager.leaveCurrentEntity();
            }
        }

        function populateProjectSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = projects.map(p =>
                `<option value="${p.id}">${p.name}</option>`
            ).join('');
        }

        // Load functions
        async function loadPanelData(panel, id = null, subtype = null, subid = null) {
            switch(panel) {
                case 'overview': await loadOverview(); break;
                case 'projects': await loadProjectsList(); break;
                case 'apps': await loadApps(); break;
                case 'features': await loadFeatures(); break;
                case 'bugs': await loadBugs(); break;
                case 'errors': await loadErrors(); break;
                case 'testing': await loadTestRuns(); break;
                case 'deployments': await loadDeployments(); break;
                case 'tmux': await loadTmuxSessions(); break;
                case 'nodes': await loadNodes(); break;
                case 'regions': await loadRegions(); break;
                case 'queue': await refreshQueue(); refreshOrchestratorTasks(); break;
                case 'tasks': await loadTasks(); break;
                case 'workers': await loadWorkers(); break;
                case 'services': await initServicesPanel(); break;
                case 'vault': await loadSecrets(); break;
                case 'accounts': await loadAccounts(); break;
                case 'focus': await initFocusPanel(id, subtype, subid); break;
                case 'docs': await loadDocumentation(); break;
                case 'system-overview': await loadSystemOverview(); break;
                case 'sop': await loadSopList(); break;
            }
        }

        async function loadProjects() {
            const response = await api('/projects');
            projects = Array.isArray(response) ? response : [];
            const list = document.getElementById('projectList');
            if (!list) return;

            list.innerHTML = `
                <button class="project-item ${currentProject === 'all' ? 'active' : ''}" data-project="all" onclick="selectProject('all')">
                    <span>All Projects</span>
                    <span class="project-badge">${projects.length}</span>
                </button>
                ${projects.map(p => `
                    <button class="project-item ${currentProject == p.id ? 'active' : ''}" data-project="${p.id}" onclick="selectProject(${p.id})">
                        <span>${p.name}</span>
                        <span class="project-badge">${(p.feature_count || 0) + (p.bug_count || 0)}</span>
                    </button>
                `).join('')}
            `;
        }

        function selectProject(projectId) {
            currentProject = projectId;
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.toggle('active', item.dataset.project == projectId);
            });
            loadPanelData(currentPanel);
        }

        async function loadStats() {
            const stats = await api('/stats');

            const statFeatures = document.getElementById('statFeatures');
            const statBugs = document.getElementById('statBugs');
            const statErrors = document.getElementById('statErrors');
            const statNodes = document.getElementById('statNodes');

            if (statFeatures) statFeatures.textContent = stats.features?.total || 0;
            if (statBugs) statBugs.textContent = stats.bugs?.open || 0;
            if (statErrors) statErrors.textContent = stats.errors?.open?.count || 0;
            if (statNodes) statNodes.textContent = Object.values(stats.nodes || {}).reduce((a, b) => a + b, 0);

            // Update pinned panel badges
            if (typeof updatePinnedBadges === 'function') {
                updatePinnedBadges();
            }

            const overviewProjects = document.getElementById('overviewProjects');
            const overviewFeatures = document.getElementById('overviewFeatures');
            const overviewBugs = document.getElementById('overviewBugs');
            const overviewErrors = document.getElementById('overviewErrors');

            if (overviewProjects) overviewProjects.textContent = stats.projects || 0;
            if (overviewFeatures) overviewFeatures.textContent = stats.features?.in_progress || 0;
            if (overviewBugs) overviewBugs.textContent = stats.bugs?.open || 0;
            if (overviewErrors) overviewErrors.textContent = stats.errors?.open?.count || 0;

            // Update global status bar
            const statusProjects = document.getElementById('statusProjects');
            const statusTasks = document.getElementById('statusTasks');
            const statusWorkers = document.getElementById('statusWorkers');
            const statusLastSync = document.getElementById('statusLastSync');

            if (statusProjects) statusProjects.textContent = `${stats.projects || 0} projects`;
            if (statusTasks) statusTasks.textContent = `${(stats.features?.total || 0) + (stats.bugs?.open || 0)} tasks`;
            if (statusWorkers) statusWorkers.textContent = `Workers: ${stats.workers?.active || 0}`;
            if (statusLastSync) statusLastSync.textContent = new Date().toLocaleTimeString();

            // Activity feed with clickable links
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = (stats.recent_activity || []).slice(0, 5).map(a => {
                const link = getActivityLink(a.action, a.entity_type, a.entity_id, a.details);
                const clickHandler = link ? `onclick="navigateToActivityTarget('${link.panel}', ${link.id || 'null'}, '${link.session || ''}')" style="cursor: pointer;"` : '';
                return `
                <div class="activity-item" ${clickHandler}>
                    <div class="activity-icon">${getActivityIcon(a.action)}</div>
                    <div class="activity-content">
                        <div class="activity-action">${formatAction(a.action, a.entity_type, a.details)}</div>
                        <div class="activity-time">${formatTime(a.created_at)}</div>
                    </div>
                    ${link ? '<div class="activity-arrow" style="color: var(--text-secondary); font-size: 12px;"></div>' : ''}
                </div>
            `}).join('');

            // Load environment health summary
            loadEnvHealthSummary();
        }

        async function loadEnvHealthSummary() {
            const container = document.getElementById('envHealthSummary');
            if (!container) return;

            try {
                // Use server-side proxy to avoid CORS/mixed-content issues
                const resp = await fetch('/api/env-health?all=true');
                if (!resp.ok) throw new Error('Failed to fetch env health');

                const results = await resp.json();

                container.innerHTML = results.map(env => `
                    <div class="env-health-item" onclick="window.open('${window.location.protocol}//${window.location.hostname}:${env.port}', '_blank')" style="cursor: pointer;" title="Click to open ${env.name}">
                        <div class="env-health-name">
                            <span>${env.icon}</span>
                            <span>${env.name}</span>
                            <span style="color: var(--text-secondary); font-size: 10px;">:${env.port}</span>
                        </div>
                        <span class="env-health-status ${env.status}">${env.status}</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load env health:', e);
                container.innerHTML = '<span style="color: var(--text-secondary);">Unable to check environments</span>';
            }
        }

        function getActivityIcon(action) {
            const icons = {
                'login': '', 'logout': '', 'create_project': '', 'create_feature': '',
                'create_bug': '', 'update_feature': '', 'update_bug': '', 'tmux_send': '',
                'tmux_create': '', 'resolve_error': ''
            };
            return icons[action] || '';
        }

        function formatAction(action, entityType, details) {
            return `${action.replace(/_/g, ' ')}${details ? `: ${details}` : ''}`;
        }

        // Navigate to activity target (panel + optional entity/session)
        function navigateToActivityTarget(panel, entityId, session) {
            navigateToPanel(panel);

            // If tmux panel with session, select the session
            if (panel === 'tmux' && session) {
                setTimeout(() => {
                    selectSession(session);
                }, 300);
            }

            // If entity-specific, try to highlight/show that entity
            if (entityId && panel === 'errors') {
                setTimeout(() => showErrorDetail(entityId), 300);
            }
        }

        // Get navigation target for activity item
        function getActivityLink(action, entityType, entityId, details) {
            // tmux actions -> go to tmux panel with session
            if (action.includes('tmux') || action.includes('assign') && details) {
                const sessionMatch = details?.match(/arch_\w+|claude|termus/i);
                if (sessionMatch) {
                    return { panel: 'tmux', session: sessionMatch[0] };
                }
                return { panel: 'tmux' };
            }
            // Entity-specific actions
            if (entityType === 'error' || action.includes('error')) {
                return { panel: 'errors', id: entityId };
            }
            if (entityType === 'bug' || action.includes('bug')) {
                return { panel: 'bugs', id: entityId };
            }
            if (entityType === 'feature' || action.includes('feature')) {
                return { panel: 'features', id: entityId };
            }
            if (entityType === 'project' || action.includes('project')) {
                return { panel: 'projects', id: entityId };
            }
            return null;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        // === Sidebar Section Toggle ===
        function toggleSidebarSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                // Save state to localStorage
                const collapsed = JSON.parse(localStorage.getItem('sidebarCollapsed') || '{}');
                collapsed[sectionId] = section.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', JSON.stringify(collapsed));
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const icon = document.getElementById('sidebarCollapseIcon');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                if (icon) {
                    icon.textContent = sidebar.classList.contains('collapsed') ? '' : '';
                }
                // Save state to localStorage
                localStorage.setItem('sidebarFullyCollapsed', sidebar.classList.contains('collapsed'));
            }
        }

        // Mobile/Tablet sidebar overlay toggle
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
                document.body.style.overflow = isOpen ? '' : 'hidden';
            }
        }

        // Close mobile sidebar on window resize if going to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 991) {
                const sidebar = document.getElementById('mainSidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        // === Focus Mode ===
        function toggleFocusMode() {
            const body = document.body;
            const btn = document.getElementById('focusToggle');
            const isActive = body.classList.toggle('focus-mode');

            if (btn) {
                btn.classList.toggle('active', isActive);
            }

            // Save state
            localStorage.setItem('focusMode', isActive);

            // Show notification
            if (isActive) {
                showNotification('Focus Mode enabled - distractions hidden', 'info');
            }
        }

        // Theme toggle function with smooth transition
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            const currentTheme = html.getAttribute('data-theme');

            // Add transition class for smooth animation
            html.classList.add('theme-transition');

            if (currentTheme === 'light') {
                html.removeAttribute('data-theme');
                icon.textContent = '';
                localStorage.setItem('theme', 'dark');
                showNotification('Dark mode enabled', 'info');
            } else {
                html.setAttribute('data-theme', 'light');
                icon.textContent = '';
                localStorage.setItem('theme', 'light');
                showNotification('Light mode enabled', 'info');
            }

            // Remove transition class after animation completes
            setTimeout(() => html.classList.remove('theme-transition'), 300);
        }

        // Set theme (used by system preference listener)
        function setTheme(theme) {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');

            html.classList.add('theme-transition');

            if (theme === 'light') {
                html.setAttribute('data-theme', 'light');
                if (icon) icon.textContent = '';
            } else {
                html.removeAttribute('data-theme');
                if (icon) icon.textContent = '';
            }

            setTimeout(() => html.classList.remove('theme-transition'), 300);
        }

        // Restore theme on load (also syncs icon state)
        function restoreTheme() {
            const savedTheme = localStorage.getItem('theme');
            const icon = document.getElementById('themeIcon');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Determine effective theme
            let effectiveTheme = 'dark'; // default
            if (savedTheme) {
                effectiveTheme = savedTheme;
            } else if (!prefersDark) {
                effectiveTheme = 'light';
            }

            // Apply theme (already applied by inline script, but sync icon)
            if (effectiveTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                if (icon) icon.textContent = '';
            } else {
                document.documentElement.removeAttribute('data-theme');
                if (icon) icon.textContent = '';
            }

            // Listen for system preference changes (only if no saved preference)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        // Restore focus mode state on load
        function restoreFocusMode() {
            if (localStorage.getItem('focusMode') === 'true') {
                document.body.classList.add('focus-mode');
                const btn = document.getElementById('focusToggle');
                if (btn) btn.classList.add('active');
            }
        }

        // Keyboard shortcut for focus mode (Ctrl+Shift+F)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                toggleFocusMode();
            }
            // ESC to exit focus mode
            if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) {
                toggleFocusMode();
            }
        });

        // Restore sidebar collapsed state on load
        function restoreSidebarState() {
            // Restore full sidebar collapse state
            const isFullyCollapsed = localStorage.getItem('sidebarFullyCollapsed') === 'true';
            if (isFullyCollapsed) {
                const sidebar = document.getElementById('mainSidebar');
                const icon = document.getElementById('sidebarCollapseIcon');
                if (sidebar) {
                    sidebar.classList.add('collapsed');
                    if (icon) icon.textContent = '';
                }
            }

            // Restore individual section collapse states
            const collapsed = JSON.parse(localStorage.getItem('sidebarCollapsed') || '{}');
            Object.keys(collapsed).forEach(sectionId => {
                if (collapsed[sectionId]) {
                    const section = document.getElementById(sectionId);
                    if (section) section.classList.add('collapsed');
                }
            });

            // Restore pinned panels
            renderPinnedPanels();
        }

        // === Quick Access / Pinned Panels ===
        const PANEL_CONFIG = {
            queue: { icon: '', name: 'Queue', priority: true },
            overview: { icon: '', name: 'Dashboard', priority: false },
            projects: { icon: '', name: 'Projects', priority: false },
            features: { icon: '', name: 'Features', priority: true },
            bugs: { icon: '', name: 'Bugs', priority: true },
            errors: { icon: '', name: 'Errors', priority: true },
            tmux: { icon: '', name: 'Sessions', priority: false },
            nodes: { icon: '', name: 'Nodes', priority: false },
            tasks: { icon: '', name: 'Tasks', priority: false },
            testing: { icon: '', name: 'Testing', priority: false },
            deployments: { icon: '', name: 'Deploy', priority: false },
            docs: { icon: '', name: 'Docs', priority: false }
        };

        function getPinnedPanels() {
            const stored = localStorage.getItem('pinnedPanels');
            if (stored) {
                return JSON.parse(stored);
            }
            // Default pinned panels
            return ['features', 'bugs', 'errors'];
        }

        function setPinnedPanels(panels) {
            localStorage.setItem('pinnedPanels', JSON.stringify(panels));
            renderPinnedPanels();
        }

        function togglePinPanel(panelName) {
            const pinned = getPinnedPanels();
            const index = pinned.indexOf(panelName);
            if (index > -1) {
                pinned.splice(index, 1);
                showNotification(`Unpinned ${PANEL_CONFIG[panelName]?.name || panelName}`, 'info');
            } else {
                if (pinned.length >= 6) {
                    showNotification('Maximum 6 pinned panels allowed', 'warning');
                    return;
                }
                pinned.push(panelName);
                showNotification(`Pinned ${PANEL_CONFIG[panelName]?.name || panelName}`, 'success');
            }
            setPinnedPanels(pinned);
        }

        function isPanelPinned(panelName) {
            return getPinnedPanels().includes(panelName);
        }

        function getPanelBadgeCount(panelName) {
            // Return badge counts based on current stats
            switch (panelName) {
                case 'features':
                    const featEl = document.getElementById('statFeatures');
                    return featEl ? parseInt(featEl.textContent) || 0 : 0;
                case 'bugs':
                    const bugEl = document.getElementById('statBugs');
                    return bugEl ? parseInt(bugEl.textContent) || 0 : 0;
                case 'errors':
                    const errEl = document.getElementById('statErrors');
                    return errEl ? parseInt(errEl.textContent) || 0 : 0;
                default:
                    return 0;
            }
        }

        function renderPinnedPanels() {
            const container = document.getElementById('pinnedPanels');
            const quickAccess = document.getElementById('sidebarQuickAccess');
            if (!container) return;

            const pinned = getPinnedPanels();

            // Hide section if no pinned panels
            if (pinned.length === 0) {
                if (quickAccess) quickAccess.style.display = 'none';
                return;
            }
            if (quickAccess) quickAccess.style.display = 'block';

            container.innerHTML = pinned.map(panelName => {
                const config = PANEL_CONFIG[panelName] || { icon: '', name: panelName };
                const count = getPanelBadgeCount(panelName);
                const badgeHtml = count > 0 ? `<span class="chip-badge${config.priority ? '' : ' warning'}">${count}</span>` : '';

                return `
                    <button class="pinned-panel-chip" onclick="navigateToPanel('${panelName}')" title="${config.name}">
                        <span class="chip-icon">${config.icon}</span>
                        <span>${config.name}</span>
                        ${badgeHtml}
                        <span class="unpin-btn" onclick="event.stopPropagation(); togglePinPanel('${panelName}')" title="Unpin"></span>
                    </button>
                `;
            }).join('') + `
                <button class="add-pin-btn" onclick="showPinPanelMenu(event)" title="Pin a panel">+</button>
            `;
        }

        function showPinPanelMenu(event) {
            event.stopPropagation();

            // Remove existing menu
            const existingMenu = document.getElementById('pinPanelMenu');
            if (existingMenu) existingMenu.remove();

            const pinned = getPinnedPanels();
            const unpinnedPanels = Object.keys(PANEL_CONFIG).filter(p => !pinned.includes(p));

            if (unpinnedPanels.length === 0) {
                showNotification('All panels are already pinned', 'info');
                return;
            }

            const menu = document.createElement('div');
            menu.id = 'pinPanelMenu';
            menu.style.cssText = `
                position: fixed;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 8px 0;
                z-index: 1001;
                min-width: 150px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            menu.innerHTML = unpinnedPanels.map(panelName => {
                const config = PANEL_CONFIG[panelName];
                return `
                    <button style="display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 16px; background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 13px; text-align: left;"
                            onmouseover="this.style.background='var(--bg-hover)'"
                            onmouseout="this.style.background='none'"
                            onclick="togglePinPanel('${panelName}'); this.parentElement.remove()">
                        <span>${config.icon}</span>
                        <span>${config.name}</span>
                    </button>
                `;
            }).join('');

            document.body.appendChild(menu);

            // Position near the button
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 4) + 'px';

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        // Update pinned panel badges when stats change
        function updatePinnedBadges() {
            renderPinnedPanels();
        }

        // Expose functions globally
        window.togglePinPanel = togglePinPanel;
        window.showPinPanelMenu = showPinPanelMenu;
        window.isPanelPinned = isPanelPinned;

        // === Auto-refresh Toggle (Enhanced) ===
        let autoRefreshInterval = null;
        let autoRefreshCountdown = null;
        let autoRefreshSecondsLeft = 0;
        const DEFAULT_REFRESH_INTERVAL = 120000; // 120 seconds (2 minutes) - reduced API load
        let currentRefreshInterval = parseInt(localStorage.getItem('refreshInterval')) || DEFAULT_REFRESH_INTERVAL;

        function toggleAutoRefresh(enabled) {
            // Use DashboardRefresh module if available
            if (typeof DashboardRefresh !== 'undefined') {
                if (enabled) {
                    DashboardRefresh.startAutoRefresh(currentRefreshInterval);
                } else {
                    DashboardRefresh.stopAutoRefresh();
                }
            }

            // Also maintain local state for backward compatibility
            if (enabled) {
                autoRefreshInterval = setInterval(() => {
                    refreshAll({ silent: true });
                }, currentRefreshInterval);
                localStorage.setItem('autoRefreshEnabled', 'true');
                startAutoRefreshCountdown();
                updateAutoRefreshStatusUI(true);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                if (autoRefreshCountdown) {
                    clearInterval(autoRefreshCountdown);
                    autoRefreshCountdown = null;
                }
                localStorage.setItem('autoRefreshEnabled', 'false');
                updateAutoRefreshStatusUI(false);
            }
        }

        function startAutoRefreshCountdown() {
            autoRefreshSecondsLeft = Math.floor(currentRefreshInterval / 1000);
            updateCountdownDisplay();

            if (autoRefreshCountdown) clearInterval(autoRefreshCountdown);
            autoRefreshCountdown = setInterval(() => {
                autoRefreshSecondsLeft--;
                if (autoRefreshSecondsLeft <= 0) {
                    autoRefreshSecondsLeft = Math.floor(currentRefreshInterval / 1000);
                }
                updateCountdownDisplay();
            }, 1000);
        }

        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('refreshCountdown');
            if (countdownEl) {
                countdownEl.textContent = `(${autoRefreshSecondsLeft}s)`;
            }
        }

        function updateAutoRefreshStatusUI(enabled) {
            const statusEl = document.getElementById('autoRefreshStatus');
            if (statusEl) {
                statusEl.textContent = enabled ? 'On' : 'Off';
                statusEl.style.color = enabled ? 'var(--success)' : 'var(--text-secondary)';
            }
        }

        function setRefreshInterval(ms) {
            currentRefreshInterval = Math.max(120000, Math.min(ms, 300000));  // Min 120s (2 min) to prevent rate limiting
            localStorage.setItem('refreshInterval', currentRefreshInterval);

            // Restart auto-refresh with new interval if enabled
            const enabled = localStorage.getItem('autoRefreshEnabled') === 'true';
            if (enabled) {
                toggleAutoRefresh(false);
                toggleAutoRefresh(true);
            }
        }

        // Restore auto-refresh state
        function restoreAutoRefreshState() {
            const enabled = localStorage.getItem('autoRefreshEnabled') === 'true';
            const savedInterval = localStorage.getItem('refreshInterval');
            if (savedInterval) {
                currentRefreshInterval = parseInt(savedInterval);
            }

            const toggle = document.getElementById('autoRefreshToggle');
            if (toggle) {
                toggle.checked = enabled;
                if (enabled) toggleAutoRefresh(true);
            }

            // Update interval selector if present
            const intervalSelect = document.getElementById('refreshIntervalSelect');
            if (intervalSelect) {
                intervalSelect.value = currentRefreshInterval;
            }
        }

        // === Alert Banner ===
        let alertBannerDismissed = false;
        let offlineEnvironments = [];

        function updateAlertBanner(errorCount, offlineEnvs) {
            const banner = document.getElementById('alertBanner');
            const textEl = document.getElementById('alertBannerText');
            const envAction = document.getElementById('alertBannerEnvAction');

            if (alertBannerDismissed || (errorCount === 0 && offlineEnvs.length === 0)) {
                if (banner) banner.style.display = 'none';
                return;
            }

            offlineEnvironments = offlineEnvs;

            const parts = [];
            if (errorCount > 0) parts.push(`${errorCount} open error${errorCount > 1 ? 's' : ''}`);
            if (offlineEnvs.length > 0) parts.push(`${offlineEnvs.length} env${offlineEnvs.length > 1 ? 's' : ''} offline (${offlineEnvs.join(', ')})`);

            if (textEl) textEl.textContent = parts.join('  ');
            if (envAction) envAction.style.display = offlineEnvs.length > 0 ? 'inline-block' : 'none';
            if (banner) banner.style.display = 'flex';
        }

        function dismissAlertBanner() {
            const banner = document.getElementById('alertBanner');
            if (banner) banner.style.display = 'none';
            alertBannerDismissed = true;
            // Reset after 5 minutes
            setTimeout(() => { alertBannerDismissed = false; }, 300000);
        }

        function restartOfflineEnv() {
            if (offlineEnvironments.length === 0) return;
            const env = offlineEnvironments[0];
            showNotification(`Restarting ${env}...`, 'info');
            // Would call restart API here
            api('/environments/' + env.toLowerCase() + '/restart', { method: 'POST' })
                .then(() => {
                    showNotification(`${env} restart initiated`, 'success');
                    loadEnvironmentsStatus();
                })
                .catch(() => {
                    showNotification(`Failed to restart ${env}`, 'error');
                });
        }

        // === Update Last Refresh Time ===
        function updateLastRefreshTime() {
            const el = document.getElementById('lastRefreshTime');
            if (el) el.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        // === Enhanced Environment Cards ===
        // Use current hostname for environment checks (works across different hosts)
        const ENV_HOST = window.location.hostname || 'localhost';
        const ENVIRONMENTS = [
            { id: 'prod', name: 'PROD', port: 8080 },
            { id: 'qa', name: 'QA', port: 8081 },
            { id: 'dev', name: 'DEV', port: 8082 },
            { id: 'env3', name: 'ENV3', port: 8085 }
        ];

        // Project port/environment configurations
        const PROJECT_PORTS = {
            'architect': {
                envs: [
                    { name: 'PROD', port: 8080, protocol: 'https' },
                    { name: 'QA', port: 8081, protocol: 'http' },
                    { name: 'DEV', port: 8082, protocol: 'http' },
                    { name: 'ENV3', port: 8085, protocol: 'http' }
                ],
                docs: '/architecture/'
            },
            'basic_edu_apps_final': {
                envs: [
                    { name: 'PROD', port: 5051, protocol: 'https' },
                    { name: 'DEV', port: 5052, protocol: 'http' }
                ],
                docs: '/docs/'
            },
            'kanbanflow': {
                envs: [
                    { name: 'DEV', port: 6051, protocol: 'https' },
                    { name: 'QA', port: 6052, protocol: 'http' },
                    { name: 'STAGING', port: 6053, protocol: 'http' },
                    { name: 'PROD', port: 6054, protocol: 'http' }
                ],
                docs: null
            }
        };

        function getProjectPorts(projectName) {
            // Check exact match first
            if (PROJECT_PORTS[projectName]) return PROJECT_PORTS[projectName];
            // Check case-insensitive
            const lower = projectName.toLowerCase();
            for (const [key, value] of Object.entries(PROJECT_PORTS)) {
                if (key.toLowerCase() === lower) return value;
            }
            return null;
        }

        async function loadEnvironmentsStatus() {
            const grid = document.getElementById('environmentsGrid');
            if (!grid) return;

            const offlineEnvs = [];

            grid.innerHTML = ENVIRONMENTS.map(env => `
                <div class="env-card-enhanced" data-env="${env.id}">
                    <div class="env-card-header">
                        <span class="env-name">${env.name}</span>
                        <span class="status-dot pending pulse" id="env-dot-${env.id}"></span>
                    </div>
                    <div class="env-card-info">
                        <div class="env-host">Port ${env.port}</div>
                        <div class="env-status-text" id="env-status-${env.id}">Checking...</div>
                    </div>
                    <div class="env-card-metrics" id="env-metrics-${env.id}" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                        <div style="display: flex; gap: 12px; font-size: 11px;">
                            <div style="flex: 1;">
                                <div style="color: var(--text-secondary); margin-bottom: 2px;">CPU</div>
                                <div class="env-cpu" style="font-weight: 600;">--</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="color: var(--text-secondary); margin-bottom: 2px;">Memory</div>
                                <div class="env-memory" style="font-weight: 600;">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="env-card-actions">
                        <a href="javascript:void(0)" onclick="window.open(location.protocol + '//' + location.hostname + ':${env.port}', '_blank')" class="btn btn-sm" title="Open ${env.name} in new tab">Open</a>
                        <button class="btn btn-sm" onclick="viewEnvLogs('${env.id}')" title="View server logs for ${env.name}">Logs</button>
                        <button class="btn btn-sm" onclick="restartEnv('${env.id}')" title="Restart ${env.name} server"></button>
                    </div>
                </div>
            `).join('');

            // Use server-side proxy to check all environments (avoids CORS/ERR_BLOCKED_BY_CLIENT)
            try {
                const resp = await fetch('/api/env-health?all=true');
                if (!resp.ok) throw new Error('Failed to fetch env health');

                const results = await resp.json();
                const resultsArray = Array.isArray(results) ? results : [];

                // Update each environment card based on server response
                for (const env of ENVIRONMENTS) {
                    const dot = document.getElementById(`env-dot-${env.id}`);
                    const status = document.getElementById(`env-status-${env.id}`);
                    const metrics = document.getElementById(`env-metrics-${env.id}`);

                    // Find matching result by port
                    const result = resultsArray.find(r => r.port === env.port);

                    if (result && (result.status === 'online' || result.status === 'healthy')) {
                        if (dot) dot.className = 'status-dot online';
                        if (status) { status.textContent = 'Online'; status.style.color = 'var(--success)'; }

                        // Show metrics if available
                        if (metrics && (result.cpu !== undefined || result.memory !== undefined)) {
                            metrics.style.display = 'block';
                            const cpuEl = metrics.querySelector('.env-cpu');
                            const memEl = metrics.querySelector('.env-memory');
                            if (cpuEl && result.cpu !== undefined) cpuEl.textContent = `${result.cpu}%`;
                            if (memEl && result.memory !== undefined) memEl.textContent = `${result.memory}%`;
                        }
                    } else {
                        if (dot) dot.className = 'status-dot offline';
                        if (status) { status.textContent = 'Offline'; status.style.color = 'var(--error)'; }
                        offlineEnvs.push(env.name);
                    }
                }
            } catch (e) {
                console.error('Failed to load environment status:', e);
                // Mark all as unknown on error
                for (const env of ENVIRONMENTS) {
                    const dot = document.getElementById(`env-dot-${env.id}`);
                    const status = document.getElementById(`env-status-${env.id}`);
                    if (dot) dot.className = 'status-dot offline';
                    if (status) { status.textContent = 'Unknown'; status.style.color = 'var(--text-secondary)'; }
                }
            }

            // Update alert banner
            const errorCount = parseInt(document.getElementById('overviewErrors')?.textContent || '0');
            updateAlertBanner(errorCount, offlineEnvs);
        }

        function viewEnvLogs(envId) {
            showNotification(`Opening logs for ${envId.toUpperCase()}...`, 'info');
            // Would open logs panel or modal
        }

        function restartEnv(envId) {
            if (!confirm(`Restart ${envId.toUpperCase()} environment?`)) return;
            showNotification(`Restarting ${envId.toUpperCase()}...`, 'info');
            api('/environments/' + envId + '/restart', { method: 'POST' })
                .then(() => {
                    showNotification(`${envId.toUpperCase()} restart initiated`, 'success');
                    setTimeout(loadEnvironmentsStatus, 5000);
                })
                .catch(() => {
                    showNotification(`Failed to restart ${envId.toUpperCase()}`, 'error');
                });
        }

        async function loadRunningServices() {
            const grid = document.getElementById('runningServicesGrid');
            if (!grid) return;

            grid.innerHTML = '<p style="color: var(--text-secondary);">Loading services...</p>';

            try {
                const data = await api('/services');
                const services = data.services || [];

                if (services.length === 0) {
                    grid.innerHTML = '<p style="color: var(--text-secondary);">No Python services detected</p>';
                    return;
                }

                grid.innerHTML = services.map(svc => {
                    const healthColor = svc.health === 'healthy' ? 'var(--success)' :
                                       svc.health === 'no-health-endpoint' ? 'var(--warning)' : 'var(--text-secondary)';
                    const healthIcon = svc.health === 'healthy' ? '' :
                                      svc.health === 'no-health-endpoint' ? '' : '?';
                    const typeIcon = svc.type === 'dashboard' ? '' :
                                    svc.type === 'webapp' ? '' : '';

                    return `
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; border-left: 3px solid ${healthColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600;">${typeIcon} ${svc.name}</span>
                                <span style="color: ${healthColor}; font-size: 12px;">${healthIcon} ${svc.health}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                <span style="color: var(--text-secondary);">:${svc.port}  ${svc.env}</span>
                                <a href="${svc.url}" target="_blank" class="btn btn-sm" style="padding: 2px 8px; font-size: 11px;">Open</a>
                            </div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 6px;">PID: ${svc.pid}</div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load running services:', e);
                grid.innerHTML = '<p style="color: var(--error);">Failed to load services</p>';
            }
        }

        async function loadOverview() {
            await loadStats();

            // Load system health data
            await loadOverviewSystemHealth();

            // Load environments status
            await loadEnvironmentsStatus();

            // Load running services
            await loadRunningServices();

            // Load critical items
            await loadOverviewCriticalItems();

            // Load active work
            await loadOverviewActiveWork();

            // Load tmux sessions overview
            await loadOverviewTmuxSessions();

            // Load recent activity
            await loadOverviewActivity();

            // Update last refresh times
            document.getElementById('overviewLastRefresh').textContent = new Date().toLocaleTimeString();
            updateLastRefreshTime();

            // Projects grid - clicking goes to Focus panel for that project
            const grid = document.getElementById('overviewProjects');
            grid.innerHTML = projects.slice(0, 6).map(p => `
                <div class="card project-card" onclick="navigateToPanel('focus', ${p.id})" style="cursor: pointer;">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${p.name}</div>
                            <div class="card-meta" style="font-family: monospace; font-size: 11px;">${p.source_path || 'No path'}</div>
                        </div>
                        <span class="badge badge-${p.status}">${p.status}</span>
                    </div>
                    <div class="card-body" style="font-size: 13px; color: var(--text-secondary);">${p.description || 'No description'}</div>
                    <div class="card-footer" style="display: flex; gap: 12px; font-size: 12px;">
                        <span onclick="event.stopPropagation(); navigateToPanel('focus', ${p.id})" style="cursor: pointer; color: ${p.feature_count > 0 ? 'var(--accent)' : 'var(--text-secondary)'};">
                            ${p.feature_count} features
                        </span>
                        <span onclick="event.stopPropagation(); navigateToPanel('bugs'); filterBugsByProject(${p.id})" style="cursor: pointer; color: ${p.bug_count > 0 ? 'var(--warning)' : 'var(--text-secondary)'};">
                            ${p.bug_count} bugs
                        </span>
                        <span onclick="event.stopPropagation(); navigateToPanel('errors'); filterErrorsByProject(${p.id})" style="cursor: pointer; color: ${p.error_count > 0 ? 'var(--error)' : 'var(--text-secondary)'};">
                            ${p.error_count} errors
                        </span>
                    </div>
                </div>
            `).join('');

            if (projects.length > 6) {
                grid.innerHTML += `
                    <div class="card" onclick="navigateToPanel('projects')" style="cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 150px;">
                        <div style="text-align: center; color: var(--text-secondary);">
                            <div style="font-size: 24px;">+${projects.length - 6}</div>
                            <div>more projects</div>
                        </div>
                    </div>
                `;
            }
        }

        async function loadOverviewSystemHealth() {
            try {
                const [nodes, workers, stats, accounts] = await Promise.all([
                    api('/nodes'),
                    api('/workers/status'),
                    api('/stats'),
                    api('/accounts').catch(() => [])
                ]);

                const onlineNodes = nodes.filter(n => n.status === 'online').length;
                const tmuxCount = stats.tmux_sessions || 0;
                const activeWorkers = workers.stats?.active || 0;
                const activeAccounts = accounts.filter(a => a.status === 'online').length;

                document.getElementById('overviewNodesOnline').textContent = onlineNodes;
                document.getElementById('overviewAccountsActive').textContent = activeAccounts;
                document.getElementById('overviewTmuxActive').textContent = tmuxCount;
                document.getElementById('overviewWorkersActive').textContent = activeWorkers;
                document.getElementById('overviewProjectCount').textContent = stats.projects || 0;

                // Show active accounts with quick login
                const accountsList = document.getElementById('overviewAccountsList');
                if (accounts.length > 0) {
                    accountsList.innerHTML = `
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">Active Accounts:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${accounts.slice(0, 5).map(a => `
                                <span style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 11px; display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 6px; height: 6px; border-radius: 50%; background: ${a.status === 'online' ? 'var(--success)' : 'var(--text-secondary)'};"></span>
                                    ${a.user}@${a.hostname}
                                </span>
                            `).join('')}
                            ${accounts.length > 5 ? `<span style="font-size: 11px; color: var(--text-secondary);">+${accounts.length - 5} more</span>` : ''}
                        </div>
                    `;
                } else {
                    accountsList.innerHTML = '';
                }

                // Update system status
                const statusEl = document.getElementById('overviewSystemStatus');
                if (onlineNodes === 0 && nodes.length > 0) {
                    statusEl.className = 'badge badge-critical';
                    statusEl.textContent = 'Offline';
                } else if (onlineNodes < nodes.length) {
                    statusEl.className = 'badge badge-warning';
                    statusEl.textContent = 'Degraded';
                } else {
                    statusEl.className = 'badge badge-online';
                    statusEl.textContent = 'Healthy';
                }

                // Calculate uptime (mock - would need server-side tracking)
                const startTime = sessionStorage.getItem('dashboardStart');
                if (!startTime) {
                    sessionStorage.setItem('dashboardStart', Date.now().toString());
                    document.getElementById('overviewUptime').textContent = '0m';
                } else {
                    const uptime = Date.now() - parseInt(startTime);
                    const minutes = Math.floor(uptime / 60000);
                    const hours = Math.floor(minutes / 60);
                    if (hours > 0) {
                        document.getElementById('overviewUptime').textContent = `${hours}h ${minutes % 60}m`;
                    } else {
                        document.getElementById('overviewUptime').textContent = `${minutes}m`;
                    }
                }
            } catch (e) {
                console.error('Failed to load system health:', e);
            }
        }

        async function loadOverviewCriticalItems() {
            try {
                const [bugs, errors] = await Promise.all([
                    api('/bugs?severity=critical&status=open'),
                    api('/errors?status=open')
                ]);

                // Also get high severity bugs
                const highBugs = await api('/bugs?severity=high&status=open');
                const criticalBugs = bugs.concat(highBugs);

                // Get recent errors (last 10)
                const recentErrors = errors.slice(0, 5);

                const list = document.getElementById('criticalItemsList');
                const count = document.getElementById('criticalCount');
                const totalCritical = criticalBugs.length + recentErrors.length;
                count.textContent = totalCritical;

                if (totalCritical === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No critical items</p>';
                    return;
                }

                let html = '';

                // Critical/High bugs - clickable items that link to Focus panel
                for (const bug of criticalBugs.slice(0, 3)) {
                    html += `
                        <div class="critical-item" onclick="navigateToPanel('focus', ${bug.project_id}, 'bug', ${bug.id})" style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                            <span class="badge badge-${bug.severity}">${bug.severity}</span>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${bug.title}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    <a href="#focus/${bug.project_id}" onclick="event.stopPropagation(); navigateToPanel('focus', ${bug.project_id})" style="color: var(--accent); text-decoration: none;">${bug.project_name || 'Unknown'}</a>
                                    <span style="margin-left: 8px; opacity: 0.5;">${formatTime(bug.created_at)}</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); startWorkingOnBug(${bug.id})">Start Working</button>
                        </div>
                    `;
                }

                // Recent errors - clickable items that link to Errors panel with filter
                for (const error of recentErrors.slice(0, 2)) {
                    html += `
                        <div class="critical-item" onclick="navigateToPanel('errors', ${error.id})" style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                            <span class="badge badge-critical">error</span>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${error.message || 'Unknown error'}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    <span>x${error.occurrence_count}</span>
                                    <span style="margin: 0 6px;"></span>
                                    <span>${error.source || 'Unknown'}</span>
                                    <span style="margin-left: 8px; opacity: 0.5;">${formatTime(error.last_seen)}</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); resolveError(${error.id})">Resolve</button>
                        </div>
                    `;
                }

                list.innerHTML = html;
            } catch (e) {
                console.error('Failed to load critical items:', e);
            }
        }

        // Track current detail view for realtime updates
        let currentDetailType = null;
        let currentDetailId = null;
        let detailRefreshInterval = null;

        async function showCriticalDetail(type, id) {
            currentDetailType = type;
            currentDetailId = id;

            const titleEl = document.getElementById('criticalDetailTitle');
            const bodyEl = document.getElementById('criticalDetailBody');
            const footerEl = document.getElementById('criticalDetailFooter');

            bodyEl.innerHTML = '<p style="text-align: center;">Loading...</p>';
            showModal('criticalDetail');

            try {
                if (type === 'bug') {
                    const bugs = await api(`/bugs?id=${id}`);
                    const bug = bugs.find(b => b.id === id) || bugs[0];
                    if (!bug) throw new Error('Bug not found');

                    titleEl.innerHTML = `<span class="badge badge-${bug.severity}" style="margin-right: 10px;">${bug.severity}</span> ${bug.title}`;

                    bodyEl.innerHTML = `
                        <div style="display: grid; gap: 16px;">
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Project</label>
                                <div style="font-weight: 500;">${bug.project_name || 'Unknown'}</div>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Status</label>
                                <div><span class="badge badge-${bug.status}">${bug.status}</span></div>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Description</label>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; white-space: pre-wrap;">${bug.description || 'No description'}</div>
                            </div>
                            ${bug.tmux_session ? `
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Assigned Session</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="badge badge-open">${bug.tmux_session}</span>
                                    <button class="btn btn-secondary" onclick="captureAndShowSession('${bug.tmux_session}')">View Output</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Resolution Progress</label>
                                <div id="resolutionProgress" style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                                    <p style="color: var(--text-secondary);">Click "View Output" to see session activity</p>
                                </div>
                            </div>
                            ` : ''}
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Timeline</label>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    Created: ${formatTime(bug.created_at)}<br>
                                    Updated: ${formatTime(bug.updated_at)}
                                </div>
                            </div>
                        </div>
                    `;

                    footerEl.innerHTML = `
                        <button class="btn btn-secondary" onclick="hideModal('criticalDetail')">Close</button>
                        ${!bug.tmux_session ? `<button class="btn btn-primary" onclick="hideModal('criticalDetail'); startWorkingOnBug(${bug.id})">Start Working</button>` : ''}
                        ${bug.status !== 'resolved' ? `<button class="btn btn-success" onclick="markBugComplete(${bug.id}); hideModal('criticalDetail');">Mark Complete</button>` : ''}
                    `;

                    // Start realtime updates if assigned to tmux
                    if (bug.tmux_session) {
                        startDetailRefresh(bug.tmux_session);
                    }

                } else if (type === 'error') {
                    const errors = await api('/errors?status=open');
                    const error = errors.find(e => e.id === id);
                    if (!error) throw new Error('Error not found');

                    titleEl.innerHTML = `<span class="badge badge-critical">Error</span> ${error.error_type}`;

                    bodyEl.innerHTML = `
                        <div style="display: grid; gap: 16px;">
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Message</label>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; word-break: break-word;">${error.message}</div>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Source</label>
                                <div style="font-family: monospace;">${error.source || 'Unknown'}</div>
                            </div>
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Occurrences</label>
                                <div><span class="badge badge-critical">${error.occurrence_count}x</span></div>
                            </div>
                            ${error.stack_trace ? `
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Stack Trace</label>
                                <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto; max-height: 200px;">${error.stack_trace}</pre>
                            </div>
                            ` : ''}
                            <div class="form-group">
                                <label style="color: var(--text-secondary);">Timeline</label>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    First seen: ${formatTime(error.first_seen)}<br>
                                    Last seen: ${formatTime(error.last_seen)}<br>
                                    Node: ${error.node_id || 'local'}
                                </div>
                            </div>
                        </div>
                    `;

                    footerEl.innerHTML = `
                        <button class="btn btn-secondary" onclick="hideModal('criticalDetail')">Close</button>
                        <button class="btn btn-primary" onclick="createBugFromErrorOverview(${error.id})">Create Bug</button>
                        <button class="btn btn-success" onclick="resolveErrorFromDetail(${error.id})">Mark Resolved</button>
                    `;
                }
            } catch (e) {
                console.error('Failed to load detail:', e);
                bodyEl.innerHTML = `<p style="color: var(--error);">Failed to load: ${e.message}</p>`;
            }
        }

        function startDetailRefresh(sessionName) {
            // Clear any existing interval
            if (detailRefreshInterval) clearInterval(detailRefreshInterval);

            // Refresh every 5 seconds
            // Auto-refresh disabled - refresh manually instead
            /* DISABLED FOR PERFORMANCE
            // DISABLED: detailRefreshInterval = setInterval(async () => {
                if (!document.getElementById('modal-criticalDetail').classList.contains('active')) {
                    clearInterval(detailRefreshInterval);
                    return;
                }
                await captureAndShowSession(sessionName);
            }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Reduced from 5s to 60s
            */
        }

        async function captureAndShowSession(sessionName) {
            const progressEl = document.getElementById('resolutionProgress');
            if (!progressEl) return;

            try {
                const result = await api('/tmux/capture', 'POST', { session: sessionName, lines: 50 });
                if (result.output) {
                    progressEl.innerHTML = `<pre style="margin: 0; white-space: pre-wrap;">${result.output}</pre>`;
                    progressEl.scrollTop = progressEl.scrollHeight;
                }
            } catch (e) {
                console.error('Failed to capture session:', e);
            }
        }

        async function resolveBugFromDetail(bugId) {
            await updateBug(bugId, 'resolved');
            hideModal('criticalDetail');
            loadOverviewCriticalItems();
            showNotification('Bug marked as resolved', 'success');
        }

        async function resolveErrorFromDetail(errorId) {
            await resolveError(errorId);
            hideModal('criticalDetail');
            loadOverviewCriticalItems();
        }

        async function createBugFromErrorOverview(errorId) {
            try {
                // Get or select a project for the bug
                let projectId = currentProject !== 'all' ? currentProject : null;
                if (!projectId && projects.length > 0) {
                    projectId = projects[0].id;
                }
                if (!projectId) {
                    showNotification('No project available. Create a project first.', 'error');
                    return;
                }

                const result = await api(`/errors/${errorId}/create-bug`, 'POST', {
                    project_id: projectId
                });
                if (result.success) {
                    hideModal('criticalDetail');
                    showNotification('Bug created from error', 'success');
                    loadOverviewCriticalItems();
                }
            } catch (e) {
                showNotification('Failed to create bug: ' + e.message, 'error');
            }
        }

        async function loadOverviewActiveWork() {
            try {
                const response = await api('/features?status=in_progress');
                const features = Array.isArray(response) ? response : [];
                const list = document.getElementById('activeWorkList');
                if (!list) return;

                if (features.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No active work</p>';
                    return;
                }

                list.innerHTML = features.slice(0, 5).map(f => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; cursor: pointer;" onclick="navigateToPanel('focus', ${f.project_id}, 'feature', ${f.id})">
                        <span class="badge badge-in_progress">in progress</span>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                <a href="#focus/${f.project_id}" onclick="event.stopPropagation(); navigateToPanel('focus', ${f.project_id})" style="color: var(--accent); text-decoration: none;">${f.project_name || 'Unknown'}</a>
                                ${f.tmux_session ? ` <span style="opacity: 0.5;"></span> tmux: ${f.tmux_session}` : ''}
                            </div>
                        </div>
                        ${f.tmux_session
                            ? `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); selectSession('${f.tmux_session}'); navigateToPanel('tmux');">View</button>`
                            : `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); queueFeature(${f.id})">Queue</button>`
                        }
                    </div>
                `).join('');

                if (features.length > 5) {
                    list.innerHTML += `
                        <div style="text-align: center; padding: 8px; color: var(--text-secondary); cursor: pointer;" onclick="navigateToPanel('features')">
                            +${features.length - 5} more in progress
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Failed to load active work:', e);
            }
        }

        // Helper functions to filter bugs/errors by project
        function filterBugsByProject(projectId) {
            const select = document.getElementById('bugProjectFilter');
            if (select) {
                select.value = projectId;
                loadBugsList();
            }
        }

        function filterErrorsByProject(projectId) {
            // Store project filter and reload errors
            sessionStorage.setItem('errorProjectFilter', projectId);
            loadErrors();
        }

        async function loadOverviewTmuxSessions() {
            try {
                await api('/tmux/sessions/refresh', 'POST');
                const response = await api('/tmux/sessions');
                const sessions = Array.isArray(response) ? response : [];
                const grid = document.getElementById('tmuxOverviewGrid');
                if (!grid) return;

                if (sessions.length === 0) {
                    grid.innerHTML = '<p style="color: var(--text-secondary);">No tmux sessions</p>';
                    return;
                }

                grid.innerHTML = sessions.slice(0, 8).map(s => `
                    <div style="background: var(--bg-tertiary); padding: 10px 14px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                         onclick="captureTmux('${s.session_name}'); navigateToPanel('tmux');">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${s.attached ? 'var(--success)' : 'var(--text-secondary)'}"></div>
                        <span style="font-weight: 500;">${s.session_name}</span>
                        <span style="font-size: 12px; color: var(--text-secondary);">${s.window_count}w</span>
                    </div>
                `).join('');

                if (sessions.length > 8) {
                    grid.innerHTML += `
                        <div style="background: var(--bg-tertiary); padding: 10px 14px; border-radius: 6px; cursor: pointer; color: var(--text-secondary);"
                             onclick="navigateToPanel('tmux')">
                            +${sessions.length - 8} more
                        </div>
                    `;
                }

                // Update tmux count in system health
                document.getElementById('overviewTmuxActive').textContent = sessions.length;
            } catch (e) {
                console.error('Failed to load tmux sessions:', e);
            }
        }

        async function loadOverviewActivity() {
            try {
                const stats = await api('/stats');
                const feed = document.getElementById('overviewActivityFeed');

                const activities = stats.recent_activity || [];
                if (activities.length === 0) {
                    feed.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No recent activity</p>';
                    return;
                }

                feed.innerHTML = activities.slice(0, 10).map(a => `
                    <div class="activity-item">
                        <div class="activity-icon">${getActivityIcon(a.action)}</div>
                        <div class="activity-content">
                            <div class="activity-action">${formatAction(a.action, a.entity_type, a.details)}</div>
                            <div class="activity-time">${formatTime(a.created_at)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load activity:', e);
            }
        }

        async function loadFeatures() {
            const statusFilter = document.getElementById('featureStatusFilter');
            const searchInput = document.getElementById('featureSearch');
            const status = statusFilter?.value || '';
            const search = searchInput?.value || '';

            let endpoint = '/features?';
            if (currentProject !== 'all') endpoint += `project_id=${currentProject}&`;
            if (status) endpoint += `status=${status}&`;

            const response = await api(endpoint);
            const features = Array.isArray(response) ? response : [];
            const filtered = search
                ? features.filter(f => f.name?.toLowerCase().includes(search.toLowerCase()))
                : features;

            // Group features by project
            const byProject = {};
            for (const f of filtered) {
                const projectKey = f.project_id || 0;
                const projectName = f.project_name || 'Unknown Project';
                if (!byProject[projectKey]) {
                    byProject[projectKey] = { name: projectName, features: [] };
                }
                byProject[projectKey].features.push(f);
            }

            const grid = document.getElementById('featuresGrid');
            if (!grid) return;

            if (Object.keys(byProject).length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary)">No features found</p>';
                return;
            }

            // If filtering by single project, show features directly
            if (currentProject !== 'all') {
                grid.innerHTML = filtered.map(f => renderFeatureCard(f)).join('');
                return;
            }

            // Show grouped by project
            let html = '';
            for (const projectId of Object.keys(byProject)) {
                const group = byProject[projectId];
                const statusCounts = {
                    proposed: group.features.filter(f => f.status === 'proposed').length,
                    in_progress: group.features.filter(f => f.status === 'in_progress').length,
                    completed: group.features.filter(f => f.status === 'completed').length
                };

                html += `
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleProjectFeatures(${projectId})">
                            <div>
                                <div class="card-title" style="font-size: 18px;"> ${group.name}</div>
                                <div class="card-meta">
                                    ${group.features.length} feature${group.features.length !== 1 ? 's' : ''} 
                                    <span style="color: var(--warning);">${statusCounts.in_progress} in progress</span> 
                                    <span style="color: var(--success);">${statusCounts.completed} completed</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <a href="#focus/${projectId}" class="btn btn-secondary" onclick="event.stopPropagation();">Focus</a>
                                <span id="projectFeaturesToggle-${projectId}" style="font-size: 20px;"></span>
                            </div>
                        </div>
                        <div id="projectFeatures-${projectId}" class="card-body" style="padding: 0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; padding: 16px;">
                                ${group.features.map(f => renderFeatureCard(f)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            grid.innerHTML = html;
        }

        function renderFeatureCard(f) {
            return `
                <div class="card" style="margin: 0;">
                    <div class="card-header">
                        <div>
                            <div class="card-title inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="name" data-edit-type="text" title="Click to edit">${f.name}</div>
                            <div class="card-meta">${f.project_name || 'Unknown project'}</div>
                        </div>
                        <span class="badge badge-${f.status} inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="status" data-edit-type="select" title="Click to change status">${f.status}</span>
                    </div>
                    <div class="card-body inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="description" data-edit-type="textarea" title="Click to edit">${f.description || 'No description'}</div>
                    <div class="card-footer">
                        <div>
                            ${f.priority ? `<span class="badge badge-${f.priority} inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="priority" data-edit-type="select" title="Click to change priority">${f.priority}</span>` : ''}
                            ${f.tmux_session ? `<span class="badge badge-open">tmux: ${f.tmux_session}</span>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="queueFeature(${f.id})">Queue</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleProjectFeatures(projectId) {
            const el = document.getElementById(`projectFeatures-${projectId}`);
            const toggle = document.getElementById(`projectFeaturesToggle-${projectId}`);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                toggle.textContent = '';
            } else {
                el.style.display = 'none';
                toggle.textContent = '';
            }
        }

        async function loadBugs() {
            const statusFilter = document.getElementById('bugStatusFilter');
            const severityFilter = document.getElementById('bugSeverityFilter');
            const status = statusFilter?.value || '';
            const severity = severityFilter?.value || '';

            let endpoint = '/bugs?';
            if (currentProject !== 'all') endpoint += `project_id=${currentProject}&`;
            if (status) endpoint += `status=${status}&`;
            if (severity) endpoint += `severity=${severity}&`;

            const response = await api(endpoint);
            const bugs = Array.isArray(response) ? response : [];

            const grid = document.getElementById('bugsGrid');
            if (!grid) return;

            grid.innerHTML = bugs.map(b => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title inline-editable" data-entity-id="${b.id}" data-entity-type="bug" data-field="title" data-edit-type="text" title="Click to edit">${b.title}</div>
                            <div class="card-meta">${b.project_name || 'Unknown project'}</div>
                        </div>
                        <div>
                            <span class="badge badge-${b.severity} inline-editable" data-entity-id="${b.id}" data-entity-type="bug" data-field="severity" data-edit-type="select" title="Click to change severity">${b.severity}</span>
                            <span class="badge badge-${b.status} inline-editable" data-entity-id="${b.id}" data-entity-type="bug" data-field="status" data-edit-type="select" title="Click to change status">${b.status}</span>
                        </div>
                    </div>
                    <div class="card-body inline-editable" data-entity-id="${b.id}" data-entity-type="bug" data-field="description" data-edit-type="textarea" title="Click to edit">${b.description || 'No description'}</div>
                    <div class="card-footer">
                        <div>
                            ${b.tmux_session ? `<span class="badge badge-open">tmux: ${b.tmux_session}</span>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="startWorkingOnBug(${b.id})" title="Send to tmux session">Start Working</button>
                            ${b.status !== 'resolved' ? `<button class="btn btn-success" onclick="markBugComplete(${b.id})" title="Mark as complete after verification">Mark Complete</button>` : ''}
                            <button class="btn btn-secondary" onclick="showEditBugModal(${b.id})">Edit</button>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color: var(--text-secondary)">No bugs found</p>';
        }

        // ========================================
        // PAGINATION STATE & FUNCTIONS
        // ========================================
        const paginationState = {
            errors: { page: 1, pageSize: 25, total: 0, data: [], originalData: [] },
            tasks: { page: 1, pageSize: 25, total: 0, data: [], originalData: [] },
            workers: { page: 1, pageSize: 10, total: 0, data: [], originalData: [] },
            testRuns: { page: 1, pageSize: 10, total: 0, data: [], originalData: [] },
            deployments: { page: 1, pageSize: 10, total: 0, data: [], originalData: [] },
        };

        // Store original grid data for filtering
        const gridOriginalData = {
            bugs: [],
            nodes: []
        };

        function updatePaginationUI(tableName) {
            const state = paginationState[tableName];
            const totalPages = Math.ceil(state.total / state.pageSize) || 1;
            const start = (state.page - 1) * state.pageSize + 1;
            const end = Math.min(state.page * state.pageSize, state.total);

            const showingEl = document.getElementById(`${tableName}Showing`);
            const totalEl = document.getElementById(`${tableName}Total`);
            const pageInfoEl = document.getElementById(`${tableName}PageInfo`);
            const prevBtn = document.getElementById(`${tableName}Prev`);
            const nextBtn = document.getElementById(`${tableName}Next`);

            if (showingEl) showingEl.textContent = state.total > 0 ? `${start}-${end}` : '0';
            if (totalEl) totalEl.textContent = state.total;
            if (pageInfoEl) pageInfoEl.textContent = `Page ${state.page} of ${totalPages}`;
            if (prevBtn) prevBtn.disabled = state.page <= 1;
            if (nextBtn) nextBtn.disabled = state.page >= totalPages;
        }

        function prevPage(tableName) {
            const state = paginationState[tableName];
            if (state.page > 1) {
                state.page--;
                renderPaginatedTable(tableName);
            }
        }

        function nextPage(tableName) {
            const state = paginationState[tableName];
            const totalPages = Math.ceil(state.total / state.pageSize) || 1;
            if (state.page < totalPages) {
                state.page++;
                renderPaginatedTable(tableName);
            }
        }

        function changePageSize(tableName) {
            const select = document.getElementById(`${tableName}PageSize`);
            if (select) {
                paginationState[tableName].pageSize = parseInt(select.value);
                paginationState[tableName].page = 1;
                renderPaginatedTable(tableName);
            }
        }

        function renderPaginatedTable(tableName) {
            const state = paginationState[tableName];
            const start = (state.page - 1) * state.pageSize;
            const end = start + state.pageSize;
            const pageData = state.data.slice(start, end);

            switch (tableName) {
                case 'errors': renderErrorsTable(pageData); break;
                case 'tasks': renderTasksTable(pageData); break;
                case 'workers': renderWorkersTable(pageData); break;
                case 'testRuns': renderTestRunsTablePaginated(pageData); break;
                case 'deployments': renderDeploymentsTable(pageData); break;
            }
            updatePaginationUI(tableName);
        }

        // Store errors for detail view
        let currentErrors = [];

        function renderErrorsTable(errors) {
            const tbody = document.getElementById('errorsTable');
            if (!tbody) return;

            tbody.innerHTML = errors.map(e => `
                <tr style="cursor: pointer;" onclick="showErrorDetail(${e.id})">
                    <td><span class="badge badge-${e.error_type === 'error' ? 'critical' : 'medium'}">${e.error_type}</span></td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(e.message || 'N/A')}</td>
                    <td>${escapeHtml(e.source || 'N/A')}</td>
                    <td>${e.node_hostname || 'N/A'}</td>
                    <td>${e.occurrence_count}</td>
                    <td>${formatTime(e.last_seen)}</td>
                    <td onclick="event.stopPropagation()">
                        ${e.status === 'open' ? `
                            <button class="btn btn-primary" onclick="queueError(${e.id})" title="Add to queue">Queue</button>
                            <button class="btn btn-secondary" onclick="resolveError(${e.id})">Resolve</button>
                        ` : e.status === 'queued' ? '<span class="badge badge-warning">Queued</span>' : '<span class="badge badge-resolved">Resolved</span>'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary)">No errors found</td></tr>';
        }

        async function loadErrors() {
            const statusFilter = document.getElementById('errorStatusFilter');
            const status = statusFilter?.value || 'all';

            let endpoint = `/errors?status=${status}`;
            if (currentProject !== 'all') endpoint += `&project_id=${currentProject}`;

            const response = await api(endpoint);
            currentErrors = Array.isArray(response?.errors) ? response.errors :
                           Array.isArray(response) ? response : [];

            // Update pagination state
            paginationState.errors.data = currentErrors;
            paginationState.errors.total = currentErrors.length;
            paginationState.errors.page = 1;

            renderPaginatedTable('errors');
        }

        async function showErrorDetail(errorId) {
            // Track entity viewing for collaboration
            CollaborationManager.viewEntity('error', errorId);

            let error = currentErrors.find(e => e.id === errorId);

            // If error not in currentErrors, fetch it directly
            if (!error) {
                try {
                    const response = await api(`/errors?id=${errorId}`);
                    if (response.errors && response.errors.length > 0) {
                        error = response.errors[0];
                        currentErrors.push(error);  // Add to cache
                    } else {
                        showNotification('Error not found', 'error');
                        return;
                    }
                } catch (e) {
                    showNotification('Failed to load error details', 'error');
                    return;
                }
            }

            const body = document.getElementById('errorDetailBody');
            body.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="badge badge-${error.error_type === 'error' ? 'critical' : 'medium'}" style="font-size: 14px;">${error.error_type}</span>
                        <span style="color: var(--text-secondary);">Occurred ${error.occurrence_count} time(s)</span>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px;">Message</label>
                        <p style="margin: 5px 0; font-size: 15px;">${escapeHtml(error.message || 'N/A')}</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="color: var(--text-secondary); font-size: 12px;">Source</label>
                            <p style="margin: 5px 0;">${escapeHtml(error.source || 'N/A')}</p>
                        </div>
                        <div>
                            <label style="color: var(--text-secondary); font-size: 12px;">Node</label>
                            <p style="margin: 5px 0;">${error.node_hostname || 'N/A'}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="color: var(--text-secondary); font-size: 12px;">First Seen</label>
                            <p style="margin: 5px 0;">${formatTime(error.first_seen)}</p>
                        </div>
                        <div>
                            <label style="color: var(--text-secondary); font-size: 12px;">Last Seen</label>
                            <p style="margin: 5px 0;">${formatTime(error.last_seen)}</p>
                        </div>
                    </div>
                    ${error.stack_trace ? `
                        <div>
                            <label style="color: var(--text-secondary); font-size: 12px;">Stack Trace</label>
                            <pre style="margin: 5px 0; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px; overflow-x: auto; max-height: 300px;">${escapeHtml(error.stack_trace)}</pre>
                        </div>
                    ` : ''}
                </div>
            `;

            const footer = document.getElementById('errorDetailFooter');
            footer.innerHTML = error.status === 'open' ? `
                <button class="btn btn-secondary" onclick="hideModal('errorDetail')">Close</button>
                <button class="btn btn-secondary" onclick="resolveErrorFromModal(${error.id})">Resolve</button>
                <button class="btn btn-secondary" onclick="createBugFromErrorModal(${error.id})">Create Bug</button>
                <button class="btn btn-primary" onclick="sendErrorToClaude(${error.id})">Send to Claude</button>
            ` : `
                <button class="btn btn-secondary" onclick="hideModal('errorDetail')">Close</button>
                <span class="badge badge-resolved">Resolved</span>
            `;

            showModal('errorDetail');
        }

        async function resolveErrorFromModal(errorId) {
            await resolveError(errorId);
            hideModal('errorDetail');
        }

        async function createBugFromErrorModal(errorId) {
            await createBugFromError(errorId);
            hideModal('errorDetail');
        }

        async function queueError(errorId) {
            const result = await api('/assign-to-tmux', 'POST', {
                entity_type: 'error',
                entity_id: errorId,
                use_queue: true
            });
            if (result.success) {
                showNotification(`Error #${errorId} added to queue`, 'success');
                loadErrors();
            } else {
                showNotification(result.error || 'Failed to queue error', 'error');
            }
        }

        async function sendErrorToClaude(errorId) {
            const error = currentErrors.find(e => e.id === errorId);
            if (!error) return;

            // First refresh tmux sessions to get latest
            await api('/tmux/sessions/refresh', 'POST');
            const sessionsRaw = await api('/tmux/sessions');
            const sessions = deduplicateSessions(Array.isArray(sessionsRaw) ? sessionsRaw : []);

            // Find Claude sessions (sessions with 'claude' or 'arch' in name)
            const claudeSessions = sessions.filter(s =>
                s.session_name.toLowerCase().includes('claude') ||
                s.session_name.toLowerCase().includes('arch')
            );

            if (claudeSessions.length === 0) {
                showNotification('No Claude sessions found. Create a tmux session with "claude" in the name.', 'error');
                return;
            }

            // Build the prompt for Claude with full workflow instructions
            const dashboardUrl = window.location.origin;
            const prompt = `Fix this error and complete the full workflow:

ERROR ID: ${error.id}
Error Type: ${error.error_type}
Message: ${error.message}
Source: ${error.source || 'Unknown'}
${error.stack_trace ? `\nStack Trace:\n${error.stack_trace}` : ''}

WORKFLOW - Complete ALL steps:
1. Analyze and fix the error in the codebase
2. Run tests to verify the fix
3. Commit the fix with a descriptive message
4. Restart/deploy the server
5. Mark error as resolved by running:
   curl -X POST "${dashboardUrl}/api/errors/${error.id}/resolve" -H "Cookie: $(cat /tmp/arch_cookies.txt | grep session | cut -f7)"

Start by analyzing the error.`;

            // If multiple Claude sessions, use assign modal, otherwise send directly
            if (claudeSessions.length === 1) {
                const result = await api('/tmux/send', 'POST', {
                    session: claudeSessions[0].session_name,
                    message: prompt
                });
                if (result.success) {
                    showNotification(`Error sent to ${claudeSessions[0].session_name}`, 'success');
                    hideModal('errorDetail');
                } else {
                    showNotification('Failed to send to Claude session', 'error');
                }
            } else {
                // Multiple sessions - use assign modal
                assignContext = { entityType: 'error', entityId: errorId };
                document.getElementById('assignTmuxMessage').value = prompt;

                // Update session selector to show only Claude sessions
                const selector = document.getElementById('assignTmuxSession');
                selector.innerHTML = claudeSessions.map(s =>
                    `<option value="${s.session_name}">${s.session_name} (${s.node_hostname || 'local'})</option>`
                ).join('');

                showModal('assignTmux');
            }
        }

        // ================================
        // Termius-Style Tmux Interface
        // ================================

        let currentSession = null;
        let tmuxRefreshInterval = null;
        let lastTmuxRefresh = 0;
        const TMUX_CACHE_DURATION = 30000; // 30 seconds
        let sessionViewMode = 'tree'; // 'list' or 'tree'
        let collapsedGroups = new Set(); // Track collapsed groups in tree view

        // ================================
        // xterm.js Terminal Integration
        // ================================
        let xterm = null;
        let xtermFitAddon = null;
        let terminalViewMode = localStorage.getItem('terminalViewMode') || 'xterm';
        let xtermInitialized = false;

        function initXterm() {
            if (xtermInitialized || !window.Terminal) {
                console.log('xterm.js not available or already initialized');
                return;
            }

            const container = document.getElementById('xtermContainer');
            if (!container) return;

            // Create terminal with custom theme matching dashboard
            xterm = new Terminal({
                cursorBlink: true,
                cursorStyle: 'bar',
                fontSize: 13,
                fontFamily: "'JetBrains Mono', 'Fira Code', 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace",
                lineHeight: 1.4,
                letterSpacing: 0.5,
                theme: {
                    background: '#0d1117',
                    foreground: '#c9d1d9',
                    cursor: '#58a6ff',
                    cursorAccent: '#0d1117',
                    selectionBackground: '#264f78',
                    black: '#484f58',
                    red: '#ff7b72',
                    green: '#3fb950',
                    yellow: '#d29922',
                    blue: '#58a6ff',
                    magenta: '#bc8cff',
                    cyan: '#39c5cf',
                    white: '#b1bac4',
                    brightBlack: '#6e7681',
                    brightRed: '#ffa198',
                    brightGreen: '#56d364',
                    brightYellow: '#e3b341',
                    brightBlue: '#79c0ff',
                    brightMagenta: '#d2a8ff',
                    brightCyan: '#56d4dd',
                    brightWhite: '#f0f6fc'
                },
                scrollback: 5000,
                allowProposedApi: true
            });

            // Add fit addon for responsive sizing
            xtermFitAddon = new FitAddon.FitAddon();
            xterm.loadAddon(xtermFitAddon);

            // Add web links addon for clickable URLs
            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            xterm.loadAddon(webLinksAddon);

            // Open terminal in container
            xterm.open(container);
            xtermFitAddon.fit();

            // Handle window resize
            window.addEventListener('resize', () => {
                if (xtermFitAddon) {
                    setTimeout(() => xtermFitAddon.fit(), 100);
                }
            });

            // Handle input from xterm (send to tmux)
            xterm.onData(data => {
                if (currentSession) {
                    sendToTmuxViaXterm(data);
                }
            });

            // Show welcome message
            xterm.writeln('\x1b[36m\x1b[0m');
            xterm.writeln('\x1b[36m\x1b[0m  \x1b[1;33mArchitect Dashboard\x1b[0m - \x1b[32mxterm.js Terminal\x1b[0m                      \x1b[36m\x1b[0m');
            xterm.writeln('\x1b[36m\x1b[0m');
            xterm.writeln('\x1b[36m\x1b[0m  Select a tmux session from the sidebar to connect.          \x1b[36m\x1b[0m');
            xterm.writeln('\x1b[36m\x1b[0m  Type commands directly - they\'ll be sent to the session.    \x1b[36m\x1b[0m');
            xterm.writeln('\x1b[36m\x1b[0m');
            xterm.writeln('');

            xtermInitialized = true;
            console.log('xterm.js initialized successfully');

            // Apply saved view preference
            setTerminalView(terminalViewMode);
        }

        async function sendToTmuxViaXterm(data) {
            if (!currentSession) return;

            try {
                // Handle special keys
                if (data === '\r') {
                    // Enter key - send newline
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        keys: 'Enter'
                    });
                } else if (data === '\x7f') {
                    // Backspace
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        keys: 'BSpace'
                    });
                } else if (data === '\x03') {
                    // Ctrl+C
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        keys: 'C-c'
                    });
                } else if (data === '\x04') {
                    // Ctrl+D
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        keys: 'C-d'
                    });
                } else if (data === '\x1b') {
                    // Escape
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        keys: 'Escape'
                    });
                } else if (data.startsWith('\x1b[')) {
                    // Arrow keys and other escape sequences
                    const arrowMap = {
                        '\x1b[A': 'Up',
                        '\x1b[B': 'Down',
                        '\x1b[C': 'Right',
                        '\x1b[D': 'Left'
                    };
                    if (arrowMap[data]) {
                        await api('/tmux/send', 'POST', {
                            session_name: currentSession,
                            keys: arrowMap[data]
                        });
                    }
                } else {
                    // Regular text - send as literal
                    await api('/tmux/send', 'POST', {
                        session_name: currentSession,
                        text: data,
                        literal: true
                    });
                }
            } catch (e) {
                console.error('Failed to send to tmux:', e);
            }
        }

        function setTerminalView(view) {
            terminalViewMode = view;
            localStorage.setItem('terminalViewMode', view);

            const xtermContainer = document.getElementById('xtermContainer');
            const legacyOutput = document.getElementById('tmuxOutput');
            const xtermBtn = document.getElementById('viewXterm');
            const legacyBtn = document.getElementById('viewLegacy');

            if (view === 'xterm') {
                if (xtermContainer) xtermContainer.style.display = 'flex';
                if (legacyOutput) legacyOutput.style.display = 'none';
                if (xtermBtn) xtermBtn.classList.add('active');
                if (legacyBtn) legacyBtn.classList.remove('active');

                // Refit xterm when switching to it
                if (xtermFitAddon) {
                    setTimeout(() => xtermFitAddon.fit(), 50);
                }
            } else {
                if (xtermContainer) xtermContainer.style.display = 'none';
                if (legacyOutput) legacyOutput.style.display = 'block';
                if (xtermBtn) xtermBtn.classList.remove('active');
                if (legacyBtn) legacyBtn.classList.add('active');
            }
        }

        function writeToXterm(text) {
            if (!xterm || !xtermInitialized) return;

            // Clear terminal and write new content
            xterm.clear();

            // Process text line by line to handle properly
            const lines = text.split('\n');
            lines.forEach((line, index) => {
                if (index < lines.length - 1) {
                    xterm.writeln(line);
                } else {
                    xterm.write(line);
                }
            });

            // Scroll to bottom
            xterm.scrollToBottom();
        }

        function clearXterm() {
            if (xterm) {
                xterm.clear();
                xterm.writeln('\x1b[2J\x1b[H'); // Clear screen and move cursor to home
            }
        }

        // Initialize xterm when DOM is ready and tmux panel is shown
        function ensureXtermInitialized() {
            if (!xtermInitialized && window.Terminal) {
                initXterm();
            }
        }

        async function loadTmuxSessions() {
            // Initialize xterm.js when tmux panel is shown
            ensureXtermInitialized();

            const now = Date.now();
            // Only refresh from tmux if cache is stale
            if (now - lastTmuxRefresh > TMUX_CACHE_DURATION) {
                await refreshTmuxSessions();
            } else {
                // Use cached data from database
                const response = await api('/tmux/sessions');
                const sessions = Array.isArray(response) ? response : [];
                // Apply deduplication to cached data as well
                tmuxSessions = deduplicateSessions(sessions);
                updateSessionsUI();
            }

            // Refit xterm after panel is shown
            if (xtermFitAddon) {
                setTimeout(() => xtermFitAddon.fit(), 100);
            }
        }

        function updateSessionsUI() {
            const countEl = document.getElementById('sessionCount');
            if (countEl) countEl.textContent = `${tmuxSessions.length} session${tmuxSessions.length !== 1 ? 's' : ''}`;
            renderSessionsList();
            // Update assign modal selector
            const selector = document.getElementById('assignTmuxSession');
            if (selector) {
                selector.innerHTML = tmuxSessions.map(s =>
                    `<option value="${s.session_name}">${s.session_name} (${s.node_hostname || 'local'})</option>`
                ).join('');
            }
        }

        function filterSessions(query) {
            const items = document.querySelectorAll('#tmuxSessionsList .session-item');
            const lowerQuery = query.toLowerCase().trim();

            items.forEach(item => {
                const name = item.querySelector('.session-item-name')?.textContent?.toLowerCase() || '';
                if (lowerQuery === '' || name.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // In tree view, hide groups with no visible sessions
            if (sessionViewMode === 'tree') {
                const groups = document.querySelectorAll('#tmuxSessionsList .session-group');
                groups.forEach(group => {
                    const visibleInGroup = group.querySelectorAll('.session-item[style*="display: flex"], .session-item:not([style*="display: none"])');
                    const hasVisibleItems = [...group.querySelectorAll('.session-item')].some(i => i.style.display !== 'none');
                    group.style.display = hasVisibleItems || lowerQuery === '' ? 'block' : 'none';
                });
            }

            // Show "no matches" message if all hidden
            const visibleItems = [...items].filter(i => i.style.display !== 'none');
            let noMatchMsg = document.getElementById('noMatchMsg');
            if (visibleItems.length === 0 && lowerQuery) {
                if (!noMatchMsg) {
                    noMatchMsg = document.createElement('div');
                    noMatchMsg.id = 'noMatchMsg';
                    noMatchMsg.style.cssText = 'color: #8b949e; text-align: center; padding: 20px; font-size: 13px;';
                    noMatchMsg.textContent = 'No matching sessions';
                    document.getElementById('tmuxSessionsList').appendChild(noMatchMsg);
                }
            } else if (noMatchMsg) {
                noMatchMsg.remove();
            }
        }

        let currentSessionFilter = 'all';
        let isRefreshingTmux = false; // Mutex to prevent concurrent refresh calls

        // Deduplicate sessions by session_name, preferring local node
        function deduplicateSessions(sessions) {
            const seen = new Map();
            for (const s of sessions) {
                const existing = seen.get(s.session_name);
                if (!existing) {
                    seen.set(s.session_name, s);
                } else {
                    // Prefer 'local' node, then most recent activity
                    const existingIsLocal = existing.node_id === 'local';
                    const currentIsLocal = s.node_id === 'local';
                    if (currentIsLocal && !existingIsLocal) {
                        seen.set(s.session_name, s);
                    } else if (!existingIsLocal && !currentIsLocal) {
                        // Neither is local - prefer most recent
                        const existingTime = existing.last_activity ? new Date(existing.last_activity).getTime() : 0;
                        const currentTime = s.last_activity ? new Date(s.last_activity).getTime() : 0;
                        if (currentTime > existingTime) {
                            seen.set(s.session_name, s);
                        }
                    }
                }
            }
            return Array.from(seen.values());
        }

        async function refreshTmuxSessions() {
            // Prevent concurrent refresh calls
            if (isRefreshingTmux) {
                console.log('Refresh already in progress, skipping');
                return;
            }
            isRefreshingTmux = true;

            try {
                await api('/tmux/sessions/refresh', 'POST');
                const response = await api('/tmux/sessions');
                const sessions = Array.isArray(response) ? response : [];
                // Deduplicate sessions by session_name
                tmuxSessions = deduplicateSessions(sessions);
                lastTmuxRefresh = Date.now();

                // Update UI
                updateSessionsUI();

                // Update last refresh time
                const refreshEl = document.getElementById('lastRefresh');
                if (refreshEl) refreshEl.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            } finally {
                isRefreshingTmux = false;
            }
        }

        let sessionSortBy = 'name'; // name, status, activity

        // Get session group - groups by project for organized hierarchy
        function getSessionGroup(session) {
            // Workers get their own group
            if (session.is_worker) return 'workers';

            // Group by project if assigned
            if (session.project_name) {
                // Use project_id as group key, or sanitize project name
                const projectKey = session.project_id ? `project_${session.project_id}` :
                    session.project_name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                return projectKey;
            }

            return 'unassigned';
        }

        function renderSessionItem(s) {
            const statusClass = s.attached ? 'attached' : 'detached';
            const statusText = s.attached ? 'Attached' : 'Detached';
            const lastActive = s.last_activity ? formatTime(s.last_activity) : '';
            const env = s.environment || '';
            const isWorker = s.is_worker;
            const hasAssignment = s.project_name || s.milestone_name || s.run_status;

            // Build assignment info
            let assignmentInfo = '';
            if (isWorker) {
                assignmentInfo = '<span style="color: var(--purple);"> Worker</span>';
            } else if (s.run_status) {
                assignmentInfo = `<span style="color: var(--accent);"> ${s.project_name || ''} - Run #${s.run_number} (${s.run_status})</span>`;
            } else if (s.milestone_name) {
                assignmentInfo = `<span style="color: var(--green);"> ${s.milestone_name}</span>`;
            } else if (s.assigned_task_type) {
                assignmentInfo = `<span style="color: var(--text-secondary);"> ${s.assigned_task_type}</span>`;
            }

            return `
                <div class="session-item ${currentSession === s.session_name ? 'active' : ''}"
                     onclick="selectSession('${s.session_name}')"
                     oncontextmenu="showSessionContextMenu(event, tmuxSessions.find(x => x.session_name === '${s.session_name}'))"
                     data-attached="${s.attached}"
                     data-session-name="${s.session_name}"
                     title="Right-click for more options"
                     style="${hasAssignment ? 'border-left: 3px solid var(--accent);' : ''}">
                    <div class="session-item-row">
                        <span class="session-item-name">${s.session_name}</span>
                        <div class="session-item-badges">
                            ${env ? `<span class="env-tag" style="font-size: 9px; padding: 2px 5px; background: var(--bg-tertiary); border-radius: 3px; color: var(--accent);">${env}</span>` : ''}
                            <span class="status-badge ${statusClass}" style="font-size: 10px; padding: 2px 6px;">${statusText}</span>
                        </div>
                    </div>
                    ${assignmentInfo ? `<div class="session-item-assignment">${assignmentInfo}</div>` : ''}
                    <div class="session-item-meta">
                        <span>${s.node_hostname || 'local'}</span>
                        <span>${lastActive}</span>
                    </div>
                </div>
            `;
        }

        function renderSessionsList() {
            const list = document.getElementById('tmuxSessionsList');
            if (!list) return;

            // Filter sessions
            let filtered = tmuxSessions;
            if (currentSessionFilter === 'attached') {
                filtered = tmuxSessions.filter(s => s.attached);
            } else if (currentSessionFilter === 'detached') {
                filtered = tmuxSessions.filter(s => !s.attached);
            }

            // Sort sessions
            filtered = [...filtered].sort((a, b) => {
                if (sessionSortBy === 'name') {
                    return (a.session_name || '').localeCompare(b.session_name || '');
                } else if (sessionSortBy === 'status') {
                    // Attached first, then by name
                    if (a.attached !== b.attached) return b.attached ? 1 : -1;
                    return (a.session_name || '').localeCompare(b.session_name || '');
                } else if (sessionSortBy === 'activity') {
                    // Most recent first
                    const aTime = a.last_activity ? new Date(a.last_activity).getTime() : 0;
                    const bTime = b.last_activity ? new Date(b.last_activity).getTime() : 0;
                    return bTime - aTime;
                }
                return 0;
            });

            if (filtered.length === 0) {
                list.innerHTML = `<div style="color: var(--text-secondary); text-align: center; padding: 40px 20px; font-size: 13px;">
                    ${tmuxSessions.length === 0 ? 'No sessions found' : 'No matching sessions'}
                </div>`;
                return;
            }

            // Render based on view mode
            if (sessionViewMode === 'tree') {
                renderTreeView(list, filtered);
            } else {
                renderFlatList(list, filtered);
            }
        }

        function renderFlatList(list, sessions) {
            list.innerHTML = sessions.map(s => renderSessionItem(s)).join('');
        }

        function renderTreeView(list, sessions) {
            // Build project groups from sessions
            const groups = {};
            const groupInfo = {};

            for (const session of sessions) {
                const groupId = getSessionGroup(session);
                if (!groups[groupId]) {
                    groups[groupId] = [];
                    // Store group info
                    if (groupId === 'workers') {
                        groupInfo[groupId] = { name: 'Workers', icon: '' };
                    } else if (groupId === 'unassigned') {
                        groupInfo[groupId] = { name: 'Unassigned', icon: '' };
                    } else {
                        groupInfo[groupId] = { name: session.project_name || 'Unknown', icon: '' };
                    }
                }
                groups[groupId].push(session);
            }

            // Sort groups: projects first (alphabetically), then workers, then unassigned
            const groupIds = Object.keys(groups).sort((a, b) => {
                if (a === 'unassigned') return 1;
                if (b === 'unassigned') return -1;
                if (a === 'workers') return 1;
                if (b === 'workers') return -1;
                return (groupInfo[a]?.name || '').localeCompare(groupInfo[b]?.name || '');
            });

            let html = '';
            for (const groupId of groupIds) {
                const groupSessions = groups[groupId];
                if (!groupSessions || groupSessions.length === 0) continue;

                const config = groupInfo[groupId] || { name: 'Other', icon: '' };
                const isCollapsed = collapsedGroups.has(groupId);
                const attachedCount = groupSessions.filter(s => s.attached).length;

                html += `
                    <div class="session-group ${isCollapsed ? 'collapsed' : ''}" data-group="${groupId}">
                        <div class="session-group-header" onclick="toggleSessionGroup('${groupId}')">
                            <span class="session-group-toggle"></span>
                            <span class="session-group-icon">${config.icon}</span>
                            <span class="session-group-name">${config.name}</span>
                            <span class="session-group-count">${attachedCount > 0 ? `${attachedCount}/` : ''}${groupSessions.length}</span>
                        </div>
                        <div class="session-group-sessions">
                            ${groupSessions.map(s => renderSessionItem(s)).join('')}
                        </div>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        function toggleSessionGroup(groupId) {
            if (collapsedGroups.has(groupId)) {
                collapsedGroups.delete(groupId);
            } else {
                collapsedGroups.add(groupId);
            }
            renderSessionsList();
        }

        function setSessionView(view) {
            sessionViewMode = view;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            updateGroupControlsVisibility();
            renderSessionsList();
        }

        function setSessionFilter(filter) {
            currentSessionFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.filter === filter);
            });
            renderSessionsList();
        }

        function setSessionSort(sortBy) {
            sessionSortBy = sortBy;
            document.querySelectorAll('.sort-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.sort === sortBy);
            });
            renderSessionsList();
        }

        function toggleSessionsSidebar() {
            const sidebar = document.getElementById('sessionsSidebar');
            const btn = sidebar.querySelector('.sidebar-collapse-btn');
            const isCollapsed = sidebar.classList.toggle('collapsed');
            btn.textContent = isCollapsed ? '' : '';
            localStorage.setItem('tmuxSidebarCollapsed', isCollapsed);
        }

        // Restore sidebar state on load
        if (localStorage.getItem('tmuxSidebarCollapsed') === 'true') {
            const sidebar = document.getElementById('sessionsSidebar');
            if (sidebar) {
                sidebar.classList.add('collapsed');
                const btn = sidebar.querySelector('.sidebar-collapse-btn');
                if (btn) btn.textContent = '';
            }
        }

        // Update group controls visibility based on view mode
        function updateGroupControlsVisibility() {
            const controls = document.getElementById('groupControls');
            if (controls) {
                controls.style.display = sessionViewMode === 'tree' ? 'flex' : 'none';
            }
        }

        // Expand all session groups
        async function expandAllGroups() {
            collapsedGroups.clear();
            // Persist to server
            try {
                await api('/tmux/groups/expand-all', 'POST');
            } catch (e) {
                console.log('Could not persist expand state:', e);
            }
            renderSessionsList();
        }

        // Collapse all session groups
        async function collapseAllGroups() {
            const groups = document.querySelectorAll('.session-group');
            groups.forEach(g => {
                const groupId = g.dataset.group;
                if (groupId) collapsedGroups.add(groupId);
            });
            // Persist to server
            try {
                await api('/tmux/groups/collapse-all', 'POST');
            } catch (e) {
                console.log('Could not persist collapse state:', e);
            }
            renderSessionsList();
        }

        // Auto-assign sessions to projects
        async function autoAssignSessions() {
            try {
                const result = await api('/tmux/groups/auto-assign', 'POST');
                if (result.assigned > 0) {
                    showNotification(`Assigned ${result.assigned} sessions to projects`, 'success');
                    await refreshTmuxSessions();
                } else {
                    showNotification('No sessions to auto-assign', 'info');
                }
            } catch (e) {
                showNotification('Failed to auto-assign sessions', 'error');
            }
        }

        // Session context menu for right-click actions
        let sessionContextMenu = null;
        let availableProjects = [];

        async function loadAvailableProjects() {
            try {
                const result = await api('/tmux/groups/projects');
                availableProjects = result.projects || [];
            } catch (e) {
                console.log('Could not load projects:', e);
            }
        }

        function showSessionContextMenu(event, session) {
            event.preventDefault();
            event.stopPropagation();

            // Remove existing menu
            hideSessionContextMenu();

            // Create menu
            const menu = document.createElement('div');
            menu.className = 'session-context-menu';
            menu.id = 'sessionContextMenu';

            // Build project submenu items
            let projectItems = availableProjects.map(p =>
                `<div class="session-context-menu-item" onclick="assignSessionToProject('${session.session_name}', ${p.id})">${p.name}</div>`
            ).join('');

            if (!projectItems) {
                projectItems = '<div class="session-context-menu-item" style="color: var(--text-secondary);">No projects available</div>';
            }

            menu.innerHTML = `
                <div class="session-context-menu-item" onclick="selectSession('${session.session_name}')">
                    <span></span> View Session
                </div>
                <div class="session-context-menu-divider"></div>
                <div class="session-context-submenu">
                    <div class="session-context-menu-item">
                        <span></span> Assign to Project <span style="margin-left: auto;"></span>
                    </div>
                    <div class="session-context-submenu-content">
                        <div class="session-context-menu-item" onclick="assignSessionToProject('${session.session_name}', null)">
                            <span></span> Unassign
                        </div>
                        <div class="session-context-menu-divider"></div>
                        ${projectItems}
                    </div>
                </div>
                <div class="session-context-menu-item" onclick="toggleSessionWorker('${session.session_name}', ${!session.is_worker})">
                    <span>${session.is_worker ? '' : ''}</span> ${session.is_worker ? 'Unmark as Worker' : 'Mark as Worker'}
                </div>
                <div class="session-context-menu-divider"></div>
                <div class="session-context-menu-item" onclick="killSessionConfirm('${session.session_name}')" style="color: #f85149;">
                    <span></span> Kill Session
                </div>
            `;

            // Position menu
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;

            document.body.appendChild(menu);
            sessionContextMenu = menu;

            // Adjust position if off screen
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = `${window.innerWidth - rect.width - 10}px`;
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = `${window.innerHeight - rect.height - 10}px`;
            }

            // Close menu on click outside
            setTimeout(() => {
                document.addEventListener('click', hideSessionContextMenu, { once: true });
            }, 10);
        }

        function hideSessionContextMenu() {
            if (sessionContextMenu) {
                sessionContextMenu.remove();
                sessionContextMenu = null;
            }
        }

        async function assignSessionToProject(sessionName, projectId) {
            hideSessionContextMenu();
            try {
                await api('/tmux/groups/assign', 'POST', {
                    session_name: sessionName,
                    project_id: projectId
                });
                showNotification(projectId ? 'Session assigned to project' : 'Session unassigned', 'success');
                await refreshTmuxSessions();
            } catch (e) {
                showNotification('Failed to assign session', 'error');
            }
        }

        async function toggleSessionWorker(sessionName, isWorker) {
            hideSessionContextMenu();
            try {
                await api('/tmux/groups/worker', 'POST', {
                    session_name: sessionName,
                    is_worker: isWorker
                });
                showNotification(isWorker ? 'Session marked as worker' : 'Session unmarked as worker', 'success');
                await refreshTmuxSessions();
            } catch (e) {
                showNotification('Failed to update session', 'error');
            }
        }

        // Load projects on init
        loadAvailableProjects();

        async function selectSession(sessionName) {
            currentSession = sessionName;

            // On mobile, open fullscreen terminal modal directly
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                openTmuxTerminal(sessionName);
                return;
            }

            // Update UI
            document.getElementById('currentTmuxSession').textContent = sessionName;

            const session = tmuxSessions.find(s => s.session_name === sessionName);
            const statusEl = document.getElementById('sessionStatus');
            if (session && statusEl) {
                statusEl.textContent = session.attached ? 'Attached' : 'Detached';
                statusEl.className = `status-badge ${session.attached ? 'attached' : 'detached'}`;
            }

            // Show env badge if applicable
            const envEl = document.getElementById('sessionEnv');
            if (envEl) {
                const env = sessionName.match(/env\d?|dev|qa|prod/i)?.[0];
                if (env) {
                    envEl.textContent = env;
                    envEl.style.display = 'inline-block';
                } else {
                    envEl.style.display = 'none';
                }
            }

            // Enable action buttons
            document.querySelectorAll('#sessionActions .action-btn').forEach(btn => {
                if (!btn.onclick?.toString().includes('toggleFocusMode')) {
                    btn.disabled = false;
                }
            });

            // Update sidebar selection
            document.querySelectorAll('.session-item').forEach(el => {
                el.classList.toggle('active', el.querySelector('span')?.textContent === sessionName);
            });

            // Load terminal output
            await refreshCurrentSession();

            // Focus input or xterm
            if (terminalViewMode === 'xterm' && xterm) {
                xterm.focus();
            } else {
                document.getElementById('tmuxInput')?.focus();
            }

            // Start auto-refresh if enabled
            const autoRefreshEnabled = document.getElementById('autoRefreshToggle')?.checked;
            if (tmuxRefreshInterval) clearInterval(tmuxRefreshInterval);
            if (autoRefreshEnabled) {
                tmuxRefreshInterval = setInterval(refreshCurrentSession, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Reduced from 5s to 60s
            }
        }

        // Session Control Functions
        function toggleKeyboard() {
            const panel = document.getElementById('keyboardPanel');
            const btn = document.getElementById('keyboardToggle');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.classList.add('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshToggle');
            const statusEl = document.getElementById('autoRefreshStatus');
            if (checkbox.checked) {
                statusEl.textContent = 'On';
                if (currentSession && !tmuxRefreshInterval) {
                    tmuxRefreshInterval = setInterval(refreshCurrentSession, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Reduced from 5s to 60s
                }
            } else {
                statusEl.textContent = 'Off';
                if (tmuxRefreshInterval) {
                    clearInterval(tmuxRefreshInterval);
                    tmuxRefreshInterval = null;
                }
            }
        }

        function toggleTmuxFocusMode() {
            const sidebar = document.getElementById('sessionsSidebar');
            const focusBtn = document.querySelector('.action-btn[title*="Focus Mode"]');

            if (sidebar && sidebar.style.display === 'none') {
                // Exit tmux focus mode
                sidebar.style.display = 'flex';
                if (focusBtn) focusBtn.style.background = '#21262d';
            } else if (sidebar) {
                // Enter tmux focus mode
                sidebar.style.display = 'none';
                if (focusBtn) {
                    focusBtn.style.background = 'var(--accent)';
                    focusBtn.style.color = 'white';
                }
            }
        }

        async function copyLogs() {
            if (!currentSession) return;
            const output = document.getElementById('tmuxOutput')?.textContent;
            if (output) {
                await navigator.clipboard.writeText(output);
                showNotification('Logs copied to clipboard', 'success');
            }
        }

        async function killSessionConfirm() {
            if (!currentSession) return;
            if (await showConfirm('Kill Session', `Are you sure you want to kill "${currentSession}"?`)) {
                await api('/tmux/kill', 'POST', { session: currentSession });
                showNotification(`Session "${currentSession}" killed`, 'success');
                currentSession = null;
                document.getElementById('currentTmuxSession').textContent = 'Select a session';
                document.getElementById('sessionStatus').textContent = '--';
                document.getElementById('sessionStatus').className = 'status-badge';
                document.querySelectorAll('#sessionActions .action-btn').forEach(btn => {
                    if (!btn.onclick?.toString().includes('toggleFocusMode')) {
                        btn.disabled = true;
                    }
                });
                await refreshTmuxSessions();
            }
        }

        async function restartSession() {
            if (!currentSession) return;
            showNotification('Restarting session...', 'info');
            // Kill and recreate with same name
            await api('/tmux/kill', 'POST', { session: currentSession });
            await api('/tmux/create', 'POST', { session_name: currentSession });
            await refreshTmuxSessions();
            await selectSession(currentSession);
            showNotification('Session restarted', 'success');
        }

        function toggleAttach() {
            if (!currentSession) return;
            showNotification('Attach/Detach requires terminal access', 'info');
        }

        // Scrollback state
        let currentScrollbackLines = 0;
        let userScrolledUp = false;

        function updateScrollbackSetting() {
            currentScrollbackLines = parseInt(document.getElementById('scrollbackSelect').value) || 0;
            if (currentSession) {
                refreshCurrentSession();
            }
        }

        async function refreshCurrentSession() {
            if (!currentSession) return;

            const result = await api('/tmux/capture', 'POST', {
                session: currentSession,
                scrollback: currentScrollbackLines
            });

            if (result.success) {
                const output = document.getElementById('tmuxOutput');
                output.innerHTML = highlightTerminalOutput(result.output || '(empty)');

                // Update line count indicator
                const lineCount = result.output ? result.output.split('\n').length : 0;
                const lineCountEl = document.getElementById('lineCount');
                if (lineCountEl) {
                    lineCountEl.textContent = result.history_size ?
                        `${lineCount} / ${result.history_size}` : `${lineCount}`;
                }

                // Auto-scroll to bottom (unless user scrolled up)
                if (!userScrolledUp) {
                    output.scrollTop = output.scrollHeight;
                }
            }
        }

        // Terminal resize handling
        let terminalResizeObserver = null;

        function initTerminalResizeObserver() {
            const terminalOutput = document.getElementById('tmuxOutput');
            if (!terminalOutput || terminalResizeObserver) return;

            terminalResizeObserver = new ResizeObserver(entries => {
                for (const entry of entries) {
                    const { width, height } = entry.contentRect;

                    // Calculate approximate rows/cols based on font metrics
                    const computedStyle = getComputedStyle(terminalOutput);
                    const fontSize = parseFloat(computedStyle.fontSize);
                    const lineHeight = parseFloat(computedStyle.lineHeight) || fontSize * 1.5;
                    const charWidth = fontSize * 0.6; // Approximate monospace char width

                    const cols = Math.floor((width - 40) / charWidth); // Account for padding
                    const rows = Math.floor((height - 32) / lineHeight);

                    // Update terminal dimensions indicator
                    const dimsEl = document.getElementById('terminalDims');
                    if (dimsEl) {
                        dimsEl.textContent = `${cols}x${rows}`;
                    }

                    // Store for potential tmux resize commands
                    window.terminalDimensions = { cols, rows };
                }
            });

            terminalResizeObserver.observe(terminalOutput);
        }

        // ANSI escape code parser with 256-color and true color (24-bit RGB) support
        function parseAnsiCodes(text) {
            // Standard 8 colors (indices 0-7) - Solarized palette
            const standardColors = [
                '#073642', '#dc322f', '#859900', '#b58900',
                '#268bd2', '#d33682', '#2aa198', '#eee8d5'
            ];
            // Bright colors (indices 8-15)
            const brightColors = [
                '#657b83', '#ff6b6b', '#7ed321', '#f5a623',
                '#58a6ff', '#bd93f9', '#56d4dd', '#ffffff'
            ];

            // Generate 256-color palette value
            function get256Color(n) {
                if (n < 8) {
                    return standardColors[n];
                } else if (n < 16) {
                    return brightColors[n - 8];
                } else if (n < 232) {
                    // 6x6x6 color cube (indices 16-231)
                    const idx = n - 16;
                    const r = Math.floor(idx / 36);
                    const g = Math.floor((idx % 36) / 6);
                    const b = idx % 6;
                    const toVal = v => v === 0 ? 0 : 55 + v * 40;
                    return `rgb(${toVal(r)}, ${toVal(g)}, ${toVal(b)})`;
                } else {
                    // Grayscale (indices 232-255)
                    const gray = (n - 232) * 10 + 8;
                    return `rgb(${gray}, ${gray}, ${gray})`;
                }
            }

            // Style attributes
            const styles = {
                1: 'font-weight:bold',
                2: 'opacity:0.7',
                3: 'font-style:italic',
                4: 'text-decoration:underline',
                5: 'animation:blink 1s step-end infinite',
                7: 'filter:invert(1)',
                8: 'visibility:hidden',
                9: 'text-decoration:line-through'
            };

            let result = '';
            let currentStyle = { fg: null, bg: null, attrs: [] };
            const ansiRegex = /\x1b\[([0-9;]*)m/g;
            let lastIndex = 0;
            let match;

            function buildStyleString() {
                const parts = [];
                if (currentStyle.fg) parts.push(`color:${currentStyle.fg}`);
                if (currentStyle.bg) parts.push(`background-color:${currentStyle.bg}`);
                parts.push(...currentStyle.attrs);
                return parts.join(';');
            }

            while ((match = ansiRegex.exec(text)) !== null) {
                // Add text before this escape sequence
                if (match.index > lastIndex) {
                    const segment = text.substring(lastIndex, match.index);
                    const style = buildStyleString();
                    if (style) {
                        result += `<span style="${style}">${segment}</span>`;
                    } else {
                        result += segment;
                    }
                }

                // Parse the escape sequence codes
                const codes = match[1] ? match[1].split(';').map(c => parseInt(c) || 0) : [0];
                let i = 0;

                while (i < codes.length) {
                    const code = codes[i];

                    if (code === 0) {
                        // Reset all
                        currentStyle = { fg: null, bg: null, attrs: [] };
                    } else if (code >= 1 && code <= 9 && styles[code]) {
                        // Style attribute
                        if (!currentStyle.attrs.includes(styles[code])) {
                            currentStyle.attrs.push(styles[code]);
                        }
                    } else if (code >= 30 && code <= 37) {
                        // Standard foreground (30-37)
                        currentStyle.fg = standardColors[code - 30];
                    } else if (code === 38) {
                        // Extended foreground
                        if (codes[i + 1] === 5 && codes[i + 2] !== undefined) {
                            // 256-color: 38;5;N
                            currentStyle.fg = get256Color(codes[i + 2]);
                            i += 2;
                        } else if (codes[i + 1] === 2 && codes[i + 4] !== undefined) {
                            // True color: 38;2;R;G;B
                            currentStyle.fg = `rgb(${codes[i + 2]}, ${codes[i + 3]}, ${codes[i + 4]})`;
                            i += 4;
                        }
                    } else if (code === 39) {
                        // Default foreground
                        currentStyle.fg = null;
                    } else if (code >= 40 && code <= 47) {
                        // Standard background (40-47)
                        currentStyle.bg = standardColors[code - 40];
                    } else if (code === 48) {
                        // Extended background
                        if (codes[i + 1] === 5 && codes[i + 2] !== undefined) {
                            // 256-color: 48;5;N
                            currentStyle.bg = get256Color(codes[i + 2]);
                            i += 2;
                        } else if (codes[i + 1] === 2 && codes[i + 4] !== undefined) {
                            // True color: 48;2;R;G;B
                            currentStyle.bg = `rgb(${codes[i + 2]}, ${codes[i + 3]}, ${codes[i + 4]})`;
                            i += 4;
                        }
                    } else if (code === 49) {
                        // Default background
                        currentStyle.bg = null;
                    } else if (code >= 90 && code <= 97) {
                        // Bright foreground (90-97)
                        currentStyle.fg = brightColors[code - 90];
                    } else if (code >= 100 && code <= 107) {
                        // Bright background (100-107)
                        currentStyle.bg = brightColors[code - 100];
                    }
                    i++;
                }

                lastIndex = ansiRegex.lastIndex;
            }

            // Add remaining text
            if (lastIndex < text.length) {
                const segment = text.substring(lastIndex);
                const style = buildStyleString();
                if (style) {
                    result += `<span style="${style}">${segment}</span>`;
                } else {
                    result += segment;
                }
            }

            return result;
        }

        function highlightTerminalOutput(text) {
            // First, parse ANSI escape codes
            let processed = parseAnsiCodes(text);

            // Escape HTML only in non-span content (careful not to break our ANSI spans)
            // Since ANSI parsing creates spans, we need to escape first, then parse ANSI
            // So let's do it differently: escape first, then parse ANSI on original, then combine

            // Actually, let's escape the raw text first, then apply ANSI parsing
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Now parse ANSI codes (the escape characters weren't affected by HTML escaping)
            escaped = parseAnsiCodes(escaped);

            // Highlight JSON objects (only if no ANSI codes present in that segment)
            escaped = escaped.replace(/(\{[^{}<>]*\})/g, (match) => {
                // Skip if already contains span (from ANSI parsing)
                if (match.includes('<span')) return match;
                try {
                    if (match.includes(':')) {
                        return match
                            .replace(/"([^"]+)":/g, '<span class="terminal-json-key">"$1"</span>:')
                            .replace(/: "([^"]*)"/g, ': <span class="terminal-json-string">"$1"</span>')
                            .replace(/: (\d+)/g, ': <span class="terminal-json-number">$1</span>')
                            .replace(/: (true|false)/g, ': <span class="terminal-json-boolean">$1</span>');
                    }
                } catch (e) {}
                return match;
            });

            // Highlight status words (but not inside existing spans)
            escaped = escaped.replace(/(?<!<[^>]*)\b(healthy|connected|success|ok|passed)\b(?![^<]*>)/gi, '<span class="terminal-success">$1</span>');
            escaped = escaped.replace(/(?<!<[^>]*)\b(error|failed|failure|unhealthy|disconnected)\b(?![^<]*>)/gi, '<span class="terminal-error">$1</span>');
            escaped = escaped.replace(/(?<!<[^>]*)\b(warning|warn|pending)\b(?![^<]*>)/gi, '<span class="terminal-warning">$1</span>');

            // Highlight prompts (lines ending with $ or >)
            escaped = escaped.replace(/^(.+[\$\>])\s*$/gm, '<span class="terminal-prompt">$1</span>');

            return escaped;
        }

        // Scroll handling for terminal
        function handleTerminalScroll(el) {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            const distanceFromBottom = el.scrollHeight - el.scrollTop - el.clientHeight;
            const threshold = 100; // Show button if more than 100px from bottom

            // Track if user manually scrolled up
            userScrolledUp = distanceFromBottom > threshold;

            if (scrollBtn) {
                if (userScrolledUp) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            }
        }

        function scrollTerminalToBottom() {
            const output = document.getElementById('tmuxOutput');
            if (output) {
                output.scrollTop = output.scrollHeight;
            }
        }

        // Track IME composition state
        let isComposing = false;

        function handleTmuxInputCompositionStart() {
            isComposing = true;
        }

        function handleTmuxInputCompositionEnd() {
            isComposing = false;
        }

        function handleTmuxInputKey(event) {
            // Don't interfere with IME (Japanese/Chinese/Korean input)
            if (isComposing) return;

            const isEnter = event.key === 'Enter';
            const wantsNewline = event.shiftKey;
            const forceSend = (event.ctrlKey || event.metaKey) && isEnter;

            // Ctrl/Cmd+Enter: Always send (fallback)
            if (forceSend) {
                event.preventDefault();
                event.stopPropagation();
                sendTmuxInput();
                return;
            }

            // Enter alone: Send (unless Shift is held)
            if (isEnter && !wantsNewline) {
                event.preventDefault();
                event.stopPropagation();
                sendTmuxInput();
                return;
            }

            // Shift+Enter: Allow newline (default behavior, don't prevent)
        }

        function autoResizeInput(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set height based on content, capped at max-height
            const newHeight = Math.min(textarea.scrollHeight, 120);
            textarea.style.height = newHeight + 'px';
        }

        function toggleSnippets() {
            const menu = document.getElementById('snippetMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function insertSnippet(command) {
            const input = document.getElementById('tmuxInput');
            if (input) {
                input.value = command;
                input.focus();
                autoResizeInput(input);
            }
            document.getElementById('snippetMenu').style.display = 'none';
        }

        // Close snippet menu on outside click
        document.addEventListener('click', (e) => {
            const snippetDropdown = document.querySelector('.snippet-dropdown');
            const menu = document.getElementById('snippetMenu');
            if (menu && snippetDropdown && !snippetDropdown.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        async function sendTmuxInput() {
            if (!currentSession) {
                showNotification('Select a session first', 'error');
                return;
            }

            const input = document.getElementById('tmuxInput');
            let command = input.value.trim();
            if (!command) {
                input.focus();
                return;
            }

            // Send command as-is (if user includes ##, auto-confirm worker will detect it and skip)
            await api('/tmux/send', 'POST', { session: currentSession, message: command });
            input.value = '';
            // Reset textarea height
            input.style.height = '42px';
            // Auto-focus the input
            input.focus();
            setTimeout(refreshCurrentSession, 300);
        }

        async function sendTmuxKey(key) {
            if (!currentSession) {
                showNotification('Select a session first', 'error');
                return;
            }

            await api('/tmux/send-key', 'POST', { session: currentSession, key });
            setTimeout(refreshCurrentSession, 300);
            // Auto-focus the input
            document.getElementById('tmuxInput')?.focus();
        }

        async function sendTmuxQuickCmd(command) {
            if (!currentSession) {
                showNotification('Select a session first', 'error');
                return;
            }

            await api('/tmux/send', 'POST', { session: currentSession, message: command });
            setTimeout(refreshCurrentSession, 300);
            // Auto-focus the input
            document.getElementById('tmuxInput')?.focus();
        }

        // Legacy compatibility functions
        async function captureTmux(sessionName) {
            await selectSession(sessionName);
        }

        async function captureTmuxOutput(sessionName) {
            // Show tmux output in a modal - used by autopilot queue buttons
            try {
                if (!sessionName) {
                    showNotification('No session name provided', 'error');
                    return;
                }

                showNotification(`Capturing output from ${sessionName}...`, 'info');
                const result = await api('/tmux/capture', 'POST', { session: sessionName });

                if (!result) {
                    showNotification('No response from server', 'error');
                    return;
                }

                if (result.error) {
                    showNotification(result.error, 'error');
                    return;
                }

                const output = result.output || result.content || 'No output captured';

                // Show in a modal
                const modalHtml = `
                    <div class="modal-overlay" id="modal-tmuxQuickOutput" onclick="if(event.target===this) hideModal('tmuxQuickOutput')" style="display: flex;">
                        <div class="modal" style="width: 90%; max-width: 900px; max-height: 80vh; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h2 class="modal-title"> ${sessionName} Output</h2>
                                <button class="modal-close" onclick="hideModal('tmuxQuickOutput')">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0;">
                                <pre style="margin: 0; padding: 16px; background: var(--bg-tertiary); font-family: monospace; font-size: 12px; line-height: 1.5; overflow: auto; height: 100%; max-height: 60vh; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(output)}</pre>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="hideModal('tmuxQuickOutput')">Close</button>
                                <button class="btn btn-primary" onclick="selectSession('${sessionName}'); hideModal('tmuxQuickOutput'); navigateToPanel('tmux');">Open in Tmux Panel</button>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existing = document.getElementById('modal-tmuxQuickOutput');
                if (existing) existing.remove();

                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (e) {
                console.error('[captureTmuxOutput] Error:', e);
                showNotification('Failed to capture output', 'error');
            }
        }

        async function sendTmuxCommand() {
            await sendTmuxInput();
        }

        async function killTmux(sessionName) {
            const confirmed = await showConfirm(`Kill session "${sessionName}"?`, 'Kill Session', 'Kill');
            if (!confirmed) return;

            const result = await api('/tmux/kill', 'POST', { session: sessionName });
            if (result.success) {
                refreshTmuxSessions();
            } else {
                showNotification(result.error || 'Failed to kill session', 'error');
            }
        }

        // Termius-style tmux helper functions
        function selectTmuxSession(sessionName) {
            if (sessionName) {
                captureTmux(sessionName);
            }
        }

        function closeTmuxTerminal() {
            document.getElementById('tmuxOutputContainer').style.display = 'none';
            document.getElementById('tmuxSessionSelect').value = '';
        }

        async function sendTmuxSpecial(key) {
            const session = document.getElementById('currentTmuxSession').textContent;
            if (!session) {
                showNotification('No session selected', 'error');
                return;
            }

            // tmux send-keys uses special key names
            await api('/tmux/send-key', 'POST', { session, key });
            setTimeout(() => captureTmux(session), 300);
        }

        async function sendTmuxQuick(command) {
            const session = document.getElementById('currentTmuxSession').textContent;
            if (!session) {
                showNotification('No session selected', 'error');
                return;
            }

            await api('/tmux/send', 'POST', { session, message: command });
            setTimeout(() => captureTmux(session), 500);
        }

        function insertChar(char) {
            const input = document.getElementById('tmuxCommand');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            input.value = value.substring(0, start) + char + value.substring(end);
            input.selectionStart = input.selectionEnd = start + char.length;
            input.focus();
        }

        // Auto-refresh for tmux output
        let tmuxAutoRefreshInterval = null;

        function toggleTmuxAutoRefresh() {
            const checkbox = document.getElementById('tmuxAutoRefresh');
            const session = document.getElementById('currentTmuxSession').textContent;

            if (checkbox.checked && session) {
                tmuxAutoRefreshInterval = setInterval(() => {
                    const currentSession = document.getElementById('currentTmuxSession').textContent;
                    if (currentSession && document.getElementById('tmuxOutputContainer').style.display !== 'none') {
                        captureTmux(currentSession);
                    }
                }, 2000);
            } else {
                if (tmuxAutoRefreshInterval) {
                    clearInterval(tmuxAutoRefreshInterval);
                    tmuxAutoRefreshInterval = null;
                }
            }
        }

        // Open terminal modal for a session (called when clicking session card)
        function openTmuxTerminal(sessionName) {
            const modal = document.getElementById('modal-tmuxFullscreen');
            document.getElementById('fullscreenTmuxSession').textContent = sessionName;
            document.getElementById('currentTmuxSession').textContent = sessionName;
            captureTmuxFullscreen(sessionName);
            modal.style.display = 'flex';

            // Focus the input for immediate typing
            setTimeout(() => {
                document.getElementById('fullscreenTmuxInput').focus();
            }, 100);

            // Start auto-refresh every 2 seconds
            if (window.fullscreenRefreshInterval) {
                clearInterval(window.fullscreenRefreshInterval);
            }
            window.fullscreenRefreshInterval = setInterval(() => {
                const currentSession = document.getElementById('fullscreenTmuxSession').textContent;
                if (currentSession && document.getElementById('modal-tmuxFullscreen').style.display !== 'none') {
                    captureTmuxFullscreen(currentSession);
                }
            }, 2000);
        }

        // Fullscreen terminal modal (legacy - redirects to openTmuxTerminal)
        function openTmuxFullscreen() {
            const session = document.getElementById('currentTmuxSession').textContent;
            if (!session) {
                showNotification('No session selected', 'error');
                return;
            }
            openTmuxTerminal(session);
        }

        function closeTmuxFullscreen() {
            document.getElementById('modal-tmuxFullscreen').style.display = 'none';
            if (window.fullscreenRefreshInterval) {
                clearInterval(window.fullscreenRefreshInterval);
                window.fullscreenRefreshInterval = null;
            }
        }

        async function captureTmuxFullscreen(session) {
            const result = await api('/tmux/capture', 'POST', { session });
            if (result.success) {
                const output = document.getElementById('fullscreenTmuxOutput');
                output.innerHTML = highlightTerminalOutput(result.output || '(empty)');
                output.scrollTop = output.scrollHeight;
            }
        }

        async function sendTmuxFullscreenCommand() {
            const session = document.getElementById('fullscreenTmuxSession').textContent;
            const input = document.getElementById('fullscreenTmuxInput');
            const command = input.value.trim();
            if (!command) return;

            await api('/tmux/send', 'POST', { session, message: command });
            input.value = '';
            setTimeout(() => captureTmuxFullscreen(session), 500);
        }

        async function sendFullscreenQuick(command) {
            const session = document.getElementById('fullscreenTmuxSession').textContent;
            if (!session) return;
            await api('/tmux/send', 'POST', { session, message: command });
            setTimeout(() => captureTmuxFullscreen(session), 500);
        }

        async function sendFullscreenKey(key) {
            const session = document.getElementById('fullscreenTmuxSession').textContent;
            if (!session) return;
            await api('/tmux/send-key', 'POST', { session, key });
            setTimeout(() => captureTmuxFullscreen(session), 300);
        }

        // Node auto-refresh state
        let nodesAutoRefreshInterval = null;
        let nodesRefreshCountdown = 30;
        let nodesCountdownInterval = null;

        function getHealthLevel(value) {
            if (value < 50) return 'low';
            if (value < 80) return 'medium';
            return 'high';
        }

        // ============================================================================
        // SERVICES HEALTH PANEL
        // ============================================================================
        let servicesRefreshCountdown = 15;
        let servicesCountdownInterval = null;

        function toggleServicesAutoRefresh(enabled) {
            const countdownEl = document.getElementById('servicesRefreshCountdown');

            if (enabled) {
                servicesRefreshCountdown = 15;
                updateServicesCountdownDisplay();

                servicesCountdownInterval = setInterval(() => {
                    servicesRefreshCountdown--;
                    updateServicesCountdownDisplay();

                    if (servicesRefreshCountdown <= 0) {
                        servicesRefreshCountdown = 15;
                        loadServiceHealth();
                    }
                }, 1000);

                if (countdownEl) countdownEl.classList.add('active');
            } else {
                if (servicesCountdownInterval) {
                    clearInterval(servicesCountdownInterval);
                    servicesCountdownInterval = null;
                }
                if (countdownEl) {
                    countdownEl.textContent = '';
                    countdownEl.classList.remove('active');
                }
            }
        }

        function updateServicesCountdownDisplay() {
            const countdownEl = document.getElementById('servicesRefreshCountdown');
            if (countdownEl) {
                countdownEl.textContent = `(${servicesRefreshCountdown}s)`;
            }
        }

        async function loadServiceHealth() {
            try {
                const response = await api('/services');
                const services = response.services || [];

                const grid = document.getElementById('servicesGrid');
                const emptyState = document.getElementById('servicesEmpty');
                if (!grid) return;

                // Update last updated timestamp
                const lastUpdatedEl = document.getElementById('servicesLastUpdated');
                if (lastUpdatedEl) {
                    lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                }

                // Calculate stats
                let healthy = 0, down = 0, unknown = 0;
                services.forEach(s => {
                    if (s.health === 'healthy') healthy++;
                    else if (s.health === 'no-health-endpoint' || s.health === 'unknown') unknown++;
                    else down++;
                });

                // Update stats
                document.getElementById('servicesTotal').textContent = services.length;
                document.getElementById('servicesHealthy').textContent = healthy;
                document.getElementById('servicesDown').textContent = down;
                document.getElementById('servicesUnknown').textContent = unknown;

                if (services.length === 0) {
                    grid.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                grid.style.display = 'grid';
                emptyState.style.display = 'none';

                // Sort: down first, then unknown, then healthy
                services.sort((a, b) => {
                    const order = { 'down': 0, 'no-health-endpoint': 1, 'unknown': 1, 'healthy': 2 };
                    return (order[a.health] || 1) - (order[b.health] || 1);
                });

                grid.innerHTML = services.map(s => {
                    const healthClass = s.health === 'healthy' ? 'online' :
                                       s.health === 'no-health-endpoint' || s.health === 'unknown' ? 'warning' : 'offline';
                    const healthIcon = s.health === 'healthy' ? '' :
                                      s.health === 'no-health-endpoint' ? '?' : '';
                    const healthLabel = s.health === 'healthy' ? 'Healthy' :
                                       s.health === 'no-health-endpoint' ? 'No Health Check' :
                                       s.health === 'unknown' ? 'Unknown' : 'Down';

                    const envColor = {
                        'PROD': '#3fb950',
                        'DEV': '#58a6ff',
                        'QA': '#d29922',
                        'Feature1': '#a371f7',
                        'Feature2': '#a371f7',
                        'Feature3': '#a371f7'
                    }[s.env] || '#8b949e';

                    return `
                    <div class="card" style="border-left: 3px solid ${healthClass === 'online' ? '#3fb950' : healthClass === 'warning' ? '#d29922' : '#f85149'};">
                        <div class="card-header" style="padding-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="service-health-dot ${healthClass}" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: ${healthClass === 'online' ? '#3fb950' : healthClass === 'warning' ? '#d29922' : '#f85149'};"></span>
                                <div class="card-title" style="font-size: 14px;">${s.name || s.id}</div>
                            </div>
                            <span class="badge" style="background: ${envColor}22; color: ${envColor}; border: 1px solid ${envColor}44; font-size: 10px; padding: 2px 6px;">${s.env || 'Unknown'}</span>
                        </div>
                        <div class="card-body" style="padding: 12px 16px; font-size: 12px; color: var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span>Port:</span>
                                <span style="color: var(--text-primary); font-family: monospace;">${s.port}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span>Type:</span>
                                <span style="color: var(--text-primary);">${s.type || 'unknown'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span>Status:</span>
                                <span style="color: ${healthClass === 'online' ? '#3fb950' : healthClass === 'warning' ? '#d29922' : '#f85149'}; font-weight: 500;">
                                    ${healthIcon} ${healthLabel}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>PID:</span>
                                <span style="color: var(--text-primary); font-family: monospace;">${s.pid || '-'}</span>
                            </div>
                        </div>
                        <div class="card-footer" style="padding: 8px 16px; border-top: 1px solid var(--border);">
                            <a href="${s.url}" target="_blank" class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;">Open</a>
                            <a href="${s.url}/health" target="_blank" class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;">Health</a>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load services:', error);
            }
        }

        // Initialize services auto-refresh when panel is shown
        function initServicesPanel() {
            loadServiceHealth();
            const checkbox = document.getElementById('servicesAutoRefresh');
            if (checkbox && checkbox.checked) {
                toggleServicesAutoRefresh(true);
            }
        }

        function toggleNodesAutoRefresh(enabled) {
            const countdownEl = document.getElementById('nodesRefreshCountdown');

            if (enabled) {
                nodesRefreshCountdown = 30;
                updateNodesCountdownDisplay();

                // Start countdown
                nodesCountdownInterval = setInterval(() => {
                    nodesRefreshCountdown--;
                    updateNodesCountdownDisplay();

                    if (nodesRefreshCountdown <= 0) {
                        nodesRefreshCountdown = 30;
                        loadNodes();
                    }
                }, 1000);

                if (countdownEl) countdownEl.classList.add('active');
            } else {
                if (nodesCountdownInterval) {
                    clearInterval(nodesCountdownInterval);
                    nodesCountdownInterval = null;
                }
                if (countdownEl) {
                    countdownEl.textContent = '';
                    countdownEl.classList.remove('active');
                }
            }
        }

        function updateNodesCountdownDisplay() {
            const countdownEl = document.getElementById('nodesRefreshCountdown');
            if (countdownEl) {
                countdownEl.textContent = `(${nodesRefreshCountdown}s)`;
            }
        }

        // ============================================================================
        // REGIONS MANAGEMENT
        // ============================================================================

        let regionsCache = [];

        async function loadRegions() {
            try {
                const response = await api('/regions');
                regionsCache = Array.isArray(response) ? response : [];
                renderRegions(regionsCache);
                updateRegionsSummary();
                loadRegionTopology();
            } catch (error) {
                console.error('Error loading regions:', error);
                const grid = document.getElementById('regionsGrid');
                if (grid) {
                    grid.innerHTML = `<p style="color: var(--red); grid-column: 1/-1; text-align: center; padding: 40px;">
                        Failed to load regions: ${error.message || 'Unknown error'}
                    </p>`;
                }
            }
        }

        function renderRegions(regions) {
            const grid = document.getElementById('regionsGrid');
            if (!grid) return;

            if (regions.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <h3 style="margin-bottom: 8px; color: var(--text-primary);">No Regions Configured</h3>
                        <p style="margin-bottom: 20px;">Set up deployment regions to manage multi-region infrastructure.</p>
                        <button class="btn btn-primary" onclick="showModal('newRegion')">+ Add First Region</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = regions.map(region => {
                const healthColor = getHealthColor(region.computed_health || region.health_status);
                const statusBadge = getStatusBadge(region.status);
                const isPrimary = region.is_primary ? '<span class="badge" style="background: var(--yellow); color: black; margin-left: 8px;">Primary</span>' : '';

                return `
                    <div class="card region-card" style="cursor: pointer;" onclick="showRegionDetails('${region.id}')">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h3 style="margin: 0; display: flex; align-items: center;">
                                    ${region.name}${isPrimary}
                                </h3>
                                <code style="font-size: 12px; color: var(--text-secondary);">${region.code}</code>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${statusBadge}
                                <span class="status-dot" style="background: ${healthColor};" title="${region.computed_health || region.health_status}"></span>
                            </div>
                        </div>
                        <div class="card-body" style="padding-top: 12px;">
                            ${region.location ? `<p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;"> ${region.location}</p>` : ''}
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
                                <div class="mini-stat">
                                    <span class="mini-stat-value">${region.node_count || 0}</span>
                                    <span class="mini-stat-label">Nodes</span>
                                </div>
                                <div class="mini-stat">
                                    <span class="mini-stat-value" style="color: var(--green);">${region.online_nodes || 0}</span>
                                    <span class="mini-stat-label">Online</span>
                                </div>
                                <div class="mini-stat">
                                    <span class="mini-stat-value">${region.worker_count || 0}</span>
                                    <span class="mini-stat-label">Workers</span>
                                </div>
                            </div>
                            ${region.avg_cpu !== undefined ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                        <span>CPU: ${region.avg_cpu}%</span>
                                        <span>Memory: ${region.avg_memory}%</span>
                                        <span>Disk: ${region.avg_disk}%</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: var(--text-secondary);">
                                ${region.provider || 'on-premise'}
                            </span>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); editRegion('${region.id}')">Edit</button>
                                <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewRegionNodes('${region.id}')">Nodes</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateRegionsSummary() {
            const summary = {
                total: regionsCache.length,
                active: regionsCache.filter(r => r.status === 'active').length,
                totalNodes: regionsCache.reduce((sum, r) => sum + (r.node_count || 0), 0),
                onlineNodes: regionsCache.reduce((sum, r) => sum + (r.online_nodes || 0), 0)
            };

            const el = id => document.getElementById(id);
            if (el('totalRegions')) el('totalRegions').textContent = summary.total;
            if (el('activeRegions')) el('activeRegions').textContent = summary.active;
            if (el('totalRegionNodes')) el('totalRegionNodes').textContent = summary.totalNodes;
            if (el('onlineRegionNodes')) el('onlineRegionNodes').textContent = summary.onlineNodes;
        }

        function getHealthColor(health) {
            const colors = {
                'healthy': 'var(--green)',
                'warning': 'var(--yellow)',
                'critical': 'var(--red)',
                'offline': 'var(--text-secondary)',
                'unknown': 'var(--text-secondary)'
            };
            return colors[health] || colors.unknown;
        }

        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="badge" style="background: var(--green);">Active</span>',
                'inactive': '<span class="badge" style="background: var(--text-secondary);">Inactive</span>',
                'maintenance': '<span class="badge" style="background: var(--yellow); color: black;">Maintenance</span>',
                'draining': '<span class="badge" style="background: var(--orange);">Draining</span>'
            };
            return badges[status] || badges.inactive;
        }

        async function loadRegionTopology() {
            try {
                const response = await api('/regions/topology');
                renderRegionTopology(response);
            } catch (error) {
                console.error('Error loading region topology:', error);
            }
        }

        function renderRegionTopology(topology) {
            const container = document.getElementById('regionTopologyContainer');
            if (!container) return;

            if (!topology.nodes || topology.nodes.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center;">
                        No regions configured. Add regions to see the topology.
                    </p>
                `;
                return;
            }

            const primary = topology.nodes.find(n => n.is_primary);
            const secondary = topology.nodes.filter(n => !n.is_primary);

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    ${primary ? `
                        <div class="topology-node primary" style="border: 2px solid var(--yellow); border-radius: 8px; padding: 16px; min-width: 200px; background: var(--bg-tertiary);">
                            <div style="text-align: center;">
                                <span style="font-size: 24px;"></span>
                                <h4 style="margin: 8px 0 4px;">${primary.label}</h4>
                                <code style="font-size: 11px; color: var(--text-secondary);">${primary.code}</code>
                                <div style="margin-top: 12px; font-size: 13px;">
                                    <span style="color: var(--green);">${primary.online_nodes}</span> / ${primary.node_count} nodes
                                </div>
                                ${primary.location ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;"> ${primary.location}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    ${secondary.map(region => `
                        <div class="topology-node" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; min-width: 180px; background: var(--bg-tertiary);">
                            <div style="text-align: center;">
                                <span style="font-size: 24px;">${region.status === 'active' ? '' : ''}</span>
                                <h4 style="margin: 8px 0 4px;">${region.label}</h4>
                                <code style="font-size: 11px; color: var(--text-secondary);">${region.code}</code>
                                <div style="margin-top: 12px; font-size: 13px;">
                                    <span style="color: var(--green);">${region.online_nodes}</span> / ${region.node_count} nodes
                                </div>
                                ${region.location ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;"> ${region.location}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 13px;">
                    ${topology.summary.total_regions} regions  ${topology.summary.total_nodes} total nodes  ${topology.summary.online_nodes} online
                </div>
            `;
        }

        async function createRegion(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('regionName').value.trim(),
                code: document.getElementById('regionCode').value.trim().toLowerCase(),
                provider: document.getElementById('regionProvider').value,
                description: document.getElementById('regionDescription').value.trim(),
                location: document.getElementById('regionLocation').value.trim(),
                timezone: document.getElementById('regionTimezone').value.trim(),
                latitude: parseFloat(document.getElementById('regionLatitude').value) || null,
                longitude: parseFloat(document.getElementById('regionLongitude').value) || null,
                max_nodes: parseInt(document.getElementById('regionMaxNodes').value) || 100,
                priority: parseInt(document.getElementById('regionPriority').value) || 100,
                is_primary: document.getElementById('regionIsPrimary').checked
            };

            try {
                await api('/regions', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                hideModal('newRegion');
                showNotification('Region created successfully', 'success');
                loadRegions();

                // Reset form
                event.target.reset();
            } catch (error) {
                showNotification('Failed to create region: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        async function editRegion(regionId) {
            try {
                const region = await api(`/regions/${regionId}`);

                document.getElementById('editRegionId').value = region.id;
                document.getElementById('editRegionName').value = region.name;
                document.getElementById('editRegionCode').value = region.code;
                document.getElementById('editRegionStatus').value = region.status;
                document.getElementById('editRegionDescription').value = region.description || '';
                document.getElementById('editRegionLocation').value = region.location || '';
                document.getElementById('editRegionProvider').value = region.provider || 'on-premise';
                document.getElementById('editRegionPriority').value = region.priority || 100;
                document.getElementById('editRegionMaxNodes').value = region.max_nodes || 100;
                document.getElementById('editRegionIsPrimary').checked = !!region.is_primary;

                showModal('editRegion');
            } catch (error) {
                showNotification('Failed to load region: ' + error.message, 'error');
            }
        }

        async function updateRegion(event) {
            event.preventDefault();

            const regionId = document.getElementById('editRegionId').value;
            const data = {
                name: document.getElementById('editRegionName').value.trim(),
                status: document.getElementById('editRegionStatus').value,
                description: document.getElementById('editRegionDescription').value.trim(),
                location: document.getElementById('editRegionLocation').value.trim(),
                provider: document.getElementById('editRegionProvider').value,
                priority: parseInt(document.getElementById('editRegionPriority').value) || 100,
                max_nodes: parseInt(document.getElementById('editRegionMaxNodes').value) || 100,
                is_primary: document.getElementById('editRegionIsPrimary').checked
            };

            try {
                await api(`/regions/${regionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                hideModal('editRegion');
                showNotification('Region updated successfully', 'success');
                loadRegions();
            } catch (error) {
                showNotification('Failed to update region: ' + error.message, 'error');
            }
        }

        async function confirmDeleteRegion() {
            const regionId = document.getElementById('editRegionId').value;
            const regionName = document.getElementById('editRegionName').value;

            if (!confirm(`Are you sure you want to delete the region "${regionName}"?\n\nNodes in this region will have their region assignment cleared.`)) {
                return;
            }

            try {
                await api(`/regions/${regionId}`, { method: 'DELETE' });
                hideModal('editRegion');
                showNotification('Region deleted successfully', 'success');
                loadRegions();
            } catch (error) {
                showNotification('Failed to delete region: ' + error.message, 'error');
            }
        }

        async function showRegionDetails(regionId) {
            try {
                const region = await api(`/regions/${regionId}`);

                const nodesHtml = region.nodes && region.nodes.length > 0
                    ? region.nodes.map(n => `
                        <tr>
                            <td>${n.hostname || n.id}</td>
                            <td>${n.ip_address || '-'}</td>
                            <td><span class="badge" style="background: ${n.status === 'online' ? 'var(--green)' : 'var(--text-secondary)'}">${n.status}</span></td>
                            <td>${n.role || 'worker'}</td>
                            <td>${n.cpu_usage ? n.cpu_usage.toFixed(1) + '%' : '-'}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No nodes in this region</td></tr>';

                showAlertModal(`
                    <h2 style="margin-bottom: 20px;">${region.name} <code style="font-size: 14px; color: var(--text-secondary);">${region.code}</code></h2>
                    ${region.is_primary ? '<span class="badge" style="background: var(--yellow); color: black; margin-bottom: 16px; display: inline-block;">Primary Region</span>' : ''}
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div><strong>Provider:</strong> ${region.provider || 'on-premise'}</div>
                        <div><strong>Status:</strong> ${region.status}</div>
                        <div><strong>Location:</strong> ${region.location || '-'}</div>
                        <div><strong>Timezone:</strong> ${region.timezone || '-'}</div>
                        <div><strong>Nodes:</strong> ${region.online_nodes || 0} / ${region.node_count || 0}</div>
                        <div><strong>Max Nodes:</strong> ${region.max_nodes || 100}</div>
                    </div>
                    ${region.description ? `<p style="color: var(--text-secondary); margin-bottom: 16px;">${region.description}</p>` : ''}
                    <h3 style="margin: 16px 0 12px;">Nodes</h3>
                    <table class="data-table" style="width: 100%;">
                        <thead><tr><th>Hostname</th><th>IP</th><th>Status</th><th>Role</th><th>CPU</th></tr></thead>
                        <tbody>${nodesHtml}</tbody>
                    </table>
                    <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="editRegion('${region.id}'); hideAlertModal();">Edit Region</button>
                        <button class="btn btn-primary" onclick="hideAlertModal();">Close</button>
                    </div>
                `, 'region-details');
            } catch (error) {
                showNotification('Failed to load region details: ' + error.message, 'error');
            }
        }

        async function viewRegionNodes(regionId) {
            try {
                const nodes = await api(`/regions/${regionId}/nodes`);
                const region = regionsCache.find(r => r.id === regionId);

                if (nodes.length === 0) {
                    showNotification(`No nodes in region ${region?.name || regionId}`, 'info');
                    return;
                }

                showAlertModal(`
                    <h2 style="margin-bottom: 20px;">Nodes in ${region?.name || regionId}</h2>
                    <table class="data-table" style="width: 100%;">
                        <thead><tr><th>Hostname</th><th>IP</th><th>Status</th><th>Role</th><th>CPU</th><th>Memory</th></tr></thead>
                        <tbody>
                            ${nodes.map(n => `
                                <tr>
                                    <td>${n.hostname || n.id}</td>
                                    <td>${n.ip_address || '-'}</td>
                                    <td><span class="badge" style="background: ${n.status === 'online' ? 'var(--green)' : 'var(--text-secondary)'}">${n.status}</span></td>
                                    <td>${n.role || 'worker'}</td>
                                    <td>${n.cpu_usage ? n.cpu_usage.toFixed(1) + '%' : '-'}</td>
                                    <td>${n.memory_usage ? n.memory_usage.toFixed(1) + '%' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="hideAlertModal();">Close</button>
                    </div>
                `, 'region-nodes');
            } catch (error) {
                showNotification('Failed to load region nodes: ' + error.message, 'error');
            }
        }

        async function triggerRegionFailover(targetRegionId) {
            const region = regionsCache.find(r => r.id === targetRegionId);
            const reason = prompt(`Reason for failover to ${region?.name || targetRegionId}:`);

            if (reason === null) return; // User cancelled

            try {
                await api('/regions/failover', {
                    method: 'POST',
                    body: JSON.stringify({
                        target_region: targetRegionId,
                        reason: reason || 'Manual failover'
                    })
                });

                showNotification(`Failover to ${region?.name || targetRegionId} completed`, 'success');
                loadRegions();
            } catch (error) {
                showNotification('Failover failed: ' + error.message, 'error');
            }
        }

        async function loadNodes() {
            const response = await api('/nodes');
            const nodes = Array.isArray(response) ? response : [];

            const grid = document.getElementById('nodesGrid');
            if (!grid) return;

            // Update last updated timestamp
            const lastUpdatedEl = document.getElementById('nodesLastUpdated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            }

            grid.innerHTML = nodes.map(n => {
                const cpuVal = n.cpu_usage?.toFixed(0) || 0;
                const memVal = n.memory_usage?.toFixed(0) || 0;
                const diskVal = n.disk_usage?.toFixed(0) || 0;

                return `
                <div class="card">
                    <div class="card-header">
                        <div class="node-card">
                            <div class="node-status-indicator ${n.status || 'offline'}"></div>
                            <div>
                                <div class="card-title">${n.hostname || 'Unknown'}</div>
                                <div class="card-meta">${n.ip_address || ''}:${n.ssh_port || 22}</div>
                            </div>
                        </div>
                        <span class="badge badge-${n.status || 'offline'}">${n.status || 'offline'}</span>
                    </div>
                    <div class="card-body">
                        <p>Role: ${n.role || 'worker'}</p>
                        <p>Sessions: ${n.session_count || 0} | Workers: ${n.worker_count || 0}</p>
                        <div class="node-metrics-grid">
                            <div class="node-metric-with-bar">
                                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                    <div class="node-metric-label">CPU</div>
                                    <div class="node-metric-value" style="font-size: 14px;">${cpuVal}%</div>
                                </div>
                                <div class="node-health-bar">
                                    <div class="node-health-fill ${getHealthLevel(cpuVal)}" style="width: ${cpuVal}%"></div>
                                </div>
                            </div>
                            <div class="node-metric-with-bar">
                                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                    <div class="node-metric-label">Memory</div>
                                    <div class="node-metric-value" style="font-size: 14px;">${memVal}%</div>
                                </div>
                                <div class="node-health-bar">
                                    <div class="node-health-fill ${getHealthLevel(memVal)}" style="width: ${memVal}%"></div>
                                </div>
                            </div>
                            <div class="node-metric-with-bar">
                                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                    <div class="node-metric-label">Disk</div>
                                    <div class="node-metric-value" style="font-size: 14px;">${diskVal}%</div>
                                </div>
                                <div class="node-health-bar">
                                    <div class="node-health-fill ${getHealthLevel(diskVal)}" style="width: ${diskVal}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span>${formatTime(n.last_heartbeat)}</span>
                        <button class="btn btn-danger" onclick="removeNode('${n.id}')">Remove</button>
                    </div>
                </div>
            `}).join('') || '<p style="color: var(--text-secondary)">No nodes registered</p>';
        }

        // Termius Export Functions
        async function previewTermiusExport() {
            const preview = await api('/termius/preview');
            const container = document.getElementById('termiusPreview');
            const content = document.getElementById('termiusPreviewContent');

            if (preview.error) {
                content.innerHTML = `<p style="color: var(--error)">Error: ${preview.error}</p>`;
            } else {
                let html = `
                    <div style="margin-bottom: 15px;">
                        <strong>Summary:</strong> ${preview.total_hosts} hosts, ${preview.total_sessions} tmux sessions
                    </div>
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px;">Host</th>
                                <th style="text-align: left; padding: 8px;">IP</th>
                                <th style="text-align: left; padding: 8px;">User</th>
                                <th style="text-align: left; padding: 8px;">Status</th>
                                <th style="text-align: left; padding: 8px;">Sessions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const host of preview.hosts) {
                    const sessions = host.sessions.filter(s => s).join(', ') || '-';
                    html += `
                        <tr>
                            <td style="padding: 8px;">${host.hostname || '-'}</td>
                            <td style="padding: 8px;">${host.ip}:${host.port}</td>
                            <td style="padding: 8px;">${host.user || '-'}</td>
                            <td style="padding: 8px;"><span class="badge badge-${host.status}">${host.status}</span></td>
                            <td style="padding: 8px; font-size: 12px;">${sessions}</td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                content.innerHTML = html;
            }

            container.style.display = 'block';
        }

        function downloadTermiusExport(mode) {
            // Trigger file download
            window.location.href = `/api/termius/export?mode=${mode}&format=download`;
        }

        function getRiskBadge(taskId, riskLevel, riskScore) {
            const colors = {
                'critical': { bg: '#dc2626', text: '#fff', icon: '!!' },
                'high': { bg: '#ea580c', text: '#fff', icon: '!' },
                'medium': { bg: '#ca8a04', text: '#fff', icon: '~' },
                'low': { bg: '#22c55e', text: '#fff', icon: '' }
            };
            const level = riskLevel || 'low';
            const style = colors[level] || colors.low;
            const score = riskScore || 0;

            if (level === 'low' && score === 0) {
                return `<span style="color: var(--text-secondary); cursor: pointer;" onclick="editTaskRisk(${taskId})" title="Click to set risk">-</span>`;
            }

            return `<span class="risk-badge" style="
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                background: ${style.bg};
                color: ${style.text};
                cursor: pointer;
            " onclick="editTaskRisk(${taskId})" title="Risk: ${level} (${score}/100) - Click to edit">
                ${style.icon ? style.icon + ' ' : ''}${level.charAt(0).toUpperCase() + level.slice(1)}
                ${score > 0 ? '<span style="opacity: 0.8; font-weight: normal;">(' + score + ')</span>' : ''}
            </span>`;
        }

        async function editTaskRisk(taskId) {
            const riskLevels = ['low', 'medium', 'high', 'critical'];
            const currentRisk = await api(`/tasks/${taskId}/risk`);

            const select = document.createElement('select');
            select.style.cssText = 'padding: 4px 8px; border-radius: 4px; font-size: 12px;';
            riskLevels.forEach(level => {
                const opt = document.createElement('option');
                opt.value = level;
                opt.textContent = level.charAt(0).toUpperCase() + level.slice(1);
                if (level === (currentRisk.risk_level || 'low')) opt.selected = true;
                select.appendChild(opt);
            });

            select.onchange = async function() {
                try {
                    await api(`/tasks/${taskId}/risk`, 'PUT', { risk_level: this.value });
                    showNotification(`Risk updated to ${this.value}`, 'success');
                    loadTasks();
                } catch (e) {
                    showNotification('Failed to update risk', 'error');
                }
            };

            select.onblur = function() {
                loadTasks();
            };

            // Find and replace the badge
            event.target.replaceWith(select);
            select.focus();
        }

        function renderTasksTable(tasks) {
            const tbody = document.getElementById('tasksTable');
            if (!tbody) return;

            tbody.innerHTML = tasks.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.task_type}</td>
                    <td><span class="badge badge-${t.status === 'completed' ? 'completed' : t.status === 'failed' ? 'critical' : 'open'} inline-editable" data-entity-id="${t.id}" data-entity-type="task" data-field="status" data-edit-type="select" title="Click to change status">${t.status}</span></td>
                    <td>${getRiskBadge(t.id, t.risk_level, t.risk_score)}</td>
                    <td><span class="inline-editable" data-entity-id="${t.id}" data-entity-type="task" data-field="priority" data-edit-type="number" title="Click to edit priority">${t.priority}</span></td>
                    <td>${t.assigned_worker || '-'}</td>
                    <td>${formatTime(t.created_at)}</td>
                    <td>
                        ${t.status === 'pending' ? '<button class="btn btn-secondary" onclick="cancelTask(' + t.id + ')">Cancel</button>' : '-'}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary)">No tasks found</td></tr>';
        }

        async function loadTasks() {
            const statusFilter = document.getElementById('taskStatusFilter');
            const riskFilter = document.getElementById('taskRiskFilter');
            const status = statusFilter?.value || '';
            const riskLevel = riskFilter?.value || '';

            let endpoint = '/tasks';
            const params = [];
            if (status) params.push(`status=${status}`);
            if (riskLevel) params.push(`risk_level=${riskLevel}`);
            if (params.length > 0) endpoint += '?' + params.join('&');

            const response = await api(endpoint);
            const tasks = Array.isArray(response) ? response : [];

            // Update pagination state
            paginationState.tasks.data = tasks;
            paginationState.tasks.total = tasks.length;
            paginationState.tasks.page = 1;

            renderPaginatedTable('tasks');

            // Also load worker status
            loadWorkerStatus();
        }

        async function autoAssessTaskRisk() {
            try {
                const response = await api('/tasks/risk/auto-assess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.success) {
                    showNotification(`Assessed risk for ${response.assessed_count} tasks`, 'success');
                    loadTasks();
                } else {
                    showNotification('Failed to assess risk', 'error');
                }
            } catch (error) {
                showNotification('Error assessing risk: ' + error.message, 'error');
            }
        }

        async function loadWorkerStatus() {
            const response = await api('/workers');
            const workers = Array.isArray(response) ? response : [];
            const grid = document.getElementById('workerStatusGrid');

            if (!grid) return;

            if (!Array.isArray(workers)) {
                grid.innerHTML = '<div style="color: var(--text-secondary);">Error loading workers</div>';
                return;
            }

            grid.innerHTML = workers.map(w => {
                const statusColor = w.status === 'busy' ? 'var(--warning)' :
                                   w.status === 'idle' ? 'var(--success)' : 'var(--text-secondary)';
                const statusIcon = w.status === 'busy' ? '' : w.status === 'idle' ? '' : '';

                return `
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 500; color: var(--text-primary);">${w.worker_type}</span>
                            <span style="font-size: 12px; color: ${statusColor};">${statusIcon} ${w.status}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ID: ${w.id}<br>
                            Tasks: ${w.tasks_completed || 0} done, ${w.tasks_failed || 0} failed
                        </div>
                    </div>
                `;
            }).join('') || '<div style="color: var(--text-secondary);">No workers registered</div>';
        }

        // ========================================
        // SUGGESTED TASKS (Claude suggestions)
        // ========================================

        async function loadSuggestedTasks() {
            try {
                const response = await api('/tasks/suggest');
                const tasks = Array.isArray(response) ? response : [];
                const container = document.getElementById('suggestedTasksList');
                const card = document.getElementById('suggestedTasksCard');

                if (!container || !card) return;

                if (tasks.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';

                container.innerHTML = tasks.map(t => {
                    const priorityColors = {
                        'critical': '#ff4757',
                        'high': '#ffa502',
                        'normal': '#2ed573',
                        'low': '#747d8c'
                    };
                    const priorityColor = priorityColors[t.priority] || priorityColors.normal;

                    const typeIcons = {
                        'browser_test': '',
                        'manual_test': '',
                        'code_review': '',
                        'deployment': '',
                        'other': ''
                    };
                    const icon = typeIcons[t.task_type] || typeIcons.other;

                    // Calculate time remaining
                    let timeRemaining = '';
                    if (t.expires_at) {
                        const expires = new Date(t.expires_at);
                        const now = new Date();
                        const diff = Math.max(0, Math.floor((expires - now) / 1000));
                        if (diff > 60) {
                            timeRemaining = `${Math.floor(diff / 60)}m remaining`;
                        } else {
                            timeRemaining = `${diff}s remaining`;
                        }
                    }

                    return `
                        <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 16px;">
                            <div style="font-size: 24px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; color: var(--text-primary);">${escapeHtml(t.title)}</span>
                                    <span style="font-size: 10px; padding: 2px 6px; background: ${priorityColor}20; color: ${priorityColor}; border-radius: 4px; text-transform: uppercase;">${t.priority}</span>
                                </div>
                                ${t.description ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${escapeHtml(t.description)}</div>` : ''}
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${t.source_session ? `From: ${t.source_session}` : ''}
                                    ${timeRemaining ? `<span style="margin-left: 8px; color: var(--warning);"> ${timeRemaining}</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="confirmSuggestedTask(${t.id})" style="padding: 8px 16px;">
                                     Confirm
                                </button>
                                <button class="btn btn-secondary" onclick="skipSuggestedTask(${t.id})" style="padding: 8px 16px;">
                                    Skip
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load suggested tasks:', e);
            }
        }

        async function confirmSuggestedTask(taskId) {
            try {
                const result = await api(`/tasks/suggest/${taskId}/confirm`, 'POST', {});
                if (result.success) {
                    showNotification(result.message, 'success');
                    loadSuggestedTasks();
                }
            } catch (e) {
                showNotification('Failed to confirm task: ' + e.message, 'error');
            }
        }

        async function skipSuggestedTask(taskId) {
            const reason = prompt('Reason for skipping (optional):');
            try {
                const result = await api(`/tasks/suggest/${taskId}/skip`, 'POST', { reason });
                if (result.success) {
                    showNotification(result.message, 'info');
                    loadSuggestedTasks();
                }
            } catch (e) {
                showNotification('Failed to skip task: ' + e.message, 'error');
            }
        }

        // Load suggested tasks when tasks panel is shown
        const originalLoadTasks = loadTasks;
        loadTasks = async function() {
            await originalLoadTasks();
            await loadSuggestedTasks();
        };

        // Poll for new suggested tasks every 10 seconds when on tasks panel
        setInterval(() => { // Reduced to 60s
            if (document.getElementById('panel-tasks')?.style.display !== 'none') {
                loadSuggestedTasks();
            }
        }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 10s

        async function createTask() {
            const taskType = document.getElementById('newTaskType').value;
            const taskData = document.getElementById('newTaskData').value;
            const priority = parseInt(document.getElementById('newTaskPriority').value);

            // Parse task data - could be JSON or plain command
            let parsedData;
            try {
                parsedData = JSON.parse(taskData);
            } catch (e) {
                // Not JSON, treat as command
                parsedData = { command: taskData };
            }

            const result = await api('/tasks', 'POST', {
                task_type: taskType,
                task_data: parsedData,
                priority: priority
            });

            if (result.success) {
                hideModal('newTask');
                document.getElementById('newTaskData').value = '';
                showNotification('Task created', 'success');
                loadTasks();
            } else {
                showNotification(result.error || 'Failed to create task', 'error');
            }
        }

        // ============================================================================
        // TASK ATTACHMENT HANDLING
        // ============================================================================

        let pendingTaskFiles = [];

        function handleTaskFileSelect(event) {
            const files = Array.from(event.target.files);
            pendingTaskFiles = [...pendingTaskFiles, ...files];
            renderPendingFiles();
        }

        function renderPendingFiles() {
            const container = document.getElementById('newTaskFileList');
            if (pendingTaskFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = pendingTaskFiles.map((file, idx) => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 5px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 5px;">
                    <span style="flex: 1;"> ${file.name} <span style="color: var(--text-secondary);">(${formatFileSize(file.size)})</span></span>
                    <button onclick="removePendingFile(${idx})" class="btn btn-sm" style="padding: 2px 8px;"></button>
                </div>
            `).join('');
        }

        function removePendingFile(index) {
            pendingTaskFiles.splice(index, 1);
            renderPendingFiles();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function createTaskWithAttachments() {
            const taskType = document.getElementById('newTaskType').value;
            const taskData = document.getElementById('newTaskData').value;
            const priority = parseInt(document.getElementById('newTaskPriority').value);
            const riskLevel = document.getElementById('newTaskRiskLevel')?.value || 'low';

            let parsedData;
            try {
                parsedData = JSON.parse(taskData);
            } catch (e) {
                parsedData = { command: taskData };
            }

            // Create the task first
            const result = await api('/tasks', 'POST', {
                task_type: taskType,
                task_data: parsedData,
                priority: priority,
                risk_level: riskLevel
            });

            if (!result.success) {
                showNotification(result.error || 'Failed to create task', 'error');
                return;
            }

            const taskId = result.task.id;

            // Upload attachments if any
            if (pendingTaskFiles.length > 0) {
                let uploadCount = 0;
                for (const file of pendingTaskFiles) {
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const uploadResult = await fetch(`/api/tasks/${taskId}/attachments`, {
                            method: 'POST',
                            body: formData
                        });
                        if (uploadResult.ok) uploadCount++;
                    } catch (e) {
                        console.error('Upload failed:', e);
                    }
                }
                if (uploadCount > 0) {
                    showNotification(`Task created with ${uploadCount} attachment(s)`, 'success');
                } else {
                    showNotification('Task created, but attachments failed to upload', 'warning');
                }
            } else {
                showNotification('Task created', 'success');
            }

            // Reset and close
            pendingTaskFiles = [];
            document.getElementById('newTaskFileList').innerHTML = '';
            document.getElementById('newTaskData').value = '';
            hideModal('newTask');
            loadTasks();
        }

        let currentTaskId = null;

        async function showTaskDetails(taskId) {
            currentTaskId = taskId;

            // Track entity viewing for collaboration
            CollaborationManager.viewEntity('task', taskId);

            showModal('taskDetails');

            // Load task details
            const taskResult = await api(`/tasks/${taskId}`);
            const contentEl = document.getElementById('taskDetailsContent');

            if (taskResult.task) {
                const task = taskResult.task;
                contentEl.innerHTML = `
                    <div style="display: grid; gap: 10px;">
                        <div><strong>ID:</strong> #${task.id}</div>
                        <div><strong>Type:</strong> ${task.task_type}</div>
                        <div><strong>Status:</strong> <span class="status-badge status-${task.status}">${task.status}</span></div>
                        <div><strong>Priority:</strong> ${task.priority}</div>
                        <div><strong>Created:</strong> ${new Date(task.created_at).toLocaleString()}</div>
                        ${task.started_at ? `<div><strong>Started:</strong> ${new Date(task.started_at).toLocaleString()}</div>` : ''}
                        ${task.completed_at ? `<div><strong>Completed:</strong> ${new Date(task.completed_at).toLocaleString()}</div>` : ''}
                        <div><strong>Data:</strong></div>
                        <pre style="background: var(--bg-tertiary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(JSON.parse(task.task_data || '{}'), null, 2)}</pre>
                        ${task.error_message ? `<div style="color: var(--error);"><strong>Error:</strong> ${task.error_message}</div>` : ''}
                    </div>
                `;
            } else {
                contentEl.innerHTML = '<div style="color: var(--error);">Task not found</div>';
            }

            // Load attachments
            loadTaskAttachments(taskId);
        }

        async function loadTaskAttachments(taskId) {
            const container = document.getElementById('taskAttachmentsList');
            const result = await api(`/tasks/${taskId}/attachments`);

            if (result.attachments && result.attachments.length > 0) {
                container.innerHTML = result.attachments.map(att => `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 5px;">
                        <span></span>
                        <span style="flex: 1;">
                            <a href="/api/tasks/${taskId}/attachments/${att.id}" target="_blank" style="color: var(--accent);">${att.original_filename}</a>
                            <span style="color: var(--text-secondary); font-size: 12px;">(${formatFileSize(att.file_size)})</span>
                        </span>
                        <button onclick="deleteTaskAttachment(${taskId}, ${att.id})" class="btn btn-sm" style="padding: 2px 8px; color: var(--error);"></button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<span style="color: var(--text-secondary);">No attachments</span>';
            }
        }

        async function uploadTaskAttachment(event) {
            if (!currentTaskId) return;

            const files = event.target.files;
            let uploadCount = 0;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const result = await fetch(`/api/tasks/${currentTaskId}/attachments`, {
                        method: 'POST',
                        body: formData
                    });
                    if (result.ok) uploadCount++;
                } catch (e) {
                    console.error('Upload failed:', e);
                }
            }

            if (uploadCount > 0) {
                showNotification(`${uploadCount} file(s) uploaded`, 'success');
                loadTaskAttachments(currentTaskId);
            }
            event.target.value = '';
        }

        async function deleteTaskAttachment(taskId, attachmentId) {
            if (!confirm('Delete this attachment?')) return;

            const result = await api(`/tasks/${taskId}/attachments/${attachmentId}`, 'DELETE');
            if (result.success) {
                showNotification('Attachment deleted', 'success');
                loadTaskAttachments(taskId);
            } else {
                showNotification(result.error || 'Failed to delete attachment', 'error');
            }
        }

        async function cancelTask(taskId) {
            const result = await api(`/tasks/${taskId}/cancel`, 'POST');
            if (result.success) {
                showNotification('Task cancelled', 'success');
                loadTasks();
            }
        }

        async function processNextTask() {
            const result = await api('/tasks/process', 'POST');
            if (result.success) {
                showNotification(`Task #${result.task_id} sent to ${result.session}`, 'success');
                loadTasks();
            } else {
                showNotification(result.message || result.error || 'No tasks to process', 'info');
            }
        }

        // CRUD operations
        async function createProject() {
            const result = await api('/projects', 'POST', {
                name: document.getElementById('newProjectName').value,
                description: document.getElementById('newProjectDescription').value,
                source_path: document.getElementById('newProjectPath').value
            });

            if (result.success) {
                hideModal('newProject');
                await loadProjects();
                loadPanelData(currentPanel);
            } else {
                showNotification(result.error || 'Failed to create project', 'error');
            }
        }

        window.editProject = async function(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }

            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editProjectName').value = project.name || '';
            document.getElementById('editProjectDescription').value = project.description || '';
            document.getElementById('editProjectPath').value = project.source_path || '';
            document.getElementById('editProjectStatus').value = project.status || 'active';

            showModal('editProject');
        };

        async function updateProject() {
            const projectId = document.getElementById('editProjectId').value;
            const result = await api(`/projects/${projectId}`, 'PUT', {
                name: document.getElementById('editProjectName').value,
                description: document.getElementById('editProjectDescription').value,
                source_path: document.getElementById('editProjectPath').value,
                status: document.getElementById('editProjectStatus').value
            });

            if (result.success) {
                hideModal('editProject');
                await loadProjects();
                loadPanelData(currentPanel);
                showNotification('Project updated successfully', 'success');
            } else {
                showNotification(result.error || 'Failed to update project', 'error');
            }
        }

        async function archiveProject() {
            const projectId = document.getElementById('editProjectId').value;
            const projectName = document.getElementById('editProjectName').value;

            if (!confirm(`Are you sure you want to archive "${projectName}"? This will hide it from the active projects list.`)) {
                return;
            }

            const result = await api(`/projects/${projectId}`, 'PUT', {
                status: 'archived'
            });

            if (result.success) {
                hideModal('editProject');
                await loadProjects();
                loadPanelData(currentPanel);
                showNotification('Project archived successfully', 'success');
            } else {
                showNotification(result.error || 'Failed to archive project', 'error');
            }
        }

        async function quickArchiveProject(projectId, projectName) {
            if (!confirm(`Are you sure you want to archive "${projectName}"? This will hide it from the active projects list.`)) {
                return;
            }

            const result = await api(`/projects/${projectId}`, 'PUT', {
                status: 'archived'
            });

            if (result.success) {
                await loadProjects();
                loadPanelData(currentPanel);
                showNotification('Project archived successfully', 'success');
            } else {
                showNotification(result.error || 'Failed to archive project', 'error');
            }
        }

        // ========== Project Members/Permissions Management ==========

        async function showProjectMembers(projectId, projectName) {
            document.getElementById('projectMembersProjectId').value = projectId;
            document.getElementById('projectMembersProjectName').textContent = `Managing access for: ${projectName}`;
            showModal('projectMembers');

            // Load users for the add member dropdown
            await loadUsersForMemberSelect();

            // Load current members
            await loadProjectMembers(projectId);

            // Load permission log
            await loadProjectPermissionLog(projectId);
        }

        async function loadUsersForMemberSelect() {
            try {
                const users = await api('/users');
                const select = document.getElementById('addMemberUserId');
                select.innerHTML = '<option value="">Select user...</option>';

                if (Array.isArray(users)) {
                    users.forEach(user => {
                        select.innerHTML += `<option value="${user.id}">${user.username} (${user.role || 'user'})</option>`;
                    });
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        async function loadProjectMembers(projectId) {
            const container = document.getElementById('projectMembersList');
            const summaryContainer = document.getElementById('projectAccessSummary');

            try {
                const [members, access] = await Promise.all([
                    api(`/projects/${projectId}/members`),
                    api(`/projects/${projectId}/access`)
                ]);

                const currentUserAccess = access.access_level || 'read';
                const canManage = ['admin', 'owner'].includes(currentUserAccess);

                // Render summary badges
                const levelCounts = { owner: 0, admin: 0, write: 0, read: 0 };
                members.forEach(m => levelCounts[m.access_level] = (levelCounts[m.access_level] || 0) + 1);

                summaryContainer.innerHTML = `
                    <div style="padding: 8px 12px; background: #dc2626; color: white; border-radius: 6px; font-size: 12px;">
                        <div style="font-weight: 600;">${levelCounts.owner}</div>
                        <div>Owners</div>
                    </div>
                    <div style="padding: 8px 12px; background: #ea580c; color: white; border-radius: 6px; font-size: 12px;">
                        <div style="font-weight: 600;">${levelCounts.admin}</div>
                        <div>Admins</div>
                    </div>
                    <div style="padding: 8px 12px; background: #ca8a04; color: white; border-radius: 6px; font-size: 12px;">
                        <div style="font-weight: 600;">${levelCounts.write}</div>
                        <div>Writers</div>
                    </div>
                    <div style="padding: 8px 12px; background: #22c55e; color: white; border-radius: 6px; font-size: 12px;">
                        <div style="font-weight: 600;">${levelCounts.read}</div>
                        <div>Readers</div>
                    </div>
                    <div style="padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;">
                        <div style="font-weight: 600;">Your Access</div>
                        <div style="text-transform: capitalize;">${currentUserAccess}</div>
                    </div>
                `;

                // Render members list
                if (!members || members.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            No members yet. This project is accessible to all users with read access.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">User</th>
                                <th style="text-align: left;">Access Level</th>
                                <th style="text-align: left;">Added</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(m => `
                                <tr>
                                    <td>
                                        <div style="font-weight: 500;">${m.username}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Global: ${m.global_role || 'user'}</div>
                                    </td>
                                    <td>
                                        ${canManage ? `
                                            <select onchange="updateMemberAccess(${projectId}, ${m.user_id}, this.value)"
                                                    style="padding: 4px 8px; border-radius: 4px; font-size: 12px;"
                                                    ${m.access_level === 'owner' && levelCounts.owner <= 1 ? 'disabled title="Cannot change last owner"' : ''}>
                                                <option value="read" ${m.access_level === 'read' ? 'selected' : ''}>Read</option>
                                                <option value="write" ${m.access_level === 'write' ? 'selected' : ''}>Write</option>
                                                <option value="admin" ${m.access_level === 'admin' ? 'selected' : ''}>Admin</option>
                                                <option value="owner" ${m.access_level === 'owner' ? 'selected' : ''}>Owner</option>
                                            </select>
                                        ` : `
                                            <span class="badge" style="background: ${getAccessLevelColor(m.access_level)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: capitalize;">
                                                ${m.access_level}
                                            </span>
                                        `}
                                    </td>
                                    <td style="font-size: 12px; color: var(--text-secondary);">
                                        ${formatTime(m.added_at)}
                                        ${m.added_by_username ? `<br>by ${m.added_by_username}` : ''}
                                    </td>
                                    <td style="text-align: right;">
                                        ${canManage && !(m.access_level === 'owner' && levelCounts.owner <= 1) ? `
                                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;"
                                                    onclick="removeMember(${projectId}, ${m.user_id}, '${m.username}')">
                                                Remove
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (e) {
                container.innerHTML = `<div style="color: var(--danger); padding: 12px;">Error loading members: ${e.message}</div>`;
            }
        }

        function getAccessLevelColor(level) {
            const colors = {
                owner: '#dc2626',
                admin: '#ea580c',
                write: '#ca8a04',
                read: '#22c55e'
            };
            return colors[level] || '#6b7280';
        }

        async function addProjectMember() {
            const projectId = document.getElementById('projectMembersProjectId').value;
            const userId = document.getElementById('addMemberUserId').value;
            const level = document.getElementById('addMemberLevel').value;

            if (!userId) {
                showNotification('Please select a user', 'error');
                return;
            }

            try {
                const result = await api(`/projects/${projectId}/members`, 'POST', {
                    user_id: parseInt(userId),
                    access_level: level
                });

                if (result.success || result.user_id) {
                    showNotification('Member added successfully', 'success');
                    document.getElementById('addMemberUserId').value = '';
                    await loadProjectMembers(projectId);
                    await loadProjectPermissionLog(projectId);
                } else {
                    showNotification(result.error || 'Failed to add member', 'error');
                }
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        async function updateMemberAccess(projectId, userId, newLevel) {
            try {
                const result = await api(`/projects/${projectId}/members/${userId}`, 'PUT', {
                    access_level: newLevel
                });

                if (result.success) {
                    showNotification('Access level updated', 'success');
                    await loadProjectPermissionLog(projectId);
                } else {
                    showNotification(result.error || 'Failed to update access', 'error');
                    await loadProjectMembers(projectId);
                }
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
                await loadProjectMembers(projectId);
            }
        }

        async function removeMember(projectId, userId, username) {
            if (!confirm(`Remove ${username} from this project?`)) {
                return;
            }

            try {
                const result = await api(`/projects/${projectId}/members/${userId}`, 'DELETE');

                if (result.success) {
                    showNotification('Member removed', 'success');
                    await loadProjectMembers(projectId);
                    await loadProjectPermissionLog(projectId);
                } else {
                    showNotification(result.error || 'Failed to remove member', 'error');
                }
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        async function loadProjectPermissionLog(projectId) {
            const container = document.getElementById('projectPermissionLog');
            try {
                const logs = await api(`/projects/${projectId}/permissions/log`);

                if (!logs || logs.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px;">No permission changes recorded.</div>';
                    return;
                }

                container.innerHTML = logs.map(log => `
                    <div style="padding: 8px; border-bottom: 1px solid var(--border); font-size: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 500;">${log.action.replace(/_/g, ' ')}</span>
                            <span style="color: var(--text-secondary);">${formatTime(log.created_at)}</span>
                        </div>
                        <div style="color: var(--text-secondary);">
                            ${log.target_username || 'Unknown user'}
                            ${log.old_level ? ` (${log.old_level}  ${log.new_level})` : log.new_level ? `  ${log.new_level}` : ''}
                            by ${log.performed_by_username || 'system'}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px;">Unable to load permission log.</div>';
            }
        }

        // ========== End Project Members ==========

        async function createFeature() {
            const result = await api('/features', 'POST', {
                project_id: document.getElementById('newFeatureProject').value,
                name: document.getElementById('newFeatureName').value,
                description: document.getElementById('newFeatureDescription').value,
                priority: parseInt(document.getElementById('newFeaturePriority').value)
            });

            if (result.success) {
                hideModal('newFeature');
                loadFeatures();
            } else {
                showNotification(result.error || 'Failed to create feature', 'error');
            }
        }

        window.editFeature = async function(featureId) {
            try {
                const features = await api('/features');
                const feature = features.find(f => f.id === featureId);
                if (!feature) {
                    showNotification('Feature not found', 'error');
                    return;
                }

                document.getElementById('editFeatureId').value = feature.id;
                document.getElementById('editFeatureName').value = feature.name || '';
                document.getElementById('editFeatureDescription').value = feature.description || '';
                document.getElementById('editFeatureStatus').value = feature.status || 'pending';
                document.getElementById('editFeaturePriority').value = feature.priority || 0;

                // Track entity viewing for collaboration
                CollaborationManager.viewEntity('feature', featureId);

                // Add typing listeners to form fields
                const fields = ['editFeatureName', 'editFeatureDescription'];
                fields.forEach(fieldId => {
                    const el = document.getElementById(fieldId);
                    if (el) {
                        el.addEventListener('input', () => CollaborationManager.startTyping(fieldId));
                        el.addEventListener('blur', () => CollaborationManager.stopTyping(fieldId));
                    }
                });

                showModal('editFeature');
            } catch (e) {
                showNotification('Error loading feature', 'error');
            }
        };

        async function updateFeature() {
            const featureId = document.getElementById('editFeatureId').value;
            const result = await api(`/features/${featureId}`, 'PUT', {
                name: document.getElementById('editFeatureName').value,
                description: document.getElementById('editFeatureDescription').value,
                status: document.getElementById('editFeatureStatus').value,
                priority: parseInt(document.getElementById('editFeaturePriority').value)
            });

            if (result.success) {
                hideModal('editFeature');
                loadFeatures();
                showNotification('Feature updated successfully', 'success');
            } else {
                showNotification(result.error || 'Failed to update feature', 'error');
            }
        }

        async function createBug() {
            const result = await api('/bugs', 'POST', {
                project_id: document.getElementById('newBugProject').value,
                title: document.getElementById('newBugTitle').value,
                description: document.getElementById('newBugDescription').value,
                severity: document.getElementById('newBugSeverity').value
            });

            if (result.success) {
                hideModal('newBug');
                loadBugs();
            } else {
                showNotification(result.error || 'Failed to create bug', 'error');
            }
        }

        async function updateBug(bugId, status) {
            await api(`/bugs/${bugId}`, 'PUT', { status });
            loadBugs();
        }

        // Start working on a bug - sends to tmux session
        function startWorkingOnBug(bugId) {
            assignToTmux('bug', bugId);
        }

        // Mark bug as complete after verification
        async function markBugComplete(bugId) {
            await updateBug(bugId, 'resolved');
            loadOverviewCriticalItems();
            showNotification('Bug marked as complete', 'success');
        }

        // Store current bug for editing
        let editingBugId = null;

        // Show edit bug modal
        async function showEditBugModal(bugId) {
            editingBugId = bugId;

            // Fetch bug details
            const bug = await api(`/bugs/${bugId}`);
            if (!bug || bug.error) {
                showNotification('Failed to load bug details', 'error');
                return;
            }

            // Populate form fields
            document.getElementById('editBugTitle').value = bug.title || '';
            document.getElementById('editBugDescription').value = bug.description || '';
            document.getElementById('editBugSeverity').value = bug.severity || 'medium';
            document.getElementById('editBugStatus').value = bug.status || 'open';

            // Track entity viewing for collaboration
            CollaborationManager.viewEntity('bug', bugId);

            // Add typing listeners to form fields
            const fields = ['editBugTitle', 'editBugDescription'];
            fields.forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (el) {
                    el.addEventListener('input', () => CollaborationManager.startTyping(fieldId));
                    el.addEventListener('blur', () => CollaborationManager.stopTyping(fieldId));
                }
            });

            showModal('editBug');
        }

        // Save edited bug
        async function saveEditBug() {
            if (!editingBugId) return;

            const result = await api(`/bugs/${editingBugId}`, 'PUT', {
                title: document.getElementById('editBugTitle').value,
                description: document.getElementById('editBugDescription').value,
                severity: document.getElementById('editBugSeverity').value,
                status: document.getElementById('editBugStatus').value
            });

            if (result.success) {
                hideModal('editBug');
                loadBugs();
                showNotification('Bug updated successfully', 'success');
            } else {
                showNotification(result.error || 'Failed to update bug', 'error');
            }
        }

        async function createTmuxSession() {
            const result = await api('/tmux/create', 'POST', {
                name: document.getElementById('newTmuxSessionName').value,
                command: document.getElementById('newTmuxSessionCommand').value
            });

            if (result.success) {
                hideModal('newTmuxSession');
                refreshTmuxSessions();
            } else {
                showNotification(result.error || 'Failed to create session', 'error');
            }
        }

        async function addNode() {
            const result = await api('/nodes', 'POST', {
                hostname: document.getElementById('newNodeHostname').value,
                ip_address: document.getElementById('newNodeIP').value,
                ssh_port: parseInt(document.getElementById('newNodePort').value),
                ssh_user: document.getElementById('newNodeUser').value,
                role: document.getElementById('newNodeRole').value
            });

            if (result.success) {
                hideModal('newNode');
                loadNodes();
            } else {
                showNotification(result.error || 'Failed to add node', 'error');
            }
        }

        async function removeNode(nodeId) {
            const confirmed = await showConfirm('Remove this node from the cluster?', 'Remove Node', 'Remove');
            if (!confirmed) return;

            await api(`/nodes/${nodeId}`, 'DELETE');
            loadNodes();
        }

        async function resolveError(errorId) {
            await api(`/errors/${errorId}/resolve`, 'POST');
            loadErrors();
        }

        async function createBugFromError(errorId) {
            // Get or select a project for the bug
            let projectId = currentProject !== 'all' ? currentProject : null;

            if (!projectId && projects.length > 0) {
                // Use first project as default
                projectId = projects[0].id;
            }

            if (!projectId) {
                showNotification('No project available. Create a project first.', 'error');
                return;
            }

            const result = await api(`/errors/${errorId}/create-bug`, 'POST', {
                project_id: projectId
            });
            if (result.success) {
                showNotification(`Bug #${result.bug_id} created`, 'success');
                loadErrors();
            } else {
                showNotification(result.error || 'Failed to create bug', 'error');
            }
        }

        // Assign to tmux
        async function assignToTmux(entityType, entityId) {
            assignContext = { entityType, entityId };

            // Refresh tmux sessions before showing modal
            await api('/tmux/sessions/refresh', 'POST');
            const sessionsRaw = await api('/tmux/sessions');
            const sessions = deduplicateSessions(Array.isArray(sessionsRaw) ? sessionsRaw : []);

            const selector = document.getElementById('assignTmuxSession');
            if (sessions.length === 0) {
                selector.innerHTML = '<option value="">No tmux sessions available</option>';
                showNotification('No tmux sessions found. Create one first.', 'warning');
            } else {
                selector.innerHTML = sessions.map(s =>
                    `<option value="${s.session_name}">${s.session_name} (${s.node_hostname || 'local'})</option>`
                ).join('');
            }

            showModal('assignTmux');
        }

        async function confirmAssignToTmux() {
            if (!assignContext) return;

            const result = await api('/assign-to-tmux', 'POST', {
                entity_type: assignContext.entityType,
                entity_id: assignContext.entityId,
                session: document.getElementById('assignTmuxSession').value,
                message: document.getElementById('assignTmuxMessage').value
            });

            if (result.success) {
                hideModal('assignTmux');
                loadPanelData(currentPanel);
            } else {
                showNotification(result.error || 'Failed to assign', 'error');
            }
        }

        // Source scanning
        async function scanSources() {
            const result = await api('/scan-sources', 'POST');
            if (result.discovered.length > 0) {
                const names = result.discovered.map(d => d.name).slice(0, 5).join(', ');
                const more = result.discovered.length > 5 ? ` and ${result.discovered.length - 5} more` : '';
                const confirmed = await showConfirm(
                    `Found ${result.discovered.length} projects: ${names}${more}. Import all?`,
                    'Import Projects',
                    'Import All'
                );
                if (confirmed) {
                    for (const project of result.discovered) {
                        await api('/import-project', 'POST', project);
                    }
                    await loadProjects();
                    loadPanelData(currentPanel);
                    showNotification(`Imported ${result.discovered.length} projects`, 'success');
                }
            } else {
                showNotification('No new projects found', 'info');
            }
        }

        // Refresh all - Enhanced with DashboardRefresh module
        async function refreshAll(options = {}) {
            const { silent = false } = options;

            // CRITICAL: Don't refresh if modal is open (prevents navigation issues)
            const modals = document.querySelectorAll('.modal.show, .modal[style*="display: block"]');
            if (modals.length > 0) {
                console.log('[Dashboard] Skipping refresh - modal is open');
                return;
            }

            // Preserve scroll position during refresh
            const scrollY = window.scrollY;
            const scrollX = window.scrollX;
            const activeElement = document.activeElement;

            // Use DashboardRefresh for visual feedback if available
            if (typeof DashboardRefresh !== 'undefined' && !silent) {
                // Show loading indicator
                const indicator = document.getElementById('refreshIndicator');
                if (indicator) indicator.classList.add('active');
            }

            try {
                // Refresh all data sources in parallel for speed
                await Promise.all([
                    loadProjects(),
                    loadStats(),
                    loadEnvironmentsStatus()
                ]);

                // Refresh current panel data
                await loadPanelData(currentPanel);

                // Update UI timestamp
                updateLastRefreshTime();

                // Update Quick Access counts if DataStore is available
                if (typeof DataStore !== 'undefined') {
                    try {
                        await DataStore.refreshAll(true);
                    } catch (e) {
                        console.warn('DataStore refresh error:', e);
                    }
                }

                // Restore scroll position after refresh
                window.scrollTo(scrollX, scrollY);

                // Try to restore focus if it was on a form element
                if (activeElement && activeElement !== document.body) {
                    try {
                        activeElement.focus();
                    } catch (e) {
                        // Element might not be focusable anymore
                    }
                }

                if (!silent) {
                    console.log('[Dashboard] Refresh completed at', new Date().toLocaleTimeString());
                }
            } catch (error) {
                console.error('[Dashboard] Refresh error:', error);
                if (!silent && typeof showNotification === 'function') {
                    showNotification('Refresh failed: ' + error.message, 'error');
                }
            } finally {
                // Hide loading indicator
                if (typeof DashboardRefresh !== 'undefined') {
                    const indicator = document.getElementById('refreshIndicator');
                    if (indicator) {
                        setTimeout(() => indicator.classList.remove('active'), 300);
                    }
                }
            }
        }

        // NOTE: loadEnvironmentsStatus has been moved to the enhanced version above (around line 4115)
        // The old version below is kept for reference but is replaced by the new ENVIRONMENTS-based version.
        async function loadEnvironmentsStatusOld() {
            const environments = [
                { name: 'prod', port: 8080 },
                { name: 'qa', port: 8081 },
                { name: 'dev', port: 8082 },
                { name: 'env1', port: 8083 },
                { name: 'env2', port: 8084 },
                { name: 'env3', port: 8085 },
                { name: 'env4', port: 8086 }
            ];

            for (const env of environments) {
                const statusEl = document.getElementById(`env-${env.name}-status`);
                const cardEl = document.querySelector(`.env-card[data-env="${env.name}"]`);

                if (!statusEl) continue;

                statusEl.textContent = 'Checking...';
                statusEl.style.color = 'var(--text-secondary)';

                try {
                    const response = await fetch(`http://${window.location.hostname}:${env.port}/health`, {
                        method: 'GET',
                        mode: 'cors',
                        signal: AbortSignal.timeout(3000)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        statusEl.innerHTML = `<span style="color: var(--success);"> Healthy</span>`;
                        if (cardEl) cardEl.style.borderLeft = '3px solid var(--success)';
                    } else {
                        statusEl.innerHTML = `<span style="color: var(--error);"> Unhealthy</span>`;
                        if (cardEl) cardEl.style.borderLeft = '3px solid var(--error)';
                    }
                } catch (e) {
                    statusEl.innerHTML = `<span style="color: var(--error);"> Offline</span>`;
                    if (cardEl) cardEl.style.borderLeft = '3px solid var(--error)';
                }
            }
        }

        // =====================
        // Projects List Panel
        // =====================
        let projectViewMode = localStorage.getItem('projectViewMode') || 'compact';

        function setProjectView(mode) {
            projectViewMode = mode;
            localStorage.setItem('projectViewMode', mode);

            // Update button active states
            document.getElementById('viewCompact').classList.toggle('active', mode === 'compact');
            document.getElementById('viewExpanded').classList.toggle('active', mode === 'expanded');

            // Re-render projects list
            loadProjectsList();
        }

        async function loadProjectsList() {
            const status = document.getElementById('projectStatusFilter')?.value || '';
            const search = document.getElementById('projectSearch')?.value || '';

            let endpoint = '/projects';
            if (status) endpoint += `?status=${status}`;

            const projectList = await api(endpoint);
            // Update global projects array for editProject function
            projects = projectList;
            const filtered = search
                ? projectList.filter(p => p.name.toLowerCase().includes(search.toLowerCase()))
                : projectList;

            const container = document.getElementById('projectsListContainer');
            if (!container) return;

            // Update button active states on load
            document.getElementById('viewCompact')?.classList.toggle('active', projectViewMode === 'compact');
            document.getElementById('viewExpanded')?.classList.toggle('active', projectViewMode === 'expanded');

            let html = '';

            // Compact view - simple table
            if (projectViewMode === 'compact') {
                html = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filtered.map(project => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: 500;">${project.name}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${project.description || ''}</div>
                                        </td>
                                        <td><span class="badge badge-${project.status}">${project.status}</span></td>
                                        <td style="color: var(--text-secondary); font-size: 13px;">${formatTime(project.updated_at || project.created_at)}</td>
                                        <td>
                                            <div style="display: flex; gap: 4px;">
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editProject(${project.id})">Edit</button>
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="showProjectMembers(${project.id}, '${project.name.replace(/'/g, "\\'")}')">Members</button>
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="navigateTo('focus', ${project.id})">View</button>
                                                ${project.status !== 'archived' ? `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="quickArchiveProject(${project.id}, '${project.name.replace(/'/g, "\\'")}')">Archive</button>` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No projects found</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // Expanded view - full cards with features and milestones
                // Fetch all features and milestones in parallel for better performance
                const projectData = await Promise.all(filtered.map(async (project) => {
                    const [features, milestones] = await Promise.all([
                        api(`/features?project_id=${project.id}`),
                        api(`/milestones?project_id=${project.id}`)
                    ]);
                    return { project, features, milestones };
                }));

                for (const { project, features, milestones } of projectData) {
                    const portConfig = getProjectPorts(project.name);
                    const envsHtml = portConfig ? portConfig.envs.map(env => `
                        <a href="${env.protocol}://${ENV_HOST}:${env.port}/" target="_blank"
                           class="env-link" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; text-decoration: none; color: var(--text-primary); font-size: 12px; font-family: monospace;">
                            <span class="status-dot" style="width: 6px; height: 6px;"></span>
                            ${env.name}:${env.port}
                        </a>
                    `).join('') : '';
                    const docsLink = portConfig?.docs ? `
                        <a href="${portConfig.envs[0].protocol}://${ENV_HOST}:${portConfig.envs[0].port}${portConfig.docs}" target="_blank"
                           class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                            Docs
                        </a>
                    ` : '';

                    html += `
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header">
                                <div>
                                    <div class="card-title" style="font-size: 20px;">${project.name}</div>
                                    <div class="card-meta">${project.source_path || 'No source path'}</div>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span class="badge badge-${project.status}">${project.status}</span>
                                    <button class="btn btn-secondary" onclick="editProject(${project.id})">Edit</button>
                                    <button class="btn btn-secondary" onclick="showProjectMembers(${project.id}, '${project.name.replace(/'/g, "\\'")}')">Members</button>
                                    ${project.status !== 'archived' ? `<button class="btn btn-secondary" onclick="quickArchiveProject(${project.id}, '${project.name.replace(/'/g, "\\'")}')">Archive</button>` : ''}
                                </div>
                            </div>
                            ${envsHtml ? `
                            <div style="padding: 8px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <span style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">Environments:</span>
                                ${envsHtml}
                                ${docsLink}
                            </div>
                            ` : ''}
                            <div class="card-body">${project.description || 'No description'}</div>

                            <h4 style="margin: 16px 0 8px; color: var(--text-secondary);">Milestones (${milestones.length})</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                                ${milestones.map(m => `
                                    <div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px;">
                                        <div style="font-weight: 500;">${m.name}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            ${m.status} - ${m.progress || 0}%
                                        </div>
                                    </div>
                                `).join('') || '<span style="color: var(--text-secondary);">No milestones</span>'}
                                <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="showModal('newMilestone'); document.getElementById('newMilestoneProject').value='${project.id}'">+ Add</button>
                            </div>

                            <h4 style="margin: 16px 0 8px; color: var(--text-secondary);">Features Review (${features.length})</h4>
                            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Priority</th>
                                            <th>Assigned</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${features.map(f => `
                                            <tr>
                                                <td>
                                                    <div style="font-weight: 500;">${f.name}</div>
                                                    <div style="font-size: 12px; color: var(--text-secondary); max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${f.description || ''}</div>
                                                </td>
                                                <td>
                                                    <select class="filter-select" style="padding: 4px 8px;" onchange="updateFeatureStatus(${f.id}, this.value)">
                                                        <option value="draft" ${f.status === 'draft' ? 'selected' : ''}>Draft</option>
                                                        <option value="in_progress" ${f.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                        <option value="review" ${f.status === 'review' ? 'selected' : ''}>Review</option>
                                                        <option value="completed" ${f.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                    </select>
                                                </td>
                                                <td>${['Normal', 'High', 'Critical'][f.priority] || 'Normal'}</td>
                                                <td>${f.tmux_session || '-'}</td>
                                                <td>
                                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editFeature(${f.id})">Edit</button>
                                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="queueFeature(${f.id})">Queue</button>
                                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewFeatureFiles(${f.id})">Files</button>
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No features</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html || '<p style="color: var(--text-secondary)">No projects found</p>';
        }

        async function updateFeatureStatus(featureId, status) {
            await api(`/features/${featureId}`, 'PUT', { status });
        }

        async function viewFeatureFiles(featureId) {
            const result = await api(`/files/feature/${featureId}`);
            if (result.files && result.files.length > 0) {
                showNotification('Related files: ' + result.files.map(f => f.relative).join(', '), 'info', 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 10s
            } else {
                showNotification('No related files found', 'info');
            }
        }

        // =====================
        // Workers Panel
        // =====================
        async function loadWorkers() {
            const result = await api('/workers/status');

            // Update stats
            document.getElementById('workerTotal').textContent = result.stats?.total || 0;
            document.getElementById('workerActive').textContent = result.stats?.active || 0;
            document.getElementById('workerIdle').textContent = result.stats?.idle || 0;
            document.getElementById('workerOffline').textContent = result.stats?.offline || 0;

            // Update worker type statuses
            const workers = result.system_workers || {};
            for (const [type, info] of Object.entries(workers)) {
                const statusEl = document.getElementById(`${type.replace('_', '')}Status`);
                if (statusEl) {
                    statusEl.className = `badge badge-${info.running ? 'online' : 'offline'}`;
                    statusEl.textContent = info.running ? `Running (${info.pid})` : 'Stopped';
                }
            }

            // Also check specific statuses
            if (workers.task_worker) {
                document.getElementById('taskWorkerStatus').className = `badge badge-${workers.task_worker.running ? 'online' : 'offline'}`;
                document.getElementById('taskWorkerStatus').textContent = workers.task_worker.running ? 'Running' : 'Stopped';
            }
            if (workers.error_daemon) {
                document.getElementById('errorDaemonStatus').className = `badge badge-${workers.error_daemon.running ? 'online' : 'offline'}`;
                document.getElementById('errorDaemonStatus').textContent = workers.error_daemon.running ? 'Running' : 'Stopped';
            }
            if (workers.deploy_worker) {
                document.getElementById('deployWorkerStatus').className = `badge badge-${workers.deploy_worker.running ? 'online' : 'offline'}`;
                document.getElementById('deployWorkerStatus').textContent = workers.deploy_worker.running ? 'Running' : 'Stopped';
            }
            if (workers.confirm_worker) {
                document.getElementById('confirmWorkerStatus').className = `badge badge-${workers.confirm_worker.running ? 'online' : 'offline'}`;
                document.getElementById('confirmWorkerStatus').textContent = workers.confirm_worker.running ? 'Running' : 'Stopped';
            }

            // Registered workers table with pagination
            const registered = result.registered_workers || [];
            paginationState.workers.data = registered;
            paginationState.workers.total = registered.length;
            paginationState.workers.page = 1;
            renderPaginatedTable('workers');
        }

        function renderWorkersTable(workers) {
            const tbody = document.getElementById('workersTable');
            if (!tbody) return;

            tbody.innerHTML = workers.map(w => `
                <tr>
                    <td>${w.id}</td>
                    <td>${w.worker_type}</td>
                    <td>${w.node_hostname || 'local'}</td>
                    <td><span class="badge badge-${w.status === 'active' ? 'online' : 'offline'}">${w.status}</span></td>
                    <td>${w.tasks_completed || 0}</td>
                    <td>${formatTime(w.last_heartbeat)}</td>
                    <td>-</td>
                </tr>
            `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No registered workers</td></tr>';
        }

        async function startWorker(type) {
            const result = await api(`/workers/start/${type}`, 'POST');
            if (result.success) {
                setTimeout(loadWorkers, 1000);
            } else {
                showNotification(result.error || 'Failed to start worker', 'error');
            }
        }

        async function stopWorker(type) {
            const result = await api(`/workers/stop/${type}`, 'POST');
            if (result.success) {
                loadWorkers();
            } else {
                showNotification(result.error || 'Failed to stop worker', 'error');
            }
        }

        // =====================
        // Secure Vault Panel
        // =====================
        let secretsData = [];

        async function loadSecrets() {
            try {
                secretsData = await api('/secrets');

                // Update stats
                document.getElementById('secretTotal').textContent = secretsData.length;
                document.getElementById('secretApiKeys').textContent = secretsData.filter(s => s.category === 'api_key').length;
                document.getElementById('secretPasswords').textContent = secretsData.filter(s => s.category === 'password').length;

                // Check expiring soon (within 30 days)
                const now = new Date();
                const expiringSoon = secretsData.filter(s => {
                    if (!s.expires_at) return false;
                    const expires = new Date(s.expires_at);
                    const daysUntil = (expires - now) / (1000 * 60 * 60 * 24);
                    return daysUntil > 0 && daysUntil <= 30;
                }).length;
                document.getElementById('secretExpiring').textContent = expiringSoon;

                // Populate project dropdowns
                populateSecretProjectDropdowns();

                // Render table
                renderSecretsTable();
            } catch (e) {
                console.error('Failed to load secrets:', e);
                showNotification('Failed to load secrets', 'error');
            }
        }

        function populateSecretProjectDropdowns() {
            const newSelect = document.getElementById('newSecretProject');
            const editSelect = document.getElementById('editSecretProject');

            const options = '<option value="">No specific project</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            if (newSelect) newSelect.innerHTML = options;
            if (editSelect) editSelect.innerHTML = options;
        }

        function renderSecretsTable() {
            const tbody = document.getElementById('secretsTable');
            if (!tbody) return;

            const categoryFilter = document.getElementById('secretCategoryFilter')?.value || '';
            const searchFilter = (document.getElementById('secretSearch')?.value || '').toLowerCase();

            const filtered = secretsData.filter(s => {
                if (categoryFilter && s.category !== categoryFilter) return false;
                if (searchFilter && !s.name.toLowerCase().includes(searchFilter) &&
                    !(s.description || '').toLowerCase().includes(searchFilter)) return false;
                return true;
            });

            const categoryIcons = {
                'api_key': '',
                'password': '',
                'token': '',
                'certificate': '',
                'ssh_key': '',
                'env_var': '',
                'general': ''
            };

            tbody.innerHTML = filtered.map(s => `
                <tr>
                    <td style="font-weight: 500;">${s.name}</td>
                    <td>
                        <span class="badge badge-${s.category === 'api_key' ? 'open' : s.category === 'password' ? 'critical' : 'in_progress'}">
                            ${categoryIcons[s.category] || ''} ${s.category.replace('_', ' ')}
                        </span>
                    </td>
                    <td>${s.project_name || '<span style="color: var(--text-secondary);"></span>'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.description || '<span style="color: var(--text-secondary);"></span>'}</td>
                    <td>${s.last_accessed ? formatTime(s.last_accessed) : '<span style="color: var(--text-secondary);">Never</span>'}</td>
                    <td style="text-align: center;">${s.access_count || 0}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="viewSecret(${s.id})">View</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="editSecret(${s.id})">Edit</button>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteSecret(${s.id})">Delete</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">No secrets stored. Click "+ Add Secret" to create one.</td></tr>';
        }

        function filterSecrets() {
            renderSecretsTable();
        }

        function toggleSecretVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        }

        async function createSecret() {
            const name = document.getElementById('newSecretName').value.trim();
            const value = document.getElementById('newSecretValue').value;
            const category = document.getElementById('newSecretCategory').value;
            const projectId = document.getElementById('newSecretProject').value || null;
            const description = document.getElementById('newSecretDescription').value.trim();
            const expiresAt = document.getElementById('newSecretExpires').value || null;

            if (!name || !value) {
                showNotification('Name and value are required', 'error');
                return;
            }

            try {
                const result = await api('/secrets', 'POST', {
                    name,
                    value,
                    category,
                    project_id: projectId,
                    description,
                    expires_at: expiresAt
                });

                if (result.success) {
                    hideModal('newSecret');
                    showNotification('Secret created successfully', 'success');
                    loadSecrets();
                    // Clear form
                    document.getElementById('newSecretName').value = '';
                    document.getElementById('newSecretValue').value = '';
                    document.getElementById('newSecretDescription').value = '';
                    document.getElementById('newSecretExpires').value = '';
                } else {
                    showNotification(result.error || 'Failed to create secret', 'error');
                }
            } catch (e) {
                showNotification('Failed to create secret', 'error');
            }
        }

        async function viewSecret(id) {
            try {
                const result = await api(`/secrets/${id}`);
                if (result.value !== undefined) {
                    document.getElementById('viewSecretName').textContent = result.name;
                    document.getElementById('viewSecretCategory').textContent = result.category.replace('_', ' ');
                    document.getElementById('viewSecretCategory').className = 'badge badge-open';
                    document.getElementById('viewSecretValue').value = result.value;
                    document.getElementById('viewSecretValue').type = 'password';
                    showModal('viewSecret');
                } else {
                    showNotification(result.error || 'Failed to load secret', 'error');
                }
            } catch (e) {
                showNotification('Failed to load secret', 'error');
            }
        }

        function copySecretValue() {
            const value = document.getElementById('viewSecretValue').value;
            navigator.clipboard.writeText(value).then(() => {
                showNotification('Secret copied to clipboard', 'success');
            }).catch(() => {
                showNotification('Failed to copy secret', 'error');
            });
        }

        function editSecret(id) {
            const secret = secretsData.find(s => s.id === id);
            if (!secret) return;

            document.getElementById('editSecretId').value = id;
            document.getElementById('editSecretName').value = secret.name;
            document.getElementById('editSecretValue').value = '';
            document.getElementById('editSecretCategory').value = secret.category;
            document.getElementById('editSecretProject').value = secret.project_id || '';
            document.getElementById('editSecretDescription').value = secret.description || '';

            showModal('editSecret');
        }

        async function updateSecret() {
            const id = document.getElementById('editSecretId').value;
            const data = {
                name: document.getElementById('editSecretName').value.trim(),
                category: document.getElementById('editSecretCategory').value,
                project_id: document.getElementById('editSecretProject').value || null,
                description: document.getElementById('editSecretDescription').value.trim()
            };

            const newValue = document.getElementById('editSecretValue').value;
            if (newValue) {
                data.value = newValue;
            }

            try {
                const result = await api(`/secrets/${id}`, 'PUT', data);
                if (result.success) {
                    hideModal('editSecret');
                    showNotification('Secret updated successfully', 'success');
                    loadSecrets();
                } else {
                    showNotification(result.error || 'Failed to update secret', 'error');
                }
            } catch (e) {
                showNotification('Failed to update secret', 'error');
            }
        }

        async function deleteSecret(id) {
            const secret = secretsData.find(s => s.id === id);
            if (!confirm(`Are you sure you want to delete the secret "${secret?.name}"?`)) return;

            try {
                const result = await api(`/secrets/${id}`, 'DELETE');
                if (result.success) {
                    showNotification('Secret deleted', 'success');
                    loadSecrets();
                } else {
                    showNotification(result.error || 'Failed to delete secret', 'error');
                }
            } catch (e) {
                showNotification('Failed to delete secret', 'error');
            }
        }

        // =====================
        // Project Focus Panel
        // =====================
        let focusedProjectId = null;
        let focusedProjectData = null;
        let focusedFeatures = [];
        let allProjects = [];
        let recentProjects = JSON.parse(localStorage.getItem('recentProjects') || '[]');

        async function initFocusPanel(projectId = null, subtype = null, subid = null) {
            // Load all projects
            allProjects = await api('/projects');

            // Sort by updated_at or created_at descending
            allProjects.sort((a, b) => {
                const aDate = new Date(a.updated_at || a.created_at || 0);
                const bDate = new Date(b.updated_at || b.created_at || 0);
                return bDate - aDate;
            });

            // If project ID passed from URL, load it
            if (projectId) {
                await loadProjectFocus(projectId, subtype, subid);
            }

            // Populate tmux sessions
            await populateFocusTmuxSessions();

            // Setup click outside to hide list
            document.addEventListener('click', (e) => {
                const list = document.getElementById('focusProjectList');
                const search = document.getElementById('focusProjectSearch');
                if (list && !list.contains(e.target) && e.target !== search) {
                    list.style.display = 'none';
                }
            });
        }

        function showProjectList() {
            const list = document.getElementById('focusProjectList');
            if (list) {
                filterFocusProjects();
                list.style.display = 'block';
            }
        }

        function toggleProjectDropdown() {
            const list = document.getElementById('focusProjectList');
            if (list) {
                if (list.style.display === 'none' || !list.style.display) {
                    filterFocusProjects();
                    list.style.display = 'block';
                } else {
                    list.style.display = 'none';
                }
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const list = document.getElementById('focusProjectList');
            const search = document.getElementById('focusProjectSearch');
            const dropBtn = e.target.closest('button');
            if (list && list.style.display === 'block') {
                if (!list.contains(e.target) && e.target !== search && (!dropBtn || !dropBtn.textContent.includes(''))) {
                    list.style.display = 'none';
                }
            }
        });

        function filterFocusProjects() {
            const search = document.getElementById('focusProjectSearch').value.toLowerCase();
            const list = document.getElementById('focusProjectList');
            if (!list) return;

            // Get recent projects that match
            const recentMatches = recentProjects
                .map(id => allProjects.find(p => p.id == id))
                .filter(p => p && p.name.toLowerCase().includes(search))
                .slice(0, 3);

            // Get other projects that match
            const otherMatches = allProjects
                .filter(p => p.name.toLowerCase().includes(search))
                .filter(p => !recentProjects.includes(p.id))
                .slice(0, 10);

            let html = '';

            if (recentMatches.length > 0) {
                html += '<div style="padding: 6px 12px; font-size: 11px; color: var(--text-secondary); background: var(--bg-tertiary);">Recent</div>';
                html += recentMatches.map(p => `
                    <div class="project-list-item" onclick="selectFocusProject(${p.id})"
                        style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border);"
                        onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <div style="font-weight: 500;">${p.name}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${p.source_path || 'No path'}</div>
                    </div>
                `).join('');
            }

            if (otherMatches.length > 0) {
                html += '<div style="padding: 6px 12px; font-size: 11px; color: var(--text-secondary); background: var(--bg-tertiary);">All Projects</div>';
                html += otherMatches.map(p => `
                    <div class="project-list-item" onclick="selectFocusProject(${p.id})"
                        style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border);"
                        onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                        <div style="font-weight: 500;">${p.name}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${p.source_path || 'No path'}</div>
                    </div>
                `).join('');
            }

            if (!html) {
                html = '<div style="padding: 12px; color: var(--text-secondary); text-align: center;">No projects found</div>';
            }

            list.innerHTML = html;
        }

        function selectFocusProject(projectId) {
            // Add to recent projects
            recentProjects = recentProjects.filter(id => id != projectId);
            recentProjects.unshift(projectId);
            recentProjects = recentProjects.slice(0, 10);
            localStorage.setItem('recentProjects', JSON.stringify(recentProjects));

            // Hide list and load project
            document.getElementById('focusProjectList').style.display = 'none';
            document.getElementById('focusProjectSearch').value = '';
            loadProjectFocus(projectId);
        }

        function copyFocusLink(event) {
            event.preventDefault();
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied!', 'success');
            });
        }

        async function populateFocusTmuxSessions() {
            const sessionsRaw = await api('/tmux/sessions');
            const sessions = deduplicateSessions(Array.isArray(sessionsRaw) ? sessionsRaw : []);
            const select = document.getElementById('focusAssignSession');
            if (select) {
                // Filter to Claude/arch sessions and sort by name
                const claudeSessions = sessions.filter(s =>
                    s.session_name && (
                        s.session_name.toLowerCase().includes('claude') ||
                        s.session_name.toLowerCase().includes('arch') ||
                        s.session_name.toLowerCase().includes('env')
                    )
                ).sort((a, b) => a.session_name.localeCompare(b.session_name));

                // All other sessions
                const otherSessions = sessions.filter(s =>
                    s.session_name && !claudeSessions.find(c => c.session_name === s.session_name)
                );

                let options = '<option value="">-- Select Session --</option>';

                if (claudeSessions.length > 0) {
                    options += '<optgroup label="Claude Sessions">' +
                        claudeSessions.map(s => `<option value="${s.session_name}">${s.session_name} ${s.attached ? '(attached)' : ''}</option>`).join('') +
                        '</optgroup>';
                }

                if (otherSessions.length > 0) {
                    options += '<optgroup label="Other Sessions">' +
                        otherSessions.map(s => `<option value="${s.session_name}">${s.session_name} ${s.attached ? '(attached)' : ''}</option>`).join('') +
                        '</optgroup>';
                }

                select.innerHTML = options;

                // Auto-select arch_env3 if available
                const env3Session = claudeSessions.find(s => s.session_name === 'arch_env3');
                if (env3Session) {
                    select.value = 'arch_env3';
                } else if (claudeSessions.length > 0) {
                    select.value = claudeSessions[0].session_name;
                }
            }
        }

        async function loadProjectFocus(projectId, subtype = null, subid = null) {
            if (!projectId) {
                document.getElementById('focusContent').style.display = 'none';
                document.getElementById('focusEmpty').style.display = 'block';
                focusedProjectId = null;
                updateUrlState();
                return;
            }

            focusedProjectId = projectId;

            // Update URL to reflect current project
            updateUrlState(projectId, subtype, subid);

            try {
                // Load project details
                const projects = await api('/projects');
                focusedProjectData = projects.find(p => p.id == projectId);

                if (!focusedProjectData) {
                    showNotification('Project not found', 'error');
                    return;
                }

                // Update UI
                document.getElementById('focusProjectName').textContent = focusedProjectData.name;
                document.getElementById('focusModalProjectName').textContent = focusedProjectData.name;
                document.getElementById('focusProjectStatus').textContent = focusedProjectData.status || 'active';
                document.getElementById('focusProjectStatus').className = `badge badge-${focusedProjectData.status || 'active'}`;
                document.getElementById('focusProjectPath').textContent = focusedProjectData.source_path || 'Not set';
                document.getElementById('focusProjectTech').textContent = focusedProjectData.tech_stack || 'Not specified';

                // Load features (pass subid for highlighting)
                await loadFocusFeatures(subtype === 'feature' ? subid : null);

                // Load related data
                await loadFocusRelatedData();

                // Show content
                document.getElementById('focusContent').style.display = 'block';
                document.getElementById('focusEmpty').style.display = 'none';

            } catch (e) {
                showNotification('Failed to load project: ' + e.message, 'error');
            }
        }

        async function loadFocusFeatures(highlightFeatureId = null) {
            const filter = document.getElementById('focusFeatureFilter')?.value || '';
            let endpoint = `/features?project_id=${focusedProjectId}`;
            if (filter) endpoint += `&status=${filter}`;

            focusedFeatures = await api(endpoint);

            // Update stats
            document.getElementById('focusTotalFeatures').textContent = focusedFeatures.length;
            document.getElementById('focusInProgress').textContent = focusedFeatures.filter(f => f.status === 'in_progress').length;
            document.getElementById('focusCompleted').textContent = focusedFeatures.filter(f => f.status === 'completed').length;

            // Render table with deep links and inline editing
            const tbody = document.getElementById('focusFeaturesTable');
            tbody.innerHTML = focusedFeatures.map(f => {
                const isHighlighted = highlightFeatureId && f.id == highlightFeatureId;
                const highlightStyle = isHighlighted ? 'background: rgba(88, 166, 255, 0.15); border-left: 3px solid var(--accent);' : '';
                return `
                <tr id="feature-row-${f.id}" style="${highlightStyle}" onclick="selectFocusFeature(${f.id})" class="feature-row">
                    <td>
                        <div style="font-weight: 500;" class="inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="name" data-edit-type="text" title="Click to edit name" onclick="event.stopPropagation()">${f.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" class="inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="description" data-edit-type="textarea" title="Click to edit description" onclick="event.stopPropagation()">${(f.description || 'No description').substring(0, 60)}${f.description?.length > 60 ? '...' : ''}</div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                            <a href="#focus/${focusedProjectId}/feature/${f.id}" style="color: var(--accent);" onclick="event.stopPropagation();">Link</a>
                        </div>
                    </td>
                    <td><span class="badge badge-${f.status} inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="status" data-edit-type="select" title="Click to change status" onclick="event.stopPropagation()">${f.status}</span></td>
                    <td><span class="badge badge-${f.priority || 'medium'} inline-editable" data-entity-id="${f.id}" data-entity-type="feature" data-field="priority" data-edit-type="select" title="Click to change priority" onclick="event.stopPropagation()">${f.priority || 'medium'}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); updateFeatureStatus(${f.id}, 'in_progress')">Start</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); updateFeatureStatus(${f.id}, 'completed')">Done</button>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No features</td></tr>';

            // Update feature select for assignment
            const featureSelect = document.getElementById('focusAssignFeature');
            if (featureSelect) {
                featureSelect.innerHTML = '<option value="">-- Select Feature --</option>' +
                    focusedFeatures.filter(f => f.status !== 'completed').map(f =>
                        `<option value="${f.id}">${f.name}</option>`
                    ).join('');
            }

            // Scroll to highlighted feature
            if (highlightFeatureId) {
                const row = document.getElementById(`feature-row-${highlightFeatureId}`);
                if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function selectFocusFeature(featureId) {
            // Update URL to include feature
            updateUrlState(focusedProjectId, 'feature', featureId);

            // Highlight the selected row
            document.querySelectorAll('.feature-row').forEach(r => {
                r.style.background = '';
                r.style.borderLeft = '';
            });
            const row = document.getElementById(`feature-row-${featureId}`);
            if (row) {
                row.style.background = 'rgba(88, 166, 255, 0.15)';
                row.style.borderLeft = '3px solid var(--accent)';
            }

            // Pre-select in assignment dropdown
            const select = document.getElementById('focusAssignFeature');
            if (select) select.value = featureId;
        }

        function filterFocusFeatures() {
            loadFocusFeatures();
        }

        async function loadFocusServerStatus() {
            // Check dashboard status
            const dashEl = document.getElementById('focusDashboardStatus');
            if (dashEl) {
                try {
                    const health = await fetch('/health').then(r => r.json());
                    dashEl.innerHTML = `<span style="color: var(--success);">Online</span>`;
                } catch (e) {
                    dashEl.innerHTML = `<span style="color: var(--error);">Offline</span>`;
                }
            }

            // Check project server if source_path indicates a web project
            const projEl = document.getElementById('focusProjectServerStatus');
            if (projEl && focusedProjectData) {
                const path = focusedProjectData.source_path || '';
                // Check common ports based on project name
                if (path.includes('basic_edu_apps') || path.includes('edu_apps')) {
                    try {
                        const response = await fetch('http://' + window.location.hostname + ':5063/health', {
                            mode: 'cors',
                            signal: AbortSignal.timeout(2000)
                        });
                        if (response.ok) {
                            projEl.innerHTML = `<span style="color: var(--success);">:5063</span>`;
                        } else {
                            projEl.innerHTML = `<span style="color: var(--error);">:5063 Down</span>`;
                        }
                    } catch (e) {
                        projEl.innerHTML = `<span style="color: var(--error);">:5063 Down</span>`;
                    }
                } else {
                    projEl.innerHTML = `<span style="color: var(--text-secondary);">N/A</span>`;
                }
            }

            // Load workers status
            const workersEl = document.getElementById('focusWorkersStatus');
            if (workersEl) {
                try {
                    const workers = await api('/workers');
                    const running = workers.filter(w => w.status === 'running');
                    workersEl.innerHTML = running.length ?
                        running.map(w => `<span style="padding: 4px 8px; background: rgba(63, 185, 80, 0.2); border-radius: 4px; font-size: 11px; color: var(--success);">${w.worker_type}</span>`).join('') :
                        '<span style="padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">No workers running</span>';
                } catch (e) {
                    workersEl.innerHTML = '<span style="color: var(--error);">Error</span>';
                }
            }
        }

        async function sendQuickCommand(command) {
            const sessionName = document.getElementById('focusAssignSession').value;
            if (!sessionName) {
                showNotification('Select a session first', 'error');
                return;
            }

            try {
                await api('/tmux/send', 'POST', {
                    session: sessionName,
                    command: command
                });
                showNotification(`Sent: ${command}`, 'success');
                setTimeout(captureFocusSession, 1000);
            } catch (e) {
                showNotification('Failed to send command', 'error');
            }
        }

        async function captureFocusSession() {
            const sessionName = document.getElementById('focusAssignSession').value;
            const outputEl = document.getElementById('focusSessionOutput');

            if (!sessionName) {
                outputEl.textContent = 'Select a session first';
                return;
            }

            try {
                const result = await api('/tmux/capture', 'POST', { session: sessionName });
                outputEl.textContent = result.output || 'No output';
                outputEl.scrollTop = outputEl.scrollHeight;
            } catch (e) {
                outputEl.textContent = 'Failed to capture: ' + e.message;
            }
        }

        async function loadFocusRelatedData() {
            // Load bugs
            const bugs = await api(`/bugs?project_id=${focusedProjectId}&status=open`);
            document.getElementById('focusBugs').textContent = bugs.length;

            // Load errors (related to project path)
            const allErrors = await api('/errors');
            const projectErrors = allErrors.filter(e =>
                e.source?.includes(focusedProjectData.source_path?.split('/').pop()) ||
                e.project_id == focusedProjectId
            ).slice(0, 5);
            document.getElementById('focusErrors').textContent = projectErrors.length;

            document.getElementById('focusErrorsList').innerHTML = projectErrors.length ?
                projectErrors.map(e => `
                    <div style="padding: 8px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                        <div style="font-size: 12px; color: var(--error);">${e.error_type}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${e.message?.substring(0, 80)}</div>
                    </div>
                `).join('') :
                '<p style="color: var(--text-secondary); text-align: center;">No errors</p>';

            // Load activity
            const activity = await api('/stats');
            const recentActivity = activity.recent_activity?.filter(a =>
                a.entity_type === 'feature' || a.entity_type === 'bug'
            ).slice(0, 5) || [];

            document.getElementById('focusActivityList').innerHTML = recentActivity.length ?
                recentActivity.map(a => `
                    <div class="activity-item">
                        <span class="activity-action">${a.action}</span>
                        <span class="activity-entity">${a.entity_type}</span>
                        <span class="activity-time">${formatTime(a.timestamp)}</span>
                    </div>
                `).join('') :
                '<p style="color: var(--text-secondary); text-align: center;">No recent activity</p>';

            // Load feedback/notes
            await loadFocusFeedback();

            // Load server status
            await loadFocusServerStatus();
        }

        async function loadFocusFeedback() {
            // Get activity log entries that are notes for this project
            try {
                const activity = await api(`/activity?project_id=${focusedProjectId}&action=note`);
                const feedback = activity.filter(a => a.action === 'note' || a.action === 'feedback');

                document.getElementById('focusFeedbackList').innerHTML = feedback.length ?
                    feedback.map(f => `
                        <div style="padding: 10px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--accent);">
                            <div style="font-size: 13px;">${f.details || f.description || 'No content'}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${formatTime(f.timestamp)}</div>
                        </div>
                    `).join('') :
                    '<p style="color: var(--text-secondary); text-align: center;">No feedback yet</p>';
            } catch (e) {
                // Activity endpoint might not exist
                document.getElementById('focusFeedbackList').innerHTML =
                    '<p style="color: var(--text-secondary); text-align: center;">No feedback yet</p>';
            }
        }

        async function submitFocusFeedback() {
            const input = document.getElementById('focusFeedbackInput');
            const text = input.value.trim();
            if (!text || !focusedProjectId) return;

            try {
                await api('/activity', 'POST', {
                    action: 'note',
                    entity_type: 'project',
                    entity_id: focusedProjectId,
                    details: text
                });
                input.value = '';
                showNotification('Note added', 'success');
                await loadFocusFeedback();
            } catch (e) {
                showNotification('Failed to add note: ' + e.message, 'error');
            }
        }

        function addFocusFeedback() {
            document.getElementById('focusFeedbackInput').focus();
        }

        async function createFocusFeature() {
            const name = document.getElementById('focusNewFeatureName').value.trim();
            const description = document.getElementById('focusNewFeatureDescription').value.trim();
            const priority = document.getElementById('focusNewFeaturePriority').value;
            const status = document.getElementById('focusNewFeatureStatus').value;

            if (!name) {
                showNotification('Feature name is required', 'error');
                return;
            }

            try {
                await api('/features', 'POST', {
                    project_id: focusedProjectId,
                    name,
                    description,
                    priority,
                    status
                });
                hideModal('focusNewFeature');
                showNotification('Feature created', 'success');
                document.getElementById('focusNewFeatureName').value = '';
                document.getElementById('focusNewFeatureDescription').value = '';
                await loadFocusFeatures();
            } catch (e) {
                showNotification('Failed to create feature: ' + e.message, 'error');
            }
        }

        async function updateFeatureStatus(featureId, status) {
            try {
                await api(`/features/${featureId}`, 'PUT', { status });
                showNotification(`Feature marked as ${status}`, 'success');
                await loadFocusFeatures();
            } catch (e) {
                showNotification('Failed to update feature', 'error');
            }
        }

        async function queueFeature(featureIdParam) {
            const featureId = featureIdParam || document.getElementById('focusAssignFeature')?.value;
            if (!featureId) {
                showNotification('Select a feature first', 'error');
                return;
            }

            const result = await api('/assign-to-tmux', 'POST', {
                entity_type: 'feature',
                entity_id: parseInt(featureId),
                use_queue: true
            });

            if (result.success) {
                showNotification(`Feature added to queue (Task #${result.task_id})`, 'success');
                // Refresh lists
                if (typeof loadFocusProjectData === 'function' && focusedProjectId) {
                    loadFocusProjectData(focusedProjectId);
                }
                if (typeof loadFeatures === 'function') {
                    loadFeatures();
                }
            } else {
                showNotification(result.error || 'Failed to queue feature', 'error');
            }
        }

        async function assignFeatureToSession() {
            const featureId = document.getElementById('focusAssignFeature').value;
            const sessionName = document.getElementById('focusAssignSession').value;

            if (!featureId || !sessionName) {
                showNotification('Select both a feature and a session', 'error');
                return;
            }

            const feature = focusedFeatures.find(f => f.id == featureId);
            if (!feature) return;

            const dashboardUrl = window.location.origin;
            const message = `Implement this feature and complete the full workflow:

FEATURE ID: ${feature.id}
Feature: ${feature.name}
Description: ${feature.description || 'No description provided'}
Project: ${focusedProjectData.name}
Path: ${focusedProjectData.source_path || 'N/A'}

WORKFLOW - Complete ALL steps:
1. Implement the feature in the codebase
2. Add tests for the new functionality
3. Run tests to verify everything works
4. Commit with a descriptive message
5. Restart/deploy the server
6. Mark feature as completed by running:
   curl -X PUT "${dashboardUrl}/api/features/${feature.id}" -H "Content-Type: application/json" -H "Cookie: $(cat /tmp/arch_cookies.txt | grep session | cut -f7)" -d '{"status": "completed"}'

Start by analyzing what needs to be implemented.`;

            try {
                await api('/tmux/send', 'POST', {
                    session: sessionName,
                    message: message
                });
                showNotification(`Feature sent to ${sessionName}`, 'success');

                // Mark feature as in progress
                await updateFeatureStatus(featureId, 'in_progress');
            } catch (e) {
                showNotification('Failed to send to session: ' + e.message, 'error');
            }
        }

        // =====================
        // Accounts Panel
        // =====================
        async function loadAccounts() {
            const accountsResp = await api('/accounts');
            const accounts = Array.isArray(accountsResp) ? accountsResp : [];
            const aggregate = await api('/accounts/aggregate') || {};

            // Update stats
            const accountTotal = document.getElementById('accountTotal');
            const accountOnline = document.getElementById('accountOnline');
            const accountSessions = document.getElementById('accountSessions');

            if (accountTotal) accountTotal.textContent = accounts.length;
            if (accountOnline) accountOnline.textContent = accounts.filter(a => a.status === 'online').length;
            if (accountSessions) accountSessions.textContent = accounts.reduce((sum, a) => sum + (a.sessions || 0), 0);

            // Cross-node summaries
            const crossNodeErrors = document.getElementById('crossNodeErrors');
            const crossNodeFeatures = document.getElementById('crossNodeFeatures');
            const crossNodeSessions = document.getElementById('crossNodeSessions');

            if (crossNodeErrors) {
                crossNodeErrors.innerHTML = Array.isArray(aggregate.errors_by_node)
                    ? aggregate.errors_by_node.map(e => `<div>${e.hostname || 'Unknown'}: ${e.error_count || 0} errors</div>`).join('')
                    : 'No data';
            }

            if (crossNodeFeatures) {
                crossNodeFeatures.innerHTML = Array.isArray(aggregate.features_by_node)
                    ? aggregate.features_by_node.map(f => `<div>${f.node || 'Unassigned'}: ${f.count} ${f.status}</div>`).join('')
                    : 'No data';
            }

            if (crossNodeSessions) {
                crossNodeSessions.innerHTML = Array.isArray(aggregate.sessions_by_node)
                    ? aggregate.sessions_by_node.map(s => `<div>${s.hostname || 'Unknown'}: ${s.session_count || 0} sessions (${s.attached_count || 0} attached)</div>`).join('')
                    : 'No data';
            }

            // Accounts grid
            const grid = document.getElementById('accountsGrid');
            if (grid) {
                grid.innerHTML = accounts.map(a => `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${a.user || 'local'}@${a.hostname || 'unknown'}</div>
                                <div class="card-meta">${a.ip || 'N/A'}</div>
                            </div>
                            <span class="badge badge-${a.status || 'offline'}">${a.status || 'unknown'}</span>
                        </div>
                        <div class="card-body">
                            <p>Sessions: ${a.sessions || 0}</p>
                            <p>Workers: ${a.workers || 0}</p>
                            <p>Last seen: ${a.last_heartbeat ? formatTime(a.last_heartbeat) : 'Never'}</p>
                        </div>
                    </div>
                `).join('') || '<p style="color: var(--text-secondary)">No accounts registered</p>';
            }
        }

        // =====================
        // Testing Functions
        // =====================

        // Test category selection state
        let testCategoryState = { ui: true, api: true, db: true, auth: true, a11y: true };
        let allTestRuns = [];

        // Initialize test category card styles
        function initTestCategories() {
            Object.keys(testCategoryState).forEach(cat => {
                updateTestCategoryUI(cat);
            });
        }

        function toggleTestCategory(category) {
            testCategoryState[category] = !testCategoryState[category];
            updateTestCategoryUI(category);
        }

        function updateTestCategoryUI(category) {
            const card = document.getElementById(`testCat-${category}`);
            const checkbox = document.getElementById(`testCheck-${category}`);
            if (card && checkbox) {
                checkbox.checked = testCategoryState[category];
                card.style.borderColor = testCategoryState[category] ? 'var(--accent)' : 'transparent';
                card.style.opacity = testCategoryState[category] ? '1' : '0.5';
            }
        }

        function getSelectedTestCategories() {
            return Object.entries(testCategoryState)
                .filter(([_, selected]) => selected)
                .map(([cat, _]) => cat);
        }

        async function runSelectedTests() {
            const categories = getSelectedTestCategories();
            if (categories.length === 0) {
                showNotification('Please select at least one test category', 'warning');
                return;
            }
            await runTestsWithCategories(categories);
        }

        async function runAllTests() {
            await runTestsWithCategories(['ui', 'api', 'db', 'auth', 'a11y']);
        }

        async function runTestsWithCategories(categories) {
            try {
                showNotification(`Running ${categories.join(', ')} tests...`, 'info');

                // Show progress container
                document.getElementById('testProgressContainer').style.display = 'block';
                document.getElementById('testResultsSummary').style.display = 'none';

                const startTime = Date.now();
                let progressInterval = setInterval(() => {
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    document.getElementById('testProgressTime').textContent = `${elapsed}s elapsed`;
                }, 1000);

                const result = await api('/tests/run', 'POST', { categories });

                clearInterval(progressInterval);

                if (result.run_id) {
                    showNotification(`Test run ${result.run_id} started`, 'success');
                    pollTestProgress(result.run_id);
                }
            } catch (e) {
                document.getElementById('testProgressContainer').style.display = 'none';
                showNotification('Failed to start tests: ' + e.message, 'error');
            }
        }

        async function pollTestProgress(runId) {
            let attempts = 0;
            const maxAttempts = 60; // 5 minutes max

            const poll = async () => {
                try {
                    const run = await api(`/tests/runs/${runId}`);
                    if (run.run) {
                        const r = run.run;
                        const total = (r.passed || 0) + (r.failed || 0) + (r.skipped || 0);
                        const pct = r.total_tests ? Math.round((total / r.total_tests) * 100) : 0;

                        document.getElementById('testProgressBar').style.width = `${pct}%`;
                        document.getElementById('testProgressCount').textContent = `${total} / ${r.total_tests || '?'} tests`;

                        if (r.status === 'passed' || r.status === 'failed' || r.status === 'completed') {
                            document.getElementById('testProgressContainer').style.display = 'none';
                            showTestResults(r);
                            loadTestRuns();
                            return;
                        }
                    }

                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    } else {
                        document.getElementById('testProgressContainer').style.display = 'none';
                        loadTestRuns();
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                    setTimeout(poll, 5000);
                }
            };

            setTimeout(poll, 2000);
        }

        function showTestResults(run) {
            document.getElementById('testResultsSummary').style.display = 'block';

            document.getElementById('testResultPassed').textContent = run.passed || 0;
            document.getElementById('testResultFailed').textContent = run.failed || 0;
            document.getElementById('testResultSkipped').textContent = run.skipped || 0;
            document.getElementById('testResultTotal').textContent = run.total_tests || ((run.passed || 0) + (run.failed || 0));
            document.getElementById('testResultCoverage').textContent = `${run.coverage || 0}%`;

            const statusEl = document.getElementById('testResultStatus');
            statusEl.textContent = run.status;
            statusEl.className = `badge badge-${run.status === 'passed' ? 'online' : 'critical'}`;

            document.getElementById('testResultDuration').textContent = run.duration_seconds ?
                `${run.duration_seconds.toFixed(1)}s` : '-';
        }

        function filterTestRuns() {
            const categoryFilter = document.getElementById('testCategoryFilter');
            const statusFilter = document.getElementById('testStatusFilter');
            const category = categoryFilter?.value || 'all';
            const status = statusFilter?.value || 'all';

            let filtered = Array.isArray(allTestRuns) ? allTestRuns : [];
            if (category !== 'all') {
                filtered = filtered.filter(r => r.category === category);
            }
            if (status !== 'all') {
                filtered = filtered.filter(r => r.status === status);
            }

            // Update pagination state
            paginationState.testRuns.data = filtered;
            paginationState.testRuns.total = filtered.length;
            paginationState.testRuns.page = 1;
            renderPaginatedTable('testRuns');
        }

        function renderTestRunsTablePaginated(runs) {
            renderTestRunsTable(runs);
        }

        function copyTestOutput() {
            const outputEl = document.getElementById('testOutput');
            const output = outputEl?.textContent || '';
            navigator.clipboard.writeText(output).then(() => {
                showNotification('Test output copied to clipboard', 'success');
            });
        }

        async function loadTestRuns() {
            try {
                const response = await api('/tests/runs');
                const runs = Array.isArray(response) ? response : [];
                allTestRuns = runs;

                // Update stats with null checks
                const testTotalRuns = document.getElementById('testTotalRuns');
                const testPassRate = document.getElementById('testPassRate');
                const testTotalPassed = document.getElementById('testTotalPassed');
                const testTotalFailed = document.getElementById('testTotalFailed');
                const testAvgDuration = document.getElementById('testAvgDuration');
                const testLastRun = document.getElementById('testLastRun');

                if (testTotalRuns) testTotalRuns.textContent = runs.length;

                if (runs.length > 0) {
                    const passedRuns = runs.filter(r => r.status === 'passed').length;
                    const passRate = Math.round((passedRuns / runs.length) * 100);
                    if (testPassRate) {
                        testPassRate.textContent = `${passRate}%`;
                        testPassRate.style.color = passRate >= 80 ? 'var(--success)' : passRate >= 50 ? 'var(--warning)' : 'var(--danger)';
                    }

                    // Calculate totals
                    const totalPassed = runs.reduce((sum, r) => sum + (r.passed || 0), 0);
                    const totalFailed = runs.reduce((sum, r) => sum + (r.failed || 0), 0);
                    if (testTotalPassed) testTotalPassed.textContent = totalPassed;
                    if (testTotalFailed) testTotalFailed.textContent = totalFailed;

                    // Average duration
                    const durations = runs.filter(r => r.duration_seconds).map(r => r.duration_seconds);
                    const avgDuration = durations.length > 0 ? (durations.reduce((a, b) => a + b) / durations.length).toFixed(1) : '-';
                    if (testAvgDuration) testAvgDuration.textContent = avgDuration !== '-' ? `${avgDuration}s` : '-';

                    const lastRun = runs[0];
                    if (testLastRun) testLastRun.textContent = formatTime(lastRun.started_at);

                    // Update coverage per category
                    const categories = ['ui', 'api', 'db', 'auth', 'a11y'];
                    categories.forEach(cat => {
                        const catRuns = runs.filter(r => r.category === cat);
                        if (catRuns.length > 0) {
                            const lastCatRun = catRuns[0];
                            const coverageEl = document.getElementById(`testCoverage-${cat}`);
                            if (coverageEl) {
                                coverageEl.textContent = `${lastCatRun.coverage || 0}%`;
                            }
                        }
                    });
                }

                // Update pagination state and render
                paginationState.testRuns.data = runs;
                paginationState.testRuns.total = runs.length;
                paginationState.testRuns.page = 1;
                renderPaginatedTable('testRuns');
            } catch (e) {
                console.error('Failed to load test runs:', e);
            }
        }

        function renderTestRunsTable(runs) {
            const tbody = document.getElementById('testRunsTable');
            if (!tbody) return;

            const runsArray = Array.isArray(runs) ? runs : [];
            tbody.innerHTML = runsArray.map(run => `
                <tr>
                    <td><code>${run.run_id}</code></td>
                    <td><span class="badge" style="background: var(--bg-tertiary);">${run.category || 'all'}</span></td>
                    <td>${run.environment || '-'}</td>
                    <td><span class="badge badge-${run.status === 'passed' ? 'online' : run.status === 'running' ? 'warning' : 'critical'}">${run.status}</span></td>
                    <td style="color: var(--success)">${run.passed || 0}</td>
                    <td style="color: var(--danger)">${run.failed || 0}</td>
                    <td>${run.coverage ? run.coverage + '%' : '-'}</td>
                    <td>${run.duration_seconds ? run.duration_seconds.toFixed(1) + 's' : '-'}</td>
                    <td>${formatTime(run.started_at)}</td>
                    <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="viewTestRun('${run.run_id}')">View</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary)">No test runs yet</td></tr>';
        }

        // Legacy runTests function - now calls runAllTests
        async function runTests() {
            await runAllTests();
        }

        async function viewTestRun(runId) {
            try {
                const data = await api(`/tests/runs/${runId}`);
                const container = document.getElementById('testOutputContainer');
                const output = document.getElementById('testOutput');

                container.style.display = 'block';
                output.textContent = data.run?.output || 'No output available';
            } catch (e) {
                showNotification('Failed to load test run: ' + e.message, 'error');
            }
        }

        // =====================
        // Deployments Functions
        // =====================

        function renderDeploymentsTable(deployments) {
            const tbody = document.getElementById('deploymentsTable');
            if (!tbody) return;

            tbody.innerHTML = deployments.map(d => `
                <tr>
                    <td><code>${d.deployment_id}</code></td>
                    <td>${d.tag || 'HEAD'}</td>
                    <td><span class="badge badge-${d.target_environment === 'prod' ? 'critical' : d.target_environment === 'qa' ? 'warning' : 'online'}">${d.target_environment}</span></td>
                    <td><span class="badge badge-${d.status === 'completed' ? 'online' : d.status === 'failed' ? 'critical' : 'warning'}">${d.status}</span></td>
                    <td>${d.tests_passed ? 'Passed' : d.tests_required ? 'Required' : 'N/A'}</td>
                    <td>${d.deployed_by || '-'}</td>
                    <td>${formatTime(d.started_at)}</td>
                    <td>
                        ${d.status === 'pending' ? `<button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="executeDeployment('${d.deployment_id}')">Deploy</button>` : ''}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary)">No deployments yet</td></tr>';
        }

        async function loadDeployments() {
            try {
                const env = document.getElementById('deployEnvFilter')?.value || '';
                const response = await api('/deployments' + (env ? `?environment=${env}` : ''));

                // Handle error response or non-array response
                const deployments = Array.isArray(response) ? response : [];

                // Update stats
                document.getElementById('deployTotal').textContent = deployments.length;
                document.getElementById('deploySuccess').textContent = deployments.filter(d => d.status === 'completed').length;
                document.getElementById('deployFailed').textContent = deployments.filter(d => d.status === 'failed').length;
                document.getElementById('deployPending').textContent = deployments.filter(d => d.status === 'pending' || d.status === 'running').length;

                // Load deployment thresholds
                checkDeploymentThresholds();

                // Update pagination state and render
                paginationState.deployments.data = deployments;
                paginationState.deployments.total = deployments.length;
                paginationState.deployments.page = 1;
                renderPaginatedTable('deployments');
            } catch (e) {
                console.error('Failed to load deployments:', e);
                showNotification('Failed to load deployments. Please refresh the page.', 'error');
            }
        }

        async function executeDeployment(deploymentId) {
            const confirmed = await showConfirm('Execute this deployment?', 'Execute Deployment', 'Deploy');
            if (!confirmed) return;

            try {
                showNotification('Starting deployment...', 'info');
                const result = await api(`/deployments/${deploymentId}/execute`, 'POST');
                showNotification(`Deployment ${deploymentId} started`, 'success');

                // Poll for completion
                setTimeout(loadDeployments, 5000);
                setTimeout(loadDeployments, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 15s
                setTimeout(loadDeployments, 30000);
            } catch (e) {
                showNotification('Failed to execute deployment: ' + e.message, 'error');
            }
        }

        async function checkDeploymentThresholds() {
            try {
                const thresholds = await api('/deployments/thresholds');

                // DEV  QA
                const devQaCommits = thresholds.dev_to_qa?.commits || 0;
                const devQaCommitThreshold = thresholds.dev_to_qa?.commit_threshold || 3;
                const devQaFeatures = thresholds.dev_to_qa?.features || 0;
                const devQaFeatureThreshold = thresholds.dev_to_qa?.feature_threshold || 2;
                const devQaReady = thresholds.dev_to_qa?.ready || false;

                document.getElementById('devQaProgress').textContent = `${devQaCommits} / ${devQaCommitThreshold} commits`;
                document.getElementById('devQaFeaturesProgress').textContent = `${devQaFeatures} / ${devQaFeatureThreshold} features`;
                document.getElementById('devQaProgressBar').style.width = Math.min((devQaCommits / devQaCommitThreshold) * 100, 100) + '%';
                document.getElementById('devQaStatus').textContent = devQaReady ? 'Ready!' : 'Waiting...';
                document.getElementById('devQaStatus').style.color = devQaReady ? 'var(--success)' : 'var(--text-secondary)';

                // QA  PROD
                const qaProdCommits = thresholds.qa_to_prod?.commits || 0;
                const qaProdCommitThreshold = thresholds.qa_to_prod?.commit_threshold || 5;
                const qaProdFeatures = thresholds.qa_to_prod?.features || 0;
                const qaProdFeatureThreshold = thresholds.qa_to_prod?.feature_threshold || 3;
                const qaProdReady = thresholds.qa_to_prod?.ready || false;

                document.getElementById('qaProdProgress').textContent = `${qaProdCommits} / ${qaProdCommitThreshold} commits`;
                document.getElementById('qaProdFeaturesProgress').textContent = `${qaProdFeatures} / ${qaProdFeatureThreshold} features`;
                document.getElementById('qaProdProgressBar').style.width = Math.min((qaProdCommits / qaProdCommitThreshold) * 100, 100) + '%';
                document.getElementById('qaProdStatus').textContent = qaProdReady ? 'Ready!' : 'Waiting...';
                document.getElementById('qaProdStatus').style.color = qaProdReady ? 'var(--success)' : 'var(--text-secondary)';

            } catch (e) {
                console.error('Failed to check deployment thresholds:', e);
            }
        }

        async function triggerAutoDeployCheck() {
            try {
                showNotification('Checking auto-deploy thresholds...', 'info');
                const result = await api('/deployments/auto-check', 'POST');
                if (result.deployed) {
                    showNotification(`Auto-deployed to ${result.environment}: ${result.tag}`, 'success');
                    loadDeployments();
                } else {
                    showNotification(result.message || 'No deployment triggered', 'info');
                }
            } catch (e) {
                showNotification('Auto-deploy check failed: ' + e.message, 'error');
            }
        }

        async function checkMigrationStatus() {
            try {
                const status = await api('/migrations/status');
                const container = document.getElementById('migrationStatus');
                const content = document.getElementById('migrationContent');

                container.style.display = 'block';
                content.innerHTML = `
                    <p><strong>Database:</strong> ${status.database}</p>
                    <p><strong>Applied Migrations:</strong> ${status.applied_count}</p>
                    <p><strong>Pending Migrations:</strong> ${status.pending_count}</p>
                    <p><strong>Is Current:</strong> ${status.is_current ? 'Yes' : 'No'}</p>
                    ${status.pending_versions?.length > 0 ? `
                        <p><strong>Pending:</strong> ${status.pending_versions.join(', ')}</p>
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="runMigrations()">Run Migrations</button>
                    ` : ''}
                `;
            } catch (e) {
                showNotification('Failed to check migration status: ' + e.message, 'error');
            }
        }

        async function runMigrations() {
            const confirmed = await showConfirm('Run pending database migrations? A backup will be created.', 'Run Migrations', 'Run Migrations');
            if (!confirmed) return;

            try {
                showNotification('Running migrations...', 'info');
                const result = await api('/migrations/run', 'POST');
                showNotification(`Applied ${result.applied?.length || 0} migrations`, 'success');
                checkMigrationStatus();
            } catch (e) {
                showNotification('Failed to run migrations: ' + e.message, 'error');
            }
        }

        // Legacy keyboard shortcuts - now handled by keyboardShortcuts.js module
        // Keep this listener only for tmux fullscreen modal close (special case)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close tmux fullscreen (special case not in main module)
                const tmuxModal = document.getElementById('modal-tmuxFullscreen');
                if (tmuxModal && tmuxModal.style.display !== 'none') {
                    closeTmuxFullscreen();
                    e.preventDefault();
                    return;
                }
            }
        });

        // Note: Main keyboard shortcuts are handled by static/js/keyboardShortcuts.js
        // This includes: ?, /, [, ], R, N, 1-9, G+key sequences, J/K navigation, etc.
        // See KeyboardShortcuts module for full implementation

        // Form validation helper
        function validateForm(formEl) {
            let isValid = true;
            const inputs = formEl.querySelectorAll('[required]');

            inputs.forEach(input => {
                const group = input.closest('.form-group');
                const errorEl = group?.querySelector('.form-error');

                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                    if (group) group.classList.add('has-error');
                    if (errorEl) errorEl.textContent = 'This field is required';
                } else {
                    input.classList.remove('error');
                    if (group) group.classList.remove('has-error');
                }
            });

            return isValid;
        }

        // Clear form errors on input
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('form-input') || e.target.classList.contains('error')) {
                e.target.classList.remove('error');
                const group = e.target.closest('.form-group');
                if (group) group.classList.remove('has-error');
            }
        });

        // ============================================================================
        // ONBOARDING GUIDED TOUR
        // ============================================================================

        const tourSteps = [
            {
                target: '.header-nav',
                title: 'Navigation Bar',
                content: 'Use the top navigation to switch between different panels. You can also use keyboard shortcuts (press ? to see them).',
                position: 'bottom'
            },
            {
                target: '#sidebarQuickAccess',
                title: 'Quick Access',
                content: 'Pin your most-used panels here for quick access. Click the + button to add panels.',
                position: 'right'
            },
            {
                target: '#sidebarStats',
                title: 'Quick Stats',
                content: 'View key metrics at a glance. Click any stat to navigate to that panel.',
                position: 'right'
            },
            {
                target: '.nav-btn[data-panel="queue"]',
                title: 'Autopilot Queue',
                content: 'This is your command center. Review features, bugs, and errors that need attention.',
                position: 'bottom'
            },
            {
                target: '#nav-issues',
                title: 'Issue Tracking',
                content: 'Track features, bugs, and errors across all your projects.',
                position: 'bottom'
            },
            {
                target: '.nav-btn[data-panel="tmux"]',
                title: 'Terminal Sessions',
                content: 'Manage tmux sessions across all nodes. Send commands and view output.',
                position: 'bottom'
            },
            {
                target: '#globalSearchInput',
                title: 'Global Search',
                content: 'Search across all projects, features, bugs, and errors. Press / to focus.',
                position: 'bottom'
            }
        ];

        let currentTourStep = 0;
        let tourActive = false;

        function startTour() {
            tourActive = true;
            currentTourStep = 0;
            document.getElementById('tourOverlay').classList.add('active');
            showTourStep(currentTourStep);
        }

        function endTour(completed = false) {
            tourActive = false;
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourSpotlight').style.display = 'none';
            document.getElementById('tourTooltip').style.display = 'none';

            if (completed) {
                localStorage.setItem('tourCompleted', 'true');
                showNotification('Tour complete! Press ? anytime for keyboard shortcuts.', 'success');
            } else {
                localStorage.setItem('tourSkipped', 'true');
            }
        }

        function showTourStep(stepIndex) {
            const step = tourSteps[stepIndex];
            if (!step) {
                endTour(true);
                return;
            }

            const target = document.querySelector(step.target);
            if (!target) {
                // Skip to next step if target not found
                nextTourStep();
                return;
            }

            const rect = target.getBoundingClientRect();
            const spotlight = document.getElementById('tourSpotlight');
            const tooltip = document.getElementById('tourTooltip');

            // Position spotlight
            spotlight.style.display = 'block';
            spotlight.style.left = (rect.left - 8) + 'px';
            spotlight.style.top = (rect.top - 8) + 'px';
            spotlight.style.width = (rect.width + 16) + 'px';
            spotlight.style.height = (rect.height + 16) + 'px';

            // Build step indicators
            const dots = tourSteps.map((_, i) => {
                let cls = 'tour-step-dot';
                if (i < stepIndex) cls += ' completed';
                if (i === stepIndex) cls += ' active';
                return `<div class="${cls}"></div>`;
            }).join('');

            // Build tooltip content
            tooltip.innerHTML = `
                <div class="tour-step-indicator">${dots}</div>
                <div class="tour-title">${step.title}</div>
                <div class="tour-content">${step.content}</div>
                <div class="tour-actions">
                    <button class="tour-skip" onclick="endTour(false)">Skip tour</button>
                    <div class="tour-nav">
                        ${stepIndex > 0 ? '<button class="tour-btn tour-btn-secondary" onclick="prevTourStep()">Back</button>' : ''}
                        <button class="tour-btn tour-btn-primary" onclick="nextTourStep()">
                            ${stepIndex === tourSteps.length - 1 ? 'Finish' : 'Next'}
                        </button>
                    </div>
                </div>
            `;

            // Position tooltip
            tooltip.style.display = 'block';
            const tooltipRect = tooltip.getBoundingClientRect();
            let left, top;

            switch (step.position) {
                case 'bottom':
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    top = rect.bottom + 16;
                    break;
                case 'right':
                    left = rect.right + 16;
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    break;
                case 'left':
                    left = rect.left - tooltipRect.width - 16;
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    break;
                default:
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    top = rect.top - tooltipRect.height - 16;
            }

            // Keep tooltip in viewport
            left = Math.max(16, Math.min(left, window.innerWidth - tooltipRect.width - 16));
            top = Math.max(16, Math.min(top, window.innerHeight - tooltipRect.height - 16));

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function nextTourStep() {
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                endTour(true);
            } else {
                showTourStep(currentTourStep);
            }
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep(currentTourStep);
            }
        }

        // Check if first-time user
        function checkFirstTimeUser() {
            const tourCompleted = localStorage.getItem('tourCompleted');
            const tourSkipped = localStorage.getItem('tourSkipped');

            if (!tourCompleted && !tourSkipped) {
                // Show welcome dialog after a short delay
                setTimeout(() => {
                    showWelcomeDialog();
                }, 1500);
            }
        }

        function showWelcomeDialog() {
            const overlay = document.getElementById('tourOverlay');
            overlay.classList.add('active');
            overlay.innerHTML = `
                <div class="tour-welcome">
                    <div class="tour-welcome-icon"></div>
                    <h2>Welcome to Architect Dashboard!</h2>
                    <p>This is your project management command center. Would you like a quick tour of the interface?</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="tour-btn tour-btn-secondary" onclick="skipWelcome()">Skip for now</button>
                        <button class="tour-btn tour-btn-primary" onclick="startTourFromWelcome()">Take the tour</button>
                    </div>
                </div>
            `;
        }

        function startTourFromWelcome() {
            document.getElementById('tourOverlay').innerHTML = '';
            startTour();
        }

        function skipWelcome() {
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourOverlay').innerHTML = '';
            localStorage.setItem('tourSkipped', 'true');
        }

        // Expose tour functions
        window.startTour = startTour;
        window.endTour = endTour;
        window.nextTourStep = nextTourStep;
        window.prevTourStep = prevTourStep;
        window.skipWelcome = skipWelcome;
        window.startTourFromWelcome = startTourFromWelcome;

        // ============================================================================
        // MOBILE NAVIGATION
        // ============================================================================

        function mobileNavigate(panelName, element) {
            // Update mobile nav active state
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }

            // Navigate to panel
            navigateToPanel(panelName);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function showMobileMoreMenu() {
            document.getElementById('mobileMoreMenu').style.display = 'block';
        }

        function hideMobileMoreMenu() {
            document.getElementById('mobileMoreMenu').style.display = 'none';
        }

        function openDashboardPrintView() {
            window.location.href = '/dashboard/print';
        }

        // Expose mobile menu functions globally
        window.showMobileMoreMenu = showMobileMoreMenu;
        window.hideMobileMoreMenu = hideMobileMoreMenu;
        window.openDashboardPrintView = openDashboardPrintView;

        // ============================================================================
        // REVIEW QUEUE FUNCTIONS
        // ============================================================================

        let currentQueueFilter = 'all';
        let queueData = { summary: {}, items: [] };
        let queueAutoRefreshInterval = null;

        toggleQueueAutoRefresh = function(enabled) {
            if (enabled) {
                // Start auto-refresh every 15 seconds (reduced from 5s to prevent UI blocking)
                queueAutoRefreshInterval = setInterval(() => { // Changed to 60s
                    if (currentPanel === 'queue') {
                        refreshQueue();
                        refreshEnvCheckout();
                    }
                }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 15s
                refreshQueue(); // Immediate refresh
                refreshEnvCheckout();
            } else {
                if (queueAutoRefreshInterval) {
                    clearInterval(queueAutoRefreshInterval);
                    queueAutoRefreshInterval = null;
                }
            }
        };

        // Toggle sessions sidebar in queue panel
        function toggleQueueSessionsPane() {
            const pane = document.getElementById('queueSessionsPane');
            const btn = document.getElementById('toggleQueueSessions');
            if (pane) {
                const isVisible = pane.style.display === 'flex';
                pane.style.display = isVisible ? 'none' : 'flex';
                if (btn) btn.classList.toggle('active', !isVisible);
                if (!isVisible) loadSidebarPanelData();  // Load all sidebar data
                localStorage.setItem('queueSessionsPaneVisible', !isVisible);
            }
        }

        // Load sessions for the quick sidebar
        async function loadQueueSessions() {
            const container = document.getElementById('queueSessionsList');
            if (!container) return;

            try {
                const response = await fetch('/api/tmux/sessions');
                const sessions = await response.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px; font-size: 13px;">No active sessions</div>';
                    return;
                }

                container.innerHTML = sessions.map(s => `
                    <div class="quick-session-item" onclick="navigateToPanel('tmux')" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.15s;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${s.session_name || s.name}</span>
                            <span class="status-badge ${s.attached ? 'attached' : 'detached'}" style="font-size: 10px;">${s.attached ? 'attached' : 'detached'}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${s.window_count || s.windows || 1} window${(s.window_count || s.windows || 1) > 1 ? 's' : ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px; font-size: 13px;">Failed to load sessions</div>';
            }
        }

        // Load workers status
        async function loadWorkersStatus() {
            const container = document.getElementById('workersStatusList');
            if (!container) return;

            try {
                const response = await fetch('/api/workers/status');
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">Error loading workers</div>';
                    return;
                }

                const workers = data.system_workers || {};
                let html = '<div style="display: grid; gap: 8px;">';

                for (const [name, info] of Object.entries(workers)) {
                    const isRunning = info.running;
                    const statusColor = isRunning ? 'var(--success)' : 'var(--text-secondary)';
                    const statusIcon = isRunning ? '' : '';
                    const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: ${statusColor}; font-size: 10px;">${statusIcon}</span>
                                <span>${displayName}</span>
                            </span>
                            <span style="color: ${statusColor}; font-size: 11px;">${isRunning ? 'Running' : 'Stopped'}</span>
                        </div>
                    `;
                }

                // Add registered workers count
                const stats = data.stats || {};
                if (stats.total > 0) {
                    html += `
                        <div style="margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; text-align: center;">
                            <span style="font-size: 11px; color: var(--text-secondary);">
                                ${stats.active || 0} active / ${stats.total} registered workers
                            </span>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            } catch (e) {
                console.error('[Workers] Error:', e);
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">Failed to load workers</div>';
            }
        }

        // Load assigner activity
        async function loadAssignerActivity() {
            const summaryEl = document.getElementById('assignerSummary');
            const historyEl = document.getElementById('assignerHistoryList');
            if (!summaryEl || !historyEl) return;

            try {
                const response = await fetch('/api/assigner/status');
                const data = await response.json();

                if (data.error) {
                    historyEl.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">Error loading assigner data</div>';
                    return;
                }

                // Update summary
                const summary = data.summary || {};
                const byProject = summary.by_project || {};

                document.getElementById('assignerTotalSessions').textContent = summary.total_sessions || 0;
                document.getElementById('assignerEduApps').textContent = `edu_apps: ${byProject.edu_apps || 0}`;
                document.getElementById('assignerArchitect').textContent = `architect: ${byProject.architect || 0}`;
                document.getElementById('assignerKanban').textContent = `kanbanflow: ${byProject.kanbanflow || 0}`;

                // Update history list
                const history = data.task_history || [];
                if (history.length === 0) {
                    historyEl.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">No assignment history</div>';
                    return;
                }

                // Show last 10 entries, newest first
                const recentHistory = history.slice(-10).reverse();
                historyEl.innerHTML = recentHistory.map(h => {
                    const time = h.timestamp ? new Date(h.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '';
                    const taskPreview = (h.task || '').substring(0, 50) + ((h.task || '').length > 50 ? '...' : '');
                    const projectColors = {
                        'edu_apps': 'var(--accent)',
                        'architect': 'var(--success)',
                        'kanbanflow': 'var(--warning)'
                    };
                    const color = projectColors[h.project] || 'var(--text-secondary)';

                    return `
                        <div style="padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${h.session || 'unknown'}</span>
                                <span style="color: var(--text-secondary); font-size: 10px;">${time}</span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 11px; line-height: 1.4;">${taskPreview}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('[Assigner] Error:', e);
                historyEl.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">Failed to load assigner data</div>';
            }
        }

        // Load all sidebar data
        async function loadSidebarPanelData() {
            await Promise.all([
                loadQueueSessions(),
                loadWorkersStatus(),
                loadAssignerActivity(),
                loadWrapperStatus(),
                loadGoWrapperStatus()
            ]);
        }

        // =====================
        // CLAUDE WRAPPER FUNCTIONS
        // =====================

        async function loadWrapperStatus() {
            try {
                const response = await fetch('/api/wrapper/status');
                if (!response.ok) return;

                const data = await response.json();

                // Update summary counts
                const wrappedSessions = data.sessions.filter(s => s.has_wrapper);
                document.getElementById('wrapperSessionCount').textContent = wrappedSessions.length;

                if (data.wrapper_state) {
                    document.getElementById('wrapperPromptsApproved').textContent = data.wrapper_state.prompts_approved || 0;
                    document.getElementById('wrapperPromptsBlocked').textContent = data.wrapper_state.prompts_denied || 0;
                }

                // Render wrapped sessions list
                const list = document.getElementById('wrapperSessionsList');
                if (wrappedSessions.length === 0) {
                    list.innerHTML = `
                        <div style="color: var(--text-secondary); text-align: center; padding: 10px;">
                            No wrapped sessions running
                        </div>
                    `;
                } else {
                    list.innerHTML = wrappedSessions.map(session => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--success);"></span>
                                <span style="font-weight: 500;">${session.name}</span>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                ${session.has_claude ? '<span title="Claude running" style="font-size: 10px;"></span>' : ''}
                                <span title="Wrapper active" style="font-size: 10px;"></span>
                            </div>
                        </div>
                    `).join('');
                }

                // Also show non-wrapped Claude sessions that could be wrapped
                const claudeSessions = data.sessions.filter(s => s.has_claude && !s.has_wrapper);
                if (claudeSessions.length > 0) {
                    list.innerHTML += `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">
                                Claude sessions (no wrapper):
                            </div>
                            ${claudeSessions.slice(0, 5).map(s => `
                                <div style="font-size: 11px; color: var(--text-secondary); padding: 4px 0;">
                                     ${s.name}
                                </div>
                            `).join('')}
                            ${claudeSessions.length > 5 ? `<div style="font-size: 10px; color: var(--text-secondary);">+${claudeSessions.length - 5} more</div>` : ''}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Failed to load wrapper status:', error);
            }
        }

        function showStartWrapperModal() {
            // Generate a default session name
            const timestamp = Date.now().toString().slice(-6);
            document.getElementById('wrapperSessionName').value = `wrapped_${timestamp}`;
            document.getElementById('wrapperAutoMode').value = 'auto_respond';
            showModal('startWrapper');
        }

        async function startWrappedSession() {
            const sessionName = document.getElementById('wrapperSessionName').value.trim();
            const autoMode = document.getElementById('wrapperAutoMode').value;

            if (!sessionName) {
                showToast('Please enter a session name', 'error');
                return;
            }

            // Validate session name (alphanumeric and underscores only)
            if (!/^[a-zA-Z0-9_]+$/.test(sessionName)) {
                showToast('Session name can only contain letters, numbers, and underscores', 'error');
                return;
            }

            try {
                const response = await fetch('/api/wrapper/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_name: sessionName,
                        auto_respond: autoMode === 'auto_respond',
                        approve_all: autoMode === 'approve_all'
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showToast(data.error || 'Failed to start session', 'error');
                    return;
                }

                showToast(`Started wrapped session: ${sessionName}`, 'success');
                hideModal('startWrapper');

                // Refresh wrapper status
                loadWrapperStatus();

                // Also refresh tmux sessions
                loadQueueSessions();

            } catch (error) {
                console.error('Failed to start wrapped session:', error);
                showToast('Failed to start session', 'error');
            }
        }

        // =====================
        // GO WRAPPER FUNCTIONS
        // =====================

        async function loadGoWrapperStatus() {
            try {
                const response = await fetch('/api/go-wrapper/metrics');
                if (!response.ok) {
                    document.getElementById('goWrapperStatus').innerHTML = '<span style="color: var(--error);"></span>';
                    document.getElementById('goWrapperStatus').title = 'Go Wrapper API unavailable';
                    return;
                }

                const data = await response.json();

                // Update status
                document.getElementById('goWrapperStatus').innerHTML = '<span style="color: var(--success);"></span>';
                document.getElementById('goWrapperStatus').title = 'Healthy';

                // Update metrics
                document.getElementById('goWrapperAgentCount').textContent = data.system.running_agents || 0;
                document.getElementById('goWrapperUptime').textContent = formatDuration(data.system.uptime_seconds || 0);
                document.getElementById('goWrapperRate').textContent = (data.system.events_per_second || 0).toFixed(2);

                // Render agents list
                const list = document.getElementById('goWrapperAgentsList');
                if (!data.agents || data.agents.length === 0) {
                    list.innerHTML = `
                        <div style="color: var(--text-secondary); text-align: center; padding: 10px;">
                            No agents running
                        </div>
                    `;
                } else {
                    list.innerHTML = data.agents.map(agent => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--success); font-size: 10px;"></span>
                                    <span style="font-weight: 500; font-size: 11px;">${agent.name}</span>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary); padding-left: 16px;">
                                    ${agent.log_lines || 0} lines  ${agent.extractions || 0} extractions
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 10px; color: var(--text-secondary);">
                                ${formatDuration(agent.duration_seconds || 0)}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Failed to load Go Wrapper status:', error);
                document.getElementById('goWrapperStatus').innerHTML = '<span style="color: var(--error);"></span>';
                document.getElementById('goWrapperStatus').title = 'Failed to load';
            }
        }

        function refreshGoWrapper() {
            loadGoWrapperStatus();
            showToast('Refreshed Go Wrapper status', 'success');
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 1) return '0s';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }

        // Restore queue sessions pane state
        function restoreQueueSessionsPane() {
            const isVisible = localStorage.getItem('queueSessionsPaneVisible') === 'true';
            if (isVisible) {
                const pane = document.getElementById('queueSessionsPane');
                const btn = document.getElementById('toggleQueueSessions');
                if (pane) {
                    pane.style.display = 'flex';
                    if (btn) btn.classList.add('active');
                    loadSidebarPanelData();  // Load all sidebar data
                }
            }
        }

        // Environment Checkout Status
        let envCheckoutData = null;

        async function refreshEnvCheckout() {
            const container = document.getElementById('envCheckoutGrid');
            if (!container) return;

            try {
                const response = await fetch('/api/delegator/checkout');
                if (!response.ok) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; grid-column: span 5;">Delegator not available</div>';
                    return;
                }

                const data = await response.json();
                envCheckoutData = data;

                // Check for conflicts (multiple sessions using same env)
                const envSessionCounts = {};
                data.assigned_sessions.forEach(s => {
                    envSessionCounts[s.env_id] = (envSessionCounts[s.env_id] || 0) + 1;
                });

                const envHtml = data.environments.map(env => {
                    const hasConflict = (envSessionCounts[env.env_id] || 0) > 1;
                    const statusClass = hasConflict ? 'conflict' : (env.status === 'busy' ? 'busy' : 'idle');
                    const statusIcon = hasConflict ? '' : (env.status === 'busy' ? '' : '');

                    return `
                        <div class="env-card ${statusClass}" title="${env.path}">
                            <div class="env-name">${statusIcon} env_${env.env_id}</div>
                            <div class="env-branch" title="${env.branch || 'no branch'}">${env.branch ? ' ' + env.branch : ''}</div>
                            ${env.session ? `<div class="env-session"> ${env.session}</div>` : '<div style="color: var(--text-secondary);"></div>'}
                            ${env.task_desc ? `<div class="env-task" title="${env.task_desc}"> ${env.task_desc}</div>` : ''}
                            ${hasConflict ? '<div style="color: var(--red); font-size: 10px; margin-top: 4px; font-weight: 600;"> CONFLICT</div>' : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = envHtml;

                // Show warning if conflicts detected
                const conflicts = Object.entries(envSessionCounts).filter(([_, count]) => count > 1);
                if (conflicts.length > 0) {
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'grid-column: span 5; background: rgba(248, 81, 73, 0.15); color: var(--red); padding: 10px; border-radius: 6px; font-size: 12px; margin-top: 8px;';
                    warningDiv.innerHTML = `<strong> Environment Conflict Detected!</strong> Multiple sessions working on same environment may cause overwrites.`;
                    container.appendChild(warningDiv);
                }

            } catch (err) {
                console.error('Failed to load env checkout:', err);
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; grid-column: span 5;">Failed to load</div>';
            }
        }

        // Orchestrator Tasks from Google Sheets
        let orchestratorTasksExpanded = false;

        async function refreshOrchestratorTasks() {
            try {
                const response = await fetch('/api/orchestrator/tasks');
                const data = await response.json();

                if (data.error && !data.tasks.length) {
                    document.getElementById('orchestratorTasksList').innerHTML =
                        `<div style="font-size: 12px; color: var(--text-secondary); text-align: center; padding: 10px;">${data.error}</div>`;
                    return;
                }

                const summary = data.summary || {};
                const total = summary.total || 0;

                // Update stats
                document.getElementById('orchestratorPending').textContent = summary.pending || 0;
                document.getElementById('orchestratorImplementing').textContent = summary.implementing || 0;
                document.getElementById('orchestratorCompleted').textContent = summary.completed || 0;
                document.getElementById('orchestratorTotal').textContent = total;

                // Update progress bar
                if (total > 0) {
                    const completedPct = ((summary.completed || 0) / total * 100).toFixed(1);
                    const implementingPct = ((summary.implementing || 0) / total * 100).toFixed(1);
                    const pendingPct = ((summary.pending || 0) / total * 100).toFixed(1);

                    document.getElementById('orchestratorCompletedBar').style.width = completedPct + '%';
                    document.getElementById('orchestratorImplementingBar').style.width = implementingPct + '%';
                    document.getElementById('orchestratorPendingBar').style.width = pendingPct + '%';
                } else {
                    document.getElementById('orchestratorCompletedBar').style.width = '0%';
                    document.getElementById('orchestratorImplementingBar').style.width = '0%';
                    document.getElementById('orchestratorPendingBar').style.width = '0%';
                }

                // Render tasks list (show most recent 10)
                const tasks = data.tasks || [];
                const recentTasks = tasks.slice(0, 15);
                const listHtml = recentTasks.length ? recentTasks.map(t => {
                    const statusColor = {
                        'completed': 'var(--green)',
                        'implementing': 'var(--accent)',
                        'pending': 'var(--yellow)',
                        'failed': 'var(--red)',
                        'blocked': 'var(--orange)'
                    }[t.status_category] || 'var(--text-secondary)';

                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 4px;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; flex-shrink: 0;"></span>
                            <span style="flex: 1; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.description}">${t.description}</span>
                            <span style="font-size: 10px; color: var(--text-secondary); flex-shrink: 0;">${t.status}</span>
                            ${t.session ? `<span style="font-size: 10px; color: var(--accent); flex-shrink: 0;">${t.session}</span>` : ''}
                        </div>
                    `;
                }).join('') : '<div style="font-size: 12px; color: var(--text-secondary); text-align: center; padding: 10px;">No tasks found</div>';

                document.getElementById('orchestratorTasksList').innerHTML = listHtml;

            } catch (err) {
                console.error('Failed to load orchestrator tasks:', err);
                document.getElementById('orchestratorTasksList').innerHTML =
                    '<div style="font-size: 12px; color: var(--red); text-align: center; padding: 10px;">Failed to load tasks</div>';
            }
        }

        function toggleOrchestratorTasksList() {
            orchestratorTasksExpanded = !orchestratorTasksExpanded;
            document.getElementById('orchestratorTasksList').style.display = orchestratorTasksExpanded ? 'block' : 'none';
            document.getElementById('orchestratorTasksToggle').textContent = orchestratorTasksExpanded ? '' : '';
        }

        refreshQueue = async function() {
            try {
                const response = await fetch('/api/autopilot/queue');
                const data = await response.json();

                // Combine all items for display
                const allItems = [
                    ...(data.in_progress || []).map(i => ({...i, item_type: 'in_progress'})),
                    ...(data.items || []).map(i => ({...i, item_type: i.item_type || 'milestone'})),
                    ...(data.blocked || []).map(i => ({...i, item_type: 'blocked'})),
                    ...(data.incidents || []).map(i => ({...i, item_type: 'incident'}))
                ];

                queueData = { ...data, items: allItems };

                // Update summary counts
                document.getElementById('queueApprovalCount').textContent = data.summary.ready_for_approval || 0;
                document.getElementById('queueIncidentCount').textContent = data.summary.incidents || 0;
                document.getElementById('queueBlockedCount').textContent = data.summary.blocked || 0;
                document.getElementById('queueInputCount').textContent = data.summary.needs_input || 0;

                // Update in-progress count if element exists
                const inProgressEl = document.getElementById('queueInProgressCount');
                if (inProgressEl) {
                    inProgressEl.textContent = data.summary.in_progress || 0;
                }

                // Render items
                renderQueueItems(allItems);

                // Update timestamp
                document.getElementById('queueLastRefresh').textContent = 'Updated just now';

                // Update activity status bar
                updateActivityStatus(data);
            } catch (err) {
                console.error('Failed to refresh queue:', err);
            }
        }

        async function updateActivityStatus(queueData) {
            try {
                // Fetch session health for activity indicators
                const sessionsResp = await fetch('/api/tmux/sessions');
                const sessions = await sessionsResp.json();

                // Fetch errors count
                const errorsResp = await fetch('/api/errors');
                const errorsData = await errorsResp.json();
                const errors = errorsData.errors || errorsData || [];
                const openErrors = errors.filter(e => e.status === 'open').length;

                // Get in-progress runs and their sessions
                const inProgressRuns = queueData.in_progress || [];
                const activeSessions = inProgressRuns.map(r => r.tmux_session).filter(Boolean);

                // Check each active session's status
                const sessionStatuses = [];
                let workingCount = 0;
                let waitingCount = 0;

                for (const sessionName of activeSessions) {
                    try {
                        const healthResp = await fetch(`/api/tmux/sessions/${sessionName}/health`);
                        const health = await healthResp.json();

                        // Detect if working based on output
                        const preview = (health.output_preview || '').toLowerCase();
                        const isWorking = preview.includes('thinking') || preview.includes('working') ||
                                         preview.includes('reading') || preview.includes('building') ||
                                         preview.includes('searching') || preview.includes('writing');
                        const isWaiting = health.is_waiting_input || preview.includes('do you want');

                        if (isWorking) workingCount++;
                        else if (isWaiting) waitingCount++;

                        sessionStatuses.push({
                            name: sessionName,
                            status: isWorking ? 'working' : (isWaiting ? 'waiting' : 'idle'),
                            run: inProgressRuns.find(r => r.tmux_session === sessionName)
                        });
                    } catch (e) {
                        sessionStatuses.push({ name: sessionName, status: 'unknown' });
                    }
                }

                // Update UI
                document.getElementById('activeSessionCount').textContent = activeSessions.length;
                document.getElementById('statWorking').textContent = workingCount;
                document.getElementById('statWaiting').textContent = waitingCount;
                document.getElementById('statErrors').textContent = openErrors;

                // Update pulse color based on activity
                const pulse = document.getElementById('activityPulse');
                if (workingCount > 0) {
                    pulse.style.background = 'var(--green)';
                    pulse.style.animation = 'pulse 1s infinite';
                } else if (waitingCount > 0) {
                    pulse.style.background = 'var(--yellow)';
                    pulse.style.animation = 'pulse 2s infinite';
                } else if (activeSessions.length > 0) {
                    pulse.style.background = 'var(--accent)';
                    pulse.style.animation = 'pulse 3s infinite';
                } else {
                    pulse.style.background = 'var(--text-secondary)';
                    pulse.style.animation = 'none';
                }

                // Render session chips
                const container = document.getElementById('activitySessions');
                if (sessionStatuses.length === 0) {
                    container.innerHTML = '<span style="color: var(--text-secondary); font-size: 12px;">No active sessions</span>';
                } else {
                    container.innerHTML = sessionStatuses.map(s => `
                        <div class="session-chip ${s.status}" title="${s.run?.title || s.name}">
                            <span class="status-dot"></span>
                            <span>${s.name}</span>
                            ${s.status === 'working' ? '<span style="color: var(--accent);"></span>' : ''}
                        </div>
                    `).join('');
                }

                // Get completed today count
                try {
                    const featuresResp = await fetch('/api/features');
                    const features = await featuresResp.json();
                    const completedToday = features.filter(f => {
                        if (f.status !== 'completed' || !f.updated_at) return false;
                        const updated = new Date(f.updated_at);
                        const today = new Date();
                        return updated.toDateString() === today.toDateString();
                    }).length;
                    document.getElementById('statCompleted').textContent = completedToday;
                } catch (e) {}

            } catch (err) {
                console.error('Failed to update activity status:', err);
            }
        }

        function filterQueue(type) {
            currentQueueFilter = type;

            // Update filter button states
            document.querySelectorAll('.queue-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === type);
            });

            applyQueueFilters();
        }

        function applyQueueFilters() {
            const appFilter = document.getElementById('queueAppFilter')?.value || 'all';
            const typeFilter = document.getElementById('queueTypeFilter')?.value || 'all';

            // Filter, sort and render items
            let items = queueData.items || [];

            // Apply type button filter
            if (currentQueueFilter !== 'all') {
                items = items.filter(item => {
                    if (currentQueueFilter === 'session') {
                        return item.task_type === 'session_task' || item.item_type === 'session';
                    }
                    if (currentQueueFilter === 'event') {
                        return ['restart', 'error_fix', 'health_check', 'deployment'].includes(item.task_type);
                    }
                    return item.item_type === currentQueueFilter || item.task_type === currentQueueFilter;
                });
            }

            // Apply app dropdown filter
            if (appFilter !== 'all') {
                items = items.filter(item => {
                    const taskData = typeof item.task_data === 'string' ? item.task_data : JSON.stringify(item.task_data || {});
                    return taskData.includes(appFilter) || item.project === appFilter || item.app_name === appFilter;
                });
            }

            // Apply type dropdown filter
            if (typeFilter !== 'all') {
                items = items.filter(item => item.task_type === typeFilter);
            }

            items = sortQueueItemsArray(items);
            renderQueueItems(items);

            // Update count display
            const countEl = document.getElementById('queueFilteredCount');
            if (countEl) {
                countEl.textContent = `Showing ${items.length} of ${(queueData.items || []).length}`;
            }
        }

        function renderQueueItems(items) {
            const container = document.getElementById('queueItems');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 12px; opacity: 0.7;"></div>
                        <div style="font-size: 18px; margin-bottom: 8px;">All caught up!</div>
                        <div style="font-size: 14px;">No items need your attention right now.</div>
                    </div>
                `;
                return;
            }

            const icons = {
                milestone: '',
                run: '',
                in_progress: '',
                incident: '',
                blocked: '',
                input_needed: ''
            };

            const statusColors = {
                created: 'var(--text-secondary)',
                planning: 'var(--purple)',
                executing: 'var(--accent)',
                testing: 'var(--warning)',
                fixing: 'var(--error)',
                ready_for_review: 'var(--success)',
                blocked: 'var(--error)',
                proposed: 'var(--text-secondary)'
            };

            container.innerHTML = items.map(item => {
                // Calculate duration for in_progress items
                let durationStr = '';
                if (item.item_type === 'in_progress' && item.started_at) {
                    const started = new Date(item.started_at);
                    const now = new Date();
                    const diffMs = now - started;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    if (diffDays > 0) durationStr = `${diffDays}d ${diffHours % 24}h`;
                    else if (diffHours > 0) durationStr = `${diffHours}h ${diffMins % 60}m`;
                    else durationStr = `${diffMins}m`;
                }

                // Format started time
                let startedStr = '';
                if (item.started_at) {
                    const d = new Date(item.started_at);
                    startedStr = d.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                }

                // Truncate description
                const desc = item.description ? (item.description.length > 100 ? item.description.substring(0, 100) + '...' : item.description) : '';

                return `
                <div class="queue-item" data-item-id="${item.id}" data-item-type="${item.item_type}" data-priority="${item.priority || 'normal'}" style="${item.item_type === 'in_progress' ? 'border-left: 3px solid var(--accent);' : ''}">
                    <input type="checkbox" class="queue-item-checkbox" data-id="${item.id}" onchange="updateQueueSelection()" onclick="event.stopPropagation()" style="width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;">
                    <div class="queue-item-priority ${item.priority || ''}"></div>
                    <div class="queue-item-icon">${icons[item.item_type] || ''}</div>
                    <div class="queue-item-content" onclick="showQueueItemDetail(${item.id})" style="cursor: pointer;">
                        <div class="queue-item-title">${escapeHtml(item.title)}</div>
                        <div class="queue-item-meta">
                            <span>${item.project_name || 'Unknown'}</span>
                            <span class="queue-priority-badge priority-${item.priority || 'normal'}">${item.priority || 'normal'}</span>
                            <span style="color: ${statusColors[item.status] || 'var(--text-secondary)'}">${item.status || ''}</span>
                            ${item.item_type === 'in_progress' && item.tmux_session ? `<span> ${item.tmux_session}</span>` : ''}
                        </div>
                        ${desc ? `<div class="queue-item-desc" style="margin-top: 4px; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">${escapeHtml(desc)}</div>` : ''}
                        ${item.item_type === 'in_progress' ? `
                            <div class="queue-item-progress" style="margin-top: 6px; font-size: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
                                <span style="color: var(--success);"> ${item.test_pass_count || 0}</span>
                                <span style="color: var(--error);"> ${item.test_fail_count || 0}</span>
                                <span style="color: var(--warning);"> ${item.error_count || 0}</span>
                                ${durationStr ? `<span style="color: var(--text-secondary);"> ${durationStr}</span>` : ''}
                                ${startedStr ? `<span style="color: var(--text-secondary);"> ${startedStr}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="queue-item-actions">
                        ${getQueueItemActions(item)}
                    </div>
                </div>
                `;
            }).join('');

            // Update batch bar visibility
            updateQueueSelection();
        }

        function getQueueItemActions(item) {
            // Use item_id if available, fall back to id
            const itemId = item.item_id || item.id;

            if (item.item_type === 'milestone') {
                return `
                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); approveMilestone(${itemId})">Approve</button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showMilestoneEvidence(${itemId})">Review</button>
                `;
            } else if (item.item_type === 'in_progress') {
                return `
                    ${item.tmux_session ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); captureTmuxOutput('${item.tmux_session}')">Output</button>` : ''}
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showRunDetail(${itemId})">Details</button>
                `;
            } else if (item.item_type === 'run') {
                if (item.status === 'created') {
                    return `
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showStartRunModal(${itemId})">Start</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showRunDetail(${itemId})">View</button>
                    `;
                } else if (item.status === 'ready_for_review') {
                    return `
                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); approveRun(${itemId})">Approve</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showRunDetail(${itemId})">Review</button>
                    `;
                }
                return `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showRunDetail(${itemId})">View</button>`;
            } else if (item.item_type === 'incident') {
                return `
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); investigateIncident(${itemId})">Investigate</button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); dismissQueueItem(${item.id})">Dismiss</button>
                `;
            } else if (item.item_type === 'blocked') {
                return `
                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); resolveBlocker(${itemId})">Resolve</button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showRunDetail(${itemId})">View</button>
                `;
            } else {
                return `
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showQueueItemDetail(${item.id})">View</button>
                `;
            }
        }

        async function showMilestoneEvidence(milestoneId) {
            try {
                // Fetch milestone, project, and runs in parallel
                const [milestoneResp, runsResp] = await Promise.all([
                    fetch(`/api/autopilot/milestones/${milestoneId}`),
                    fetch(`/api/autopilot/runs?milestone_id=${milestoneId}`)
                ]);

                const milestone = await milestoneResp.json();
                const runsData = await runsResp.json();
                const runs = runsData.runs || runsData || [];

                // Fetch project info
                let project = null;
                if (milestone.project_id) {
                    try {
                        const projResp = await fetch(`/api/projects/${milestone.project_id}`);
                        project = await projResp.json();
                    } catch (e) { }
                }

                // Parse evidence packet if it exists
                let evidence = {};
                if (milestone.evidence_packet) {
                    try {
                        evidence = JSON.parse(milestone.evidence_packet);
                    } catch (e) {
                        evidence = { raw: milestone.evidence_packet };
                    }
                }

                // Calculate progress from runs
                const completedRuns = runs.filter(r => r.status === 'complete' || r.status === 'completed').length;
                const totalRuns = runs.length;
                const progress = totalRuns > 0 ? Math.round((completedRuns / totalRuns) * 100) : 0;

                // Risk color
                const riskScore = milestone.risk_score || 0;
                const riskColor = riskScore >= 70 ? 'var(--red)' : riskScore >= 40 ? 'var(--yellow)' : 'var(--green)';
                const riskLabel = riskScore >= 70 ? 'High Risk' : riskScore >= 40 ? 'Medium Risk' : 'Low Risk';

                // Status badge color
                const statusColors = {
                    proposed: '#8b949e',
                    approved: '#238636',
                    executing: '#1f6feb',
                    completed: '#238636',
                    blocked: '#da3633',
                    rejected: '#da3633'
                };

                // Build runs table
                const runsTable = runs.length > 0 ? `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 8px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Run</th>
                                <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Status</th>
                                <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Session</th>
                                <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Started</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${runs.map(r => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 8px;">#${r.id}</td>
                                    <td style="padding: 8px;">
                                        <span class="badge" style="background: ${statusColors[r.status] || '#8b949e'};">${r.status}</span>
                                    </td>
                                    <td style="padding: 8px;">${r.session_name || '-'}</td>
                                    <td style="padding: 8px;">${r.started_at ? new Date(r.started_at).toLocaleString() : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="color: var(--text-secondary); margin-top: 8px;">No runs yet</p>';

                // Show comprehensive modal
                const content = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Left Column -->
                        <div>
                            <h3 style="margin: 0 0 16px; display: flex; align-items: center; gap: 8px;">
                                 ${escapeHtml(milestone.name)}
                                <span class="badge" style="background: ${statusColors[milestone.status] || '#8b949e'}; font-size: 12px;">${milestone.status}</span>
                            </h3>

                            <!-- Project Info -->
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">PROJECT</div>
                                <div style="font-weight: 600;">${project ? escapeHtml(project.name) : 'Project #' + milestone.project_id}</div>
                                ${project?.source_path ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"> ${escapeHtml(project.source_path)}</div>` : ''}
                            </div>

                            <!-- Description -->
                            ${milestone.description ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">DESCRIPTION</div>
                                    <div style="line-height: 1.5;">${escapeHtml(milestone.description)}</div>
                                </div>
                            ` : ''}

                            <!-- Goal -->
                            ${milestone.goal ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">GOAL</div>
                                    <div style="line-height: 1.5;">${escapeHtml(milestone.goal)}</div>
                                </div>
                            ` : ''}

                            <!-- Scope -->
                            ${milestone.scope ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">SCOPE</div>
                                    <div style="line-height: 1.5; white-space: pre-wrap;">${escapeHtml(milestone.scope)}</div>
                                </div>
                            ` : ''}

                            <!-- Definition of Done -->
                            ${milestone.definition_of_done ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">DEFINITION OF DONE</div>
                                    <div style="line-height: 1.5; white-space: pre-wrap;">${escapeHtml(milestone.definition_of_done)}</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Progress & Risk -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--blue);">${progress}%</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Progress</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${completedRuns}/${totalRuns} runs</div>
                                </div>
                                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: ${riskColor};">${riskScore}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Risk Score</div>
                                    <div style="font-size: 11px; color: ${riskColor}; margin-top: 4px;">${riskLabel}</div>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">TIMELINE</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    <div>
                                        <span style="color: var(--text-secondary);">Created:</span><br>
                                        ${milestone.created_at ? new Date(milestone.created_at).toLocaleDateString() : 'N/A'}
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary);">Target:</span><br>
                                        ${milestone.target_date ? new Date(milestone.target_date).toLocaleDateString() : 'Not set'}
                                    </div>
                                </div>
                            </div>

                            <!-- Execution Runs -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">EXECUTION RUNS</div>
                                ${runsTable}
                            </div>

                            <!-- Evidence Packet -->
                            ${Object.keys(evidence).length > 0 ? `
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">EVIDENCE PACKET</div>
                                    <pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; overflow: auto; max-height: 200px; font-size: 11px; margin: 0;">${JSON.stringify(evidence, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end;">
                        ${milestone.status === 'proposed' ? `
                            <button class="btn btn-success" onclick="approveMilestone(${milestoneId}); hideModal('milestone-evidence')">
                                 Approve & Start
                            </button>
                            <button class="btn btn-danger" onclick="rejectMilestone(${milestoneId}); hideModal('milestone-evidence')">
                                 Reject
                            </button>
                        ` : ''}
                        ${milestone.status === 'approved' || milestone.status === 'executing' ? `
                            <button class="btn btn-primary" onclick="startMilestoneRun(${milestoneId}); hideModal('milestone-evidence')">
                                 Start New Run
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="editMilestone(${milestoneId}); hideModal('milestone-evidence')">
                             Edit
                        </button>
                        <button class="btn btn-secondary" onclick="hideModal('milestone-evidence')">Close</button>
                    </div>
                `;

                showDynamicModal('Milestone Review', content, 'milestone-evidence', { width: '800px' });
            } catch (err) {
                console.error('Failed to load milestone:', err);
                showNotification('Failed to load milestone: ' + err.message, 'error');
            }
        }

        async function startMilestoneRun(milestoneId) {
            try {
                const response = await fetch(`/api/autopilot/milestones/${milestoneId}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    showNotification('New run started!', 'success');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    showNotification('Failed: ' + (err.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                showNotification('Failed to start run: ' + err.message, 'error');
            }
        }

        async function editMilestone(milestoneId) {
            // TODO: Implement edit modal
            showNotification('Edit milestone coming soon', 'info');
        }

        async function approveMilestone(milestoneId) {
            try {
                const response = await fetch(`/api/autopilot/milestones/${milestoneId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (response.ok) {
                    showNotification('Milestone approved! Starting execution...', 'success');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Approval failed');
                }
            } catch (err) {
                showNotification('Failed to approve: ' + err.message, 'error');
            }
        }

        async function rejectMilestone(milestoneId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            try {
                const response = await fetch(`/api/autopilot/milestones/${milestoneId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (response.ok) {
                    showNotification('Milestone rejected', 'info');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Rejection failed');
                }
            } catch (err) {
                showNotification('Failed to reject: ' + err.message, 'error');
            }
        }

        async function exportMilestone(milestoneId) {
            try {
                const response = await fetch(`/api/autopilot/milestones/${milestoneId}`);
                const milestone = await response.json();

                // Generate markdown export
                const markdown = `# ${milestone.name}

**Status:** ${milestone.status}
**Risk Score:** ${milestone.risk_score || 0}/100

## Goal
${milestone.goal || 'N/A'}

## Scope
${milestone.scope || 'N/A'}

## Definition of Done
${milestone.definition_of_done || 'N/A'}

## Evidence Packet
${JSON.stringify(JSON.parse(milestone.evidence_packet || '{}'), null, 2)}
`;
                navigator.clipboard.writeText(markdown);
                showNotification('Milestone document copied to clipboard!', 'success');
            } catch (err) {
                showNotification('Failed to export: ' + err.message, 'error');
            }
        }

        function showQueueItemDetail(queueId) {
            // Navigate to focus panel with the queue item
            navigateToPanel('focus');
            // Could load specific item details here
        }

        function dismissQueueItem(queueId) {
            showConfirm('Dismiss this item from the queue?', 'Confirm Dismiss', 'Dismiss').then(confirmed => {
                if (confirmed) {
                    // Call dismiss API
                    showNotification('Item dismissed', 'info');
                    refreshQueue();
                }
            });
        }

        function investigateIncident(incidentId) {
            showNotification('Opening investigation...', 'info');
            navigateToPanel('focus');
        }

        // ============================================================================
        // AUTOPILOT RUN FUNCTIONS
        // ============================================================================

        async function showStartRunModal(runId) {
            try {
                // Get run details and available tmux sessions
                const [runResponse, sessionsResponse] = await Promise.all([
                    fetch(`/api/autopilot/runs/${runId}`),
                    fetch('/api/tmux/sessions')
                ]);

                const run = await runResponse.json();
                const sessions = await sessionsResponse.json();

                // Build session options
                const sessionOptions = sessions.map(s =>
                    `<option value="${s.session_name}">${s.session_name} ${s.node_id ? `(${s.node_id})` : ''}</option>`
                ).join('');

                const content = `
                    <h3>${escapeHtml(run.milestone_name || 'Run')} - Run #${run.run_number}</h3>
                    <p><strong>Project:</strong> ${escapeHtml(run.project_name || 'Unknown')}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${run.status}">${run.status}</span></p>

                    <div style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select tmux Session:</label>
                        <select id="runTmuxSession" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="">-- Select a session --</option>
                            ${sessionOptions}
                            <option value="__new__">+ Create new session</option>
                        </select>
                    </div>

                    <div id="newSessionNameContainer" style="display: none; margin-top: 12px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Session Name:</label>
                        <input type="text" id="newSessionName" placeholder="autopilot_${run.project_id}" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 8px;">
                        <button class="btn btn-success" onclick="startAutopilotRun(${runId})">Start Run</button>
                        <button class="btn btn-secondary" onclick="hideModal('start-run')">Cancel</button>
                    </div>
                `;

                showDynamicModal('Start Autopilot Run', content, 'start-run');

                // Add event listener for session selection
                setTimeout(() => {
                    document.getElementById('runTmuxSession')?.addEventListener('change', function() {
                        const container = document.getElementById('newSessionNameContainer');
                        if (container) {
                            container.style.display = this.value === '__new__' ? 'block' : 'none';
                        }
                    });
                }, 100);
            } catch (err) {
                showNotification('Failed to load run details: ' + err.message, 'error');
            }
        }

        async function startAutopilotRun(runId) {
            const sessionSelect = document.getElementById('runTmuxSession');
            let sessionName = sessionSelect?.value;

            if (!sessionName) {
                showNotification('Please select a tmux session', 'warning');
                return;
            }

            // Handle new session creation
            if (sessionName === '__new__') {
                sessionName = document.getElementById('newSessionName')?.value;
                if (!sessionName) {
                    showNotification('Please enter a session name', 'warning');
                    return;
                }
            }

            try {
                const response = await fetch(`/api/autopilot/runs/${runId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tmux_session: sessionName })
                });

                if (response.ok) {
                    hideModal('start-run');
                    showNotification('Run started! Sending to ' + sessionName, 'success');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to start run');
                }
            } catch (err) {
                showNotification('Failed to start run: ' + err.message, 'error');
            }
        }

        async function showRunDetail(runId) {
            try {
                if (!runId) {
                    showNotification('Invalid run ID', 'error');
                    return;
                }

                const response = await fetch(`/api/autopilot/runs/${runId}`);
                if (!response) {
                    showNotification('No response from server', 'error');
                    return;
                }
                if (!response.ok) {
                    showNotification(`Failed to load run: ${response.status}`, 'error');
                    return;
                }

                const run = await response.json();
                if (!run || run.error) {
                    showNotification(run?.error || 'Run not found', 'error');
                    return;
                }

                const content = `
                    <h3>${escapeHtml(run.milestone_name || run.title || 'Run')} - Run #${run.run_number || runId}</h3>
                    <p><strong>Project:</strong> ${escapeHtml(run.project_name || 'Unknown')}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${run.status || 'unknown'}">${run.status || 'unknown'}</span></p>
                    ${run.tmux_session ? `<p><strong>tmux Session:</strong> ${escapeHtml(run.tmux_session)}</p>` : ''}

                    ${run.goal ? `
                        <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--primary);">
                            <strong>Goal:</strong>
                            <p style="margin: 4px 0 0 0; color: var(--text-secondary);">${escapeHtml(run.goal)}</p>
                        </div>
                    ` : ''}

                    ${run.scope ? `
                        <div style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--info);">
                            <strong>Scope:</strong>
                            <p style="margin: 4px 0 0 0; color: var(--text-secondary);">${escapeHtml(run.scope)}</p>
                        </div>
                    ` : ''}

                    ${run.definition_of_done ? `
                        <div style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--success);">
                            <strong>Definition of Done:</strong>
                            <p style="margin: 4px 0 0 0; color: var(--text-secondary);">${escapeHtml(run.definition_of_done)}</p>
                        </div>
                    ` : ''}

                    ${run.plan_summary ? `
                        <div style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--warning);">
                            <strong>Plan:</strong>
                            <p style="margin: 4px 0 0 0; color: var(--text-secondary);">${escapeHtml(run.plan_summary)}</p>
                        </div>
                    ` : ''}

                    <div style="margin-top: 12px;">
                        <strong>Progress:</strong>
                        <div style="display: flex; gap: 16px; margin-top: 8px;">
                            <span style="color: var(--success);"> ${run.test_pass_count || 0} passed</span>
                            <span style="color: var(--error);"> ${run.test_fail_count || 0} failed</span>
                            <span style="color: var(--warning);"> ${run.error_count || 0} errors</span>
                        </div>
                    </div>

                    ${run.blocked_reason ? `
                        <div style="margin-top: 12px; padding: 12px; background: rgba(210, 153, 34, 0.15); border: 1px solid var(--warning); border-radius: 6px;">
                            <strong>Blocked:</strong> ${escapeHtml(run.blocked_reason)}
                            ${run.blocked_question ? `<p style="margin-top: 8px;"><em>${escapeHtml(run.blocked_question)}</em></p>` : ''}
                        </div>
                    ` : ''}

                    <div style="margin-top: 20px; display: flex; gap: 8px;">
                        ${run.tmux_session ? `<button class="btn btn-primary" onclick="captureTmuxOutput('${run.tmux_session}')">View Output</button>` : ''}
                        <button class="btn btn-secondary" onclick="hideModal('run-detail')">Close</button>
                    </div>
                `;

                showDynamicModal('Run Details', content, 'run-detail');
            } catch (err) {
                showNotification('Failed to load run details: ' + err.message, 'error');
            }
        }

        async function approveRun(runId) {
            try {
                const response = await fetch(`/api/autopilot/runs/${runId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'complete' })
                });

                if (response.ok) {
                    showNotification('Run approved and marked complete!', 'success');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Approval failed');
                }
            } catch (err) {
                showNotification('Failed to approve run: ' + err.message, 'error');
            }
        }

        async function resolveBlocker(runId) {
            const resolution = prompt('Enter resolution or answer to unblock this run:');
            if (!resolution) return;

            try {
                const response = await fetch(`/api/autopilot/runs/${runId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'executing',
                        resolution: resolution
                    })
                });

                if (response.ok) {
                    showNotification('Blocker resolved, run continuing...', 'success');
                    refreshQueue();
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to resolve');
                }
            } catch (err) {
                showNotification('Failed to resolve blocker: ' + err.message, 'error');
            }
        }

        // ============================================================================
        // APPS / AUTOPILOT FUNCTIONS
        // ============================================================================

        let appsData = [];

        async function loadApps() {
            try {
                const response = await fetch('/api/apps');
                const data = await response.json();
                // Handle both array response and object with apps property
                appsData = Array.isArray(data) ? data : (data.apps || []);
                renderApps(appsData);
            } catch (err) {
                console.error('Failed to load apps:', err);
            }
        }

        function renderApps(apps) {
            const container = document.getElementById('appsGrid');

            // Ensure apps is an array
            if (!Array.isArray(apps)) {
                apps = apps.apps || [];
            }

            if (!apps || apps.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 12px; opacity: 0.7;"></div>
                        <div style="font-size: 18px; margin-bottom: 8px;">No apps yet</div>
                        <div style="font-size: 14px; margin-bottom: 20px;">Add an app to start autopilot development</div>
                        <button class="btn btn-primary" onclick="showAddAppModal()">+ Add Your First App</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = apps.map(app => {
                // Handle both numeric and string IDs (e.g., "project-1")
                const appIdAttr = typeof app.id === 'string' ? `'${app.id}'` : app.id;
                return `
                <div class="app-card" onclick="showAppDetail(${appIdAttr})">
                    <div class="app-card-header">
                        <div class="app-card-name">${escapeHtml(app.name)}</div>
                        <div class="app-card-status ${app.autopilot_enabled ? 'running' : 'idle'}">
                            ${app.autopilot_enabled ? 'Running' : 'Idle'}
                        </div>
                    </div>
                    ${app.goal ? `<div class="app-card-goal">${escapeHtml(app.goal)}</div>` : ''}
                    <div class="app-card-phase">Phase: ${app.current_phase || 'idle'}</div>
                    <div class="app-card-actions">
                        ${app.autopilot_enabled
                            ? `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); stopApp(${appIdAttr})">Stop</button>`
                            : `<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); startApp(${appIdAttr})">Start</button>`
                        }
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showAppDetail(${appIdAttr})">Details</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function startApp(appId) {
            try {
                const response = await fetch(`/api/apps/${appId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'observe' })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Autopilot started!', 'success');
                    loadApps();
                } else {
                    throw new Error(data.error || 'Failed to start');
                }
            } catch (err) {
                showNotification('Failed to start: ' + err.message, 'error');
            }
        }

        async function stopApp(appId) {
            try {
                const response = await fetch(`/api/apps/${appId}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Autopilot stopped', 'info');
                    loadApps();
                } else {
                    throw new Error(data.error || 'Failed to stop');
                }
            } catch (err) {
                showNotification('Failed to stop: ' + err.message, 'error');
            }
        }

        async function showAppDetail(appId) {
            try {
                const response = await fetch(`/api/apps/${appId}`);
                const app = await response.json();

                const content = `
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Goal</label>
                            <div>${escapeHtml(app.goal || 'No goal set')}</div>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Current Phase</label>
                            <div style="color: var(--cyan);">${app.current_phase || 'idle'}</div>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Autopilot Mode</label>
                            <div>${app.autopilot_mode || 'observe'}</div>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: var(--text-secondary);">Source Path</label>
                            <div style="font-family: monospace; font-size: 12px;">${escapeHtml(app.source_path || 'Not set')}</div>
                        </div>

                        ${app.current_run ? `
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                            <label style="font-size: 12px; color: var(--text-secondary);">Current Run</label>
                            <div>Run #${app.current_run.run_number} - ${app.current_run.status}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Goal: ${escapeHtml(app.current_run.goal || 'No goal')}
                            </div>
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            ${app.autopilot_enabled
                                ? `<button class="btn btn-danger" onclick="stopApp(${app.id}); hideModal('app-detail')">Stop Autopilot</button>`
                                : `<button class="btn btn-success" onclick="startApp(${app.id}); hideModal('app-detail')">Start Autopilot</button>`
                            }
                            <button class="btn btn-secondary" onclick="hideModal('app-detail')">Close</button>
                        </div>
                    </div>
                `;

                showDynamicModal(app.name, content, 'app-detail');
            } catch (err) {
                showNotification('Failed to load app details: ' + err.message, 'error');
            }
        }

        function showAddAppModal() {
            const content = `
                <form id="addAppForm" onsubmit="submitAddApp(event)">
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">App Name *</label>
                        <input type="text" name="name" required style="width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Source Path</label>
                        <input type="text" name="source_path" placeholder="/path/to/project" style="width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Goal</label>
                        <textarea name="goal" rows="3" placeholder="What should the autopilot work towards?" style="width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Description</label>
                        <textarea name="description" rows="2" style="width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('add-app')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add App</button>
                    </div>
                </form>
            `;

            showDynamicModal('Add New App', content, 'add-app');
        }

        async function submitAddApp(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/apps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        source_path: formData.get('source_path'),
                        goal: formData.get('goal'),
                        description: formData.get('description')
                    })
                });

                const data = await response.json();
                if (data.success || data.id) {
                    showNotification('App added successfully!', 'success');
                    hideModal('add-app');
                    loadApps();
                } else {
                    throw new Error(data.error || 'Failed to add app');
                }
            } catch (err) {
                showNotification('Failed to add app: ' + err.message, 'error');
            }
        }

        function showDynamicModal(title, content, modalId, options = {}) {
            const width = options.width || '600px';

            // Create or update dynamic modal
            let modal = document.getElementById(`modal-${modalId}`);
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = `modal-${modalId}`;
                modal.innerHTML = `
                    <div class="modal" style="max-width: ${width}; width: 90%;">
                        <div class="modal-header">
                            <h2 class="modal-title"></h2>
                            <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px; max-height: 80vh; overflow-y: auto;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // Update width if modal already exists
                const modalContent = modal.querySelector('.modal');
                if (modalContent) {
                    modalContent.style.maxWidth = width;
                }
            }

            // Click backdrop to close (only add once when modal is created)
            if (!modal.dataset.backdropAttached) {
                modal.dataset.backdropAttached = 'true';
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modalId);
                    }
                });
            }

            modal.querySelector('.modal-title').textContent = title;
            modal.querySelector('.modal-body').innerHTML = content;
            modal.style.display = 'flex';
        }

        function formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        // ==================== DOCUMENTATION ====================

        let documentationMarkdown = '';

        // System Overview
        async function loadSystemOverview() {
            if (typeof initSystemOverview === 'function') {
                if (!window.systemOverview) {
                    window.systemOverview = initSystemOverview('systemOverviewContainer');
                } else {
                    window.systemOverview.render();
                }
            } else {
                console.warn('SystemOverview component not loaded');
                document.getElementById('systemOverviewContainer').innerHTML =
                    '<p style="color: var(--text-secondary);">System Overview component loading...</p>';
            }
        }

        async function loadDocumentation() {
            try {
                const response = await fetch('/api/documentation');
                if (response.ok) {
                    const data = await response.json();
                    documentationMarkdown = data.markdown;
                    document.getElementById('docsVersion').textContent = data.version || 'v1.0.0';
                    document.getElementById('docsUpdated').textContent = `Updated: ${formatTime(data.updated_at)}`;
                    document.getElementById('docsContent').innerHTML = data.html;
                } else {
                    // Fallback to static documentation
                    generateStaticDocumentation();
                }
            } catch (e) {
                console.log('Loading static documentation');
                generateStaticDocumentation();
            }
        }

        function generateStaticDocumentation() {
            const stats = window.dashboardStats || {};
            const now = new Date().toISOString();

            documentationMarkdown = `# Architect Dashboard Documentation

## Overview
The Architect Dashboard is a distributed project management and automation platform that enables:
- **Autonomous Development**: AI-assisted coding through tmux/Claude integration
- **Project Management**: Track projects, features, bugs, and milestones
- **Error Aggregation**: Collect and manage errors across distributed nodes
- **Deployment Orchestration**: Multi-environment deployment with testing gates
- **Real-time Monitoring**: Live dashboards with auto-refresh

## Current System State
- **Projects**: ${stats.projects?.total || 0} total
- **Features**: ${stats.features?.total || 0} total (${stats.features?.in_progress || 0} in progress)
- **Bugs**: ${stats.bugs?.open || 0} open
- **Errors**: ${stats.errors?.open?.count || 0} unresolved
- **tmux Sessions**: Active Claude Code integration

## Features

### 1. Queue Management
The Queue panel is the command center for task orchestration:
- **Priority Queue**: Tasks ordered by priority and creation time
- **Auto-assignment**: Automatically assign tasks to available Claude sessions
- **Status Tracking**: pending  assigned  in_progress  completed/failed

### 2. Apps Management
Track and manage applications across environments:
- **App Registry**: Central catalog of all applications
- **Environment Status**: dev/qa/prod deployment states
- **Health Monitoring**: Real-time health checks

### 3. Projects & Milestones
Full project lifecycle management:
- **Project Creation**: Define projects with source paths
- **Milestone Tracking**: Group features by release targets
- **Progress Visualization**: Track completion percentages

### 4. Features & Bugs
Issue tracking with AI integration:
- **Feature Specifications**: Detailed feature definitions
- **Bug Tracking**: Severity levels (critical/high/medium/low)
- **tmux Assignment**: Send to Claude for autonomous fixing
- **Status Workflow**: open  in_progress  testing  completed

### 5. Error Aggregation
Centralized error management:
- **Auto-deduplication**: Group similar errors
- **Occurrence Tracking**: Count and timestamp tracking
- **Bug Conversion**: Create bugs from errors
- **Batch Operations**: Resolve multiple errors at once

### 6. tmux Sessions
AI-powered development integration:
- **Session Management**: Create, monitor, kill sessions
- **Claude Code Integration**: Send tasks directly to Claude
- **Live Capture**: View session output in real-time
- **Command Execution**: Send commands to sessions

### 7. Testing Framework
Quality assurance integration:
- **Test Runs**: Track test execution history
- **Pass/Fail Metrics**: Monitor test health
- **Deployment Gates**: Block deploys on test failures

### 8. Deployments
Multi-environment deployment management:
- **Tag-based Deploys**: v*.*.*  QA, release-*.*.*  PROD
- **Test Prerequisites**: Require passing tests before deploy
- **Rollback Support**: Track deployment history

### 9. Cluster Management
Distributed node orchestration:
- **Node Registry**: Track all cluster nodes
- **Health Monitoring**: CPU, memory, disk metrics
- **Task Distribution**: Route tasks to appropriate nodes

### 10. Settings & Accounts
Configuration and access management:
- **Cross-node Accounts**: Manage distributed access
- **Environment Configuration**: Multi-env settings

## API Reference

### Authentication
All API endpoints require session authentication except /api/errors (POST) and /health.

### Core Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| \`/api/projects\` | GET, POST | List/create projects |
| \`/api/projects/\\<id\\>\` | PUT, DELETE | Update/archive project |
| \`/api/features\` | GET, POST | List/create features |
| \`/api/features/\\<id\\>\` | PUT | Update feature |
| \`/api/bugs\` | GET, POST | List/create bugs |
| \`/api/bugs/\\<id\\>\` | PUT | Update bug |
| \`/api/errors\` | GET, POST | List/log errors |
| \`/api/errors/\\<id\\>/resolve\` | POST | Resolve error |
| \`/api/errors/\\<id\\>/create-bug\` | POST | Convert to bug |

### tmux Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| /api/tmux/sessions | GET | List sessions |
| /api/tmux/sessions/refresh | POST | Refresh from tmux |
| /api/tmux/send | POST | Send command |
| /api/tmux/capture | POST | Capture output |
| /api/tmux/create | POST | Create session |
| /api/tmux/kill | POST | Kill session |

### Queue Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| \`/api/queue\` | GET, POST | List/add queue items |
| \`/api/queue/\\<id\\>\` | PUT, DELETE | Update/remove item |
| \`/api/assign-to-tmux\` | POST | Assign task to session |

### Utility Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| /api/stats | GET | Dashboard statistics |
| /api/documentation | GET | This documentation |
| /health | GET | Health check |

## Environment Configuration

### Multi-Environment Setup
| Environment | Port | Purpose |
|-------------|------|---------|
| PROD | 8080 | Production |
| QA | 8081 | Quality Assurance |
| DEV | 8082 | Development |
| ENV3 | 8085 | Feature Development |

### Environment Variables
| Variable | Default | Description |
|----------|---------|-------------|
| PORT | 8080 | Server port |
| HOST | 0.0.0.0 | Server host |
| SECRET_KEY | (auto) | Flask secret |
| ARCHITECT_USER | architect | Admin username |
| ARCHITECT_PASSWORD | peace5 | Admin password |

## Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| /Ctrl + K | Global search |
| /Ctrl + R | Refresh current panel |
| /Ctrl + N | New item (context-aware) |
| Esc | Close modals |

## Recent Activity Integration
Activity items in the Overview panel are clickable:
- **tmux actions**  Navigate to Sessions panel
- **Error actions**  Navigate to Errors panel
- **Feature/Bug actions**  Navigate to respective panels

## Mobile Support
The dashboard is fully responsive with:
- **Bottom Navigation**: Mobile-optimized nav bar
- **Touch Gestures**: Swipe-friendly interactions
- **Safe Area**: iOS notch/home indicator support
- **Fullscreen Modals**: Optimized for small screens

---
*Generated: ${now}*
*Dashboard Version: 1.0.0*
`;

            document.getElementById('docsVersion').textContent = 'v1.0.0';
            document.getElementById('docsUpdated').textContent = `Updated: ${formatTime(now)}`;
            document.getElementById('docsContent').innerHTML = markdownToHtml(documentationMarkdown);
        }

        function markdownToHtml(md) {
            // Simple markdown to HTML converter
            let html = md
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold and italic
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Tables
                .replace(/^\|(.+)\|$/gm, (match, content) => {
                    const cells = content.split('|').map(c => c.trim());
                    if (cells.every(c => c.match(/^-+$/))) {
                        return '<!-- table separator -->';
                    }
                    const isHeader = !match.includes('---');
                    const tag = isHeader ? 'th' : 'td';
                    return '<tr>' + cells.map(c => `<${tag}>${c}</${tag}>`).join('') + '</tr>';
                })
                // Horizontal rule
                .replace(/^---$/gm, '<hr>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            // Wrap tables
            html = html.replace(/((<tr>.*<\/tr>\s*)+)/g, '<table>$1</table>');
            html = html.replace(/<!-- table separator -->/g, '');

            // Clean up table headers
            html = html.replace(/<table><tr><th>/g, '<table><thead><tr><th>');
            html = html.replace(/<\/th><\/tr><tr><td>/g, '</th></tr></thead><tbody><tr><td>');
            html = html.replace(/<\/td><\/tr><\/table>/g, '</td></tr></tbody></table>');

            // Wrap in paragraph
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><h/g, '<h').replace(/<\/h(\d)><\/p>/g, '</h$1>');
            html = html.replace(/<p><table>/g, '<table>').replace(/<\/table><\/p>/g, '</table>');
            html = html.replace(/<p><hr><\/p>/g, '<hr>');
            html = html.replace(/<p><\/p>/g, '');

            return html;
        }

        function refreshDocumentation() {
            loadDocumentation();
            showNotification('Documentation refreshed', 'success');
        }

        async function updateDocumentation() {
            try {
                showNotification('Updating documentation...', 'info');
                const result = await api('/documentation/update', 'POST', {
                    trigger_type: 'manual'
                });

                if (result.error) {
                    showNotification('Failed to update: ' + result.error, 'error');
                    return;
                }

                showNotification(`Documentation updated: ${result.old_version}  ${result.new_version}`, 'success');
                await loadDocumentation();
            } catch (e) {
                showNotification('Failed to update documentation: ' + e.message, 'error');
            }
        }

        async function copyDocumentation() {
            const btn = document.getElementById('copyDocsBtn');
            const originalText = btn.textContent;

            try {
                await navigator.clipboard.writeText(documentationMarkdown);
                btn.textContent = 'Copied!';
                showNotification('Documentation copied to clipboard', 'success');
            } catch (e) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = documentationMarkdown;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                btn.textContent = 'Copied!';
                showNotification('Documentation copied to clipboard', 'success');
            }

            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // =====================
        // SOP Editor Functions
        // =====================
        let currentSopFile = null;
        let sopDirty = false;

        async function loadSopList() {
            console.log('[SOP] Loading SOP list...');
            try {
                const result = await api('/sop');
                console.log('[SOP] API response:', result);
                const select = document.getElementById('sopFileSelect');
                if (!select) {
                    console.error('[SOP] sopFileSelect element not found!');
                    return;
                }
                select.innerHTML = '<option value="">Select SOP file...</option>';

                if (result && result.sops && result.sops.length > 0) {
                    console.log('[SOP] Found', result.sops.length, 'SOP files');
                    result.sops.forEach(sop => {
                        const option = document.createElement('option');
                        option.value = sop.name;
                        option.textContent = `${sop.name} (${Math.round(sop.size/1024)}KB)`;
                        select.appendChild(option);
                    });
                    console.log('[SOP] Dropdown populated with', select.options.length - 1, 'files');
                } else {
                    console.log('[SOP] No SOP files found or invalid response');
                }
            } catch (e) {
                console.error('[SOP] Error loading SOP list:', e);
                showNotification('Failed to load SOP list: ' + e.message, 'error');
            }
        }

        async function loadSopFile(filename) {
            if (!filename) {
                document.getElementById('sopEditor').value = '';
                document.getElementById('sopFileName').textContent = 'No file selected';
                document.getElementById('sopModified').textContent = '';
                document.getElementById('saveSopBtn').disabled = true;
                currentSopFile = null;
                return;
            }

            try {
                const result = await api(`/sop/${filename}`);
                if (result.error) {
                    showNotification('Failed to load SOP: ' + result.error, 'error');
                    return;
                }

                document.getElementById('sopEditor').value = result.content;
                document.getElementById('sopFileName').textContent = result.name;
                document.getElementById('sopModified').textContent = `Modified: ${new Date(result.modified).toLocaleString()}`;
                currentSopFile = filename;
                sopDirty = false;
                document.getElementById('saveSopBtn').disabled = true;

                // Update preview
                updateSopPreview();
            } catch (e) {
                showNotification('Failed to load SOP: ' + e.message, 'error');
            }
        }

        function markSopDirty() {
            if (currentSopFile && !sopDirty) {
                sopDirty = true;
                document.getElementById('saveSopBtn').disabled = false;
                document.getElementById('sopFileName').textContent = currentSopFile + ' *';
            }
            updateSopPreview();
        }

        async function saveSopFile() {
            if (!currentSopFile || !sopDirty) return;

            try {
                const content = document.getElementById('sopEditor').value;
                const result = await api(`/sop/${currentSopFile}`, 'PUT', { content });

                if (result.error) {
                    showNotification('Failed to save SOP: ' + result.error, 'error');
                    return;
                }

                showNotification(`SOP saved: ${currentSopFile}`, 'success');
                sopDirty = false;
                document.getElementById('saveSopBtn').disabled = true;
                document.getElementById('sopFileName').textContent = currentSopFile;
            } catch (e) {
                showNotification('Failed to save SOP: ' + e.message, 'error');
            }
        }

        function updateSopPreview() {
            const content = document.getElementById('sopEditor').value;
            const preview = document.getElementById('sopPreview');

            // Simple markdown to HTML conversion
            let html = content
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/`([^`]+)`/gim, '<code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">$1</code>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/\n/gim, '<br>');

            preview.innerHTML = html || '<p style="color: var(--text-secondary);">Markdown preview will appear here...</p>';
        }

        function toggleSopPreview() {
            const preview = document.querySelector('.sop-preview-section');
            preview.style.display = preview.style.display === 'none' ? 'flex' : 'none';
        }

        // =====================
        // Session Assigner Sync
        // =====================
        async function syncFromAssigner() {
            try {
                showNotification('Syncing from Session Assigner...', 'info');
                const result = await api('/assigner/sync', 'POST');

                if (result.error) {
                    showNotification('Sync failed: ' + result.error, 'error');
                    return;
                }

                showNotification(`Synced ${result.synced} tasks from ${result.total_sessions} sessions`, 'success');
                refreshQueue();
            } catch (e) {
                showNotification('Sync failed: ' + e.message, 'error');
            }
        }

        async function loadAssignerSessions() {
            try {
                const result = await api('/assigner/sessions');
                return result.sessions || {};
            } catch (e) {
                console.error('Failed to load assigner sessions:', e);
                return {};
            }
        }

        // Expose CRUD functions globally for onclick handlers
        window.updateProject = updateProject;
        window.createProject = createProject;
        window.cancelTask = cancelTask;
        window.mobileNavigate = mobileNavigate;
        window.escapeHtml = escapeHtml;
        window.refreshDocumentation = refreshDocumentation;
        window.updateDocumentation = updateDocumentation;
        window.copyDocumentation = copyDocumentation;
        window.loadSopList = loadSopList;
        window.loadSopFile = loadSopFile;
        window.saveSopFile = saveSopFile;
        window.markSopDirty = markSopDirty;
        window.toggleSopPreview = toggleSopPreview;
        window.syncFromAssigner = syncFromAssigner;
        window.showNotification = showNotification;
        window.queueFeature = queueFeature;
        window.captureTmuxOutput = captureTmuxOutput;
        window.showRunDetail = showRunDetail;
        window.filterQueue = filterQueue;
        window.applyQueueFilters = applyQueueFilters;
        window.viewTestRun = viewTestRun;
        window.loadTestRuns = loadTestRuns;
        window.runAllTests = runAllTests;
        window.runSelectedTests = runSelectedTests;
        window.toggleTestCategory = toggleTestCategory;
        window.filterTestRuns = filterTestRuns;

        // =====================
        // Feedback Widget
        // =====================
        let feedbackScreenshot = null;
        let feedbackAnnotations = [];
        let currentAnnotationTool = 'highlight';
        let isDrawing = false;
        let drawStart = null;
        let speechRecognition = null;
        let isRecording = false;
        let cachedOriginalImage = null; // Cache for fast canvas redrawing

        function openFeedbackWidget() {
            // Hide the feedback container while modal is open
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('feedbackMinimized').style.display = 'none';
            document.getElementById('feedbackOverlay').style.display = 'block';

            // Update context info
            document.getElementById('feedbackPage').textContent = window.location.hash || '/';
            document.getElementById('feedbackScreen').textContent = `${window.innerWidth}x${window.innerHeight}`;
            document.getElementById('feedbackTime').textContent = new Date().toLocaleString();
            document.getElementById('feedbackBrowser').textContent = navigator.userAgent.split(' ').slice(-1)[0];

            // Populate projects dropdown
            const projectSelect = document.getElementById('feedbackProject');
            projectSelect.innerHTML = '<option value="">Select Project...</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function closeFeedbackWidget() {
            document.getElementById('feedbackOverlay').style.display = 'none';
            // Check if widget was minimized before opening
            const isMinimized = localStorage.getItem('feedbackWidgetMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('feedbackContainer').style.display = 'none';
                document.getElementById('feedbackMinimized').style.display = 'flex';
            } else {
                document.getElementById('feedbackContainer').style.display = 'flex';
            }

            // Stop recording if active
            if (isRecording && speechRecognition) {
                speechRecognition.stop();
                isRecording = false;
            }

            // Reset state
            resetFeedbackForm();
        }

        function toggleFeedbackWidget() {
            const container = document.getElementById('feedbackContainer');
            const minimized = document.getElementById('feedbackMinimized');
            const isCurrentlyMinimized = container.style.display === 'none';

            if (isCurrentlyMinimized) {
                // Expand
                container.style.display = 'flex';
                minimized.style.display = 'none';
                localStorage.setItem('feedbackWidgetMinimized', 'false');
            } else {
                // Minimize
                container.style.display = 'none';
                minimized.style.display = 'flex';
                localStorage.setItem('feedbackWidgetMinimized', 'true');
            }
        }

        // Restore feedback widget state on load
        (function restoreFeedbackWidgetState() {
            const isMinimized = localStorage.getItem('feedbackWidgetMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('feedbackContainer').style.display = 'none';
                document.getElementById('feedbackMinimized').style.display = 'flex';
            }
        })();

        function resetFeedbackForm() {
            document.getElementById('feedbackText').value = '';
            document.getElementById('screenshotCanvas').style.display = 'none';
            document.getElementById('screenshotPlaceholder').style.display = 'block';
            document.getElementById('annotationTools').style.display = 'none';
            document.getElementById('clearAnnotationsBtn').disabled = true;
            feedbackScreenshot = null;
            feedbackAnnotations = [];
            cachedOriginalImage = null; // Clear image cache
        }

        // Speech-to-text
        function toggleVoiceInput() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('Speech recognition not supported in this browser', 'error');
                return;
            }

            if (isRecording) {
                speechRecognition.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceStatus.textContent = 'Click to speak';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            let finalTranscript = document.getElementById('feedbackText').value;

            speechRecognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceStatus.textContent = 'Listening...';
            };

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                document.getElementById('feedbackText').value = finalTranscript + interimTranscript;
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceStatus.textContent = 'Error: ' + event.error;
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };

            speechRecognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceStatus.textContent = 'Click to speak';
                document.getElementById('feedbackText').value = finalTranscript.trim();
            };

            speechRecognition.start();
        }

        // Screenshot capture with multiple fallback strategies
        async function captureScreenshot() {
            const overlay = document.getElementById('feedbackOverlay');
            overlay.style.display = 'none';

            // Give time for overlay to hide
            await new Promise(r => setTimeout(r, 150));

            try {
                // Strategy 1: Use native screen capture if available (best quality)
                if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getDisplayMedia({
                            video: {
                                displaySurface: 'browser',
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            },
                            preferCurrentTab: true,
                            selfBrowserSurface: 'include',
                            systemAudio: 'exclude'
                        });

                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.muted = true;

                        // Wait for video metadata to load
                        await new Promise((resolve, reject) => {
                            video.onloadedmetadata = () => {
                                video.play().then(resolve).catch(reject);
                            };
                            video.onerror = reject;
                            setTimeout(() => reject(new Error('Video load timeout')), 5000);
                        });

                        // Small delay to ensure frame is rendered
                        await new Promise(r => setTimeout(r, 100));

                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth || 1920;
                        canvas.height = video.videoHeight || 1080;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);

                        // Stop all tracks immediately
                        stream.getTracks().forEach(track => track.stop());

                        feedbackScreenshot = canvas.toDataURL('image/png');
                        displayScreenshot(feedbackScreenshot);
                        overlay.style.display = 'block';
                        return;
                    } catch (mediaErr) {
                        // Handle specific error types
                        if (mediaErr.name === 'NotAllowedError') {
                            console.log('Screen capture permission denied, falling back to DOM capture');
                            showNotification('Permission denied. Using DOM capture instead.', 'warning');
                        } else if (mediaErr.name === 'NotSupportedError') {
                            console.log('Screen capture not supported, falling back to DOM capture');
                        } else if (mediaErr.name === 'AbortError') {
                            console.log('Screen capture cancelled by user');
                            showNotification('Capture cancelled. Using DOM capture instead.', 'info');
                        } else {
                            console.error('getDisplayMedia error:', mediaErr);
                        }
                        // Fall through to DOM capture
                    }
                }

                // Strategy 2: DOM-based capture (works without permissions)
                await captureDOMSnapshot();

            } catch (err) {
                console.error('Screenshot error:', err);
                showNotification('Screenshot capture failed: ' + (err.message || 'Unknown error'), 'error');
                // Last resort: create placeholder
                await createPlaceholderScreenshot();
            }

            overlay.style.display = 'block';
        }

        // DOM snapshot capture - renders actual page content to canvas
        async function captureDOMSnapshot() {
            const canvas = document.createElement('canvas');
            const scale = Math.min(window.devicePixelRatio || 1, 2); // Cap at 2x for performance
            const width = window.innerWidth;
            const height = window.innerHeight;

            canvas.width = width * scale;
            canvas.height = height * scale;

            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);

            // Draw page background
            const bodyStyle = getComputedStyle(document.body);
            ctx.fillStyle = bodyStyle.backgroundColor || '#0d1117';
            ctx.fillRect(0, 0, width, height);

            // Capture main content area
            const mainContent = document.querySelector('.main-content');
            const sidebar = document.querySelector('.sidebar');

            // Draw sidebar representation
            if (sidebar) {
                const sidebarRect = sidebar.getBoundingClientRect();
                ctx.fillStyle = getComputedStyle(sidebar).backgroundColor || '#161b22';
                ctx.fillRect(sidebarRect.left, sidebarRect.top, sidebarRect.width, sidebarRect.height);

                // Draw sidebar items
                const sidebarItems = sidebar.querySelectorAll('.nav-item, .sidebar-item, button, a');
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                sidebarItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    if (rect.width === 0 || rect.height === 0) return;
                    const isActive = item.classList.contains('active');
                    ctx.fillStyle = isActive ? '#238636' : '#21262d';
                    ctx.fillRect(rect.left + 4, rect.top, rect.width - 8, rect.height);
                    ctx.fillStyle = '#c9d1d9';
                    const text = item.textContent?.trim().substring(0, 20) || '';
                    if (text) ctx.fillText(text, rect.left + 12, rect.top + rect.height/2 + 4);
                });
            }

            // Draw main content area
            if (mainContent) {
                const mainRect = mainContent.getBoundingClientRect();
                ctx.fillStyle = getComputedStyle(mainContent).backgroundColor || '#0d1117';
                ctx.fillRect(mainRect.left, mainRect.top, mainRect.width, mainRect.height);

                // Draw panel header
                const panelHeader = mainContent.querySelector('.panel-header, h1, h2, .section-title');
                if (panelHeader) {
                    const headerRect = panelHeader.getBoundingClientRect();
                    ctx.fillStyle = '#f0f6fc';
                    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.fillText(panelHeader.textContent?.trim() || currentPanel, headerRect.left, headerRect.top + 24);
                }

                // Capture visible cards/items in main content
                const cards = mainContent.querySelectorAll('.card, .item, tr, .list-item, .feature-card, .bug-card, .project-card, .milestone-card');
                cards.forEach((card, index) => {
                    if (index > 25) return; // Limit for performance
                    const rect = card.getBoundingClientRect();
                    if (rect.top > height || rect.bottom < 0 || rect.width === 0) return; // Skip off-screen

                    const cardStyle = getComputedStyle(card);
                    ctx.fillStyle = cardStyle.backgroundColor || '#21262d';
                    ctx.strokeStyle = '#30363d';
                    ctx.lineWidth = 1;

                    // Draw card background
                    ctx.fillRect(rect.left, rect.top, rect.width, rect.height);
                    ctx.strokeRect(rect.left, rect.top, rect.width, rect.height);

                    // Draw card text content
                    const title = card.querySelector('h3, h4, .title, .name, td:first-child, .card-title');
                    if (title) {
                        ctx.fillStyle = '#c9d1d9';
                        ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif';
                        const text = title.textContent?.trim().substring(0, 50) || '';
                        if (text) ctx.fillText(text, rect.left + 12, rect.top + 20);
                    }

                    // Draw status badges if present
                    const badge = card.querySelector('.badge, .status, .tag, .severity-badge');
                    if (badge) {
                        const badgeRect = badge.getBoundingClientRect();
                        if (badgeRect.width > 0) {
                            const badgeStyle = getComputedStyle(badge);
                            ctx.fillStyle = badgeStyle.backgroundColor || '#238636';
                            ctx.fillRect(badgeRect.left, badgeRect.top, badgeRect.width, badgeRect.height);
                            ctx.fillStyle = badgeStyle.color || '#fff';
                            ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                            ctx.fillText(badge.textContent?.trim() || '', badgeRect.left + 4, badgeRect.top + 12);
                        }
                    }
                });

                // Capture tables
                const tables = mainContent.querySelectorAll('table');
                tables.forEach(table => {
                    const tableRect = table.getBoundingClientRect();
                    if (tableRect.top > height || tableRect.bottom < 0) return;

                    ctx.strokeStyle = '#30363d';
                    ctx.strokeRect(tableRect.left, tableRect.top, tableRect.width, tableRect.height);

                    // Draw table headers
                    const headers = table.querySelectorAll('th');
                    headers.forEach(th => {
                        const thRect = th.getBoundingClientRect();
                        ctx.fillStyle = '#161b22';
                        ctx.fillRect(thRect.left, thRect.top, thRect.width, thRect.height);
                        ctx.fillStyle = '#c9d1d9';
                        ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.fillText(th.textContent?.trim().substring(0, 15) || '', thRect.left + 8, thRect.top + 16);
                    });
                });

                // Draw any modal or overlay that's visible
                const modals = document.querySelectorAll('.modal[style*="block"], .dialog[style*="block"], .popup:not([style*="none"])');
                modals.forEach(modal => {
                    const modalRect = modal.getBoundingClientRect();
                    if (modalRect.width > 0 && modalRect.height > 0) {
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                        ctx.fillRect(0, 0, width, height);
                        ctx.fillStyle = '#21262d';
                        ctx.fillRect(modalRect.left, modalRect.top, modalRect.width, modalRect.height);
                        ctx.strokeStyle = '#30363d';
                        ctx.strokeRect(modalRect.left, modalRect.top, modalRect.width, modalRect.height);
                    }
                });
            }

            // Draw page info overlay at bottom
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(10, height - 65, 320, 55);
            ctx.fillStyle = '#8b949e';
            ctx.font = '11px monospace';
            ctx.fillText('DOM Capture - ' + new Date().toLocaleString(), 20, height - 45);
            ctx.fillText('Panel: ' + (currentPanel || 'dashboard'), 20, height - 28);
            ctx.fillText('URL: ' + window.location.pathname.substring(0, 40), 20, height - 12);

            feedbackScreenshot = canvas.toDataURL('image/png');
            displayScreenshot(feedbackScreenshot);
        }

        // Fallback placeholder when all capture methods fail
        async function createPlaceholderScreenshot() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;

            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, 800, 600);

            // Draw placeholder content
            ctx.fillStyle = '#21262d';
            ctx.fillRect(50, 50, 700, 500);
            ctx.strokeStyle = '#30363d';
            ctx.strokeRect(50, 50, 700, 500);

            ctx.fillStyle = '#8b949e';
            ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Screenshot Capture Unavailable', 400, 200);

            ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText('Use the annotation tools to mark approximate locations', 400, 240);
            ctx.fillText('of any issues you want to report.', 400, 260);

            ctx.font = '12px monospace';
            ctx.fillStyle = '#58a6ff';
            ctx.fillText('Page: ' + window.location.href.substring(0, 60), 400, 320);
            ctx.fillText('Panel: ' + (currentPanel || 'unknown'), 400, 340);
            ctx.fillText('Time: ' + new Date().toLocaleString(), 400, 360);

            ctx.textAlign = 'left';

            feedbackScreenshot = canvas.toDataURL('image/png');
            displayScreenshot(feedbackScreenshot);
        }

        function displayScreenshot(dataUrl) {
            const placeholder = document.getElementById('screenshotPlaceholder');
            const canvas = document.getElementById('screenshotCanvas');
            const container = document.getElementById('screenshotContainer');
            const annotationTools = document.getElementById('annotationTools');

            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            annotationTools.style.display = 'flex';
            document.getElementById('clearAnnotationsBtn').disabled = false;

            const img = new Image();
            img.onload = () => {
                // Scale to fit container while maintaining aspect ratio
                const maxWidth = container.clientWidth - 20;
                const maxHeight = 400;
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (maxHeight / height) * width;
                    height = maxHeight;
                }

                canvas.width = width;
                canvas.height = height;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Store original image for redrawing
                canvas.dataset.originalImage = dataUrl;
                canvas.dataset.imgWidth = width;
                canvas.dataset.imgHeight = height;

                // Cache scaled image for fast redrawing during annotations
                const scaledImg = new Image();
                scaledImg.onload = () => {
                    cachedOriginalImage = scaledImg;
                };
                scaledImg.src = canvas.toDataURL('image/png');

                // Add mouse and touch event listeners for annotations
                setupAnnotationListeners(canvas);
            };
            img.onerror = () => {
                console.error('Failed to load screenshot image');
                showNotification('Failed to display screenshot', 'error');
            };
            img.src = dataUrl;
        }

        function setupAnnotationListeners(canvas) {
            // Helper to get coordinates from mouse or touch event
            function getEventCoords(e, rect) {
                if (e.touches && e.touches.length > 0) {
                    return {
                        x: e.touches[0].clientX - rect.left,
                        y: e.touches[0].clientY - rect.top
                    };
                } else if (e.changedTouches && e.changedTouches.length > 0) {
                    return {
                        x: e.changedTouches[0].clientX - rect.left,
                        y: e.changedTouches[0].clientY - rect.top
                    };
                }
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            function handleStart(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const coords = getEventCoords(e, rect);
                drawStart = { x: coords.x, y: coords.y };
                isDrawing = true;
            }

            function handleMove(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const coords = getEventCoords(e, rect);

                // Redraw canvas with original image and all annotations
                redrawCanvas(canvas);

                // Draw current annotation preview
                const ctx = canvas.getContext('2d');
                drawAnnotation(ctx, currentAnnotationTool, drawStart.x, drawStart.y, coords.x, coords.y, true);
            }

            function handleEnd(e) {
                if (!isDrawing) return;
                e.preventDefault();
                isDrawing = false;

                const rect = canvas.getBoundingClientRect();
                const coords = getEventCoords(e, rect);

                // Only save annotation if there was meaningful movement
                const minDistance = 5;
                const dx = Math.abs(coords.x - drawStart.x);
                const dy = Math.abs(coords.y - drawStart.y);
                if (dx > minDistance || dy > minDistance) {
                    feedbackAnnotations.push({
                        tool: currentAnnotationTool,
                        x1: drawStart.x,
                        y1: drawStart.y,
                        x2: coords.x,
                        y2: coords.y
                    });
                }

                redrawCanvas(canvas);
            }

            function handleCancel() {
                if (isDrawing) {
                    isDrawing = false;
                    redrawCanvas(canvas);
                }
            }

            // Mouse events
            canvas.onmousedown = handleStart;
            canvas.onmousemove = handleMove;
            canvas.onmouseup = handleEnd;
            canvas.onmouseleave = handleCancel;

            // Touch events for mobile/tablet support
            canvas.ontouchstart = handleStart;
            canvas.ontouchmove = handleMove;
            canvas.ontouchend = handleEnd;
            canvas.ontouchcancel = handleCancel;

            // Prevent default touch behavior to avoid scrolling while drawing
            canvas.style.touchAction = 'none';
        }

        function redrawCanvas(canvas) {
            const ctx = canvas.getContext('2d');

            // Use cached image for synchronous drawing (avoids race condition)
            if (cachedOriginalImage && cachedOriginalImage.complete) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(cachedOriginalImage, 0, 0, canvas.width, canvas.height);

                // Redraw all saved annotations
                feedbackAnnotations.forEach(a => {
                    drawAnnotation(ctx, a.tool, a.x1, a.y1, a.x2, a.y2, false);
                });
            } else {
                // Fallback: load image if not cached
                const img = new Image();
                img.onload = () => {
                    cachedOriginalImage = img;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    feedbackAnnotations.forEach(a => {
                        drawAnnotation(ctx, a.tool, a.x1, a.y1, a.x2, a.y2, false);
                    });
                };
                img.src = canvas.dataset.originalImage;
            }
        }

        function drawAnnotation(ctx, tool, x1, y1, x2, y2, isPreview) {
            ctx.save();

            switch (tool) {
                case 'highlight':
                    ctx.fillStyle = isPreview ? 'rgba(255, 255, 0, 0.2)' : 'rgba(255, 255, 0, 0.35)';
                    ctx.strokeStyle = '#ffcc00';
                    ctx.lineWidth = 2;
                    const w = x2 - x1;
                    const h = y2 - y1;
                    ctx.fillRect(x1, y1, w, h);
                    ctx.strokeRect(x1, y1, w, h);
                    break;

                case 'circle':
                    ctx.strokeStyle = '#f85149';
                    ctx.lineWidth = 3;
                    const rx = Math.abs(x2 - x1) / 2;
                    const ry = Math.abs(y2 - y1) / 2;
                    const cx = x1 + (x2 - x1) / 2;
                    const cy = y1 + (y2 - y1) / 2;
                    ctx.beginPath();
                    ctx.ellipse(cx, cy, rx, ry, 0, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;

                case 'arrow':
                    ctx.strokeStyle = '#58a6ff';
                    ctx.fillStyle = '#58a6ff';
                    ctx.lineWidth = 3;

                    // Draw line
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();

                    // Draw arrowhead
                    const angle = Math.atan2(y2 - y1, x2 - x1);
                    const headLen = 15;
                    ctx.beginPath();
                    ctx.moveTo(x2, y2);
                    ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI / 6), y2 - headLen * Math.sin(angle - Math.PI / 6));
                    ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI / 6), y2 - headLen * Math.sin(angle + Math.PI / 6));
                    ctx.closePath();
                    ctx.fill();
                    break;
            }

            ctx.restore();
        }

        function setAnnotationTool(tool) {
            currentAnnotationTool = tool;
            document.querySelectorAll('.annotation-tool').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
        }

        function clearAnnotations() {
            feedbackAnnotations = [];
            const canvas = document.getElementById('screenshotCanvas');
            if (canvas.dataset.originalImage) {
                redrawCanvas(canvas);
            }
        }

        async function submitFeedback() {
            const text = document.getElementById('feedbackText').value.trim();
            const category = document.getElementById('feedbackCategory').value;
            const priority = document.getElementById('feedbackPriority').value;
            const projectId = document.getElementById('feedbackProject').value;

            if (!text) {
                showNotification('Please describe the issue', 'error');
                return;
            }

            // Get final screenshot with annotations
            let screenshotData = null;
            const canvas = document.getElementById('screenshotCanvas');
            if (canvas.style.display !== 'none') {
                screenshotData = canvas.toDataURL('image/png');
            }

            // Prepare bug data
            const bugData = {
                title: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                description: text,
                severity: priority === 'critical' ? 'critical' : priority === 'high' ? 'high' : priority === 'medium' ? 'medium' : 'low',
                category: category,
                project_id: projectId || null,
                context: {
                    page: window.location.hash || '/',
                    url: window.location.href,
                    screen: `${window.innerWidth}x${window.innerHeight}`,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    annotations: feedbackAnnotations.length
                },
                screenshot: screenshotData
            };

            try {
                const response = await api('/bugs', {
                    method: 'POST',
                    body: JSON.stringify(bugData)
                });

                showNotification('Feedback submitted successfully! Bug #' + response.id, 'success');
                closeFeedbackWidget();
            } catch (err) {
                console.error('Submit feedback error:', err);
                showNotification('Failed to submit feedback: ' + err.message, 'error');
            }
        }

        // Export feedback functions
        window.openFeedbackWidget = openFeedbackWidget;
        window.closeFeedbackWidget = closeFeedbackWidget;
        window.toggleFeedbackWidget = toggleFeedbackWidget;
        window.toggleVoiceInput = toggleVoiceInput;
        window.captureScreenshot = captureScreenshot;
        window.clearAnnotations = clearAnnotations;
        window.setAnnotationTool = setAnnotationTool;
        window.submitFeedback = submitFeedback;

        // =====================
        // Status Narrator
        // =====================
        let narratorSpeech = null;
        let narratorData = null;
        let speechNarratorActive = false;
        let speechNarratorInterval = null;

        function toggleSpeechNarrator() {
            const blob = document.getElementById('narratorBlob');
            const wasActive = speechNarratorActive;
            speechNarratorActive = !speechNarratorActive;

            console.log('toggleSpeechNarrator: was=' + wasActive + ', now=' + speechNarratorActive);

            if (speechNarratorActive) {
                // Enable speech narrator
                blob.classList.add('active');
                blob.title = 'Speech narrator ON - click to disable';
                blob.innerHTML = ''; // Green mic
                localStorage.setItem('speechNarratorActive', 'true');
                showNotification(' Speech narrator ON', 'success');

                // Show the narrator panel with status summary
                const panel = document.getElementById('narratorPanel');
                if (panel.style.display === 'none' || !panel.style.display) {
                    panel.style.display = 'block';
                    // Update the panel data immediately
                    updateNarratorData();
                }

                // First, test audio works with a quick beep (Web Audio API)
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    oscillator.connect(gain);
                    gain.connect(audioCtx.destination);
                    oscillator.frequency.value = 440;
                    gain.gain.value = 0.1;
                    oscillator.start();
                    setTimeout(() => oscillator.stop(), 100);
                    console.log('Audio beep test passed');
                } catch (e) {
                    console.warn('Audio context test failed:', e);
                }

                // CRITICAL: Must be synchronous for Chrome user gesture requirement
                if ('speechSynthesis' in window) {
                    // Cancel any pending speech
                    window.speechSynthesis.cancel();

                    // Force-load voices by calling getVoices() - some browsers need this
                    let voices = window.speechSynthesis.getVoices();
                    console.log('Voices available:', voices.length);

                    const utterance = new SpeechSynthesisUtterance('Speech narrator activated. Loading status.');
                    utterance.rate = 1.0;
                    utterance.volume = 1.0;
                    utterance.lang = 'en-US';

                    // Try to set voice if available
                    if (voices.length > 0) {
                        const voice = voices.find(v => v.name === 'Samantha') ||
                                     voices.find(v => v.name.includes('Google')) ||
                                     voices.find(v => v.lang.startsWith('en')) ||
                                     voices[0];
                        if (voice) {
                            utterance.voice = voice;
                            console.log('Selected voice:', voice.name);
                        }
                    } else {
                        console.log('No voices loaded yet, using browser default');
                    }

                    utterance.onstart = () => {
                        console.log('Speech started successfully');
                        blob.classList.add('speaking');
                    };

                    utterance.onend = () => {
                        console.log('Intro speech ended, loading full status...');
                        blob.classList.remove('speaking');
                        updateNarratorData().then(() => speakStatus());
                    };

                    utterance.onerror = (e) => {
                        console.error('Speech error:', e.error, e);
                        blob.classList.remove('speaking');
                        // Common errors: 'canceled', 'interrupted', 'audio-busy', 'not-allowed'
                        if (e.error === 'not-allowed') {
                            showNotification('Speech blocked - check browser permissions', 'error');
                        } else if (e.error === 'canceled') {
                            console.log('Speech was canceled (normal if toggled off)');
                        } else {
                            showNotification('Speech error: ' + e.error, 'error');
                        }
                    };

                    // MUST call speak() synchronously in click handler
                    window.speechSynthesis.speak(utterance);
                    console.log('speak() called - pending:', window.speechSynthesis.pending, 'speaking:', window.speechSynthesis.speaking);
                } else {
                    showNotification('Speech not supported in this browser', 'error');
                }

                // Set up periodic updates (every 5 minutes)
                speechNarratorInterval = setInterval(() => {
                    if (speechNarratorActive) {
                        updateNarratorData().then(() => speakStatus());
                    }
                }, 300000); // 5 minutes
            } else {
                // Disable speech narrator
                blob.classList.remove('active');
                blob.classList.remove('speaking');
                blob.title = 'Speech narrator OFF - click to enable';
                blob.innerHTML = ''; // Muted mic
                localStorage.setItem('speechNarratorActive', 'false');
                stopSpeaking();
                showNotification(' Speech narrator OFF', 'info');

                // Hide the narrator panel
                const panel = document.getElementById('narratorPanel');
                if (panel) {
                    panel.style.display = 'none';
                }

                // Clear interval
                if (speechNarratorInterval) {
                    clearInterval(speechNarratorInterval);
                    speechNarratorInterval = null;
                }
            }
        }

        // Restore speech narrator state on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            const wasActive = localStorage.getItem('speechNarratorActive') === 'true';
            const blob = document.getElementById('narratorBlob');
            console.log('[Narrator] Restoring state: wasActive=' + wasActive);
            if (blob) {
                if (wasActive) {
                    blob.classList.add('active');
                    blob.title = 'Speech narrator ON - click to disable';
                    blob.innerHTML = '';
                    speechNarratorActive = true;
                } else {
                    blob.innerHTML = '';
                    blob.title = 'Speech narrator OFF - click to enable';
                    speechNarratorActive = false;
                }
                console.log('[Narrator] Blob element found and state restored');
            } else {
                console.error('[Narrator] Blob element not found!');
            }
        });

        function toggleNarratorPanel() {
            const panel = document.getElementById('narratorPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                updateNarratorData();
            }
        }

        function toggleNarratorWidget() {
            const container = document.getElementById('narratorContainer');
            const minimized = document.getElementById('narratorMinimized');
            const isCurrentlyMinimized = container.style.display === 'none';

            if (isCurrentlyMinimized) {
                // Expand
                container.style.display = 'flex';
                minimized.style.display = 'none';
                localStorage.setItem('narratorWidgetMinimized', 'false');
            } else {
                // Minimize - also close the panel if open
                document.getElementById('narratorPanel').style.display = 'none';
                container.style.display = 'none';
                minimized.style.display = 'flex';
                localStorage.setItem('narratorWidgetMinimized', 'true');
            }
        }

        // Restore narrator widget state on load
        (function restoreNarratorWidgetState() {
            const isMinimized = localStorage.getItem('narratorWidgetMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('narratorContainer').style.display = 'none';
                document.getElementById('narratorMinimized').style.display = 'flex';
            }
        })();

        async function updateNarratorData() {
            try {
                const [stats, sessions, queue] = await Promise.all([
                    api('/stats'),
                    api('/tmux/sessions'),
                    api('/autopilot/queue')
                ]);

                narratorData = { stats, sessions, queue };

                // Update time
                document.getElementById('narratorTime').textContent = 'Updated ' + new Date().toLocaleTimeString();

                // Calculate overall progress
                const totalFeatures = stats.features?.total || 0;
                const completedFeatures = stats.features?.completed || 0;
                const progress = totalFeatures > 0 ? Math.round((completedFeatures / totalFeatures) * 100) : 0;

                // Update progress ring
                const ring = document.getElementById('progressRing');
                const circumference = 314; // 2 * PI * 50
                const offset = circumference - (progress / 100 * circumference);
                ring.style.strokeDashoffset = offset;
                document.getElementById('progressPercent').textContent = progress + '%';

                // Update health indicator
                const healthDiv = document.getElementById('narratorHealth');
                const openErrors = stats.errors?.open?.count || 0;
                const criticalBugs = stats.bugs?.critical || 0;

                if (criticalBugs > 0 || openErrors > 5) {
                    healthDiv.innerHTML = `<div style="font-size: 48px; margin-bottom: 8px;"></div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--red, #f85149);">Needs Attention</div>`;
                } else if (openErrors > 0) {
                    healthDiv.innerHTML = `<div style="font-size: 48px; margin-bottom: 8px;"></div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--yellow, #d29922);">Minor Issues</div>`;
                } else {
                    healthDiv.innerHTML = `<div style="font-size: 48px; margin-bottom: 8px;"></div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--green, #3fb950);">System Healthy</div>`;
                }

                // Update stats grid
                const statsDiv = document.getElementById('narratorStats');
                const totalSessions = sessions.length;
                const attachedSessions = sessions.filter(s => s.attached).length;
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.projects || 0}</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.features?.in_progress || 0}</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.bugs?.open || 0}</div>
                        <div class="stat-label">Open Bugs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalSessions}</div>
                        <div class="stat-label">tmux Sessions${attachedSessions > 0 ? ` (${attachedSessions} attached)` : ''}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.nodes?.online || 0}</div>
                        <div class="stat-label">Nodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.errors?.open?.count || 0}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.tasks?.running || 0}</div>
                        <div class="stat-label">Tasks Running</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${queue.active_runs?.length || 0}</div>
                        <div class="stat-label">Active Runs</div>
                    </div>
                `;

                // Update sessions
                const sessionsDiv = document.getElementById('narratorSessions');
                // Show ALL sessions, not just attached ones
                sessionsDiv.innerHTML = sessions.length > 0
                    ? sessions.slice(0, 8).map(s => `
                        <div class="session-chip">
                            <span class="dot ${s.attached ? 'active' : (s.autopilot_run_id ? 'busy' : 'idle')}"></span>
                            ${s.session_name}
                        </div>
                    `).join('')
                    : '<span style="color: var(--text-secondary); font-size: 12px;">No tmux sessions</span>';

                // Generate summary
                const summaryDiv = document.getElementById('narratorSummary');
                const summary = generateStatusSummary(stats, sessions, queue);
                summaryDiv.textContent = summary;

            } catch (err) {
                console.error('Failed to update narrator:', err);
            }
        }

        function generateStatusSummary(stats, sessions, queue) {
            const parts = [];

            // Projects
            parts.push(`You have ${stats.projects || 0} projects`);

            // Features
            const inProgress = stats.features?.in_progress || 0;
            const completed = stats.features?.completed || 0;
            const total = stats.features?.total || 0;
            if (total > 0) {
                parts.push(`${completed} of ${total} features completed, ${inProgress} in progress`);
            }

            // Bugs
            const openBugs = stats.bugs?.open || 0;
            if (openBugs > 0) {
                parts.push(`${openBugs} open bugs need attention`);
            } else {
                parts.push('no open bugs');
            }

            // Tmux sessions - show total and attached
            const totalSessions = sessions.length;
            const attachedSessions = sessions.filter(s => s.attached).length;
            if (totalSessions > 0) {
                if (attachedSessions > 0) {
                    parts.push(`${totalSessions} tmux sessions running, ${attachedSessions} attached`);
                } else {
                    parts.push(`${totalSessions} tmux sessions running`);
                }
            }

            // Nodes status
            const nodesOnline = stats.nodes?.online || 0;
            if (nodesOnline > 0) {
                parts.push(`${nodesOnline} node${nodesOnline > 1 ? 's' : ''} online`);
            }

            // Workers status
            const runningTasks = stats.tasks?.running || 0;
            const completedTasks = stats.tasks?.completed || 0;
            if (runningTasks > 0) {
                parts.push(`${runningTasks} task${runningTasks > 1 ? 's' : ''} running`);
            }

            // Errors
            const openErrors = stats.errors?.open?.count || 0;
            if (openErrors > 0) {
                parts.push(`${openErrors} open error${openErrors > 1 ? 's' : ''}`);
            }

            // Autopilot
            const activeRuns = queue.active_runs?.length || 0;
            if (activeRuns > 0) {
                parts.push(`${activeRuns} autopilot runs executing`);
            }

            return parts.join('. ') + '.';
        }

        // Cache voices once loaded
        let cachedVoices = [];
        let voicesReady = false;

        function ensureVoicesLoaded() {
            return new Promise((resolve) => {
                if ('speechSynthesis' in window) {
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        cachedVoices = voices;
                        voicesReady = true;
                        resolve(voices);
                    } else {
                        // Wait for voices to load
                        window.speechSynthesis.onvoiceschanged = () => {
                            cachedVoices = window.speechSynthesis.getVoices();
                            voicesReady = true;
                            console.log('Voices loaded:', cachedVoices.length);
                            resolve(cachedVoices);
                        };
                        // Fallback timeout - some browsers never fire voiceschanged
                        setTimeout(() => {
                            if (!voicesReady) {
                                cachedVoices = window.speechSynthesis.getVoices();
                                console.log('Voices loaded (timeout):', cachedVoices.length);
                                resolve(cachedVoices);
                            }
                        }, 1000);
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // Speak text with voice - handles async voice loading
        async function speakText(text, options = {}) {
            if (!('speechSynthesis' in window)) {
                console.error('Speech synthesis not supported');
                showNotification('Speech not supported in this browser', 'error');
                return false;
            }

            // Ensure voices are loaded
            await ensureVoicesLoaded();

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = options.rate || 1.0;
            utterance.pitch = options.pitch || 1.0;
            utterance.volume = options.volume || 1.0;

            // Select best English voice
            if (cachedVoices.length > 0) {
                const preferredVoice = cachedVoices.find(v => v.name === 'Samantha') ||
                                       cachedVoices.find(v => v.name.includes('Google') && v.lang.startsWith('en')) ||
                                       cachedVoices.find(v => v.name.includes('English')) ||
                                       cachedVoices.find(v => v.lang.startsWith('en')) ||
                                       cachedVoices[0];
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log('Using voice:', preferredVoice.name);
                }
            }

            return new Promise((resolve, reject) => {
                utterance.onstart = () => console.log('Speech started:', text.substring(0, 50) + '...');
                utterance.onend = () => {
                    console.log('Speech ended');
                    resolve(true);
                };
                utterance.onerror = (e) => {
                    console.error('Speech error:', e.error);
                    logErrorToBackend({
                        type: 'speech_synthesis',
                        message: `Speech failed: ${e.error}`,
                        source: 'dashboard.html:speakText'
                    });
                    showNotification('Speech failed: ' + e.error, 'error');
                    reject(e);
                };

                window.speechSynthesis.speak(utterance);

                // Chrome bug workaround - keep speech alive
                const keepAlive = setInterval(() => {
                    if (!window.speechSynthesis.speaking) {
                        clearInterval(keepAlive);
                    } else {
                        window.speechSynthesis.pause();
                        window.speechSynthesis.resume();
                    }
                }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 10s
            });
        }

        // Initialize voices on page load
        if ('speechSynthesis' in window) {
            cachedVoices = window.speechSynthesis.getVoices();
            if (cachedVoices.length > 0) {
                voicesReady = true;
                console.log('Voices ready on load:', cachedVoices.length);
            }
            window.speechSynthesis.onvoiceschanged = () => {
                cachedVoices = window.speechSynthesis.getVoices();
                voicesReady = true;
                console.log('Voices loaded:', cachedVoices.length);
            };
        }

        function speakStatus() {
            console.log('speakStatus called, narratorData:', !!narratorData);

            if (!narratorData) {
                updateNarratorData().then(() => speakStatus());
                return;
            }

            const { stats, sessions, queue } = narratorData;

            // Build speech text
            let speech = "Here's your system status update. ";

            // Health
            const openErrors = stats.errors?.open?.count || 0;
            const criticalBugs = stats.bugs?.critical || 0;
            if (criticalBugs > 0) {
                speech += `Warning: You have ${criticalBugs} critical bugs that need immediate attention. `;
            } else if (openErrors > 5) {
                speech += "There are some errors that need your attention. ";
            } else {
                speech += "Your system is running smoothly. ";
            }

            // Progress
            const total = stats.features?.total || 0;
            const completed = stats.features?.completed || 0;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            speech += `Overall progress is at ${progress} percent. `;

            // Details
            speech += `You have ${stats.projects || 0} projects with ${stats.features?.in_progress || 0} features currently in progress. `;

            const openBugs = stats.bugs?.open || 0;
            if (openBugs > 0) {
                speech += `There are ${openBugs} open bugs. `;
            }

            // Sessions
            const activeSessions = sessions?.filter(s => s.attached)?.length || 0;
            const autopilotRuns = queue?.active_runs?.length || 0;
            if (autopilotRuns > 0) {
                speech += `${autopilotRuns} autopilot runs are currently executing across your sessions. `;
            } else if (activeSessions > 0) {
                speech += `${activeSessions} terminal sessions are active. `;
            }

            speech += "That's your current status.";

            console.log('Speech text:', speech);

            // Speak using Web Speech API
            if ('speechSynthesis' in window) {
                // Stop any current speech
                window.speechSynthesis.cancel();

                narratorSpeech = new SpeechSynthesisUtterance(speech);
                narratorSpeech.rate = 0.95;
                narratorSpeech.pitch = 1.0;
                narratorSpeech.volume = 1.0;

                // Use cached voices or try to get them
                let voices = cachedVoices.length > 0 ? cachedVoices : window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.length);

                if (voices.length > 0) {
                    // Priority order for English voices
                    const preferredVoice = voices.find(v => v.name === 'Google UK English Female') ||
                                           voices.find(v => v.name === 'Google US English') ||
                                           voices.find(v => v.name.includes('Samantha')) ||
                                           voices.find(v => v.name.includes('Karen')) ||
                                           voices.find(v => v.name.includes('Alex')) ||
                                           voices.find(v => v.lang.startsWith('en'));
                    if (preferredVoice) {
                        narratorSpeech.voice = preferredVoice;
                        console.log('Using voice:', preferredVoice.name);
                    }
                }

                // Show speaking indicator (if panel is open)
                const speakingIndicator = document.getElementById('speakingIndicator');
                const narratorBlob = document.getElementById('narratorBlob');

                if (speakingIndicator) speakingIndicator.style.display = 'block';
                if (narratorBlob) narratorBlob.classList.add('speaking');

                narratorSpeech.onstart = () => {
                    console.log('Speech started');
                };

                narratorSpeech.onend = () => {
                    console.log('Speech ended');
                    if (speakingIndicator) speakingIndicator.style.display = 'none';
                    if (narratorBlob) narratorBlob.classList.remove('speaking');
                };

                narratorSpeech.onerror = (event) => {
                    console.error('Speech error:', event.error);
                    logErrorToBackend({
                        type: 'speech_synthesis',
                        message: `Speech synthesis failed in speakStatus: ${event.error}`,
                        source: 'dashboard.html:speakStatus'
                    });
                    showNotification('Speech error: ' + event.error, 'error');
                    if (speakingIndicator) speakingIndicator.style.display = 'none';
                    if (narratorBlob) narratorBlob.classList.remove('speaking');
                };

                // Actually speak
                console.log('Calling speechSynthesis.speak()');
                window.speechSynthesis.speak(narratorSpeech);

                // Chrome bug workaround: speech can pause, keep it alive
                const resumeInterval = setInterval(() => {
                    if (!window.speechSynthesis.speaking) {
                        clearInterval(resumeInterval);
                    } else {
                        window.speechSynthesis.pause();
                        window.speechSynthesis.resume();
                    }
                }, 60000 * (typeof mobileMultiplier !== "undefined" ? mobileMultiplier : 1)); // Changed from 10s

            } else {
                showNotification('Text-to-speech not supported in this browser', 'error');
            }
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            const speakingIndicator = document.getElementById('speakingIndicator');
            const narratorBlob = document.getElementById('narratorBlob');
            if (speakingIndicator) speakingIndicator.style.display = 'none';
            if (narratorBlob) narratorBlob.classList.remove('speaking');
        }

        // Export narrator functions
        window.toggleNarratorPanel = toggleNarratorPanel;
        window.toggleNarratorWidget = toggleNarratorWidget;
        window.toggleSpeechNarrator = toggleSpeechNarrator;
        window.speakStatus = speakStatus;
        window.stopSpeaking = stopSpeaking;

        // Queue sorting and batch operations
        let queueSortBy = 'priority';
        let queueSortAsc = false;
        const priorityOrder = { critical: 0, high: 1, normal: 2, low: 3 };
        const statusOrder = { blocked: 0, incident: 1, executing: 2, testing: 3, planning: 4, created: 5, ready_for_review: 6 };
        let selectedQueueItems = new Set();

        function sortQueueItemsArray(items) {
            if (!items) return [];
            return [...items].sort((a, b) => {
                let cmp = 0;
                switch (queueSortBy) {
                    case 'priority': cmp = (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2); break;
                    case 'status': cmp = (statusOrder[a.status] || 5) - (statusOrder[b.status] || 5); break;
                    case 'date': cmp = new Date(b.created_at || 0) - new Date(a.created_at || 0); break;
                    case 'project': cmp = (a.project_name || '').localeCompare(b.project_name || ''); break;
                    case 'type': cmp = (a.item_type || '').localeCompare(b.item_type || ''); break;
                }
                return queueSortAsc ? -cmp : cmp;
            });
        }
        window.sortQueueItems = function() { queueSortBy = document.getElementById('queueSortBy').value; filterQueue(currentQueueFilter); };
        window.toggleQueueSortDir = function() { queueSortAsc = !queueSortAsc; document.getElementById('queueSortDir').textContent = queueSortAsc ? '' : ''; filterQueue(currentQueueFilter); };
        window.updateQueueSelection = function() {
            const checkboxes = document.querySelectorAll('.queue-item-checkbox');
            selectedQueueItems.clear();
            checkboxes.forEach(cb => { const item = cb.closest('.queue-item'); if (cb.checked) { selectedQueueItems.add(cb.dataset.id); item.classList.add('selected'); } else { item.classList.remove('selected'); } });
            document.getElementById('queueSelectedCount').textContent = selectedQueueItems.size;
            document.getElementById('queueBatchBar').style.display = selectedQueueItems.size > 0 ? 'flex' : 'none';
            const selectAll = document.getElementById('queueSelectAll');
            if (selectAll) { selectAll.checked = checkboxes.length > 0 && selectedQueueItems.size === checkboxes.length; selectAll.indeterminate = selectedQueueItems.size > 0 && selectedQueueItems.size < checkboxes.length; }
        };
        window.toggleQueueSelectAll = function(checked) { document.querySelectorAll('.queue-item-checkbox').forEach(cb => cb.checked = checked); updateQueueSelection(); };
        window.clearQueueSelection = function() { document.querySelectorAll('.queue-item-checkbox').forEach(cb => cb.checked = false); updateQueueSelection(); };
        window.batchApproveQueue = async function() {
            const items = getSelectedQueueItemsByType(['milestone', 'run']);
            if (items.length === 0) { showNotification('No milestones or runs selected', 'warning'); return; }
            for (const item of items) { try { if (item.type === 'milestone') await fetch(`/api/autopilot/milestones/${item.id}/approve`, { method: 'POST' }); else await fetch(`/api/autopilot/runs/${item.id}/status`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'approved' }) }); } catch (e) { console.error(e); } }
            showNotification(`Approved ${items.length} items`, 'success'); clearQueueSelection(); refreshQueue();
        };
        window.batchStartQueue = async function() {
            const items = getSelectedQueueItemsByType(['run']);
            if (items.length === 0) { showNotification('No runs selected', 'warning'); return; }
            for (const item of items) { try { await fetch(`/api/autopilot/runs/${item.id}/start`, { method: 'POST' }); } catch (e) { console.error(e); } }
            showNotification(`Started ${items.length} runs`, 'success'); clearQueueSelection(); refreshQueue();
        };
        window.batchDismissQueue = async function() {
            if (selectedQueueItems.size === 0) { showNotification('No items selected', 'warning'); return; }
            for (const id of selectedQueueItems) { try { await fetch(`/api/queue/${id}`, { method: 'DELETE' }); } catch (e) { console.error(e); } }
            showNotification(`Dismissed ${selectedQueueItems.size} items`, 'success'); clearQueueSelection(); refreshQueue();
        };
        window.showBatchAssignModal = function() { if (selectedQueueItems.size === 0) { showNotification('No items selected', 'warning'); return; } showModal('assignToTmux'); };
        function getSelectedQueueItemsByType(types) { const items = []; document.querySelectorAll('.queue-item-checkbox:checked').forEach(cb => { const item = cb.closest('.queue-item'); if (types.includes(item.dataset.itemType)) items.push({ id: cb.dataset.id, type: item.dataset.itemType }); }); return items; }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Restore UI state from localStorage
            restoreSidebarState();
            restoreFocusMode();
            restoreTheme();
            restoreAutoRefreshState();
            restoreQueueSessionsPane();

            // Initialize DataStore (centralized data management)
            await initDataStore();

            // Load core data
            await loadProjects();
            await loadStats();
            loadEnvironmentsStatus();

            // Load autopilot data
            await refreshQueue();
            await refreshEnvCheckout();
            await loadApps();

            // Check URL hash for direct linking (default to queue)
            const initialPanel = window.location.hash.slice(1) || 'queue';
            navigateToPanel(initialPanel);

            // Initialize terminal ResizeObserver (after short delay to ensure element exists)
            setTimeout(initTerminalResizeObserver, 500);

            // Check for first-time user and show tour
            checkFirstTimeUser();
        });
    </script>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="modal-shortcuts" style="display:none;">
        <div class="modal" style="max-width: 580px;">
            <div class="modal-header">
                <h2 class="modal-title"> Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="document.getElementById('modal-shortcuts').style.display='none'">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 12px;">Panel Navigation</h4>
                        <div class="shortcut-row"><kbd>1</kbd>-<kbd>9</kbd> <span>Quick panel switch</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>O</kbd> <span>Overview</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>P</kbd> <span>Projects</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>F</kbd> <span>Features</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>B</kbd> <span>Bugs</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>S</kbd> <span>Sessions</span></div>
                        <div class="shortcut-row"><kbd>G</kbd> <kbd>Q</kbd> <span>Queue</span></div>

                        <h4 style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin: 16px 0 12px;">List Navigation</h4>
                        <div class="shortcut-row"><kbd>J</kbd>/<kbd></kbd> <span>Move down</span></div>
                        <div class="shortcut-row"><kbd>K</kbd>/<kbd></kbd> <span>Move up</span></div>
                        <div class="shortcut-row"><kbd>Enter</kbd>/<kbd>O</kbd> <span>Open item</span></div>
                    </div>
                    <div>
                        <h4 style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 12px;">Actions</h4>
                        <div class="shortcut-row"><kbd>N</kbd> <span>New item</span></div>
                        <div class="shortcut-row"><kbd>R</kbd> <span>Refresh panel</span></div>
                        <div class="shortcut-row"><kbd>/</kbd> <span>Focus search</span></div>
                        <div class="shortcut-row"><kbd></kbd>+<kbd>K</kbd> <span>Global search</span></div>
                        <div class="shortcut-row"><kbd></kbd>+<kbd>S</kbd> <span>Save form</span></div>
                        <div class="shortcut-row"><kbd>Esc</kbd> <span>Close/Clear</span></div>

                        <h4 style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin: 16px 0 12px;">View</h4>
                        <div class="shortcut-row"><kbd></kbd>+<kbd></kbd>+<kbd>F</kbd> <span>Focus mode</span></div>
                        <div class="shortcut-row"><kbd></kbd>+<kbd></kbd>+<kbd>L</kbd> <span>Theme toggle</span></div>
                        <div class="shortcut-row"><kbd>[</kbd>/<kbd>]</kbd> <span>Toggle sidebar</span></div>
                        <div class="shortcut-row"><kbd>?</kbd> <span>This help</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .shortcut-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .shortcut-row kbd {
            display: inline-block;
            padding: 3px 6px;
            font-size: 11px;
            font-family: monospace;
            color: var(--text-primary);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            min-width: 22px;
            text-align: center;
        }
        .shortcut-row span {
            color: var(--text-secondary);
            margin-left: auto;
        }
        #modal-shortcuts .modal-overlay.active,
        #modal-shortcuts.active {
            display: flex !important;
        }
    </style>

    <script>

        // Mobile Detection - Disable aggressive refresh on mobile
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        // Extend intervals on mobile to save memory
        const mobileMultiplier = isMobile ? 3 : 1; // 3x longer on mobile

        // Mobile AJAX Throttling - Prevent browser overload
        if (isMobile) {
            const originalFetch = window.fetch;
            let fetchQueue = [];
            let processing = false;

            window.fetch = async function(...args) {
                // On mobile, queue AJAX requests to prevent overwhelming browser
                return new Promise((resolve, reject) => {
                    fetchQueue.push({ args, resolve, reject });
                    processQueue();
                });
            };

            async function processQueue() {
                if (processing || fetchQueue.length === 0) return;
                processing = true;

                const { args, resolve, reject } = fetchQueue.shift();
                try {
                    const result = await originalFetch(...args);
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    processing = false;
                    // Small delay between requests on mobile
                    if (fetchQueue.length > 0) {
                        setTimeout(processQueue, 100);
                    }
                }
            }
        }


        // ============================================================================
        // KEYBOARD SHORTCUTS SYSTEM
        // ============================================================================

        const KeyboardShortcuts = {
            lastKey: null,
            lastKeyTime: 0,
            selectedItemIndex: -1,
            enabled: true,

            // Panel mapping for number keys 1-9
            panelMap: {
                '1': 'overview',
                '2': 'projects',
                '3': 'milestones',
                '4': 'features',
                '5': 'bugs',
                '6': 'errors',
                '7': 'tmux',
                '8': 'queue',
                '9': 'nodes'
            },

            // G+X navigation sequences
            gotoMap: {
                'o': 'overview',
                'd': 'overview',
                'p': 'projects',
                'm': 'milestones',
                'f': 'features',
                'b': 'bugs',
                'e': 'errors',
                's': 'tmux',
                't': 'tmux',
                'q': 'queue',
                'n': 'nodes',
                'w': 'workers',
                'a': 'agents',
                'c': 'focus'
            },

            isTyping(e) {
                const tag = e.target.tagName;
                return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || e.target.isContentEditable;
            },

            isModalOpen() {
                const modals = document.querySelectorAll('.modal-overlay');
                for (const modal of modals) {
                    if (modal.style.display === 'flex' || modal.classList.contains('active')) return true;
                }
                return false;
            },

            closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                    modal.classList.remove('active');
                });
            },

            getListItems() {
                const selectors = {
                    'projects': '.project-card',
                    'features': '.feature-card, .feature-row, [data-feature-id]',
                    'bugs': '.bug-card, .bug-row, [data-bug-id]',
                    'errors': '.error-card, .error-row',
                    'tmux': '.session-item',
                    'queue': '.queue-item',
                    'nodes': '.node-card',
                    'milestones': '.milestone-card'
                };
                const selector = selectors[currentPanel];
                return selector ? Array.from(document.querySelectorAll(selector)) : [];
            },

            navigateList(direction) {
                const items = this.getListItems();
                if (items.length === 0) return;

                items.forEach(item => item.classList.remove('keyboard-selected'));

                if (direction === 'down') this.selectedItemIndex = Math.min(this.selectedItemIndex + 1, items.length - 1);
                else if (direction === 'up') this.selectedItemIndex = Math.max(this.selectedItemIndex - 1, 0);
                else if (direction === 'first') this.selectedItemIndex = 0;
                else if (direction === 'last') this.selectedItemIndex = items.length - 1;

                if (this.selectedItemIndex >= 0 && this.selectedItemIndex < items.length) {
                    const item = items[this.selectedItemIndex];
                    item.classList.add('keyboard-selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            },

            openSelectedItem() {
                const items = this.getListItems();
                if (this.selectedItemIndex >= 0 && this.selectedItemIndex < items.length) {
                    const item = items[this.selectedItemIndex];
                    const actionBtn = item.querySelector('.btn-primary, .action-btn, [onclick]');
                    if (actionBtn) actionBtn.click();
                    else item.click();
                }
            },

            resetSelection() {
                this.selectedItemIndex = -1;
                document.querySelectorAll('.keyboard-selected').forEach(el => el.classList.remove('keyboard-selected'));
            },

            showKeyIndicator(key) {
                let indicator = document.getElementById('keyIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'keyIndicator';
                    indicator.style.cssText = `
                        position: fixed; bottom: 100px; right: 20px;
                        background: var(--bg-tertiary); border: 1px solid var(--border);
                        border-radius: 8px; padding: 8px 16px; font-family: monospace;
                        font-size: 14px; color: var(--accent); z-index: 10000;
                        opacity: 0; transition: opacity 0.2s; pointer-events: none;
                    `;
                    document.body.appendChild(indicator);
                }
                indicator.textContent = key;
                indicator.style.opacity = '1';
                setTimeout(() => indicator.style.opacity = '0', 500);
            }
        };

        // Main keyboard event handler
        document.addEventListener('keydown', (e) => {
            if (!KeyboardShortcuts.enabled) return;

            const isTyping = KeyboardShortcuts.isTyping(e);
            const isModalOpen = KeyboardShortcuts.isModalOpen();
            const now = Date.now();

            // === GLOBAL SHORTCUTS (work even when typing) ===

            // Escape - Close modal or clear search
            if (e.key === 'Escape') {
                if (isModalOpen) {
                    e.preventDefault();
                    KeyboardShortcuts.closeAllModals();
                    return;
                }
                if (document.body.classList.contains('focus-mode')) {
                    e.preventDefault();
                    if (typeof toggleFocusMode === 'function') toggleFocusMode();
                    return;
                }
                const searchInput = document.getElementById('globalSearch') || document.getElementById('sessionFilter');
                if (searchInput && document.activeElement === searchInput) {
                    searchInput.value = '';
                    searchInput.blur();
                    return;
                }
                KeyboardShortcuts.resetSelection();
                return;
            }

            // Ctrl/Cmd + K - Global search
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('globalSearch');
                if (searchInput) { searchInput.focus(); searchInput.select(); }
                return;
            }

            // Ctrl/Cmd + S - Save current form
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                const saveBtn = document.querySelector('.modal-overlay[style*="flex"] .btn-primary, .modal-overlay.active .btn-primary');
                if (saveBtn) { saveBtn.click(); showNotification('Saved', 'success'); }
                return;
            }

            // Ctrl/Cmd + Shift + F - Toggle focus mode
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                if (typeof toggleFocusMode === 'function') toggleFocusMode();
                return;
            }

            // Ctrl/Cmd + Shift + L - Toggle theme
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'l') {
                e.preventDefault();
                if (typeof toggleTheme === 'function') toggleTheme();
                return;
            }

            // Don't process other shortcuts if typing
            if (isTyping) return;

            // Don't process navigation shortcuts if modal is open
            if (isModalOpen) return;

            // === PANEL SHORTCUTS ===

            // ? - Show shortcuts help
            if (e.key === '?') {
                e.preventDefault();
                const modal = document.getElementById('modal-shortcuts');
                if (modal) { modal.classList.add('active'); modal.style.display = 'flex'; }
                return;
            }

            // Number keys 1-9 - Quick panel navigation
            if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const panel = KeyboardShortcuts.panelMap[e.key];
                if (panel) {
                    e.preventDefault();
                    KeyboardShortcuts.showKeyIndicator(e.key);
                    if (typeof navigateToPanel === 'function') navigateToPanel(panel);
                    KeyboardShortcuts.resetSelection();
                }
                return;
            }

            // G+X sequences for navigation
            if (e.key.toLowerCase() === 'g' && !e.ctrlKey && !e.metaKey) {
                KeyboardShortcuts.lastKey = 'g';
                KeyboardShortcuts.lastKeyTime = now;
                KeyboardShortcuts.showKeyIndicator('g...');
                return;
            }

            if (KeyboardShortcuts.lastKey === 'g' && now - KeyboardShortcuts.lastKeyTime < 500) {
                KeyboardShortcuts.lastKey = null;
                const panel = KeyboardShortcuts.gotoMap[e.key.toLowerCase()];
                if (panel) {
                    e.preventDefault();
                    KeyboardShortcuts.showKeyIndicator('g' + e.key.toLowerCase());
                    if (typeof navigateToPanel === 'function') navigateToPanel(panel);
                    KeyboardShortcuts.resetSelection();
                }
                return;
            }

            if (KeyboardShortcuts.lastKey === 'g' && now - KeyboardShortcuts.lastKeyTime >= 500) {
                KeyboardShortcuts.lastKey = null;
            }

            // === ACTION SHORTCUTS ===

            // N - New item (context-aware)
            if (e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                const modalMap = {
                    'projects': 'newProject', 'features': 'newFeature', 'bugs': 'newBug',
                    'tmux': 'newTmuxSession', 'milestones': 'newMilestone', 'queue': 'newTask', 'nodes': 'addNode'
                };
                const modalName = modalMap[currentPanel];
                if (modalName && typeof showModal === 'function') showModal(modalName);
                else showNotification('Press N on a panel that supports creating items', 'info');
                return;
            }

            // R - Refresh current panel
            if (e.key.toLowerCase() === 'r' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (typeof loadPanelData === 'function') { loadPanelData(currentPanel); showNotification('Refreshed', 'info'); }
                return;
            }

            // / - Focus search/filter
            if (e.key === '/') {
                e.preventDefault();
                const filterInputs = [
                    document.getElementById('sessionFilter'), document.getElementById('projectFilter'),
                    document.getElementById('featureFilter'), document.getElementById('bugFilter'),
                    document.getElementById('globalSearch')
                ];
                for (const input of filterInputs) {
                    if (input && input.offsetParent !== null) { input.focus(); input.select(); return; }
                }
                return;
            }

            // [ or ] - Toggle sidebar
            if (e.key === '[' || e.key === ']') {
                e.preventDefault();
                if (typeof toggleSidebar === 'function') toggleSidebar();
                else document.body.classList.toggle('sidebar-collapsed');
                return;
            }

            // === LIST NAVIGATION (Vim-style J/K) ===

            // J or Down Arrow - Move down
            if (e.key.toLowerCase() === 'j' || e.key === 'ArrowDown') {
                e.preventDefault();
                KeyboardShortcuts.navigateList('down');
                return;
            }

            // K or Up Arrow - Move up
            if (e.key.toLowerCase() === 'k' || e.key === 'ArrowUp') {
                e.preventDefault();
                KeyboardShortcuts.navigateList('up');
                return;
            }

            // Enter or O - Open selected item
            if ((e.key === 'Enter' || e.key.toLowerCase() === 'o') && KeyboardShortcuts.selectedItemIndex >= 0) {
                e.preventDefault();
                KeyboardShortcuts.openSelectedItem();
                return;
            }

            // Home - Go to first item
            if (e.key === 'Home') {
                e.preventDefault();
                KeyboardShortcuts.navigateList('first');
                return;
            }

            // End or Shift+G - Go to last item
            if (e.key === 'End' || (e.key === 'G' && e.shiftKey)) {
                e.preventDefault();
                KeyboardShortcuts.navigateList('last');
                return;
            }

            // === PAGE NAVIGATION ===

            // Page Down - Jump 10 items down
            if (e.key === 'PageDown') {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (items.length > 0) {
                    items.forEach(item => item.classList.remove('keyboard-selected'));
                    KeyboardShortcuts.selectedItemIndex = Math.min(KeyboardShortcuts.selectedItemIndex + 10, items.length - 1);
                    if (KeyboardShortcuts.selectedItemIndex < 0) KeyboardShortcuts.selectedItemIndex = 0;
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    item.classList.add('keyboard-selected');
                    item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
                return;
            }

            // Page Up - Jump 10 items up
            if (e.key === 'PageUp') {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (items.length > 0) {
                    items.forEach(item => item.classList.remove('keyboard-selected'));
                    KeyboardShortcuts.selectedItemIndex = Math.max(KeyboardShortcuts.selectedItemIndex - 10, 0);
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    item.classList.add('keyboard-selected');
                    item.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
                return;
            }

            // Space - Toggle checkbox/selection on current item
            if (e.key === ' ' && KeyboardShortcuts.selectedItemIndex >= 0) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (KeyboardShortcuts.selectedItemIndex < items.length) {
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        item.classList.toggle('multi-selected');
                    }
                }
                return;
            }

            // Shift + Up/Down or J/K - Multi-select
            if (e.shiftKey && (e.key === 'ArrowDown' || e.key.toLowerCase() === 'j')) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (items.length > 0 && KeyboardShortcuts.selectedItemIndex >= 0) {
                    const currentItem = items[KeyboardShortcuts.selectedItemIndex];
                    const checkbox = currentItem.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                    else currentItem.classList.add('multi-selected');
                }
                KeyboardShortcuts.navigateList('down');
                return;
            }

            if (e.shiftKey && (e.key === 'ArrowUp' || e.key.toLowerCase() === 'k')) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (items.length > 0 && KeyboardShortcuts.selectedItemIndex >= 0) {
                    const currentItem = items[KeyboardShortcuts.selectedItemIndex];
                    const checkbox = currentItem.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                    else currentItem.classList.add('multi-selected');
                }
                KeyboardShortcuts.navigateList('up');
                return;
            }

            // X - Toggle select current item (like email clients)
            if (e.key.toLowerCase() === 'x' && KeyboardShortcuts.selectedItemIndex >= 0) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (KeyboardShortcuts.selectedItemIndex < items.length) {
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
                KeyboardShortcuts.navigateList('down');
                return;
            }

            // Ctrl/Cmd + A - Select all items
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a' && !isTyping) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                const checkboxes = items.map(item => item.querySelector('input[type="checkbox"]')).filter(Boolean);
                const allChecked = checkboxes.every(cb => cb.checked);
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                    cb.dispatchEvent(new Event('change', { bubbles: true }));
                });
                showNotification(allChecked ? 'Deselected all' : `Selected ${checkboxes.length} items`, 'info');
                return;
            }

            // E - Edit selected item
            if (e.key.toLowerCase() === 'e' && KeyboardShortcuts.selectedItemIndex >= 0) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (KeyboardShortcuts.selectedItemIndex < items.length) {
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    const editBtn = item.querySelector('[onclick*="edit"], .edit-btn, [title*="Edit"]');
                    if (editBtn) editBtn.click();
                    else KeyboardShortcuts.openSelectedItem();
                }
                return;
            }

            // D - Delete selected item (with confirmation)
            if (e.key.toLowerCase() === 'd' && KeyboardShortcuts.selectedItemIndex >= 0 && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                const items = KeyboardShortcuts.getListItems();
                if (KeyboardShortcuts.selectedItemIndex < items.length) {
                    const item = items[KeyboardShortcuts.selectedItemIndex];
                    const deleteBtn = item.querySelector('[onclick*="delete"], .delete-btn, [title*="Delete"]');
                    if (deleteBtn) {
                        if (confirm('Delete this item?')) deleteBtn.click();
                    }
                }
                return;
            }

            // Tab - Move to next section/table (within panel)
            if (e.key === 'Tab' && !e.shiftKey && !isTyping) {
                const activePanel = document.querySelector('.panel-content:not(.hidden)')?.id.replace('panel-', '') || 'overview';
                const sections = document.querySelectorAll(`#panel-${activePanel} .table-container, #panel-${activePanel} .card-grid, #panel-${activePanel} .list-container`);
                if (sections.length > 1) {
                    e.preventDefault();
                    KeyboardShortcuts.currentSectionIndex = (KeyboardShortcuts.currentSectionIndex || 0) + 1;
                    if (KeyboardShortcuts.currentSectionIndex >= sections.length) KeyboardShortcuts.currentSectionIndex = 0;
                    sections[KeyboardShortcuts.currentSectionIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    KeyboardShortcuts.resetSelection();
                    showNotification(`Section ${KeyboardShortcuts.currentSectionIndex + 1} of ${sections.length}`, 'info');
                }
                return;
            }

            // === TMUX PANEL SHORTCUTS ===
            const activePanel = document.querySelector('.panel-content:not(.hidden)')?.id.replace('panel-', '') || 'overview';
            if (activePanel === 'tmux' && e.key.length === 1 && !e.metaKey && !e.ctrlKey && !e.altKey) {
                const tmuxInput = document.getElementById('tmuxInput');
                if (tmuxInput && !['?', '/', 'j', 'k', 'n', 'r', 'g', '[', ']', 'o', 'x', 'e', 'd'].includes(e.key.toLowerCase())) {
                    tmuxInput.focus();
                    return;
                }
            }

            KeyboardShortcuts.lastKey = null;
        });

        // Add CSS for keyboard selection and multi-select
        const keyboardStyles = document.createElement('style');
        keyboardStyles.textContent = `
            .keyboard-selected {
                outline: 2px solid var(--accent) !important;
                outline-offset: 2px;
                background: var(--bg-hover) !important;
            }
            .multi-selected {
                background: rgba(88, 166, 255, 0.15) !important;
                border-left: 3px solid var(--accent) !important;
            }
            .keyboard-selected.multi-selected {
                outline: 2px solid var(--success) !important;
            }
            /* Keyboard navigation hints */
            [data-kbd-hint]::after {
                content: attr(data-kbd-hint);
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 10px;
                color: var(--text-secondary);
                opacity: 0;
                transition: opacity 0.2s;
            }
            .keyboard-nav-active [data-kbd-hint]::after {
                opacity: 0.6;
            }
        `;
        document.head.appendChild(keyboardStyles);

        // Track keyboard navigation mode
        KeyboardShortcuts.currentSectionIndex = 0;
        let keyboardNavTimeout;
        document.addEventListener('keydown', () => {
            document.body.classList.add('keyboard-nav-active');
            clearTimeout(keyboardNavTimeout);
            keyboardNavTimeout = setTimeout(() => document.body.classList.remove('keyboard-nav-active'), 3000);
        });
        document.addEventListener('mousedown', () => document.body.classList.remove('keyboard-nav-active'));

        // Update global status bar
        function updateStatusBar() {
            const lastSync = document.getElementById('statusLastSync');
            const connectionDot = document.getElementById('statusConnectionDot');

            if (lastSync) {
                lastSync.textContent = new Date().toLocaleTimeString();
            }

            // Update connection status based on last successful API call
            if (connectionDot) {
                connectionDot.className = 'status-bar-dot pulse';
            }
        }

        // Update status bar periodically
        setInterval(updateStatusBar, 30000);

        // === Gamification System ===
        const ACHIEVEMENTS = {
            first_task: { icon: '', name: 'First Steps', desc: 'Complete your first task' },
            streak_3: { icon: '', name: 'On Fire', desc: '3-day activity streak' },
            streak_7: { icon: '', name: 'Week Warrior', desc: '7-day activity streak' },
            bugs_10: { icon: '', name: 'Bug Squasher', desc: 'Fix 10 bugs' },
            features_5: { icon: '', name: 'Feature Builder', desc: 'Complete 5 features' },
            early_bird: { icon: '', name: 'Early Bird', desc: 'Log in before 7 AM' },
            night_owl: { icon: '', name: 'Night Owl', desc: 'Work past midnight' }
        };

        function showAchievement(achievementId) {
            const achievement = ACHIEVEMENTS[achievementId];
            if (!achievement) return;

            // Check if already earned
            const earned = JSON.parse(localStorage.getItem('earnedAchievements') || '[]');
            if (earned.includes(achievementId)) return;

            // Save achievement
            earned.push(achievementId);
            localStorage.setItem('earnedAchievements', JSON.stringify(earned));

            // Create toast
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-content">
                    <h4>Achievement Unlocked!</h4>
                    <p>${achievement.name}</p>
                </div>
            `;
            document.body.appendChild(toast);

            // Remove after animation
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);

            // Award XP
            addXP(50);
        }

        function addXP(amount) {
            let xp = parseInt(localStorage.getItem('userXP') || '0');
            xp += amount;
            localStorage.setItem('userXP', xp.toString());
            updateXPDisplay();
        }

        function getLevel(xp) {
            // 100 XP per level, exponential curve
            return Math.floor(Math.sqrt(xp / 50)) + 1;
        }

        function updateXPDisplay() {
            const xp = parseInt(localStorage.getItem('userXP') || '0');
            const level = getLevel(xp);
            const xpForCurrentLevel = Math.pow(level - 1, 2) * 50;
            const xpForNextLevel = Math.pow(level, 2) * 50;
            const progress = ((xp - xpForCurrentLevel) / (xpForNextLevel - xpForCurrentLevel)) * 100;

            const levelEl = document.getElementById('userLevel');
            const fillEl = document.getElementById('xpFill');
            const textEl = document.getElementById('xpText');

            if (levelEl) levelEl.textContent = `Lv.${level}`;
            if (fillEl) fillEl.style.width = `${progress}%`;
            if (textEl) textEl.textContent = `${xp - xpForCurrentLevel} / ${xpForNextLevel - xpForCurrentLevel} XP`;
        }

        function checkDailyStreak() {
            const lastActive = localStorage.getItem('lastActiveDate');
            const today = new Date().toDateString();

            if (lastActive !== today) {
                let streak = parseInt(localStorage.getItem('activityStreak') || '0');

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastActive === yesterday.toDateString()) {
                    streak++;
                    if (streak === 3) showAchievement('streak_3');
                    if (streak === 7) showAchievement('streak_7');
                } else if (lastActive) {
                    streak = 1; // Reset streak
                } else {
                    streak = 1; // First day
                }

                localStorage.setItem('activityStreak', streak.toString());
                localStorage.setItem('lastActiveDate', today);
                addXP(10); // Daily login XP

                updateStreakDisplay();
            }
        }

        function updateStreakDisplay() {
            const streak = parseInt(localStorage.getItem('activityStreak') || '0');
            const streakEl = document.getElementById('streakCount');
            if (streakEl) streakEl.textContent = streak;
        }

        // Check time-based achievements
        function checkTimeAchievements() {
            const hour = new Date().getHours();
            if (hour < 7) showAchievement('early_bird');
            if (hour >= 0 && hour < 5) showAchievement('night_owl');
        }

        // Initialize gamification on load
        document.addEventListener('DOMContentLoaded', () => {
            checkDailyStreak();
            checkTimeAchievements();
            updateXPDisplay();
            updateStreakDisplay();
        });
    </script>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" data-tooltip="Toggle Light/Dark Mode (L)" data-tooltip-pos="left">
        <span id="themeIcon"></span>
    </button>

    <!-- Global Status Bar -->
    <div class="global-status-bar" id="globalStatusBar">
        <div class="status-bar-left">
            <div class="status-bar-item">
                <span class="status-bar-dot pulse" id="statusConnectionDot"></span>
                <span>Connected</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span>Last sync:</span>
                <span id="statusLastSync">--:--:--</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span id="statusWorkers">Workers: --</span>
            </div>
        </div>
        <div class="status-bar-right">
            <div class="status-bar-item">
                <span id="statusProjects">0 projects</span>
            </div>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item">
                <span id="statusTasks">0 tasks</span>
            </div>
            <div class="status-bar-divider"></div>
            <span class="status-bar-link" onclick="toggleFocusMode()" data-tooltip="Hide status bar" data-tooltip-pos="left"> Focus</span>
            <div class="status-bar-divider"></div>
            <div class="status-bar-item" id="sessionTimeIndicator" style="cursor: pointer;" onclick="refreshSession()" data-tooltip="Click to extend session" data-tooltip-pos="left">
                <span> Session: <span id="sessionTimeRemaining">--:--</span></span>
            </div>
        </div>
    </div>

    <!-- Session Timeout Warning Modal -->
    <div class="modal-overlay" id="modal-session-warning" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3> Session Expiring</h3>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p style="font-size: 16px; margin-bottom: 15px;">Your session will expire in:</p>
                <div id="sessionCountdown" style="font-size: 48px; font-weight: bold; color: var(--accent); margin: 20px 0;">5:00</div>
                <p style="color: var(--text-secondary);">Click "Stay Logged In" to continue working, or you will be automatically logged out.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="logoutNow()">Logout Now</button>
                <button class="btn btn-primary" onclick="extendSession()">Stay Logged In</button>
            </div>
        </div>
    </div>

    <script>
        // Session Timeout Management
        const SessionManager = {
            checkInterval: null,
            countdownInterval: null,
            warningShown: false,
            warningThreshold: 300, // 5 minutes
            sessionTimeout: 3600,  // Default 1 hour, updated from server

            init() {
                this.checkSession();
                // Check session status every 30 seconds
                this.checkInterval = setInterval(() => this.checkSession(), 30000);
            },

            async checkSession() {
                try {
                    const response = await fetch('/api/session/status');
                    if (response.status === 401) {
                        // Session expired, redirect to login
                        window.location.href = '/login?expired=1';
                        return;
                    }

                    const data = await response.json();
                    this.sessionTimeout = data.timeout_seconds;
                    this.warningThreshold = data.warning_threshold || 300;
                    this.updateDisplay(data.remaining_seconds);

                    // Show warning if within threshold
                    if (data.remaining_seconds <= this.warningThreshold && !this.warningShown) {
                        this.showWarning(data.remaining_seconds);
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
            },

            updateDisplay(remainingSeconds) {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                const indicator = document.getElementById('sessionTimeRemaining');
                if (indicator) {
                    indicator.textContent = display;

                    // Change color based on time remaining
                    const container = document.getElementById('sessionTimeIndicator');
                    if (remainingSeconds <= 60) {
                        container.style.color = '#e74c3c'; // Red
                    } else if (remainingSeconds <= this.warningThreshold) {
                        container.style.color = '#f39c12'; // Orange
                    } else {
                        container.style.color = ''; // Default
                    }
                }
            },

            showWarning(remainingSeconds) {
                this.warningShown = true;
                const modal = document.getElementById('modal-session-warning');
                modal.style.display = 'flex';

                // Start countdown
                let countdown = remainingSeconds;
                this.updateCountdownDisplay(countdown);

                this.countdownInterval = setInterval(() => {
                    countdown--;
                    this.updateCountdownDisplay(countdown);
                    this.updateDisplay(countdown);

                    if (countdown <= 0) {
                        this.logout();
                    }
                }, 1000);
            },

            updateCountdownDisplay(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                const display = `${minutes}:${secs.toString().padStart(2, '0')}`;
                const el = document.getElementById('sessionCountdown');
                if (el) {
                    el.textContent = display;
                    // Red when under 1 minute
                    el.style.color = seconds <= 60 ? '#e74c3c' : 'var(--accent)';
                }
            },

            async extend() {
                try {
                    const response = await fetch('/api/session/keepalive', { method: 'POST' });
                    if (response.ok) {
                        this.hideWarning();
                        this.checkSession();
                        showToast('Session extended', 'success');
                    }
                } catch (error) {
                    console.error('Failed to extend session:', error);
                    showToast('Failed to extend session', 'error');
                }
            },

            hideWarning() {
                this.warningShown = false;
                const modal = document.getElementById('modal-session-warning');
                modal.style.display = 'none';
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
            },

            logout() {
                window.location.href = '/logout';
            }
        };

        // Global functions for buttons
        function extendSession() {
            SessionManager.extend();
        }

        function logoutNow() {
            SessionManager.logout();
        }

        function refreshSession() {
            SessionManager.extend();
        }

        // Initialize session management on page load
        document.addEventListener('DOMContentLoaded', () => {
            SessionManager.init();
        });
    </script>
    <!-- Inline Editing Module -->
    <script src="/static/js/inlineEdit.js"></script>

    <!-- Quick Create FAB and Modal -->
    <style>
        /* Floating Action Button */
        .quick-create-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c4dff 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(94, 53, 177, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 24px;
            color: white;
        }
        .quick-create-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(94, 53, 177, 0.5);
        }
        .quick-create-fab.open {
            transform: rotate(45deg);
        }

        /* Quick Create Modal */
        .quick-create-modal {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 380px;
            max-height: 500px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 999;
            overflow: hidden;
        }
        .quick-create-modal.show {
            display: block;
            animation: slideUp 0.2s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quick-create-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-create-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .quick-create-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        .quick-create-tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .quick-create-tab:hover {
            color: var(--text-primary);
        }
        .quick-create-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .quick-create-body {
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }
        .quick-create-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 12px;
        }
        .quick-create-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .quick-create-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        .quick-create-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 13px;
        }
        .quick-create-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .quick-create-btn:hover {
            background: #7c4dff;
        }
        .quick-create-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        .quick-input-mode {
            background: var(--background-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .quick-input-mode textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-background);
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            font-family: monospace;
        }
    </style>

    <!-- Floating Action Button -->
    <button class="quick-create-fab" id="quickCreateFab" onclick="toggleQuickCreate()" title="Quick Create">
        +
    </button>

    <!-- Quick Create Panel -->
    <div class="quick-create-modal" id="quickCreateModal">
        <div class="quick-create-header">
            <h3>Quick Create</h3>
            <button onclick="toggleQuickCreate()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px;">&times;</button>
        </div>
        <div class="quick-create-tabs">
            <button class="quick-create-tab active" data-type="quick">Quick Input</button>
            <button class="quick-create-tab" data-type="feature">Feature</button>
            <button class="quick-create-tab" data-type="bug">Bug</button>
            <button class="quick-create-tab" data-type="task">Task</button>
        </div>
        <div class="quick-create-body">
            <!-- Quick Input Mode -->
            <div id="quickInputPanel">
                <div class="quick-input-mode">
                    <textarea id="quickInputText" placeholder="feature: Add login page @1 #high&#10;bug: Button broken @2 !critical +john&#10;task: Run tests"></textarea>
                </div>
                <div class="quick-create-hint">
                    Syntax: <code>@N</code> project, <code>%N</code> milestone, <code>#priority</code>, <code>!severity</code>, <code>+user</code>
                </div>
                <button class="quick-create-btn" onclick="parseAndCreate()">Create</button>
            </div>

            <!-- Feature Form -->
            <div id="quickFeaturePanel" style="display: none;">
                <input type="text" class="quick-create-input" id="quickFeatureName" placeholder="Feature name">
                <div class="quick-create-row">
                    <select id="quickFeatureProject"></select>
                    <select id="quickFeaturePriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <button class="quick-create-btn" onclick="quickCreateFeature()">Create Feature</button>
            </div>

            <!-- Bug Form -->
            <div id="quickBugPanel" style="display: none;">
                <input type="text" class="quick-create-input" id="quickBugTitle" placeholder="Bug title">
                <div class="quick-create-row">
                    <select id="quickBugProject"></select>
                    <select id="quickBugSeverity">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <button class="quick-create-btn" onclick="quickCreateBug()">Create Bug</button>
            </div>

            <!-- Task Form -->
            <div id="quickTaskPanel" style="display: none;">
                <input type="text" class="quick-create-input" id="quickTaskName" placeholder="Task description">
                <div class="quick-create-row">
                    <select id="quickTaskType">
                        <option value="shell">Shell</option>
                        <option value="python">Python</option>
                        <option value="git">Git</option>
                        <option value="deploy">Deploy</option>
                        <option value="test">Test</option>
                        <option value="build">Build</option>
                    </select>
                    <select id="quickTaskPriority">
                        <option value="0">Normal (0)</option>
                        <option value="5">Medium (5)</option>
                        <option value="10">High (10)</option>
                    </select>
                </div>
                <button class="quick-create-btn" onclick="quickCreateTask()">Create Task</button>
            </div>
        </div>
    </div>

    <script>
        // Quick Create Module
        const QuickCreate = {
            isOpen: false,
            options: null,

            async init() {
                // Load options (endpoint not yet implemented)
                try {
                    const resp = await fetch('/api/quick-create/options');
                    if (resp.ok) {
                        this.options = await resp.json();
                        this.populateSelects();
                    } else if (resp.status === 401 || resp.status === 404) {
                        // Endpoint not available yet, use defaults
                        console.debug('Quick create options not available, using defaults');
                    }
                } catch (e) {
                    // Silently fail - endpoint not critical for dashboard operation
                    console.debug('Quick create options unavailable:', e.message);
                }

                // Tab switching
                document.querySelectorAll('.quick-create-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.type));
                });

                // Keyboard shortcut (Ctrl+Shift+N)
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'N') {
                        e.preventDefault();
                        toggleQuickCreate();
                    }
                });
            },

            populateSelects() {
                const projects = this.options?.projects || [];
                const projectHtml = projects.map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');

                ['quickFeatureProject', 'quickBugProject'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '<option value="">Select project</option>' + projectHtml;
                });
            },

            switchTab(type) {
                document.querySelectorAll('.quick-create-tab').forEach(t =>
                    t.classList.toggle('active', t.dataset.type === type)
                );

                ['quickInputPanel', 'quickFeaturePanel', 'quickBugPanel', 'quickTaskPanel'].forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });

                const panelMap = {
                    'quick': 'quickInputPanel',
                    'feature': 'quickFeaturePanel',
                    'bug': 'quickBugPanel',
                    'task': 'quickTaskPanel'
                };
                document.getElementById(panelMap[type]).style.display = 'block';
            }
        };

        function toggleQuickCreate() {
            const fab = document.getElementById('quickCreateFab');
            const modal = document.getElementById('quickCreateModal');
            QuickCreate.isOpen = !QuickCreate.isOpen;
            fab.classList.toggle('open', QuickCreate.isOpen);
            modal.classList.toggle('show', QuickCreate.isOpen);

            if (QuickCreate.isOpen && !QuickCreate.options) {
                QuickCreate.init();
            }
        }

        async function parseAndCreate() {
            const text = document.getElementById('quickInputText').value.trim();
            if (!text) return;

            try {
                const resp = await fetch('/api/quick-create/parse-and-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, project_id: 1 })  // Default project
                });

                const data = await resp.json();
                if (resp.ok) {
                    showToast(`Created ${data.entity_type} #${data.id}`, 'success');
                    document.getElementById('quickInputText').value = '';
                    toggleQuickCreate();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to create', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function quickCreateFeature() {
            const name = document.getElementById('quickFeatureName').value.trim();
            const project_id = document.getElementById('quickFeatureProject').value;
            const priority = document.getElementById('quickFeaturePriority').value;

            if (!name || !project_id) {
                showToast('Name and project are required', 'warning');
                return;
            }

            try {
                const resp = await fetch('/api/quick-create/feature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, project_id: parseInt(project_id), priority })
                });

                const data = await resp.json();
                if (resp.ok) {
                    showToast(`Created feature #${data.id}`, 'success');
                    document.getElementById('quickFeatureName').value = '';
                    toggleQuickCreate();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to create', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function quickCreateBug() {
            const title = document.getElementById('quickBugTitle').value.trim();
            const project_id = document.getElementById('quickBugProject').value;
            const severity = document.getElementById('quickBugSeverity').value;

            if (!title || !project_id) {
                showToast('Title and project are required', 'warning');
                return;
            }

            try {
                const resp = await fetch('/api/quick-create/bug', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, project_id: parseInt(project_id), severity })
                });

                const data = await resp.json();
                if (resp.ok) {
                    showToast(`Created bug #${data.id}`, 'success');
                    document.getElementById('quickBugTitle').value = '';
                    toggleQuickCreate();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to create', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function quickCreateTask() {
            const name = document.getElementById('quickTaskName').value.trim();
            const task_type = document.getElementById('quickTaskType').value;
            const priority = parseInt(document.getElementById('quickTaskPriority').value);

            if (!name) {
                showToast('Task description is required', 'warning');
                return;
            }

            try {
                const resp = await fetch('/api/quick-create/task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_type,
                        priority,
                        name,
                        task_data: { name, description: name }
                    })
                });

                const data = await resp.json();
                if (resp.ok) {
                    showToast(`Created task #${data.id}`, 'success');
                    document.getElementById('quickTaskName').value = '';
                    toggleQuickCreate();
                    loadStats();
                } else {
                    showToast(data.error || 'Failed to create', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            QuickCreate.init();
        });
        // ============================================================================
        // Token Tracking Functions
        // ============================================================================

        async function refreshTokenMetrics() {
            try {
                // Fetch global and session metrics
                const metricsResp = await api('/api/tokens/metrics');

                // Handle 404 gracefully (endpoint not yet implemented)
                if (metricsResp.status === 404) {
                    console.log('Token metrics endpoint not available yet');
                    return;
                }

                if (!metricsResp.ok) throw new Error('Failed to fetch metrics');
                const metrics = await metricsResp.json();

                // Update global metrics cards
                updateGlobalMetrics(metrics.global);

                // Update session breakdown table
                updateSessionMetrics(metrics.sessions);

                // Fetch recent tasks with token details
                const tasksResp = await api('/api/tokens/tasks?limit=50');
                if (tasksResp.ok) {
                    const tasks = await tasksResp.json();
                    updateTaskTokensTable(tasks.tasks);
                }

            } catch (error) {
                console.error('Error refreshing token metrics:', error);
                // Only show error if it's not a 404 (endpoint not found)
                if (!error.message.includes('404')) {
                    showToast('Failed to load token metrics', 'error');
                }
            }
        }

        function updateGlobalMetrics(global) {
            // Tokens/Hour
            document.getElementById('tokensHourValue').textContent = global.tokens_hour.toLocaleString();
            document.getElementById('tokensHourProgress').style.width = `${global.usage_percent.tokens_hour}%`;
            document.getElementById('tokensHourPercent').textContent = `${global.usage_percent.tokens_hour.toFixed(1)}%`;

            // Color code progress bar based on usage
            const tokensHourBar = document.getElementById('tokensHourProgress');
            if (global.usage_percent.tokens_hour >= 90) {
                tokensHourBar.style.background = '#ef4444'; // Red
            } else if (global.usage_percent.tokens_hour >= 80) {
                tokensHourBar.style.background = '#f59e0b'; // Orange
            } else {
                tokensHourBar.style.background = 'var(--accent)'; // Cyan
            }

            // Tokens/Day
            document.getElementById('tokensDayValue').textContent = global.tokens_day.toLocaleString();
            document.getElementById('tokensDayProgress').style.width = `${global.usage_percent.tokens_day}%`;
            document.getElementById('tokensDayPercent').textContent = `${global.usage_percent.tokens_day.toFixed(1)}%`;

            // Cost/Hour
            document.getElementById('costHourValue').textContent = `$${global.cost_hour.toFixed(2)}`;
            document.getElementById('costHourProgress').style.width = `${global.usage_percent.cost_hour}%`;
            document.getElementById('costHourPercent').textContent = `${global.usage_percent.cost_hour.toFixed(1)}%`;

            // Cost/Day
            document.getElementById('costDayValue').textContent = `$${global.cost_day.toFixed(2)}`;
            document.getElementById('costDayProgress').style.width = `${global.usage_percent.cost_day}%`;
            document.getElementById('costDayPercent').textContent = `${global.usage_percent.cost_day.toFixed(1)}%`;
        }

        function updateSessionMetrics(sessions) {
            const tbody = document.getElementById('sessionMetricsTable');

            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            No session data available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sessions.map(session => {
                const throttleIcon = {
                    'none': '',
                    'warning': '',
                    'soft': '',
                    'hard': '',
                    'critical': ''
                }[session.throttle_level] || '';

                return `
                    <tr>
                        <td><code>${session.session_id}</code></td>
                        <td>${session.task_count}</td>
                        <td>${session.tokens_hour.toLocaleString()}</td>
                        <td>${session.tokens_day.toLocaleString()}</td>
                        <td>$${session.cost_hour.toFixed(4)}</td>
                        <td>$${session.cost_day.toFixed(4)}</td>
                        <td>
                            ${throttleIcon} <span style="text-transform: uppercase; font-size: 11px;">${session.throttle_level}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateTaskTokensTable(tasks) {
            const tbody = document.getElementById('taskTokensTable');

            if (!tasks || tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            No recent tasks found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                const statusBadge = {
                    'completed': '<span class="badge badge-success">Completed</span>',
                    'running': '<span class="badge badge-info">Running</span>',
                    'pending': '<span class="badge badge-warning">Pending</span>',
                    'failed': '<span class="badge badge-danger">Failed</span>'
                }[task.status] || '<span class="badge">Unknown</span>';

                const tokensIn = task.tokens_in || 0;
                const tokensOut = task.tokens_out || tokensIn; // Fallback to estimate
                const cost = task.cost || ((tokensOut / 1000) * 0.003); // Estimate if not provided

                const duration = task.duration ? `${task.duration.toFixed(1)}s` : '-';
                const model = task.model || task.delegated_type || 'unknown';

                return `
                    <tr>
                        <td>#${task.id}</td>
                        <td><code style="font-size: 11px;">${task.type || 'task'}</code></td>
                        <td><code style="font-size: 11px;">${task.session_id || 'none'}</code></td>
                        <td>${statusBadge}</td>
                        <td style="text-align: right;">${tokensIn.toLocaleString()}</td>
                        <td style="text-align: right;">${tokensOut.toLocaleString()}</td>
                        <td style="text-align: right;">$${cost.toFixed(4)}</td>
                        <td><code style="font-size: 10px;">${model}</code></td>
                        <td style="font-size: 11px; color: var(--text-tertiary);">${duration}</td>
                    </tr>
                `;
            }).join('');
        }

        // Auto-refresh token metrics when panel is visible
        setInterval(() => {
            const tokenPanel = document.getElementById('panel-tokens');
            if (tokenPanel && !tokenPanel.classList.contains('hidden')) {
                refreshTokenMetrics();
            }
        }, 30000); // Refresh every 30 seconds

        // Load token metrics when panel becomes visible
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.target.id === 'panel-tokens' && !mutation.target.classList.contains('hidden')) {
                        refreshTokenMetrics();
                    }
                });
            });

            const tokenPanel = document.getElementById('panel-tokens');
            if (tokenPanel) {
                observer.observe(tokenPanel, { attributes: true, attributeFilter: ['class'] });
            }
        });

    </script>

    <!-- Save View Modal -->
    <div class="save-view-modal" id="saveViewModal">
        <div class="save-view-content">
            <div class="save-view-title">Save Current View</div>
            <div class="save-view-field">
                <label class="save-view-label">View Name</label>
                <input type="text" class="save-view-input" id="viewNameInput" placeholder="e.g., My Development View">
            </div>
            <div class="save-view-field">
                <label class="save-view-checkbox">
                    <input type="checkbox" id="shareViewCheckbox">
                    Share with all users
                </label>
            </div>
            <div class="save-view-actions">
                <button class="save-view-btn cancel" onclick="closeSaveViewModal()">Cancel</button>
                <button class="save-view-btn save" onclick="saveCurrentView()">Save View</button>
            </div>
        </div>
    </div>

    <script>
    // ==========================================
    // SAVED VIEWS FUNCTIONALITY
    // ==========================================

    let savedViews = [];
    let currentViewName = null;

    // Toggle views dropdown
    function toggleViewsDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('viewsDropdown');
        const isOpen = dropdown.classList.contains('open');

        // Close other dropdowns
        document.querySelectorAll('.views-dropdown.open').forEach(d => d.classList.remove('open'));

        if (!isOpen) {
            dropdown.classList.add('open');
            loadSavedViews();
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.views-dropdown')) {
            document.querySelectorAll('.views-dropdown.open').forEach(d => d.classList.remove('open'));
        }
    });

    // Load saved views from API
    async function loadSavedViews() {
        try {
            const response = await fetch('/api/dashboard/config/layouts', {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('Failed to load views');

            const data = await response.json();
            savedViews = data.layouts || [];
            renderSavedViews();
        } catch (error) {
            console.error('Error loading saved views:', error);
            savedViews = [];
            renderSavedViews();
        }
    }

    // Render saved views in dropdown
    function renderSavedViews() {
        const container = document.getElementById('savedViewsList');

        if (savedViews.length === 0) {
            container.innerHTML = '<div class="views-empty">No saved views yet</div>';
            return;
        }

        // Separate personal and shared views
        const personalViews = savedViews.filter(v => !v.is_shared);
        const sharedViews = savedViews.filter(v => v.is_shared);

        let html = '';

        if (personalViews.length > 0) {
            personalViews.forEach(view => {
                const isActive = currentViewName === view.name;
                html += renderViewItem(view, isActive);
            });
        }

        if (sharedViews.length > 0) {
            if (personalViews.length > 0) {
                html += '<div class="views-divider"></div>';
                html += '<div class="views-section-label">Shared Views</div>';
            }
            sharedViews.forEach(view => {
                const isActive = currentViewName === view.name;
                html += renderViewItem(view, isActive, true);
            });
        }

        if (html === '') {
            html = '<div class="views-empty">No saved views yet</div>';
        }

        container.innerHTML = html;
    }

    // Render single view item
    function renderViewItem(view, isActive, isShared = false) {
        return `
            <div class="views-item ${isActive ? 'active' : ''}" onclick="applyView('${view.name}')">
                <span class="views-item-name">${view.name}${isShared ? ' (shared)' : ''}</span>
                <div class="views-item-actions">
                    <button class="views-item-btn delete" onclick="deleteView(event, '${view.name}')" title="Delete view">x</button>
                </div>
            </div>
        `;
    }

    // Open save view modal
    function openSaveViewModal() {
        document.getElementById('saveViewModal').classList.add('open');
        document.getElementById('viewNameInput').value = '';
        document.getElementById('viewNameInput').focus();
        document.getElementById('shareViewCheckbox').checked = false;
        // Close dropdown
        document.querySelectorAll('.views-dropdown.open').forEach(d => d.classList.remove('open'));
    }

    // Close save view modal
    function closeSaveViewModal() {
        document.getElementById('saveViewModal').classList.remove('open');
    }

    // Get current dashboard state
    function getCurrentDashboardState() {
        return {
            theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
            currentPanel: currentPanel || 'overview',
            pinnedPanels: getPinnedPanels(),
            sidebarCollapsed: localStorage.getItem('sidebarFullyCollapsed') === 'true',
            focusMode: document.body.classList.contains('focus-mode'),
            refreshInterval: parseInt(localStorage.getItem('refreshInterval') || '30000'),
            autoRefreshEnabled: localStorage.getItem('autoRefreshEnabled') === 'true',  // Disabled by default for reliability
            panels: {}
        };
    }

    // Save current view
    async function saveCurrentView() {
        const viewName = document.getElementById('viewNameInput').value.trim();
        const isShared = document.getElementById('shareViewCheckbox').checked;

        if (!viewName) {
            showToast('Please enter a view name', 'error');
            return;
        }

        const config = getCurrentDashboardState();

        try {
            const response = await fetch('/api/dashboard/config/layouts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    name: viewName,
                    config: config,
                    shared: isShared
                })
            });

            if (!response.ok) throw new Error('Failed to save view');

            currentViewName = viewName;
            closeSaveViewModal();
            showToast(`View "${viewName}" saved successfully`, 'success');
            loadSavedViews();
        } catch (error) {
            console.error('Error saving view:', error);
            showToast('Failed to save view', 'error');
        }
    }

    // Apply a saved view
    async function applyView(viewName) {
        try {
            const response = await fetch(`/api/dashboard/config/layouts/${encodeURIComponent(viewName)}/apply`, {
                method: 'POST',
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to apply view');

            const data = await response.json();
            const config = data.config || {};

            // Apply theme
            if (config.theme === 'light') {
                document.body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-theme');
                localStorage.setItem('theme', 'dark');
            }

            // Apply focus mode
            if (config.focusMode) {
                document.body.classList.add('focus-mode');
            } else {
                document.body.classList.remove('focus-mode');
            }

            // Apply pinned panels
            if (config.pinnedPanels) {
                setPinnedPanels(config.pinnedPanels);
                renderPinnedPanels();
            }

            // Navigate to saved panel
            if (config.currentPanel) {
                navigateToPanel(config.currentPanel);
            }

            // Apply refresh settings
            if (config.refreshInterval) {
                localStorage.setItem('refreshInterval', config.refreshInterval.toString());
            }

            currentViewName = viewName;

            // Close dropdown
            document.querySelectorAll('.views-dropdown.open').forEach(d => d.classList.remove('open'));

            showToast(`Applied view "${viewName}"`, 'success');
            renderSavedViews();
        } catch (error) {
            console.error('Error applying view:', error);
            showToast('Failed to apply view', 'error');
        }
    }

    // Delete a saved view
    async function deleteView(event, viewName) {
        event.stopPropagation();

        if (!confirm(`Delete view "${viewName}"?`)) return;

        try {
            const response = await fetch(`/api/dashboard/config/layouts/${encodeURIComponent(viewName)}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to delete view');

            if (currentViewName === viewName) {
                currentViewName = null;
            }

            showToast(`View "${viewName}" deleted`, 'success');
            loadSavedViews();
        } catch (error) {
            console.error('Error deleting view:', error);
            showToast('Failed to delete view', 'error');
        }
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSaveViewModal();
        }
    });

    // Close modal when clicking backdrop
    document.getElementById('saveViewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSaveViewModal();
        }
    });

    // Initialize views on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Pre-load views for faster dropdown
        loadSavedViews();
    });

    // ===== AI Assistant Functions =====

    function setAIInstruction(text) {
        document.getElementById('ai-instruction').value = text;
        document.getElementById('ai-instruction').focus();
    }

    async function breakdownInstruction() {
        const instruction = document.getElementById('ai-instruction').value.trim();

        if (!instruction) {
            showNotification('Please enter an instruction', 'error');
            return;
        }

        const targetProvider = document.getElementById('ai-target-provider').value;
        const priority = parseInt(document.getElementById('ai-priority').value);
        const autoExecute = document.getElementById('ai-auto-execute').checked;

        // Show results section
        document.getElementById('ai-results').style.display = 'block';
        document.getElementById('ai-status').style.display = 'flex';
        document.getElementById('ai-breakdown').style.display = 'none';
        document.getElementById('ai-error').style.display = 'none';

        // Disable button
        const btn = document.getElementById('ai-breakdown-btn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="border: 2px solid rgba(255,255,255,0.3); border-top-color: white; width: 14px; height: 14px; display: inline-block; margin-right: 8px;"></div> Analyzing...';

        try {
            const response = await fetch('/api/tasks/ai-breakdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    instruction: instruction,
                    auto_execute: autoExecute,
                    target_provider: targetProvider,
                    priority: priority
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to break down instruction');
            }

            // Hide status, show breakdown
            document.getElementById('ai-status').style.display = 'none';
            document.getElementById('ai-breakdown').style.display = 'block';

            // Display instruction
            document.getElementById('ai-instruction-display').textContent = data.instruction;

            // Display total time
            document.getElementById('ai-total-time').textContent = data.estimated_total_time;

            // Display queued info if tasks were queued
            if (data.tasks_queued && data.tasks_queued.length > 0) {
                document.getElementById('ai-queued-info').style.display = 'block';
                document.getElementById('ai-queued-count').textContent = `${data.tasks_queued.length} (${data.queue_type})`;
            } else {
                document.getElementById('ai-queued-info').style.display = 'none';
            }

            // Render tasks
            renderAITasks(data.breakdown, data.tasks_queued);

            // Show success notification
            if (autoExecute) {
                showNotification(` Breakdown complete! ${data.tasks_queued.length} tasks queued`, 'success');
            } else {
                showNotification(' Breakdown complete! Review tasks below', 'success');
            }

        } catch (error) {
            console.error('AI breakdown error:', error);

            // Hide status, show error
            document.getElementById('ai-status').style.display = 'none';
            document.getElementById('ai-error').style.display = 'block';
            document.getElementById('ai-error').innerHTML = `
                <strong>Error:</strong> ${error.message}
                ${error.details ? `<br><small>${error.details}</small>` : ''}
            `;

            showNotification('Failed to break down instruction', 'error');
        } finally {
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = ' Break Down';
        }
    }

    function renderAITasks(breakdown, queuedTaskIds) {
        const container = document.getElementById('ai-tasks-list');
        container.innerHTML = '';

        breakdown.forEach((task, index) => {
            const isQueued = queuedTaskIds && queuedTaskIds[index];

            const taskCard = document.createElement('div');
            taskCard.style.cssText = 'padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; border-left: 3px solid var(--cyan);';

            const typeColors = {
                'code': 'var(--cyan)',
                'test': 'var(--green)',
                'investigation': 'var(--yellow)',
                'deploy': 'var(--purple)',
                'documentation': 'var(--blue)',
                'review': 'var(--orange)'
            };

            const typeColor = typeColors[task.type] || 'var(--text-secondary)';

            taskCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="background: ${typeColor}; color: black; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                            ${task.type}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 12px;">
                            Step ${task.step}
                        </div>
                        ${isQueued ? '<div style="background: var(--green); color: black; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;"> QUEUED</div>' : ''}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 12px;">
                        ${task.estimated_time}
                    </div>
                </div>
                <div style="color: var(--text-primary); font-size: 14px; line-height: 1.5;">
                    ${task.description}
                </div>
                ${task.dependencies && task.dependencies.length > 0 ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary);">
                        <strong>Depends on:</strong> Step ${task.dependencies.join(', Step ')}
                    </div>
                ` : ''}
            `;

            container.appendChild(taskCard);
        });
    }

    // Handle Enter key in instruction textarea (Ctrl+Enter to submit)
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('ai-instruction');
        if (textarea) {
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    breakdownInstruction();
                }
            });
        }
    });

    // ==========================================
    // SYSTEM HEALTH MONITORING
    // ==========================================

    let healthCharts = {};
    let healthRefreshInterval = null;

    async function loadHealthData() {
        try {
            const hours = document.getElementById('healthTimeRange')?.value || 24;

            // Load historical data
            const sysResponse = await fetch(`/api/health/system?hours=${hours}`, {
                credentials: 'include'
            });
            const sysData = await sysResponse.json();

            // Load current status
            const currentResponse = await fetch('/api/health/current', {
                credentials: 'include'
            });
            const currentData = await currentResponse.json();

            // Update current status cards
            document.getElementById('currentCpu').textContent = `${currentData.system.cpu_percent.toFixed(1)}%`;
            document.getElementById('currentMemory').textContent = `${currentData.system.memory_percent.toFixed(1)}%`;
            document.getElementById('currentDisk').textContent = `${currentData.system.disk_percent.toFixed(1)}%`;

            const servicesRunning = currentData.services.filter(s => s.status === 'running').length;
            document.getElementById('currentServices').textContent = `${servicesRunning}/${currentData.services.length}`;

            // Count workers
            const workerServices = currentData.services.filter(s =>
                s.name.includes('Worker') || s.name.includes('Sync')
            );
            const workersActive = workerServices.filter(s => s.status === 'running').length;
            document.getElementById('currentWorkers').textContent = `${workersActive}/${workerServices.length}`;

            // Render charts
            renderHealthCharts(sysData.data);

        } catch (error) {
            console.error('Error loading health data:', error);
        }
    }

    function renderHealthCharts(data) {
        if (!data || data.length === 0) return;

        const labels = data.map(d => {
            const date = new Date(d.time);
            return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        });

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                x: {
                    display: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: 'rgba(255, 255, 255, 0.6)', maxTicksLimit: 12 }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    max: 100,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        callback: function(value) { return value + '%'; }
                    }
                }
            }
        };

        // CPU Chart
        const cpuCtx = document.getElementById('cpuChart');
        if (cpuCtx) {
            if (healthCharts.cpu) healthCharts.cpu.destroy();
            healthCharts.cpu = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CPU %',
                        data: data.map(d => d.cpu_percent),
                        borderColor: 'rgb(88, 166, 255)',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Memory Chart
        const memCtx = document.getElementById('memoryChart');
        if (memCtx) {
            if (healthCharts.memory) healthCharts.memory.destroy();
            healthCharts.memory = new Chart(memCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Memory %',
                        data: data.map(d => d.memory_percent),
                        borderColor: 'rgb(63, 185, 80)',
                        backgroundColor: 'rgba(63, 185, 80, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Disk Chart
        const diskCtx = document.getElementById('diskChart');
        if (diskCtx) {
            if (healthCharts.disk) healthCharts.disk.destroy();
            healthCharts.disk = new Chart(diskCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Disk %',
                        data: data.map(d => d.disk_percent),
                        borderColor: 'rgb(210, 153, 34)',
                        backgroundColor: 'rgba(210, 153, 34, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Services & Workers Chart
        const servicesCtx = document.getElementById('servicesChart');
        if (servicesCtx) {
            if (healthCharts.services) healthCharts.services.destroy();
            const servicesOptions = JSON.parse(JSON.stringify(chartOptions));
            servicesOptions.scales.y.max = Math.max(...data.map(d => d.services_running), ...data.map(d => d.workers_active)) + 2;
            servicesOptions.scales.y.ticks.callback = function(value) { return value; };

            healthCharts.services = new Chart(servicesCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Services',
                            data: data.map(d => d.services_running),
                            borderColor: 'rgb(88, 166, 255)',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Workers',
                            data: data.map(d => d.workers_active),
                            borderColor: 'rgb(139, 148, 158)',
                            backgroundColor: 'rgba(139, 148, 158, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    ...servicesOptions,
                    plugins: {
                        ...servicesOptions.plugins,
                        legend: {
                            display: true,
                            labels: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    }
                }
            });
        }
    }

    function toggleHealthAutoRefresh(enabled) {
        if (enabled) {
            loadHealthData();
            healthRefreshInterval = setInterval(loadHealthData, 60000);
        } else {
            if (healthRefreshInterval) {
                clearInterval(healthRefreshInterval);
                healthRefreshInterval = null;
            }
        }
    }

    // ==========================================
    // REPORTS & AUDITS
    // ==========================================

    let currentReportContent = '';

    async function loadReports() {
        try {
            const response = await fetch('/api/reports');
            const data = await response.json();

            if (data.error) {
                showNotification('Error loading reports: ' + data.error, 'error');
                return;
            }

            const reportsList = document.getElementById('reportsList');
            const reportsCount = document.getElementById('reportsCount');

            reportsCount.textContent = data.count;

            if (data.reports.length === 0) {
                reportsList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">No reports found</div>';
                return;
            }

            reportsList.innerHTML = data.reports.map(report => {
                const sizeKB = (report.size / 1024).toFixed(1);
                const modified = new Date(report.modified).toLocaleString();
                const icon = report.type === 'documentation' ? '' : '';

                return `
                    <div class="report-item" onclick="viewReport('${report.path}')" style="padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-size: 18px;">${icon}</span>
                            <span style="font-weight: 600; font-size: 13px; flex: 1;">${report.name}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between;">
                            <span>${sizeKB} KB</span>
                            <span>${modified.split(',')[0]}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Add hover effect
            document.querySelectorAll('.report-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = 'var(--bg-secondary)';
                    this.style.borderColor = 'var(--accent)';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'var(--bg-card)';
                    this.style.borderColor = 'var(--border)';
                });
            });

        } catch (error) {
            console.error('Error loading reports:', error);
            showNotification('Failed to load reports', 'error');
        }
    }

    async function viewReport(path) {
        try {
            const response = await fetch(`/api/reports/${encodeURIComponent(path)}`);
            const data = await response.json();

            if (data.error) {
                showNotification('Error viewing report: ' + data.error, 'error');
                return;
            }

            currentReportContent = data.content;

            document.getElementById('reportFileName').textContent = data.filename;
            document.getElementById('reportModified').textContent = `Modified: ${new Date(data.modified).toLocaleString()}  ${data.lines} lines`;

            const viewer = document.getElementById('reportViewer');

            // Convert markdown to simple HTML
            const html = data.content
                .replace(/^### (.*$)/gim, '<h3 style="font-size: 18px; font-weight: 600; margin: 24px 0 12px 0; color: var(--text-primary);">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="font-size: 22px; font-weight: 600; margin: 28px 0 14px 0; color: var(--text-primary);">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="font-size: 26px; font-weight: 600; margin: 32px 0 16px 0; color: var(--text-primary);">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px;">$1</code>')
                .replace(/^- (.*$)/gim, '<li style="margin: 4px 0;">$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li style="margin: 4px 0;">$2</li>')
                .replace(/\n\n/g, '</p><p style="margin: 12px 0;">')
                .replace(/^(?!<[hol])/gim, '<p style="margin: 12px 0;">');

            viewer.innerHTML = html;

        } catch (error) {
            console.error('Error viewing report:', error);
            showNotification('Failed to view report', 'error');
        }
    }

    function copyReportContent() {
        if (!currentReportContent) {
            showNotification('No report loaded', 'warning');
            return;
        }

        navigator.clipboard.writeText(currentReportContent).then(() => {
            showNotification('Report copied to clipboard', 'success');
            document.getElementById('copyReportBtn').textContent = 'Copied!';
            setTimeout(() => {
                document.getElementById('copyReportBtn').textContent = 'Copy';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            showNotification('Failed to copy report', 'error');
        });
    }

    // ==========================================
    // MODAL FIX FOR MOBILE - Click outside to close
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Add backdrop click handler to all modals
        const allModals = document.querySelectorAll('.modal, .modal-overlay');
        allModals.forEach(modal => {
            modal.addEventListener('click', function(e) {
                // Only close if clicking the backdrop (not modal content)
                if (e.target === modal) {
                    // Get modal ID
                    const modalId = modal.id.replace('modal-', '');
                    if (typeof hideModal === 'function') {
                        hideModal(modalId);
                    } else {
                        // Fallback: direct hide
                        modal.style.display = 'none';
                        modal.classList.remove('active');
                    }
                    console.log('[Mobile Fix] Closed modal via backdrop click:', modalId);
                }
            });
        });

        // Force-hide all modals on page load (prevent auto-show)
        setTimeout(() => {
            allModals.forEach(modal => {
                if (!modal.classList.contains('show') && modal.style.display !== 'flex') {
                    modal.style.display = 'none';
                    modal.classList.remove('active');
                }
            });
        }, 100);

        console.log('[Mobile Fix] Initialized modal backdrop click handlers for', allModals.length, 'modals');
    });

    </script>

</body>
</html>
