name: Phase 5 Testing Suite

on:
  push:
    branches: [ main, develop, feature/phase5-* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Phase 5a - Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run Unit Tests
        run: |
          go test -v \
            -run "TestCheckLimit|TestCreateRule|TestUpdateRule|TestDeleteRule|TestGetRule|TestListRules|TestRulePriority|TestGetQuota|TestIncrementQuota|TestGetViolations|TestViolationStats|TestRuleCache|TestDisabledRule|TestMultipleScopes|TestResourceTypeFiltering|TestContextCancellation|TestCleanupOldBuckets|TestCleanupOldViolations|TestCleanupOldMetrics" \
            ./pkg/services/rate_limiting -timeout 30s

      - name: Generate Coverage
        run: |
          go test -coverprofile=coverage_unit.out \
            -run "TestCheckLimit|TestCreateRule|TestUpdateRule|TestDeleteRule|TestGetRule|TestListRules|TestRulePriority|TestGetQuota|TestIncrementQuota|TestGetViolations|TestViolationStats|TestRuleCache|TestDisabledRule|TestMultipleScopes|TestResourceTypeFiltering|TestContextCancellation|TestCleanupOldBuckets|TestCleanupOldViolations|TestCleanupOldMetrics" \
            ./pkg/services/rate_limiting

  integration-tests:
    name: Phase 5b - Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run Integration Tests
        run: |
          go test -v \
            -run "TestFullRateLimitCycle|TestDailyQuotaReset|TestMultipleScopeLimits|TestRuleEnablingDisabling|TestResourceTypeSpecificLimits|TestPriorityBasedRuleEvaluation|TestViolationStatsAggregation|TestCleanupByTimeRange|TestConcurrentRequestHandling" \
            ./pkg/services/rate_limiting -timeout 60s

  load-tests:
    name: Phase 5c - Load Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run Load Tests
        run: |
          go test -v -short \
            -run "TestConcurrentRateLimitChecks|TestHighViolationRate|TestManyRules|TestLargeViolationHistory" \
            ./pkg/services/rate_limiting -timeout 120s

      - name: Run Performance Benchmarks
        run: |
          go test -bench=. -benchmem \
            -run "^$" \
            ./pkg/services/rate_limiting 2>&1 | tee bench.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: bench.txt

  e2e-tests:
    name: Phase 5d - E2E API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run E2E Tests
        run: |
          go test -v \
            -run "TestFullAdminWorkflow|TestMultiTenantIsolation|TestQuotaManagementWorkflow|TestRateLimitEnforcementFlow|TestErrorHandlingAndEdgeCases|TestConcurrentAPICalls" \
            ./pkg/services/rate_limiting -timeout 60s

  coverage-report:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Generate Full Coverage Report
        run: |
          go test -coverprofile=coverage.out ./pkg/services/rate_limiting
          go tool cover -func=coverage.out -o coverage_func.txt
          go tool cover -html=coverage.out -o coverage.html

      - name: Display Coverage Summary
        run: |
          echo "=== Coverage Summary ==="
          tail -1 coverage_func.txt

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage.out
            coverage_func.txt
            coverage.html

      - name: Comment PR with Coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage_func.txt', 'utf8').split('\n').pop();
            const comment = `## Test Coverage\n\n${coverage}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [ unit-tests, integration-tests, load-tests, e2e-tests, coverage-report ]
    if: always()
    steps:
      - name: Test Results Summary
        run: |
          echo "=== Phase 5 Testing Suite Results ==="
          echo "Phase 5a (Unit Tests): ${{ needs.unit-tests.result }}"
          echo "Phase 5b (Integration Tests): ${{ needs.integration-tests.result }}"
          echo "Phase 5c (Load Tests): ${{ needs.load-tests.result }}"
          echo "Phase 5d (E2E Tests): ${{ needs.e2e-tests.result }}"
          echo "Coverage Report: ${{ needs.coverage-report.result }}"

      - name: Fail if tests failed
        if: needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure' || needs.e2e-tests.result == 'failure'
        run: exit 1
