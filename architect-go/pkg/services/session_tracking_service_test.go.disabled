package services

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"

	"architect-go/pkg/models"
)

// MockSessionRepository mocks the SessionRepository
type MockSessionRepository struct {
	mock.Mock
}

func (m *MockSessionRepository) Create(ctx context.Context, session *models.Session) error {
	args := m.Called(ctx, session)
	return args.Error(0)
}

func (m *MockSessionRepository) Get(ctx context.Context, id string) (*models.Session, error) {
	args := m.Called(ctx, id)
	if args.Get(0) == nil {
		return nil, args.Error(1)
	}
	return args.Get(0).(*models.Session), args.Error(1)
}

func (m *MockSessionRepository) GetByToken(ctx context.Context, token string) (*models.Session, error) {
	args := m.Called(ctx, token)
	if args.Get(0) == nil {
		return nil, args.Error(1)
	}
	return args.Get(0).(*models.Session), args.Error(1)
}

func (m *MockSessionRepository) ListByUser(ctx context.Context, userID string) ([]*models.Session, error) {
	args := m.Called(ctx, userID)
	if args.Get(0) == nil {
		return nil, args.Error(1)
	}
	return args.Get(0).([]*models.Session), args.Error(1)
}

func (m *MockSessionRepository) Update(ctx context.Context, session *models.Session) error {
	args := m.Called(ctx, session)
	return args.Error(0)
}

func (m *MockSessionRepository) Delete(ctx context.Context, id string) error {
	args := m.Called(ctx, id)
	return args.Error(0)
}

func (m *MockSessionRepository) DeleteExpired(ctx context.Context) error {
	args := m.Called(ctx)
	return args.Error(0)
}

// TestSessionTrackingService_CreateSession tests session creation
func TestSessionTrackingService_CreateSession(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	mockRepo.On("Create", ctx, mock.MatchedBy(func(s *models.Session) bool {
		return s.UserID == "user-1" && s.IPAddress == "192.168.1.1"
	})).Return(nil)

	service := NewSessionTrackingService(mockRepo)
	result, err := service.CreateSession(ctx, "user-1", "192.168.1.1", "Mozilla/5.0")

	assert.NoError(t, err)
	assert.NotNil(t, result)
	mockRepo.AssertCalled(t, "Create", ctx, mock.AnythingOfType("*models.Session"))
}

// TestSessionTrackingService_GetSession tests session retrieval
func TestSessionTrackingService_GetSession(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	session := &models.Session{
		ID:     "session-1",
		UserID: "user-1",
	}

	mockRepo.On("Get", ctx, "session-1").Return(session, nil)

	service := NewSessionTrackingService(mockRepo)
	result, err := service.GetSession(ctx, "session-1")

	assert.NoError(t, err)
	assert.Equal(t, "session-1", result.ID)
	mockRepo.AssertCalled(t, "Get", ctx, "session-1")
}

// TestSessionTrackingService_ListSessions tests session listing
func TestSessionTrackingService_ListSessions(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	sessions := []*models.Session{
		{ID: "session-1", UserID: "user-1"},
		{ID: "session-2", UserID: "user-2"},
	}

	mockRepo.On("ListByUser", ctx, mock.Anything).Return(sessions, nil)

	service := NewSessionTrackingService(mockRepo)
	results, total, err := service.ListSessions(ctx, 10, 0)

	assert.NoError(t, err)
	assert.Greater(t, total, int64(0))
	mockRepo.AssertCalled(t, "ListByUser", ctx, mock.Anything)
}

// TestSessionTrackingService_ValidateSession tests session validation
func TestSessionTrackingService_ValidateSession(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	session := &models.Session{
		ID:     "session-1",
		UserID: "user-1",
	}

	mockRepo.On("Get", ctx, "session-1").Return(session, nil)

	service := NewSessionTrackingService(mockRepo)
	isValid, err := service.ValidateSession(ctx, "session-1")

	assert.NoError(t, err)
	assert.True(t, isValid)
	mockRepo.AssertCalled(t, "Get", ctx, "session-1")
}

// TestSessionTrackingService_DestroySession tests session destruction
func TestSessionTrackingService_DestroySession(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	mockRepo.On("Delete", ctx, "session-1").Return(nil)

	service := NewSessionTrackingService(mockRepo)
	err := service.DestroySession(ctx, "session-1")

	assert.NoError(t, err)
	mockRepo.AssertCalled(t, "Delete", ctx, "session-1")
}

// TestSessionTrackingService_GetUserSessions tests user session retrieval
func TestSessionTrackingService_GetUserSessions(t *testing.T) {
	mockRepo := new(MockSessionRepository)
	ctx := context.Background()

	sessions := []*models.Session{
		{ID: "session-1", UserID: "user-1"},
		{ID: "session-2", UserID: "user-1"},
	}

	mockRepo.On("ListByUser", ctx, "user-1").Return(sessions, nil)

	service := NewSessionTrackingService(mockRepo)
	results, total, err := service.GetUserSessions(ctx, "user-1", 10, 0)

	assert.NoError(t, err)
	assert.Equal(t, int64(2), total)
	assert.Equal(t, 2, len(results))
	mockRepo.AssertCalled(t, "ListByUser", ctx, "user-1")
}
