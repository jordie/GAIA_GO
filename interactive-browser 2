#!/usr/bin/env python3
"""
Interactive Browser Agent
Takes screenshots and lets Claude Code (via Read tool) analyze them
"""

import sys
import time
from pathlib import Path


def navigate_interactive(goal, url, username=None, password=None):
    """Navigate with Claude Code analyzing screenshots."""
    from selenium import webdriver
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.common.by import By
    from webdriver_manager.chrome import ChromeDriverManager

    options = Options()
    options.add_argument('--start-maximized')

    print("ğŸš€ Starting interactive browser...")
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=options)

    try:
        print(f"\nğŸ¯ Goal: {goal}")
        print(f"ğŸŒ Starting: {url}\n")

        driver.get(url)
        time.sleep(3)

        for step in range(10):
            print(f"\n{'='*70}")
            print(f"ğŸ“ STEP {step + 1}/10")
            print('='*70)

            # Get page info
            title = driver.title
            current_url = driver.current_url
            page_text = driver.find_element(By.TAG_NAME, 'body').text

            print(f"ğŸ“„ Page: {title}")
            print(f"ğŸ”— URL: {current_url}")

            # Take screenshot
            screenshot_path = f"/tmp/interactive_step_{step}.png"
            driver.save_screenshot(screenshot_path)
            print(f"ğŸ“¸ Screenshot saved: {screenshot_path}")

            # Show page text preview
            print(f"\nğŸ“ Page content preview (first 500 chars):")
            print("-"*70)
            print(page_text[:500])
            print("-"*70)

            # Available credentials
            print(f"\nğŸ” Credentials available:")
            print(f"   Username: {username if username else 'None'}")
            print(f"   Password: {'****' if password else 'None'}")

            # Wait for Claude Code to analyze via Read tool and provide action
            print(f"\nâ¸ï¸  WAITING FOR ANALYSIS...")
            print(f"   Claude Code should now:")
            print(f"   1. Read the screenshot: {screenshot_path}")
            print(f"   2. Analyze what's on the page")
            print(f"   3. Decide the next action")
            print(f"\n   Enter action (or 'quit'):")
            print(f"   - click:<link_text>")
            print(f"   - login")
            print(f"   - submit")
            print(f"   - scroll")
            print(f"   - answer:<the answer>")

            action = input("\n   Action> ").strip()

            if action.lower() == 'quit':
                print("ğŸ‘‹ Stopping")
                break

            elif action.startswith('click:'):
                link_text = action.split('click:')[1].strip()
                print(f"\nğŸ–±ï¸  Clicking: {link_text}")
                try:
                    driver.find_element(By.PARTIAL_LINK_TEXT, link_text).click()
                    print("âœ… Clicked!")
                    time.sleep(3)
                except Exception as e:
                    print(f"âŒ Error: {e}")

            elif action.lower() == 'login':
                print("\nğŸ“ Filling login form...")
                if username and password:
                    try:
                        # Try to find and fill email
                        for selector in ['input[type="email"]', 'input[name="email"]', 'input[name="username"]']:
                            try:
                                driver.find_element(By.CSS_SELECTOR, selector).send_keys(username)
                                print(f"âœ… Filled username")
                                break
                            except:
                                continue

                        # Fill password
                        driver.find_element(By.CSS_SELECTOR, 'input[type="password"]').send_keys(password)
                        print(f"âœ… Filled password")
                    except Exception as e:
                        print(f"âŒ Error: {e}")
                else:
                    print("âŒ No credentials provided")

            elif action.lower() == 'submit':
                print("\nğŸš€ Submitting form...")
                try:
                    driver.find_element(By.CSS_SELECTOR, 'button[type="submit"]').click()
                    print("âœ… Submitted!")
                    time.sleep(5)
                except Exception as e:
                    print(f"âŒ Error: {e}")

            elif action.lower() == 'scroll':
                print("\nğŸ“œ Scrolling down...")
                driver.execute_script("window.scrollBy(0, 800)")
                time.sleep(2)

            elif action.startswith('answer:'):
                answer = action.split('answer:')[1].strip()
                print(f"\nâœ… FOUND ANSWER: {answer}")

                result = {
                    'success': True,
                    'answer': answer,
                    'url': current_url,
                    'screenshot': screenshot_path
                }

                import json
                with open('/tmp/interactive_result.json', 'w') as f:
                    json.dump(result, f, indent=2)

                print(f"\nğŸ“„ Saved to: /tmp/interactive_result.json")
                return result

        print("\nâš ï¸  Reached max steps")
        return {'success': False, 'error': 'Max steps reached'}

    finally:
        print("\nâ¸ï¸  Browser will stay open. Press Enter to close...")
        input()
        driver.quit()
        print("âœ… Browser closed")


if __name__ == '__main__':
    if len(sys.argv) < 3:
        print('Usage: interactive-browser "question" <url> [username] [password]')
        sys.exit(1)

    navigate_interactive(
        sys.argv[1],
        sys.argv[2],
        sys.argv[3] if len(sys.argv) > 3 else None,
        sys.argv[4] if len(sys.argv) > 4 else None
    )
